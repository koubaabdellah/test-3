(this["webpackChunkapplication"]=this["webpackChunkapplication"]||[]).push([[6587,6920,3901,2055,423],{498807:(e,t,n)=>{"use strict";n.d(t,{Q:()=>o,g:()=>r});var o;(function(e){e[e["OFF"]=0]="OFF";e[e["ON"]=1]="ON"})(o||(o={}));var r;(function(e){e["ALL_MESSAGE"]="always";e["DM_AND_MENTION"]="mentions_or_dms";e["OFF"]="never"})(r||(r={}))},213196:(e,t,n)=>{"use strict";n.r(t);n.d(t,{CallDataModule:()=>u});var o=n(667489);var r=n(263431);var i=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var a=function(e){i(CallDataService,e);function CallDataService(){return e.call(this,{isSupportedCache:true,entityName:r.eM})||this}CallDataService.prototype.deleteCallEntity=function(e){this.getEntityCacheController().delete(e)};CallDataService.prototype.generateId=function(){var e=(0,o.randomInt)();while(this.getEntityCacheController().getEntitySynchronously(e)){e=(0,o.randomInt)()}return e};CallDataService.prototype.getCallEntity=function(e){return this.getEntityCacheController().getSynchronously(e)};CallDataService.prototype.upsertEntity=function(e){this.getEntityCacheController().putSync(e);o.notificationCenter.emitEntityUpdateSynchronously(r.FY.ENTITY.CALL,[e])};return CallDataService}(o.EntityBaseService);var l=n(492177);var s=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var c=l.k.tags("[CallDataModule]");var u=function(e){s(CallDataModule,e);function CallDataModule(t){var n=e.call(this,t)||this;n._service=new a;return n}Object.defineProperty(CallDataModule.prototype,"_dataService",{get:function(){if(!this._service){this._service=new a}return this._service},enumerable:true,configurable:true});CallDataModule.prototype.onLoad=function(){c.log("load CallDataModule")};CallDataModule.prototype.onUnload=function(){c.log("unload CallDataModule")};CallDataModule.prototype.moduleName=function(){return r.iv};CallDataModule.prototype.deleteCallEntity=function(e){this._dataService.deleteCallEntity(e)};CallDataModule.prototype.generateId=function(){return this._dataService.generateId()};CallDataModule.prototype.getCallEntity=function(e){return this._dataService.getCallEntity(e)};CallDataModule.prototype.upsertEntity=function(e){this._dataService.upsertEntity(e)};return CallDataModule}(o.AbstractModule)},263431:(e,t,n)=>{"use strict";n.d(t,{iv:()=>r,eM:()=>i,FY:()=>a});var o=n(295454);var r=o.Lb.CALL_DATA;var i="CALL";var a={ENTITY:{CALL:"ENTITY.CALL"}}},801348:(e,t,n)=>{"use strict";n.d(t,{CALL_ERROR_MESSAGE:()=>o.x2,CALL_STATE:()=>o.lt,HOLD_STATE:()=>o.ei,MONITOR_STATE:()=>o.rA,MUTE_STATE:()=>o.KC,QUEUE_CALL_DISPLAY_TYPE:()=>o.g1,RECORD_STATE:()=>o.M,CallDataUtils:()=>r.Y,FY:()=>i.FY});var o=n(855076);var r=n(160734);var i=n(263431);var a=n(213196);if(/^(130|388)3$/.test(n.j)){var l=n(814351);var s=n.n(l)}if(n.o(l,"BLFInfo"))n.d(t,{BLFInfo:function(){return l.BLFInfo}});if(n.o(l,"ConfInfo"))n.d(t,{ConfInfo:function(){return l.ConfInfo}});if(n.o(l,"QueueCallInfo"))n.d(t,{QueueCallInfo:function(){return l.QueueCallInfo}})},814351:()=>{},492177:(e,t,n)=>{"use strict";n.d(t,{k:()=>l});var o=n(862926);var r=n.n(o);var i=n(827027);var a="[CALL_DATA_MODULE][CORE]";var l=o.ModuleLogger.getLogger(a,(function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}return e}),i.PHONE_EVENT_DATA_FEATURE_KEY)},855076:(e,t,n)=>{"use strict";n.d(t,{g1:()=>r,lt:()=>i,ei:()=>a,M:()=>l,KC:()=>s,rA:()=>c,x2:()=>o.RTC_CALL_ERROR_EVENT});var o=n(343398);var r;(function(e){e["PHONE_NUMBER_NAME"]="inDIDLabel";e["PHONE_NUMBER"]="inDID";e["QUEUE_NAME"]="queueName";e["QUEUE_EXTENSION"]="queueExtPin";e["CALLER_ID_NAME"]="callerIdName";e["CALLER_ID_NUMBER"]="callerId";e["NONE"]="none"})(r||(r={}));var i;(function(e){e["IDLE"]="Idle";e["CONNECTING"]="Connecting";e["CONNECTED"]="Connected";e["DISCONNECTING"]="Disconnecting";e["DISCONNECTED"]="Disconnected"})(i||(i={}));var a;(function(e){e["IDLE"]="idle";e["HELD"]="held"})(a||(a={}));var l;(function(e){e["IDLE"]="idle";e["RECORDING"]="recording";e["RECORDING_DISABLED"]="recordingDisabled";e["DISABLED"]="disabled"})(l||(l={}));var s;(function(e){e["IDLE"]="idle";e["MUTED"]="muted"})(s||(s={}));var c;(function(e){e[e["MONITORING"]=0]="MONITORING";e[e["WHISPER"]=1]="WHISPER";e[e["BARGE"]=2]="BARGE";e[e["TAKE_OVER"]=3]="TAKE_OVER"})(c||(c={}))},160734:(e,t,n)=>{"use strict";n.d(t,{Y:()=>c});var o=n(298784);var r=n.n(o);var i=n(667489);var a=n.n(i);var l=n(263431);var s=n(492177);var c=function(){function CallDataUtils(){}CallDataUtils.getInstance=function(){if(!this._instance){this._instance=new CallDataUtils}return this._instance};CallDataUtils.prototype.upsertCallEntity=function(e){var t;s.k.info("notify ui call entity update, call entity:",{call:e});(t=this._callDataModule)===null||t===void 0?void 0:t.upsertEntity(e)};CallDataUtils.prototype.deleteCallEntity=function(e){var t;(t=this._callDataModule)===null||t===void 0?void 0:t.deleteCallEntity(e)};CallDataUtils.prototype.generateId=function(){var e;return(e=this._callDataModule)===null||e===void 0?void 0:e.generateId()};CallDataUtils.prototype.getCallEntity=function(e){var t;return(0,o.cloneDeep)((t=this._callDataModule)===null||t===void 0?void 0:t.getCallEntity(e))||null};Object.defineProperty(CallDataUtils.prototype,"_callDataModule",{get:function(){return(0,i.getModule)(l.iv)},enumerable:true,configurable:true});return CallDataUtils}()},424567:(e,t,n)=>{"use strict";n.d(t,{Li:()=>a.Li,ay:()=>l.ay,l_:()=>l.l_,q1:()=>a.q1,El:()=>l.El,l9:()=>o.l9,c$:()=>l.c$,FY:()=>o.FY,Ux:()=>c.U,rM:()=>o.rM});var o=n(484181);var r=n(794104);var i=n(957570);var a=n(271010);var l=n(324865);var s=n(598263);var c=n(693914);var u=n(819031)},306587:(e,t,n)=>{"use strict";n.r(t);n.d(t,{TelephonyModule:()=>v});var o=n(667489);var r=n.n(o);var i=n(862926);var a=n.n(i);var l=n(587040);var s=n(424567);var c=n(266800);var u=n(147877);var p=n(226417);var _=n(649002);var C=n(446875);var f=n(422125);var d=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var h=undefined&&undefined.__decorate||function(e,t,n,o){var r=arguments.length,i=r<3?t:o===null?o=Object.getOwnPropertyDescriptor(t,n):o,a;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")i=Reflect.decorate(e,t,n,o);else for(var l=e.length-1;l>=0;l--)if(a=e[l])i=(r<3?a(i):r>3?a(t,n,i):a(t,n))||i;return r>3&&i&&Object.defineProperty(t,n,i),i};var T=undefined&&undefined.__metadata||function(e,t){if(typeof Reflect==="object"&&typeof Reflect.metadata==="function")return Reflect.metadata(e,t)};var R=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var g=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var E=(0,i.createLogDecorator)(f.k.tags("[EXECUTE_LOG]"));var v=function(e){d(TelephonyModule,e);function TelephonyModule(t){var n=e.call(this,t)||this;n.getAllCallCount=function(){return n.telephonyService.getAllCallCount()};n.mergeToRCConferenceCall=function(e,t){return n.telephonyService.mergeToRCConferenceCall(e,t)};n.makeCall=function(e,t){return R(n,void 0,Promise,(function(){var n,o;return g(this,(function(r){switch(r.label){case 0:n=f.k.performance();return[4,this.telephonyService.makeCall(e,t)];case 1:o=r.sent();n.end({key:u.z.MAKE_CALL,level:i.LOG_CONTROL_LEVEL.HIGH,infos:{result:o}});return[2,o]}}))}))};n.switchCall=function(e,t){return n.telephonyService.switchCall(e,t)};n.hangUp=function(e){return n.telephonyService.hangUp(e)};n.reject=function(e){return n.telephonyService.reject(e)};n.mute=function(e){return n.telephonyService.mute(e)};n.unmute=function(e){return n.telephonyService.unmute(e)};n.hold=function(e){return n.telephonyService.hold(e)};n.unhold=function(e){return n.telephonyService.unhold(e)};n.startRecord=function(e){return n.telephonyService.startRecord(e)};n.stopRecord=function(e){return n.telephonyService.stopRecord(e)};n.dtmf=function(e,t){return n.telephonyService.dtmf(e,t)};n.answer=function(e){return n.telephonyService.answer(e)};n.sendToVoiceMail=function(e){return n.telephonyService.sendToVoiceMail(e)};n.ignore=function(e){return n.telephonyService.ignore(e)};n.startReply=function(e){return n.telephonyService.startReply(e)};n.replyWithMessage=function(e,t){return n.telephonyService.replyWithMessage(e,t)};n.flip=function(e,t){return n.telephonyService.flip(e,t)};n.forward=function(e,t){return n.telephonyService.forward(e,t)};n.transfer=function(e,t,o){return n.telephonyService.transfer(e,t,o)};n.replyWithPattern=function(e,t,o,r){return n.telephonyService.replyWithPattern(e,t,o,r)};n.getVoipState=function(){return n.telephonyService.getVoipState()};n.getWebPhoneId=function(){return n.telephonyService.getWebPhoneId()};n.getCallIdList=function(){return n.telephonyService.getCallIdList()};return n}TelephonyModule.prototype.onLoad=function(){var e=this;C.MI.setRCExtensionIdGetter((function(){var e=(0,l.gT)();return e.userConfig.getExtensionId()}));this.telephonyService.start();this.getHealthController().registerItemMap({VoIP:function(){return{state:e.getVoipState()}},allCountStatus:function(){return e.telephonyService.getRtcCallCountStats()},emergencyAddress:function(){return s.q1.getEmergencyAddress()},SIP:function(){return e.telephonyService.getSipProv()},PhoneSettingInfo:function(){return e.telephonyService.getPhoneSettingInfo()}})};TelephonyModule.prototype.onUnload=function(){this.getHealthController().dispose();this.telephonyService.stop()};TelephonyModule.prototype.moduleName=function(){return u.oF};Object.defineProperty(TelephonyModule.prototype,"telephonyService",{get:function(){if(!this._telephonyService){this._telephonyService=new _.B}return this._telephonyService},enumerable:true,configurable:true});Object.defineProperty(TelephonyModule.prototype,"userConfig",{get:function(){return this.telephonyService.userConfig},enumerable:true,configurable:true});TelephonyModule.prototype.isInCall=function(){return this.telephonyService.isInCall()};TelephonyModule.prototype.getLastActivatedCallId=function(){return this.telephonyService.getLastActivatedCallId()};TelephonyModule.prototype.mergeCall=function(e){return this.telephonyService.mergeCall(e)};TelephonyModule.prototype.park=function(e,t){return this.telephonyService.park(e,t)};TelephonyModule.prototype.promoteToVideo=function(e){return this.telephonyService.promoteToVideo(e)};TelephonyModule.prototype.canPromoteToVideo=function(){return this.telephonyService.canPromoteCallToMeet()};TelephonyModule.prototype.addCallPromotedToRCVListener=function(e,t){return this.telephonyService.addCallPromotedToRCVListener(e,t)};TelephonyModule.prototype.removeCallPromotedToRCVListener=function(e,t){return this.telephonyService.removeCallPromotedToRCVListener(e,t)};TelephonyModule.prototype.getSwitchCall=function(){var e;return(e=this.telephonyService)===null||e===void 0?void 0:e.getSwitchCall()};TelephonyModule.prototype.hideSwitchCall=function(){var e;return(e=this.telephonyService)===null||e===void 0?void 0:e.hideSwitchCall()};TelephonyModule.prototype.getCallGroupByCallId=function(e){return this.telephonyService.getCallGroupByCallId(e)};TelephonyModule.prototype.answerAndHold=function(e){return this.telephonyService.answerAndHold(e)};TelephonyModule.prototype.answerAndEnd=function(e){return this.telephonyService.answerAndEnd(e)};TelephonyModule.prototype.isOverMaximumCallLimit=function(){return this.telephonyService.isOverMaximumCallLimit()};TelephonyModule.prototype.pickUpBLFCall=function(e,t){return this.telephonyService.pickUpBLFCall(e,t)};TelephonyModule.prototype.monitorBLFCall=function(e,t){return this.telephonyService.monitorBLFCall(e,t)};TelephonyModule.prototype.whisper=function(e){return this.telephonyService.whisper(e)};TelephonyModule.prototype.barge=function(e){return this.telephonyService.barge(e)};TelephonyModule.prototype.takeOver=function(e){return this.telephonyService.takeOver(e)};TelephonyModule.prototype.getTakeOverConfirm=function(){return this.telephonyService.getTakeOverConfirm()};TelephonyModule.prototype.setTakeOverConfirm=function(){return this.telephonyService.setTakeOverConfirm()};TelephonyModule.prototype.getMergeCallConfirm=function(){return this.telephonyService.getMergeCallConfirm()};TelephonyModule.prototype.setMergeCallConfirm=function(){return this.telephonyService.setMergeCallConfirm()};TelephonyModule.prototype.setLastCalledNumber=function(e){return this.telephonyService.setLastCalledNumber(e)};TelephonyModule.prototype.reportCallQualityFeedback=function(e){this.telephonyService.reportCallQualityFeedback(e)};TelephonyModule.prototype.getFeedbackIssuesList=function(){return this.telephonyService.getFeedbackIssuesList()};TelephonyModule.prototype.callOnBehalfOf=function(e,t,n){return this.telephonyService.callOnBehalfOf(e,t,n)};TelephonyModule.prototype.getOrCreateRCConferenceForAddPeople=function(){return this.telephonyService.getOrCreateRCConferenceForAddPeople()};TelephonyModule.prototype.promoteDelegatedCallToConf=function(e){return this.telephonyService.promoteDelegatedCallToConf(e)};TelephonyModule.prototype.makeConference=function(e){return this.telephonyService.makeConference(e)};TelephonyModule.prototype.getConferenceInvitationInfo=function(e){return this.telephonyService.getConferenceInvitationInfo(e)};TelephonyModule.prototype.pickUpParkLocation=function(e){return this.telephonyService.pickUpParkLocation(e)};TelephonyModule.prototype.buildFederationNumber=function(e,t){return p.t.buildFederationNumber(e,t)};TelephonyModule.prototype.getRecentParkedSessionIds=function(){return this.telephonyService.getRecentParkedSessionIds()};var t;h([E({call:true,error:true}),T("design:type",Function),T("design:paramtypes",[Number,String]),T("design:returntype",void 0)],TelephonyModule.prototype,"park",null);h([E({call:true,error:true}),T("design:type",Function),T("design:paramtypes",[typeof(t=typeof c.PickUpParkedCallParams!=="undefined"&&c.PickUpParkedCallParams)==="function"?t:Object]),T("design:returntype",void 0)],TelephonyModule.prototype,"pickUpParkLocation",null);return TelephonyModule}(o.AbstractModule)},724773:(e,t,n)=>{"use strict";n.d(t,{h:()=>l});var o=n(667489);var r=n.n(o);var i=n(936274);var a=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var l=function(e){a(TelephonyUserConfig,e);function TelephonyUserConfig(){return e.call(this,"telephony")||this}TelephonyUserConfig.prototype.putConfig=function(e,t){this.put(e,t)};TelephonyUserConfig.prototype.getConfig=function(e){return this.get(e)};TelephonyUserConfig.prototype.removeConfig=function(e){this.remove(e)};TelephonyUserConfig.prototype.setLastCalledNumber=function(e){this.put(i.H.LAST_CALLED_NUMBER,e)};TelephonyUserConfig.prototype.getLastCalledNumber=function(){return this.get(i.H.LAST_CALLED_NUMBER)};TelephonyUserConfig.prototype.getTakeOverConfirm=function(){return this.get(i.H.TAKE_OVER_CONFIRM)};TelephonyUserConfig.prototype.setTakeOverConfirm=function(){return this.put(i.H.TAKE_OVER_CONFIRM,true)};TelephonyUserConfig.prototype.getMergeCallConfirm=function(){return this.get(i.H.MERGE_CALL_CONFIRM)};TelephonyUserConfig.prototype.setMergeCallConfirm=function(){return this.put(i.H.MERGE_CALL_CONFIRM,true)};return TelephonyUserConfig}(o.UserConfig)},936274:(e,t,n)=>{"use strict";n.d(t,{H:()=>o,S:()=>r});var o={LAST_CALLED_NUMBER:"last_called_number",TAKE_OVER_CONFIRM:"take_over_confirm",MERGE_CALL_CONFIRM:"merge_call_confirm"};var r={CURRENT_MICROPHONE:"current_microphone",CURRENT_SPEAKER:"current_speaker",CURRENT_RINGER:"current_ringer",USED_MICROPHONE_HISTORY:"used_microphone_history",USED_SPEAKER_HISTORY:"used_speaker_history",USED_RINGER_HISTORY:"used_ringer_history",CURRENT_VOLUME:"current_volume",AUTO_FOCUS_ON_INCOMING_CALL:"auto_focus_on_incoming_call",NOT_AUTO_FOCUS_ON_INCOMING_CALL_MINIMIZED:"not_auto_focus_on_incoming_call_minimized",USE_STANDALONE_CALL_WINDOW:"use_standalone_call_window",KEEP_CALL_WINDOW_IN_FRONT:"keep_call_window_in_front",LAUNCH_APP_PATH:"launch_app_path",Launch_External_App:"launch_external_app"}},446875:(e,t,n)=>{"use strict";n.d(t,{MI:()=>l});var o=n(936274);var r=n(667489);var i=n(424567);var a=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var l=function(e){a(TelephonyGlobalConfig,e);function TelephonyGlobalConfig(){return e!==null&&e.apply(this,arguments)||this}TelephonyGlobalConfig.setCurrentMicrophone=function(e){this.put(o.S.CURRENT_MICROPHONE,e)};TelephonyGlobalConfig.getCurrentMicrophone=function(){return this.get(o.S.CURRENT_MICROPHONE)};TelephonyGlobalConfig.setCurrentSpeaker=function(e){this.put(o.S.CURRENT_SPEAKER,e)};TelephonyGlobalConfig.getCurrentSpeaker=function(){return this.get(o.S.CURRENT_SPEAKER)};TelephonyGlobalConfig.setCurrentRinger=function(e){this.put(o.S.CURRENT_RINGER,e)};TelephonyGlobalConfig.getCurrentRinger=function(){return this.get(o.S.CURRENT_RINGER)};TelephonyGlobalConfig.setCurrentVolume=function(e){this.put(o.S.CURRENT_VOLUME,e)};TelephonyGlobalConfig.getCurrentVolume=function(){return this.get(o.S.CURRENT_VOLUME)};TelephonyGlobalConfig.setUsedMicrophoneHistory=function(e){this.put(o.S.USED_MICROPHONE_HISTORY,e)};TelephonyGlobalConfig.getUsedMicrophoneHistory=function(){return this.get(o.S.USED_MICROPHONE_HISTORY)};TelephonyGlobalConfig.setUsedSpeakerHistory=function(e){this.put(o.S.USED_SPEAKER_HISTORY,e)};TelephonyGlobalConfig.getUsedSpeakerHistory=function(){return this.get(o.S.USED_SPEAKER_HISTORY)};TelephonyGlobalConfig.setUsedRingerHistory=function(e){this.put(o.S.USED_RINGER_HISTORY,e)};TelephonyGlobalConfig.getUsedRingerHistory=function(){return this.get(o.S.USED_RINGER_HISTORY)};TelephonyGlobalConfig.setLaunchAppPath=function(e){TelephonyGlobalConfig._checkRCExtensionId();this.put(o.S.LAUNCH_APP_PATH+"."+TelephonyGlobalConfig._rcExtensionIdGetter(),e)};TelephonyGlobalConfig.getLaunchAppPath=function(){var e;TelephonyGlobalConfig._checkRCExtensionId();return(e=this.get(o.S.LAUNCH_APP_PATH+"."+TelephonyGlobalConfig._rcExtensionIdGetter()))!==null&&e!==void 0?e:""};TelephonyGlobalConfig.setRCExtensionIdGetter=function(e){this._rcExtensionIdGetter=e};TelephonyGlobalConfig.getAutoFocusOnInComingCall=function(){var e;TelephonyGlobalConfig._checkRCExtensionId();return(e=this.get(o.S.AUTO_FOCUS_ON_INCOMING_CALL+"."+TelephonyGlobalConfig._rcExtensionIdGetter()))!==null&&e!==void 0?e:true};TelephonyGlobalConfig.setAutoFocusOnInComingCall=function(e){TelephonyGlobalConfig._checkRCExtensionId();this.put(o.S.AUTO_FOCUS_ON_INCOMING_CALL+"."+TelephonyGlobalConfig._rcExtensionIdGetter(),e)};TelephonyGlobalConfig.getNotAutoFocusOnInComingCallMinimized=function(){var e;TelephonyGlobalConfig._checkRCExtensionId();return(e=this.get(o.S.NOT_AUTO_FOCUS_ON_INCOMING_CALL_MINIMIZED+"."+TelephonyGlobalConfig._rcExtensionIdGetter()))!==null&&e!==void 0?e:false};TelephonyGlobalConfig.setNotAutoFocusOnInComingCallMinimized=function(e){TelephonyGlobalConfig._checkRCExtensionId();this.put(o.S.NOT_AUTO_FOCUS_ON_INCOMING_CALL_MINIMIZED+"."+TelephonyGlobalConfig._rcExtensionIdGetter(),e)};TelephonyGlobalConfig.getUseStandaloneCallWindow=function(){var e;TelephonyGlobalConfig._checkRCExtensionId();return(e=this.get(o.S.USE_STANDALONE_CALL_WINDOW+"."+TelephonyGlobalConfig._rcExtensionIdGetter()))!==null&&e!==void 0?e:true};TelephonyGlobalConfig.setUseStandaloneCallWindow=function(e){TelephonyGlobalConfig._checkRCExtensionId();this.put(o.S.USE_STANDALONE_CALL_WINDOW+"."+TelephonyGlobalConfig._rcExtensionIdGetter(),e)};TelephonyGlobalConfig.getKeepCallWindowInFront=function(){var e;TelephonyGlobalConfig._checkRCExtensionId();return(e=this.get(o.S.KEEP_CALL_WINDOW_IN_FRONT+"."+TelephonyGlobalConfig._rcExtensionIdGetter()))!==null&&e!==void 0?e:false};TelephonyGlobalConfig.setKeepCallWindowInFront=function(e){TelephonyGlobalConfig._checkRCExtensionId();this.put(o.S.KEEP_CALL_WINDOW_IN_FRONT+"."+TelephonyGlobalConfig._rcExtensionIdGetter(),e)};TelephonyGlobalConfig.getLaunchExternalApp=function(){var e;TelephonyGlobalConfig._checkRCExtensionId();return(e=this.get(o.S.Launch_External_App+"."+TelephonyGlobalConfig._rcExtensionIdGetter()))!==null&&e!==void 0?e:false};TelephonyGlobalConfig.setLaunchExternalApp=function(e){TelephonyGlobalConfig._checkRCExtensionId();this.put(o.S.Launch_External_App+"."+TelephonyGlobalConfig._rcExtensionIdGetter(),e)};TelephonyGlobalConfig._checkRCExtensionId=function(){if(!TelephonyGlobalConfig._rcExtensionIdGetter){throw new r.JSdkError("","can not set emergency address before rc extension id is ready")}};TelephonyGlobalConfig.moduleName=i.Li;return TelephonyGlobalConfig}(r.GlobalConfig);var s=n(724773)},147877:(e,t,n)=>{"use strict";n.d(t,{oF:()=>l,TM:()=>s,FY:()=>c,Gg:()=>isOnline,K5:()=>_,VM:()=>p,cG:()=>f,mf:()=>d,G1:()=>h,iy:()=>T,gE:()=>R,Gw:()=>g,ag:()=>v,wA:()=>y,iN:()=>A,ug:()=>E,qK:()=>m,CR:()=>I,rG:()=>S,M_:()=>N,Lj:()=>O,UA:()=>b,Wt:()=>L,tw:()=>D,St:()=>P,w2:()=>w,hN:()=>F,oy:()=>k,my:()=>U,FN:()=>G,z:()=>V,V$:()=>H});var o=n(302186);var r=n.n(o);var i=n(801348);var a=n(295454);var l=a.Lb.TELEPHONY;var s="ASK_FOR_CALL_QUALITY_FEEDBACK";var c={ENTITY:{MULTI_PARTY_CONF_CALL_STATE:"ENTITY.MULTI_PARTY_CONF_CALL_STATE"},VOIP_CALLING:l+".VOIP_CALLING",CALL_SWITCH:l+".CALL_SWITCH",CALL_GROUP_CHANGED:"CALL_GROUP_CHANGED",REGISTRATION_LIMIT_EXCEEDED:"REGISTRATION_LIMIT_EXCEEDED",CALL_ACTION_ERROR:"CALL_ACTION_ERROR",RC_NOTIFICATION_INCOMING_CALL:"RC_NOTIFICATION_INCOMING_CALL",RTC_ACCOUNT_REGISTERED:"RTC_ACCOUNT_REGISTERED",MAKE_DYNAMIC_CONFERENCE_CALL:"MAKE_DYNAMIC_CONFERENCE_CALL"};var u=Symbol(l);var isOnline=function(){return o.Pal.instance.networkStatus().getStatus()};var p;(function(e){e["MERGE_CALL_ERROR"]="MERGE_CALL_ERROR";e["ADD_PARTIES_ERROR"]="ADD_PARTIES_ERROR";e["ADD_PEOPLE_TO_CONFERENCE_MISSING_CALL_ERROR"]="ADD_PEOPLE_TO_CONFERENCE_MISSING_CALL_ERROR"})(p||(p={}));var _;(function(e){e["MERGE_SUCCESS"]="MERGE_SUCCESS"})(_||(_={}));var C={EMERGENCY_RESPONSE_LOCATION:"EMERGENCY_RESPONSE_LOCATION"};var f=9;var d=100;var h="MULTIPLE_CALL_ACTION_ERROR";var T;(function(e){e["MAKE_CALL"]="MAKE_CALL";e["HOLD"]="HOLD";e["UNHOLD"]="UNHOLD";e["ANSWER"]="ANSWER"})(T||(T={}));var R=["SPR-101","SPR-102","SPR-114","SPR-118"];var g={SET_WEB_RTC_IP_HANDLING_POLICY:"SET_WEB_RTC_IP_HANDLING_POLICY"};var E=30;var v=-8;var y="*0";var A="*80*";var m="*83";var I;(function(e){e["DISTORTED_SPEECH"]="Distorted speech";e["AUDIO_CUTS"]="Audio cuts in and out";e["CALL_DROPPED"]="Call dropped";e["ONE_WAY_AUDIO"]="One-way audio";e["ECHO"]="Echo";e["BACKGROUND_NOISES"]="Background noises";e["NOTICEABLE_AUDIO_DELAY"]="Noticeable audio delay";e["OTHER"]="Other"})(I||(I={}));var S=[I.AUDIO_CUTS,I.BACKGROUND_NOISES,I.CALL_DROPPED,I.DISTORTED_SPEECH,I.ECHO,I.NOTICEABLE_AUDIO_DELAY,I.ONE_WAY_AUDIO];var N="call-quality-feedback";var O="SpMlbxId_";var b=30*1e3;var L="+";var D="prk";var P="blf";var M=4;var w;(function(e){e["GCP"]="gcp";e["QCP"]="qpk"})(w||(w={}));var F=[i.QUEUE_CALL_DISPLAY_TYPE.PHONE_NUMBER,i.QUEUE_CALL_DISPLAY_TYPE.CALLER_ID_NUMBER];var k;(function(e){e["PREFIX"]="ERROR_P_TELEPHONY";e["MERGE"]="MERGE";e["MAKE_CALL"]="MAKE_CALL";e["UNHOLD"]="UNHOLD";e["HANDLE_NOTIFICATION_CALL"]="HANDLE_NOTIFICATION_CALL";e["MONITOR_BLF_CALL"]="MONITOR_BLF_CALL";e["CALL_ON_BEHALF_OF"]="CALL_ON_BEHALF_OF";e["PROMOTE_DELEGATED_CALL_TO_CONF"]="PROMOTE_DELEGATED_CALL_TO_CONF";e["PROMOTE_TO_VIDEO"]="PROMOTE_TO_VIDEO";e["PICK_UP"]="PICK_UP"})(k||(k={}));var U=["replaceName","replaceNumber","accessCode","pstnPassword","fromNumber","fromName","toName"];var G=["from","fromName","to","toName","onBehalfOf","sourceExtension","pickupTarget"];var H=["displayName","destinationNumber"];var V;(function(e){e["MAKE_CALL"]="PERFORMANCE_P_TELEPHONY_MAKE_CALL"})(V||(V={}))},422125:(e,t,n)=>{"use strict";n.d(t,{k:()=>l});var o=n(862926);var r=n.n(o);var i=n(827027);var a="[TELEPHONY][CORE]";var l=o.ModuleLogger.getLogger(a,(function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}return e}),i.PHONE_EVENT_DATA_FEATURE_KEY)},649002:(e,t,n)=>{"use strict";n.d(t,{B:()=>Ke});var o=n(667489);var r=n(587040);var i=n(266800);var a=n(302186);var l=n(379269);var s=n(38942);var c=n(424567);var u=n(343398);var p=n(422125);var _=n(147877);var C=n(298784);var f=n.n(C);var d=n(862926);var h=n(827027);var T=n(960782);var R=n(187933);var g=n(228164);var E=n(801348);var v=n(439126);var y=undefined&&undefined.__assign||function(){y=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++){t=arguments[n];for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r))e[r]=t[r]}return e};return y.apply(this,arguments)};var A=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var m=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var I=undefined&&undefined.__values||function(e){var t=typeof Symbol==="function"&&Symbol.iterator,n=t&&e[t],o=0;if(n)return n.call(e);if(e&&typeof e.length==="number")return{next:function(){if(e&&o>=e.length)e=void 0;return{value:e&&e[o++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};var S=30;var N="[CallSwitchController]";var O=p.k.tags(N);var b=[h.TELEPHONY_STATUS.CallConnected,h.TELEPHONY_STATUS.Ringing,h.TELEPHONY_STATUS.OnHold,h.TELEPHONY_STATUS.ParkedCall];var L=5*1e3;var D=5*1e3;var P=function(){function UpdateSwitchCallProcessor(e,t){this._name=e;this._processFunc=t}UpdateSwitchCallProcessor.prototype.process=function(){return A(this,void 0,Promise,(function(){var e;return m(this,(function(t){switch(t.label){case 0:t.trys.push([0,2,,3]);return[4,this._processFunc()];case 1:t.sent();return[3,3];case 2:e=t.sent();O.warn("failed to execute UpdateSwitchCallProcessor, "+this._name,e);return[3,3];case 3:return[2,Promise.resolve(true)]}}))}))};UpdateSwitchCallProcessor.prototype.name=function(){return this._name};return UpdateSwitchCallProcessor}();var M=function(){function CallSwitchController(e){var t=this;this._telephonyAccountController=e;this._isSubscribe=false;this._sessionToSequence=[];this._endedCalls=[];this._currentActiveCalls=[];this._lastBannerIsShown=false;this._hiddenCallList=[];this._updateSwitchCallQueue=new o.SequenceProcessorHandler({name:N,addProcessorStrategy:function(e,t,n){return[t]}});this._checkSubscription=function(){return A(t,void 0,void 0,(function(){var e;return m(this,(function(t){switch(t.label){case 0:return[4,this._canUseCallSwitch()];case 1:e=t.sent();if(!this._isSubscribe&&e){this._listenSwitchCall()}else if(this._isSubscribe&&!e){this._stopListenSwitchCall()}O.log("_checkSubscription",{canUseCallSwitch:e,_isSubscribe:this._isSubscribe});return[2]}}))}))};this._handleTelephonyPresenceNotification=function(e){O.log("_handleTelephonyPresenceNotification",{payload:e});var n=(0,r.gT)().userConfig.getExtensionId();if(e.extensionId!==n){return}if(!e.sequence){O.log("no sequence data");return}var o=e.sequence;t._handleActiveCallsInPresence(e.activeCalls,o,true)};this._handleRCNotificationReady=function(e){return A(t,void 0,void 0,(function(){return m(this,(function(t){switch(t.label){case 0:if(!(this._lastBannerIsShown&&e.includes(g.RCSubscriptionKeys.TelephonyDetail)))return[3,2];O.log("sync user rc presence when rc subscription connected");return[4,this._syncLatestUserPresenceDebounce()];case 1:t.sent();t.label=2;case 2:return[2]}}))}))};this._handleCallStateChanged=function(e){if(e.type===o.EVENT_TYPES.UPDATE){var n=Array.from(e.body.entities.values());var r=false;n.forEach((function(e){if(t._isValidEndedCall(e)){t._onCallEnded(e);r=true}}));if(r){t._updateBannerStatus();t._syncLatestPresenceWhenHasBanner()}}};this._syncLatestPresenceWhenHasBanner=f().debounce((function(){return A(t,void 0,void 0,(function(){return m(this,(function(e){switch(e.label){case 0:if(!this._lastBannerIsShown)return[3,2];O.log("sync user rc presence after call ended + 5s when has banner");return[4,this._syncLatestUserPresence()];case 1:e.sent();e.label=2;case 2:return[2]}}))}))}),L);this._clearAndSyncRCPresence=function(){if(t._lastBannerIsShown){t._currentActiveCalls=[];t._updateBannerStatus()}a.Pal.instance.networkStatus().getStatus()&&t._syncLatestUserPresenceDebounce()};this._syncLatestUserPresenceDebounce=f().debounce((function(){return A(t,void 0,void 0,(function(){return m(this,(function(e){switch(e.label){case 0:return[4,this._syncLatestUserPresence()];case 1:e.sent();return[2]}}))}))}),D);this._syncLatestUserPresence=function(){return A(t,void 0,void 0,(function(){var e;var t;return m(this,(function(n){switch(n.label){case 0:return[4,(t=this._getRCInfoModule())===null||t===void 0?void 0:t.requestLatestPresence().catch((function(e){O.log("silent sync rc presence is done with error",e);return undefined}))];case 1:e=n.sent();if(e){this._handleActiveCallsInPresence(e.activeCalls,0,false)}return[2]}}))}))}}CallSwitchController.prototype._getRCInfoModule=function(){return(0,o.getModule)(l.oF)};CallSwitchController.prototype.start=function(){var e;return A(this,void 0,void 0,(function(){return m(this,(function(t){switch(t.label){case 0:O.log("controller start");o.notificationCenter.on(_.FY.VOIP_CALLING,this._checkSubscription);(e=this._getRCInfoModule())===null||e===void 0?void 0:e.DBConfig.on(l.Uz.EXTENSION_INFO,this._checkSubscription);o.notificationCenter.on(E.FY.ENTITY.CALL,this._handleCallStateChanged);o.notificationCenter.on(o.WINDOW_EVENT.WAKE_UP_FROM_SLEEP,this._clearAndSyncRCPresence);o.notificationCenter.on(g.RC_NOTIFICATION.EVENT_KEYS.RC_NOTIFICATION_READY,this._handleRCNotificationReady);o.notificationCenter.on(o.WINDOW_EVENT.ONLINE,this._clearAndSyncRCPresence);this._subscribeNoCallPresenceChange(this._syncLatestPresenceWhenHasBanner);return[4,this._checkSubscription()];case 1:t.sent();return[2]}}))}))};CallSwitchController.prototype.stop=function(){O.log("controller stop");this._stopListenSwitchCall()};CallSwitchController.prototype._subscribeNoCallPresenceChange=function(e){return A(this,void 0,void 0,(function(){var t,n,r,i;return m(this,(function(a){switch(a.label){case 0:t=(0,o.getModule)(T.COMMON_KEY_ACTION_MODULE).getKeyActionService().get(T.ACTION_KEY.SUBSCRIBE_NO_CALL_PRESENCE_CHANGE);r=t===null||t===void 0?void 0:t.getAction;if(!r)return[3,2];return[4,t.getAction()];case 1:r=a.sent();a.label=2;case 2:n=r;i=n;if(!i)return[3,4];return[4,n(e)];case 3:i=a.sent();a.label=4;case 4:return[2,i]}}))}))};CallSwitchController.prototype._listenSwitchCall=function(){this._isSubscribe=true;this._rcNotificationModule.subscribe(g.RCSubscriptionKeys.TelephonyDetail,this._handleTelephonyPresenceNotification)};CallSwitchController.prototype._stopListenSwitchCall=function(){this._isSubscribe=false;this._rcNotificationModule.unsubscribe(g.RCSubscriptionKeys.TelephonyDetail,this._handleTelephonyPresenceNotification)};CallSwitchController.prototype._handleActiveCallsInPresence=function(e,t,n){O.log("--- START --- _handleActiveCallsInPresence",{activeCalls:this._sensitiveCall(e),sequence:t,isFromPush:n});if(e&&e.length){this._handleActiveCalls(e,t,n)}else{this._handleNoActiveCallPayload(t,n)}this._updateBannerStatus();O.log("--- END --- handleTelephonyPresence")};CallSwitchController.prototype._handleNoActiveCallPayload=function(e,t){var n,o;var r=!t;O.log("_handleNoActiveCallPayload",{isFromPush:t,payLoadSequence:e});if(!r){var i=0;try{for(var a=I(this._sessionToSequence),l=a.next();!l.done;l=a.next()){var s=l.value;i=Math.max(s.sequence,i)}}catch(e){n={error:e}}finally{try{if(l&&!l.done&&(o=a.return))o.call(a)}finally{if(n)throw n.error}}r=e>i;O.log("local max sequence may smaller then incoming one",{localMaxSequence:i,payLoadSequence:e})}if(r){this._currentActiveCalls=[]}};CallSwitchController.prototype._handleActiveCalls=function(e,t,n){var o,r;var i=[];var a=[];var l=0;var _loop_1=function(e){var o=e.sessionId||"";var r=s._sessionToSequence.find((function(e){return e.sessionId===o}));var c=r&&r.sequence||0;var u=n?t:c;var p=y(y({},e),{sequence:u});if(u>=c){s._cacheSession(o,u);if(s._isCallDataValid(p)&&!s._isCallEndedBefore(p)){O.log("_handleActiveCalls - add valid active call",{call:s._sensitiveCall(p)});i.push(p)}else{O.log("_handleActiveCalls - add invalid call with larger sequence",{call:s._sensitiveCall(p)});a.push(p)}}else{O.log("_handleActiveCalls - add invalid call",{call:s._sensitiveCall(p)});a.push(p)}l=Math.max(l,u)};var s=this;try{for(var c=I(e),u=c.next();!u.done;u=c.next()){var p=u.value;_loop_1(p)}}catch(e){o={error:e}}finally{try{if(u&&!u.done&&(r=c.return))r.call(c)}finally{if(o)throw o.error}}if(i.length){O.log("_handleActiveCalls - new active call list",{tempValidCallList:this._sensitiveCall(i)});this._currentActiveCalls=i}else if(a.length&&this._currentActiveCalls.length){this._currentActiveCalls=this._currentActiveCalls.filter((function(e){return e.sequence>l}));O.log("_handleActiveCalls - filter active call by sequence ",{tempValidCallList:this._sensitiveCall(i)})}else{O.log("_handleActiveCalls clear all call");this._currentActiveCalls=[]}};CallSwitchController.prototype._cacheSession=function(e,t){this._sessionToSequence=this._sessionToSequence.filter((function(t){return t.sessionId!==e}));this._sessionToSequence.push({sessionId:e,sequence:t});if(this._sessionToSequence.length>S){this._sessionToSequence=f().tail(this._sessionToSequence)}};CallSwitchController.prototype._isCallDataValid=function(e){var t=false;var _loop_2=function(){if(!e.id||!e.sessionId||!e.telephonyStatus||!e.direction){O.log("!!INVALID: incomplete call data",{call:n._sensitiveCall(e)});return"break"}var o=e.sipData;if(!o||!o.fromTag||!o.toTag){O.log("!!INVALID: incomplete call sip data",{call:n._sensitiveCall(e)});return"break"}var r=e.telephonyStatus;var i=e.direction===h.CALL_DIRECTION.INBOUND&&r===h.TELEPHONY_STATUS.Ringing;if(i){O.log("!!INVALID: ringing inbound call",{call:n._sensitiveCall(e)});return"break"}if(e.direction===h.CALL_DIRECTION.OUTBOUND&&r===h.TELEPHONY_STATUS.Ringing&&o.toTag===_.St){O.log("!!INVALID: ringing ring-out outbound call",{call:n._sensitiveCall(e)});return"break"}if(!b.some((function(e){return e===r}))){O.log("!!INVALID: invalid telephony status",{call:n._sensitiveCall(e)});return"break"}t=true};var n=this;do{var o=_loop_2();if(o==="break")break}while(this._falseCondition());return t};CallSwitchController.prototype._isCallEndedBefore=function(e){return this._endedCalls.some((function(t){return h.CallUtils.isSameCall(h.CallUtils.activeCall2UniqueCallInfo(e),t)}))};CallSwitchController.prototype._falseCondition=function(){return false};CallSwitchController.prototype._shouldShowSwitchCall=function(){return A(this,void 0,void 0,(function(){var e;return m(this,(function(t){switch(t.label){case 0:if(this._currentActiveCalls.length>1){O.info("_shouldShowBanner - over size active call");return[2,false]}if(this._telephonyAccountController.getCallCount()>0){O.info("_shouldShowBanner - has active call in Jupiter");return[2,false]}e=f().first(this._currentActiveCalls);if(e&&this._isInHiddenCallList(e)){O.info("_shouldShowBanner - has active call in Jupiter");return[2,false]}return[4,this._canUseCallSwitch()];case 1:if(!t.sent()){O.info("_shouldShowBanner - can not use call switch");return[2,false]}return[2,true]}}))}))};CallSwitchController.prototype._isInHiddenCallList=function(e){return this._hiddenCallList.some((function(t){return h.CallUtils.isSameCall(h.CallUtils.activeCall2UniqueCallInfo(e),h.CallUtils.activeCall2UniqueCallInfo(t))}))};CallSwitchController.prototype._canUseCallSwitch=function(){var e,t,n;return A(this,void 0,void 0,(function(){var i,a,s,c,u;return m(this,(function(p){switch(p.label){case 0:if(!(0,r.gT)().isLoggedIn()){return[2,false]}return[4,(e=this._getRCInfoModule())===null||e===void 0?void 0:e.isVoipCallingAvailable()];case 1:i=p.sent();if(!i){O.info("_canUseCallSwitch - no voip permission");return[2,false]}return[4,(t=this._getRCInfoModule())===null||t===void 0?void 0:t.isRCFeaturePermissionEnabled(l.D9.CALL_SWITCH)];case 2:a=p.sent();if(!a){O.info("_canUseCallSwitch - call switch permission");return[2,false]}return[4,(n=this._getRCInfoModule())===null||n===void 0?void 0:n.isRCFeaturePermissionEnabled(l.D9.WEB_PHONE)];case 3:s=p.sent();if(!s){O.info("_canUseCallSwitch - web phone permission");return[2,false]}c=(0,o.getModule)(R.oF);return[4,c.getById(v.O0.Phone_DefaultApp).catch((function(e){O.log("getPhoneDefaultApp failed.",{error:e})}))];case 4:u=p.sent();if(u&&u.value===v.hr.RINGCENTRAL){O.info("_canUseCallSwitch - do not use glip phone");return[2,false]}return[2,true]}}))}))};CallSwitchController.prototype._updateBannerStatus=function(){var e=this;var t=new P(Date.now().toString(),(function(){return A(e,void 0,void 0,(function(){var e;return m(this,(function(t){switch(t.label){case 0:return[4,this.getSwitchCall()];case 1:e=!!t.sent();O.log("notify call switch status, hasCall: ",{hasCall:e,_currentActiveCalls:this._sensitiveCall(this._currentActiveCalls)});if(this._lastBannerIsShown!==e){this._lastBannerIsShown=e;o.notificationCenter.emit(_.FY.CALL_SWITCH,e)}return[2]}}))}))}));this._updateSwitchCallQueue.addProcessor(t)};CallSwitchController.prototype.getSwitchCall=function(){return A(this,void 0,void 0,(function(){var e,t;return m(this,(function(n){switch(n.label){case 0:return[4,this._shouldShowSwitchCall()];case 1:t=n.sent();if(t){e=f().first(this._currentActiveCalls)}return[2,e]}}))}))};CallSwitchController.prototype.hideSwitchCall=function(){return A(this,void 0,void 0,(function(){var e;return m(this,(function(t){switch(t.label){case 0:return[4,this.getSwitchCall()];case 1:e=t.sent();O.log("hideSwitchCall",this._sensitiveCall(e));if(e){this._hiddenCallList.push(e);this._updateBannerStatus()}return[2]}}))}))};CallSwitchController.prototype._recordEndedCalls=function(e){var t=this._endedCalls.some((function(t){return t.id===e.id}));if(t){return}O.log("_recordEndedCalls, receive new ended call",e);this._endedCalls.push(e);if(this._endedCalls.length>S){this._endedCalls=f().tail(this._endedCalls)}};CallSwitchController.prototype._onCallEnded=function(e){O.log("onCallEnded, call is",(0,d.sensitive)(e,["to_num","from_num","to_name","from_name"]));var t={id:e.id,callId:e.call_id,fromTag:e.from_tag,toTag:e.to_tag};this._removeExistCallByCallData(t);this._recordEndedCalls(t)};CallSwitchController.prototype._isValidEndedCall=function(e){return!!(e&&e.call_state===E.CALL_STATE.DISCONNECTING&&e.call_id&&e.from_tag&&e.to_tag)};CallSwitchController.prototype._removeExistCallByCallData=function(e){if(this._currentActiveCalls.length){this._currentActiveCalls=this._currentActiveCalls.filter((function(t){h.CallUtils.isSameCall(h.CallUtils.activeCall2UniqueCallInfo(t),e)}))}};Object.defineProperty(CallSwitchController.prototype,"_rcNotificationModule",{get:function(){return(0,o.getModule)(g.MODULE_NAME)},enumerable:true,configurable:true});CallSwitchController.prototype._sensitiveCall=function(e){return(0,d.sensitive)(e,["from","fromName","to","toName"])};return CallSwitchController}();var w=undefined&&undefined.__read||function(e,t){var n=typeof Symbol==="function"&&e[Symbol.iterator];if(!n)return e;var o=n.call(e),r,i=[],a;try{while((t===void 0||t-- >0)&&!(r=o.next()).done)i.push(r.value)}catch(e){a={error:e}}finally{try{if(r&&!r.done&&(n=o["return"]))n.call(o)}finally{if(a)throw a.error}}return i};var F=undefined&&undefined.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(w(arguments[t]));return e};var k=d.ModuleLogger.getLogger("[TELEPHONY][VOIP]",(function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}return e}),h.PHONE_EVENT_DATA_FEATURE_KEY);var U=function(){function TelephonyLogController(e){this._telephonyEventLogController=e}TelephonyLogController.prototype.doLog=function(e,t){switch(e){case u.LOG_LEVEL.DEBUG:k.debug(t);break;case u.LOG_LEVEL.ERROR:k.error(t);break;case u.LOG_LEVEL.FATAL:k.fatal(t);break;case u.LOG_LEVEL.INFO:k.info(t);break;case u.LOG_LEVEL.TRACE:k.trace(t);break;case u.LOG_LEVEL.WARN:k.warn(t);break;default:k.info(t);break}};TelephonyLogController.prototype.report=function(){var e=[];for(var t=0;t<arguments.length;t++){e[t]=arguments[t]}k.report.apply(k,F(e))};TelephonyLogController.prototype.reportEvent=function(e){k.info(e);this._telephonyEventLogController.reportEvent(e)};return TelephonyLogController}();var G=n(615477);var H=n(166418);var V=n(831270);var B=n(274251);var x=n(470033);var W=n(696206);var j=n(642107);var Y=function(){function ToggleController(){this._isDoing=false;this._requests=[]}ToggleController.prototype.do=function(e){if(this._isDoing){var t=0;this._requests.push(e);this._requests.forEach((function(e){if(e.value){t+=1}else{t-=1}}));if(t===0){this._clearRequests()}}else{this._isDoing=true;e.func()}};ToggleController.prototype.onSuccess=function(){if(this._requests.length){var e=this._requests.splice(0,1)[0];e.func()}else{this._isDoing=false}};ToggleController.prototype.onFailure=function(){this._isDoing=false;if(this._requests.length){this._clearRequests()}};ToggleController.prototype._clearRequests=function(){this._requests.splice(0,this._requests.length).forEach((function(e){return e.onSkip()}))};return ToggleController}();var q=n(226417);var K=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var Q=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var J=p.k.tags("MonitorCallActionProcess");var X=function(){function MonitorCallActionProcess(e,t){this._callActionType=e;this._callActionController=t}MonitorCallActionProcess.prototype.process=function(){return K(this,void 0,Promise,(function(){return Q(this,(function(e){try{switch(this._callActionType){case u.RTC_CALL_ACTION.WHISPER:this._whisper();break;case u.RTC_CALL_ACTION.BARGE:this._barge();break;default:break}J.info("monitor call action with success");return[2,true]}catch(e){q.t.doErrorTrackingInCommon(this._callActionType.toUpperCase+"_FAIL",e,[]);J.info("monitor call action with error");return[2,true]}return[2]}))}))};MonitorCallActionProcess.prototype._whisper=function(){this._callActionController.getRTCCall().whisper()};MonitorCallActionProcess.prototype._barge=function(){this._callActionController.getRTCCall().barge()};MonitorCallActionProcess.prototype.name=function(){return"MonitorCallAction_"+Date.now()+"_"+(0,o.randomInt)()};return MonitorCallActionProcess}();var $=undefined&&undefined.__assign||function(){$=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++){t=arguments[n];for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r))e[r]=t[r]}return e};return $.apply(this,arguments)};var z=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var Z=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var ee=n(661586);var te=2e3;var ne=function(){function RTCCallActionController(e){this._options=e;this._callPromotedListeners=[];this._callActionCallbackMap=new Map;this._holdToggle=new Y;this._recordToggle=new Y;this._hasActiveHangUp=false;this._shouldHoldWhenConnected=false;this._callConnectedWaiter=new d.Barrier}RTCCallActionController.prototype.setRTCCall=function(e){return z(this,void 0,void 0,(function(){var t,n,o,r,i,a,l,s,c,p,_,C,f;return Z(this,(function(d){switch(d.label){case 0:t=e.rtcCall,n=e.isSwitchCall,o=e.callOption,r=e.delegatorExtensionId,i=e.confInfo,a=e.callOwnerExtensionId,l=e.isPickUpCall;s=e.callInfo||t.getCallInfo();t.setCallDelegate(this);this._rtcCall=t;c=this._getCallEntity();if(!c)return[3,4];c.uuid=s.uuid;c.connectingTime=Date.now();if(!this._isQueueCall)return[3,3];c.queueCallInfo=s.queueCallInfo;c.isQueueCall=this._isQueueCall;p=this._convertToQueueCallDisplayType(c.queueCallInfo.displayInfo);_=this._convertToQueueCallDisplayType(c.queueCallInfo.displayInfoSub);f={callerId:c.queueCallInfo.callerId,displayInfo:p,displayInfoSub:_};return[4,this._formatDisplayValue(p,c.queueCallInfo.displayInfoValue)];case 1:f.displayInfoValue=d.sent();return[4,this._formatDisplayValue(_,c.queueCallInfo.displayInfoValueSub)];case 2:C=(f.displayInfoValueSub=d.sent(),f);c.queueCallInfo=C;c.isQueueCall=this._isQueueCall;this.logger().info("call queue info",{queueCallInfo:C});d.label=3;case 3:if(n&&o){this._setSwitchCallInfo(c,o)}else if(!c.is_blf_call){c.to_num=this._options.mainNumber||s.toNum;c.to_name=s.toName;c.from_num=s.fromNum;c.from_name=s.fromName;t.isIncomingCall()&&(c.direction=h.CALL_DIRECTION.INBOUND)}c.is_multiparty_conf=t.isMultiPartyConf();c.is_rc_conf=!!t.isRccConf();if(e.blfInfo){c.blfInfo=$($({},c.blfInfo),e.blfInfo);c.is_blf_call=true}if(r){c.delegator_extension_id=r}if(i){c.conf_info=$($({},c.conf_info),i)}if(a){c.call_owner_extension_id=a}c.is_pick_up_call=l;if(t.getCallState()===u.RTC_CALL_STATE.CONNECTED){this.logger().debug("setRTCCall, call is already been connected");this._handleCallConnectedState(c)}else{this.logger().info("setRTCCall, new call entity setted",c);this._updateCallAndNotify(c)}d.label=4;case 4:return[2]}}))}))};RTCCallActionController.prototype._formatDisplayValue=function(e,t){return z(this,void 0,Promise,(function(){var n;return Z(this,(function(r){switch(r.label){case 0:if(!e||!t||!_.hN.includes(e)||t.includes(_.Wt)){return[2,t]}return[4,(0,o.getModule)(j.PHONE_PARSER_MODULE).getPhoneParser(t)];case 1:n=r.sent();return[2,!(n===null||n===void 0?void 0:n.isShortNumber())?""+_.Wt+t:t]}}))}))};RTCCallActionController.prototype.reject=function(){return this._rtcCall.reject()};RTCCallActionController.prototype.mute=function(){this._updateCallMuteState(E.MUTE_STATE.MUTED);this._rtcCall.mute()};RTCCallActionController.prototype.muteAll=function(){this._updateCallMuteState(E.MUTE_STATE.MUTED);this._rtcCall.mute(u.RTC_CALL_ACTION_DIRECTION.LOCAL);this._rtcCall.mute(u.RTC_CALL_ACTION_DIRECTION.REMOTE)};RTCCallActionController.prototype.unmute=function(e){if(e===void 0){e=true}e&&this._updateCallMuteState(E.MUTE_STATE.IDLE);this._rtcCall.unmute()};RTCCallActionController.prototype.dtmf=function(e){return this._rtcCall.dtmf(e)};RTCCallActionController.prototype.hangUp=function(){this._hasActiveHangUp=true;this._hangUpInternal()};RTCCallActionController.prototype._passiveHangUp=function(){this._hangUpInternal()};RTCCallActionController.prototype._hangUpInternal=function(){this._handleCallStateChanged(E.CALL_STATE.DISCONNECTING);this._rtcCall.hangup()};RTCCallActionController.prototype.hold=function(){var e=this;if(this._rtcCall.getCallState()===u.RTC_CALL_STATE.CONNECTING){this._shouldHoldWhenConnected=true;this.logger().warn("this call still connecting, will hold when connected",{callState:this._rtcCall.getCallState(),shouldHoldWhenConnected:this._shouldHoldWhenConnected});return}this._updateCallEntity({hold_state:E.HOLD_STATE.HELD,record_state:this._rtcCall.getRecordState()===u.RECORD_STATE.IDLE||this._rtcCall.getRecordState()===u.RECORD_STATE.STOP_RECORD_IN_PROGRESS?E.RECORD_STATE.DISABLED:E.RECORD_STATE.RECORDING_DISABLED});return new Promise((function(t,n){e._saveCallActionCallback(u.RTC_CALL_ACTION.HOLD,t,n);var o={value:true,func:function(){e._rtcCall.hold()},onSkip:function(){return e._onToggleRequestSkipped(u.RTC_CALL_ACTION.HOLD,{resolve:t,reject:n})}};e._holdToggle.do(o)}))};RTCCallActionController.prototype.silentUnhold=function(){var e=this;return new Promise((function(t,n){e._saveCallActionCallback(u.RTC_CALL_ACTION.UNHOLD,t,n);e._rtcCall.unhold()}))};RTCCallActionController.prototype.unhold=function(){var e=this;if(this._rtcCall.getCallState()===u.RTC_CALL_STATE.CONNECTING){this.logger().warn("this call still connecting, will not unhold",{callState:this._rtcCall.getCallState(),shouldHoldWhenConnected:this._shouldHoldWhenConnected});this._shouldHoldWhenConnected=false;return}this._updateCallEntity({hold_state:E.HOLD_STATE.IDLE,record_state:this._rtcCall.getRecordState()===u.RECORD_STATE.IDLE?E.RECORD_STATE.IDLE:E.RECORD_STATE.RECORDING});return new Promise((function(t,n){e._saveCallActionCallback(u.RTC_CALL_ACTION.UNHOLD,t,n);var o={value:false,func:function(){e._rtcCall.unhold()},onSkip:function(){return e._onToggleRequestSkipped(u.RTC_CALL_ACTION.UNHOLD,{resolve:t,reject:n})}};e._holdToggle.do(o)}))};Object.defineProperty(RTCCallActionController.prototype,"_isQueueCall",{get:function(){return this._rtcCall.isQueueCall()},enumerable:true,configurable:true});RTCCallActionController.prototype.getRTCCall=function(){return this._rtcCall};Object.defineProperty(RTCCallActionController.prototype,"isMultiPartyCall",{get:function(){return this._rtcCall.isMultiPartyConf()},enumerable:true,configurable:true});RTCCallActionController.prototype.answer=function(e){this._updateConnectingTime();this._rtcCall.answer(e)};RTCCallActionController.prototype.startReply=function(){this._rtcCall.startReply()};RTCCallActionController.prototype.ignore=function(){this._rtcCall.ignore()};RTCCallActionController.prototype.sendToVoiceMail=function(){this._rtcCall.sendToVoicemail()};RTCCallActionController.prototype.replyWithMessage=function(e){this._rtcCall.replyWithMessage(e)};RTCCallActionController.prototype.replyWithPattern=function(e,t,n){this._rtcCall.replyWithPattern(e,t,n)};RTCCallActionController.prototype.promoteToVideo=function(e){return this._rtcCall.promoteToVideo(e)};RTCCallActionController.prototype.park=function(){var e=this;return new Promise((function(t,n){if(!(0,_.Gg)()){n(i.q$.NOT_NETWORK);return}e._saveCallActionCallback(u.RTC_CALL_ACTION.PARK,t,n);e._rtcCall.park()}))};RTCCallActionController.prototype.parkToLocation=function(e){var t=this;return new Promise((function(n,o){if(!(0,_.Gg)()){o(i.q$.NOT_NETWORK);return}t._saveCallActionCallback(u.RTC_CALL_ACTION.PARK_TO_LOCATION,n,o);t._rtcCall.parkToLocation(e)}))};RTCCallActionController.prototype.flip=function(e){var t=this;return new Promise((function(n,o){t._saveCallActionCallback(u.RTC_CALL_ACTION.FLIP,n,o);t._rtcCall.flip(e)}))};RTCCallActionController.prototype.forward=function(e){var t=this;return new Promise((function(n,o){t._saveCallActionCallback(u.RTC_CALL_ACTION.FORWARD,n,o);t._rtcCall.forward(e)}))};RTCCallActionController.prototype.transfer=function(e,t){var n=this;return new Promise((function(r,a){return z(n,void 0,void 0,(function(){var n,l;return Z(this,(function(s){switch(s.label){case 0:if(!(0,_.Gg)()){a(i.q$.NOT_NETWORK);return[2]}this._saveCallActionCallback(e===i.tP.WARM_TRANSFER?u.RTC_CALL_ACTION.WARM_TRANSFER:u.RTC_CALL_ACTION.TRANSFER,r,a);if(!(e===i.tP.WARM_TRANSFER))return[3,1];this._rtcCall.warmTransfer(t);return[3,3];case 1:n=t;return[4,(0,o.getModule)(j.PHONE_PARSER_MODULE).getPhoneParser(t)];case 2:l=s.sent();l&&(n=l.getE164());if(!n){a(i.q$.INVALID_PHONE_NUMBER)}if(e===i.tP.TO_VOICEMAIL){n=this._handleNumberToVoicemail(n)}this._rtcCall.transfer(n);s.label=3;case 3:return[2]}}))}))}))};RTCCallActionController.prototype._onToggleRequestSkipped=function(e,t){this._consumeActionResults({action:e,callback:t,result:i.q$.NO_ERROR,isSuccess:true})};RTCCallActionController.prototype._handleUnHoldActionOnCallDisconnected=function(){var e=this;var t=this._callActionCallbackMap.get(u.RTC_CALL_ACTION.UNHOLD);if(t===null||t===void 0?void 0:t.length){this.logger().info("resolve unHold action on call disconnected");t.forEach((function(t){e._consumeActionResults({callback:t,isSuccess:true,result:"",action:u.RTC_CALL_ACTION.UNHOLD})}))}};RTCCallActionController.prototype._handleCallActionCallback=function(e,t,n){var o=this;var r=this._callActionCallbackMap.get(e);r===null||r===void 0?void 0:r.forEach((function(r){o._consumeActionResults({callback:r,isSuccess:t,result:n,action:e})}))};RTCCallActionController.prototype._consumeActionResults=function(e){var t=e.isSuccess,n=e.result,o=e.callback,r=e.action;var i=this._callActionCallbackMap.get(r);if(i){i=i.filter((function(e){return e.reject!==o.reject||e.resolve!==o.resolve}));if(i.length){this._callActionCallbackMap.set(r,i)}else{this._callActionCallbackMap.delete(r)}}t?o.resolve(n):o.reject(n)};RTCCallActionController.prototype.startRecord=function(){var e=this;this._updateCallRecordState(E.RECORD_STATE.RECORDING);return new Promise((function(t,n){e._saveCallActionCallback(u.RTC_CALL_ACTION.START_RECORD,t,n);var o={value:true,func:function(){e._rtcCall.startRecord()},onSkip:function(){return e._onToggleRequestSkipped(u.RTC_CALL_ACTION.START_RECORD,{resolve:t,reject:n})}};e._recordToggle.do(o)}))};RTCCallActionController.prototype.stopRecord=function(){var e=this;this._updateCallRecordState(E.RECORD_STATE.IDLE);return new Promise((function(t,n){e._saveCallActionCallback(u.RTC_CALL_ACTION.STOP_RECORD,t,n);var o={value:false,func:function(){e._rtcCall.stopRecord()},onSkip:function(){return e._onToggleRequestSkipped(u.RTC_CALL_ACTION.STOP_RECORD,{resolve:t,reject:n})}};e._recordToggle.do(o)}))};RTCCallActionController.prototype.addCallPromotedToRCVListener=function(e){this._callPromotedListeners.push(e)};RTCCallActionController.prototype.removeCallPromotedToRCVListener=function(e){this._callPromotedListeners=this._callPromotedListeners.filter((function(t){return t!==e}))};RTCCallActionController.prototype.onPromoteToRcv=function(e,t){var n=this;this.logger().info("on promote rcv: "+e+" meeting id: "+t.conferenceMeetingId);t.audioInput=t.audioInput&&ee(t.audioInput);t.audioOutput=t.audioOutput&&ee(t.audioOutput);this._callPromotedListeners.forEach((function(e){return e(n._options.entityId,t)}))};RTCCallActionController.prototype.onReceiveIdentity=function(e,t,n){this.logger().info("on new identity: "+e+" name: "+t+" id: "+n);if(!(0,C.isEmpty)(n)){this._updateCallEntity({from_name:t,from_num:n})}};RTCCallActionController.prototype.onCallStateChange=function(e){this.logger().log("onCallStateChange, new state",e);var t=e;e===u.RTC_CALL_STATE.DISCONNECTED&&this._handleCallStateChanged(E.CALL_STATE.DISCONNECTING);this._handleCallStateChanged(t)};RTCCallActionController.prototype.onCallActionSuccess=function(e,t){this.logger().log("onCallActionSuccess",{callAction:e,options:t});var n=this._handleActionResult(e,true,t);this._handleCallActionCallback(e,true,n)};RTCCallActionController.prototype.onCallActionFailed=function(e,t){this.logger().warn("onCallActionFailed",{callAction:e,code:t});var n=this._handleActionResult(e,false,t);this._handleCallActionCallback(e,false,n);o.notificationCenter.emit(_.FY.CALL_ACTION_ERROR,this._options.entityId,e,t);this._doErrorTrackingOnCallActionFailed(e,t)};RTCCallActionController.prototype.onCallError=function(e){this.logger().warn("OnCallError",{callId:this._rtcCall.getCallInfo().callId,message:e});this._updateAndNotifyCallError(e)};RTCCallActionController.prototype.onVoiceQualityChange=function(e){var t=this._getCallEntity();if(t&&t.my_voice_quality!==e){t.my_voice_quality=e;this._updateCallAndNotify(t);this.logger().info("VoiceQuality changed to:",e)}};RTCCallActionController.prototype.onFirstACRNotification=function(){this.logger().info("onFirstACRNotification");var e=this._getCallEntity();if(!e){return}e.record_state=E.RECORD_STATE.RECORDING;e.is_acr=true;this._updateCallAndNotify(e)};RTCCallActionController.prototype.updateCallHoldState=function(e){var t=this._getCallEntity();if(t){t.hold_state=e;e===E.HOLD_STATE.HELD&&(t.last_hold_time=Date.now());this._updateCallAndNotify(t)}};RTCCallActionController.prototype._updateCallEntity=function(e){var t=this._getCallEntity();if(t){t=$($($({},t),e),{blfInfo:t.blfInfo||e.blfInfo?$($({},t.blfInfo),e.blfInfo):undefined});if(e.hold_state===E.HOLD_STATE.HELD){t.last_hold_time=Date.now()}this._updateCallAndNotify(t)}};RTCCallActionController.prototype._saveCallActionCallback=function(e,t,n){var o=this._callActionCallbackMap.get(e);if(!o){o=[];this._callActionCallbackMap.set(e,o)}o.push({resolve:t,reject:n})};RTCCallActionController.prototype._handleToggleState=function(e,t){var n=null;switch(e){case u.RTC_CALL_ACTION.HOLD:case u.RTC_CALL_ACTION.UNHOLD:n=this._holdToggle;break;case u.RTC_CALL_ACTION.START_RECORD:case u.RTC_CALL_ACTION.STOP_RECORD:n=this._recordToggle;break;default:break}if(n){t?n.onSuccess():n.onFailure()}};RTCCallActionController.prototype._handleParkAction=function(e,t){return t&&e&&typeof t!=="number"&&t.parkExtension?t.parkExtension:""};RTCCallActionController.prototype._transformCallActionErrorCode=function(e){var t=i.q$.OTHERS;switch(e){case u.RTC_CALL_ACTION_ERROR_CODE.INVALID:t=i.q$.INVALID;break;case u.RTC_CALL_ACTION_ERROR_CODE.OTHER_ACTION_IN_PROGRESS:t=i.q$.OTHER_ACTION_IN_PROGRESS;break;case _.ag:t=i.q$.ACR_ON;break;default:break}return t};RTCCallActionController.prototype._handleStopRecordAction=function(e,t){var n=i.q$.NO_ERROR;if(!e){this._updateCallRecordState(E.RECORD_STATE.RECORDING);n=t&&typeof t==="number"?this._transformCallActionErrorCode(t):i.q$.OTHERS}return n};RTCCallActionController.prototype._handleStartRecordAction=function(e,t){var n=i.q$.NO_ERROR;if(!e){this._updateCallRecordState(E.RECORD_STATE.IDLE);n=t&&typeof t==="number"?this._transformCallActionErrorCode(t):i.q$.OTHERS}return n};RTCCallActionController.prototype._handleUnHoldAction=function(e){if(!e){this._updateCallEntity({hold_state:E.HOLD_STATE.HELD,record_state:E.RECORD_STATE.DISABLED})}};RTCCallActionController.prototype._handleHoldAction=function(e){if(!e){this._updateCallEntity({hold_state:E.HOLD_STATE.IDLE,record_state:this._rtcCall.getRecordState()===u.RECORD_STATE.IDLE?E.RECORD_STATE.IDLE:E.RECORD_STATE.RECORDING})}};RTCCallActionController.prototype._handleWhisperAction=function(e){if(e){var t=this._getCallEntity();var n=t===null||t===void 0?void 0:t.blfInfo;if(n){n.monitorState=E.MONITOR_STATE.WHISPER;this._updateCallEntity({blfInfo:n})}}};RTCCallActionController.prototype._handleBargeAction=function(e){if(e){var t=this._getCallEntity();var n=t===null||t===void 0?void 0:t.blfInfo;if(n){n.monitorState=E.MONITOR_STATE.BARGE;this._updateCallEntity({blfInfo:n})}}};RTCCallActionController.prototype._handleTakeOverAction=function(){var e,t,n;var o=this._getCallEntity();var r=o===null||o===void 0?void 0:o.blfInfo;if(r){r.monitorState=E.MONITOR_STATE.TAKE_OVER;var i=void 0;var a=void 0;if(((e=r.monitoredCall)===null||e===void 0?void 0:e.direction)===h.CALL_DIRECTION.INBOUND){i=r.monitoredCall.from;a=r.monitoredCall.fromName}else{i=(t=r.monitoredCall)===null||t===void 0?void 0:t.to;a=(n=r.monitoredCall)===null||n===void 0?void 0:n.toName}this._updateCallEntity({blfInfo:r,direction:h.CALL_DIRECTION.OUTBOUND,to_num:i,to_name:a})}};RTCCallActionController.prototype._handleActionResult=function(e,t,n){var o="";switch(e){case u.RTC_CALL_ACTION.HOLD:this._handleHoldAction(t);break;case u.RTC_CALL_ACTION.UNHOLD:this._handleUnHoldAction(t);break;case u.RTC_CALL_ACTION.START_RECORD:o=this._handleStartRecordAction(t,n);break;case u.RTC_CALL_ACTION.STOP_RECORD:o=this._handleStopRecordAction(t,n);break;case u.RTC_CALL_ACTION.PARK:o=this._handleParkAction(t,n);break;case u.RTC_CALL_ACTION.TRANSFER:case u.RTC_CALL_ACTION.WARM_TRANSFER:o=n;break;case u.RTC_CALL_ACTION.WHISPER:this._handleWhisperAction(t);break;case u.RTC_CALL_ACTION.BARGE:this._handleBargeAction(t);break;case u.RTC_CALL_ACTION.TRANSFER_TO_CONF:o=this._handleTransferToConfAction(t);break;default:break}this._handleToggleState(e,t);return o};RTCCallActionController.prototype.logger=function(){return p.k.tags("[RTCCallActionController]",this._options.entityId.toString())};RTCCallActionController.prototype._handleCallConnectingState=function(e){e.call_state=E.CALL_STATE.CONNECTING;this._updateCallAndNotify(e)};RTCCallActionController.prototype._handleCallDisconnectingState=function(e){if(e.call_state!==E.CALL_STATE.DISCONNECTED&&e.call_state!==E.CALL_STATE.DISCONNECTING){e.call_state=E.CALL_STATE.DISCONNECTING;this._setSipData(e);this._updateCallAndNotify(e)}};RTCCallActionController.prototype._setSipData=function(e){e.call_id=this._getRTCCallInfo().callId||e.call_id;e.from_tag=this._getRTCCallInfo().fromTag||e.from_tag;e.to_tag=this._getRTCCallInfo().toTag||e.to_tag};RTCCallActionController.prototype._getCallEntity=function(){var e=this._options.getCallEntityFn(this._options.entityId);if(!e){this.logger().trace("call entity not exist")}return e&&(0,C.cloneDeep)(e)};RTCCallActionController.prototype._handleCallStateChanged=function(e){var t=this._getCallEntity();if(t){switch(e){case E.CALL_STATE.CONNECTING:this._handleCallConnectingState(t);break;case E.CALL_STATE.CONNECTED:this._handleCallConnectedState(t);break;case E.CALL_STATE.DISCONNECTING:this._handleCallDisconnectingState(t);break;case E.CALL_STATE.DISCONNECTED:this._handleCallDisconnectedState(t);break;default:break}}};RTCCallActionController.prototype._updateConnectingTime=function(){var e=this._getCallEntity();if(e){e.connectingTime=Date.now();this._updateCallAndNotify(e)}};RTCCallActionController.prototype._updateCallRecordState=function(e){var t=this._getCallEntity();if(t){t.record_state=e;this._updateCallAndNotify(t)}};RTCCallActionController.prototype._updateCallMuteState=function(e){var t=this._getCallEntity();if(t){t.mute_state=e;this._updateCallAndNotify(t)}};RTCCallActionController.prototype._updateAndNotifyCallError=function(e){var t=this._getCallEntity();if(t){t.error_message=e;this._updateCallAndNotify(t)}};RTCCallActionController.prototype._setSwitchCallInfo=function(e,t){e.to_num=t.replaceNumber||"";e.to_name=t.replaceName||"";e.direction=h.CALL_DIRECTION.OUTBOUND};RTCCallActionController.prototype._updateCallAndNotify=function(e){E.CallDataUtils.getInstance().upsertCallEntity(e)};RTCCallActionController.prototype._handleNumberToVoicemail=function(e){return""+_.wA+e};RTCCallActionController.prototype._getRTCCallInfo=function(){return this._rtcCall.getCallInfo()};RTCCallActionController.prototype._handleCallConnectedState=function(e){e.call_state=E.CALL_STATE.CONNECTED;e.hold_state=E.HOLD_STATE.IDLE;e.record_state=E.RECORD_STATE.IDLE;e.connectTime=Date.now();e.session_id=this._rtcCall.getCallInfo().sessionId;e.media_optimization_vendor_name=this._rtcCall.getVdiVendorName();e.my_voice_quality=this._rtcCall.getVoiceQuality();this._updateCallAndNotify(e);this._callConnectedWaiter.open();if(this._shouldHoldWhenConnected){this._shouldHoldWhenConnected=false;this.logger().warn("do hold as its connected",{callState:this._rtcCall.getCallState(),shouldHoldWhenConnected:this._shouldHoldWhenConnected});this.hold()}};RTCCallActionController.prototype._handleCallDisconnectedState=function(e){if(this.isMultiPartyCall&&!this._callConnectedWaiter.isOpen()){this._sendMultiConfCallState({key:_.FY.ENTITY.MULTI_PARTY_CONF_CALL_STATE,errorCode:d.RESPONSE_STATUS_CODE.DEFAULT,errorType:_.VM.MERGE_CALL_ERROR})}this._handleUnHoldActionOnCallDisconnected();e.call_state=E.CALL_STATE.DISCONNECTED;if(!e.disconnectTime){e.disconnectTime=Date.now()}this._updateCallAndNotify(e)};RTCCallActionController.prototype._handleTransferToConfAction=function(e){return e?i.q$.NO_ERROR:i.q$.OTHERS};RTCCallActionController.prototype.transferToConf=function(e){var t;return z(this,void 0,Promise,(function(){var n,o;var r=this;return Z(this,(function(i){switch(i.label){case 0:if(!(0,_.Gg)()){return[2,Promise.resolve(d.RESPONSE_STATUS_CODE.NETWORK_ERROR)]}n=((t=this._getCallEntity())===null||t===void 0?void 0:t.hold_state)===E.HOLD_STATE.HELD;o=function(){return z(r,void 0,Promise,(function(){var t=this;return Z(this,(function(o){switch(o.label){case 0:if(!n)return[3,2];this.muteAll();return[4,this.silentUnhold()];case 1:o.sent();o.label=2;case 2:return[2,new Promise((function(n,o){t._saveCallActionCallback(u.RTC_CALL_ACTION.TRANSFER_TO_CONF,n,o);t.getRTCCall().transferToConf(e)}))]}}))}))};return[4,o().catch((function(e){return z(r,void 0,void 0,(function(){var t;return Z(this,(function(o){switch(o.label){case 0:o.trys.push([0,2,,3]);return[4,this.hold()];case 1:o.sent();return[3,3];case 2:t=o.sent();this.logger().warn("hold failed when transfer failed",t);return[3,3];case 3:if(n){this.unmute()}return[2,e]}}))}))}))];case 1:return[2,i.sent()]}}))}))};RTCCallActionController.prototype.mergeCalls=function(e){return z(this,void 0,void 0,(function(){var t,n,o,r,a,l;var s=this;return Z(this,(function(c){switch(c.label){case 0:t=e.toMergeActionControllers,n=e.isInitialCall,o=e.participantCode,r=e.phoneNumber,a=e.skipNotifySuccessResult;return[4,this._callConnectedWaiter.wait()];case 1:c.sent();return[4,Promise.all(t.map((function(e){return z(s,void 0,void 0,(function(){var t;return Z(this,(function(n){switch(n.label){case 0:n.trys.push([0,2,,3]);return[4,e.transferToConf({number:r,code:o,skipShortPrtsPin:true})];case 1:return[2,n.sent()];case 2:t=n.sent();this.logger().warn("merge call error happens",t);this._doErrorTracking4MergeCall(t);return[2,t];case 3:return[2]}}))}))})))];case 2:l=c.sent();this.logger().info("handle merge result",l);this._handleMergeResult({isInitialCall:n,skipNotifySuccessResult:a,validPartyCnt:l.filter((function(e){return e===i.q$.NO_ERROR})).length,toMergeCallLength:t.length,errorCodeGetter:function(){return l.find((function(e){return e!==i.q$.NO_ERROR}))}});return[2]}}))}))};RTCCallActionController.prototype.mergeToMultiPartyCall=function(e,t){return z(this,void 0,void 0,(function(){var n;var o=this;return Z(this,(function(r){switch(r.label){case 0:return[4,this._callConnectedWaiter.wait()];case 1:r.sent();return[4,Promise.all(e.map((function(e){return z(o,void 0,void 0,(function(){var t,n,o;var r;return Z(this,(function(i){switch(i.label){case 0:t=e.getCallInfo().sessionId;n=e.getCallInfo().partyId;i.label=1;case 1:i.trys.push([1,3,,4]);return[4,(r=this.getRTCCall())===null||r===void 0?void 0:r.addConferenceParty(t,n)];case 2:return[2,i.sent()];case 3:o=i.sent();this.logger().warn("merge call error happens",o);this._doErrorTracking4MergeCall(o);return[2,o];case 4:return[2]}}))}))})))];case 2:n=r.sent();this.logger().info("handle merge result",n);this._handleMergeResult({isInitialCall:t,validPartyCnt:n.filter((function(e){return e===null||e===void 0?void 0:e.sessionId})).length,toMergeCallLength:e.length,errorCodeGetter:function(){return n.find((function(e){return!(e===null||e===void 0?void 0:e.sessionId)}))}});return[2]}}))}))};RTCCallActionController.prototype._handleMergeResult=function(e){var t=e.validPartyCnt,n=e.toMergeCallLength,o=e.isInitialCall,r=e.errorCodeGetter,i=e.skipNotifySuccessResult,a=i===void 0?false:i;if(t===n){this.logger().info("merge success");this._sendMultiConfCallState({skipNotifySuccessResult:a,key:_.FY.ENTITY.MULTI_PARTY_CONF_CALL_STATE,errorCode:_.K5.MERGE_SUCCESS})}else if(t===0){this.logger().info("merge failed, no valid party, should hangup:",o);o&&this._passiveHangUp();this._sendMultiConfCallState({skipNotifySuccessResult:a,key:_.FY.ENTITY.MULTI_PARTY_CONF_CALL_STATE,errorCode:r(),errorType:_.VM.MERGE_CALL_ERROR})}else{this.logger().info("add some party failed");this._sendMultiConfCallState({skipNotifySuccessResult:a,key:_.FY.ENTITY.MULTI_PARTY_CONF_CALL_STATE,errorCode:r(),errorType:_.VM.ADD_PARTIES_ERROR})}};RTCCallActionController.prototype._sendMultiConfCallState=function(e){var t=e.key,n=e.errorCode,r=e.errorType,i=e.skipNotifySuccessResult,a=i===void 0?false:i;this.logger().info("_sendState",{key:t,errorCode:n,errorType:r,skipNotifySuccessResult:a});var l=this._getCallEntity();if(this._hasActiveHangUp){this.logger().info("cannot sent call state when hangup initiative by host",l);return}if(a&&n===_.K5.MERGE_SUCCESS){this.logger().info("There is no need to send success state.");return}o.notificationCenter.emit(t,n,r)};RTCCallActionController.prototype.whisper=function(){return this._doActionInQueue(u.RTC_CALL_ACTION.WHISPER)};RTCCallActionController.prototype.barge=function(){return this._doActionInQueue(u.RTC_CALL_ACTION.BARGE)};RTCCallActionController.prototype.takeOver=function(){var e=this;return new Promise((function(t,n){if(!(0,_.Gg)()){n(i.q$.NOT_NETWORK)}else{e.getRTCCall().dtmf(_.qK);e._handleTakeOverAction();t()}}))};RTCCallActionController.prototype.getCalleeName=function(){var e;return z(this,void 0,Promise,(function(){var t,n,o,r;var i=this;return Z(this,(function(a){switch(a.label){case 0:t=(e=this._rtcCall)===null||e===void 0?void 0:e.getCallInfo();n=t===null||t===void 0?void 0:t.toName;o=t===null||t===void 0?void 0:t.toNum;if(!(!n&&o))return[3,2];r=function(){return z(i,void 0,void 0,(function(){var e,t;return Z(this,(function(n){switch(n.label){case 0:return[4,this._phoneContactModule.matchPhoneContact(H.PhoneContactUtils.buildPhoneContactId({phoneNumber:o}))];case 1:e=n.sent();t=e;if(!t)return[3,3];return[4,this._contactModule.getNameById(e)];case 2:t=n.sent();n.label=3;case 3:return[2,t||""]}}))}))};return[4,(0,d.timeoutPromise)(r(),te).catch((function(e){i.logger().info("match name timeout",e);return""}))];case 1:n=a.sent();a.label=2;case 2:return[2,n||""]}}))}))};RTCCallActionController.prototype._doActionInQueue=function(e){var t=this;return new Promise((function(n,o){t._saveCallActionCallback(e,n,o);if(!(0,_.Gg)()){o(i.q$.NOT_NETWORK)}else{var r=new X(e,t);t.monitorCallActionQueue.addProcessor(r)}}))};Object.defineProperty(RTCCallActionController.prototype,"monitorCallActionQueue",{get:function(){if(!this._monitorCallActionQueue){this._monitorCallActionQueue=new o.SequenceProcessorHandler({name:RTCCallActionController.constructor.name})}return this._monitorCallActionQueue},enumerable:true,configurable:true});RTCCallActionController.prototype._convertToQueueCallDisplayType=function(e){var t=Object.keys(E.QUEUE_CALL_DISPLAY_TYPE);if(e===undefined){return E.QUEUE_CALL_DISPLAY_TYPE.NONE}var n=t.find((function(t){return E.QUEUE_CALL_DISPLAY_TYPE[t]===e}));if(n){return E.QUEUE_CALL_DISPLAY_TYPE[n]}return undefined};RTCCallActionController.prototype._doErrorTrackingOnCallActionFailed=function(e,t){var n,o;var r=Array.from(Object.keys(u.RTC_CALL_ACTION)).find((function(t){return u.RTC_CALL_ACTION[t]===e}))||e;var i=Array.from(Object.keys(u.RTC_CALL_ACTION_ERROR_CODE)).find((function(e){return u.RTC_CALL_ACTION_ERROR_CODE[e]===t}))||t;q.t.doErrorTrackingInCommon(r+"_"+i,{entityId:(n=this._options)===null||n===void 0?void 0:n.entityId,mainNumber:(o=this._options)===null||o===void 0?void 0:o.mainNumber},["mainNumber"])};RTCCallActionController.prototype._doErrorTracking4MergeCall=function(e){var t,n;q.t.doErrorTrackingInCommon(_.oy.MERGE+"_FAIL",{entityId:(t=this._options)===null||t===void 0?void 0:t.entityId,mainNumber:(n=this._options)===null||n===void 0?void 0:n.mainNumber,error:e},["mainNumber"])};Object.defineProperty(RTCCallActionController.prototype,"_phoneContactModule",{get:function(){return(0,o.getModule)(H.Po)},enumerable:true,configurable:true});Object.defineProperty(RTCCallActionController.prototype,"_contactModule",{get:function(){return(0,o.getModule)(V.MODULE_NAME)},enumerable:true,configurable:true});return RTCCallActionController}();var oe=undefined&&undefined.__assign||function(){oe=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++){t=arguments[n];for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r))e[r]=t[r]}return e};return oe.apply(this,arguments)};var re=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var ie=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var ae=function(){function TelephonyCallController(e,t){this.entityId=e;this._entityGetter=t;this._delegatedCallWrapper=new d.AsyncObjectWrapper}TelephonyCallController.prototype._initCallEntity=function(){var e={id:this.entityId,to_num:"",from_num:"",uuid:"",call_state:E.CALL_STATE.IDLE,hold_state:E.HOLD_STATE.IDLE,record_state:E.RECORD_STATE.DISABLED,startTime:Date.now(),connectingTime:0,connectTime:0,disconnectTime:0,session_id:"",party_id:"",direction:h.CALL_DIRECTION.OUTBOUND,mute_state:E.MUTE_STATE.IDLE,from_name:"",to_name:"",is_multiparty_conf:false,queueCallInfo:{callerId:""},isQueueCall:false,source:_.oF};this.updateCacheAndNotify(e)};TelephonyCallController.prototype.getEntityId=function(){return this.entityId};TelephonyCallController.prototype.isBLFCall=function(){var e;return!this._callActionController&&((e=this._getCallEntity())===null||e===void 0?void 0:e.is_blf_call)};TelephonyCallController.prototype.isMyHostRCConferenceCall=function(){var e;var t=this._getCallEntity();return!!((e=t===null||t===void 0?void 0:t.conf_info)===null||e===void 0?void 0:e.is_host)};TelephonyCallController.prototype.isDelegatedCall=function(){var e=this._getCallEntity();return!!(e===null||e===void 0?void 0:e.is_delegator_call)};TelephonyCallController.prototype.isCallByCallOnBehalf=function(){var e=this._getCallEntity();return!!((e===null||e===void 0?void 0:e.delegator_extension_id)&&!e.is_rc_conf)};TelephonyCallController.prototype.isTakeOverCall=function(){var e=this._getCallEntity();return!!((e===null||e===void 0?void 0:e.blfInfo)&&(e===null||e===void 0?void 0:e.blfInfo.monitorState)===E.MONITOR_STATE.TAKE_OVER)};TelephonyCallController.prototype.isPickUpCall=function(){var e=this._getCallEntity();return!!(e===null||e===void 0?void 0:e.is_pick_up_call)};TelephonyCallController.prototype.isMultiPartyConfCall=function(){var e=this._getCallEntity();return!!(e===null||e===void 0?void 0:e.is_multiparty_conf)};TelephonyCallController.prototype.generateClientRefId=function(){if(!this._clientRefId){this._clientRefId=(0,o.generateUUID)()}return this._clientRefId};TelephonyCallController.prototype.getClientRefId=function(){return this._clientRefId};TelephonyCallController.prototype.waitDelegatedCall=function(e){return(0,d.timeoutPromise)(this._delegatedCallWrapper.getObj(),e)};TelephonyCallController.prototype.onReceiveDelegatedIncomingCall=function(e){this._delegatedCallWrapper.setObj(e)};TelephonyCallController.prototype.getConferenceInfo=function(){var e=this._getCallEntity();return e===null||e===void 0?void 0:e.conf_info};TelephonyCallController.prototype.getCallToNumber=function(){var e=this._getCallEntity();return e===null||e===void 0?void 0:e.to_num};TelephonyCallController.prototype.hasRTCCall=function(){var e;return!!((e=this._callActionController)===null||e===void 0?void 0:e.getRTCCall())};TelephonyCallController.prototype.createRTCCallDelegate=function(e){if(!this._callActionController){this._callActionController=new ne({mainNumber:e,entityId:this.entityId,getCallEntityFn:this._entityGetter})}return this._callActionController};TelephonyCallController.prototype.setRCNotificationCall=function(e,t){return re(this,void 0,void 0,(function(){return ie(this,(function(n){switch(n.label){case 0:this._initCallEntity();return[4,this.updateRCNotificationCall(e,t)];case 1:n.sent();return[2]}}))}))};TelephonyCallController.prototype.updateRCNotificationCall=function(e,t){var n,o,r;return re(this,void 0,void 0,(function(){var i,a,l,s,c;return ie(this,(function(u){switch(u.label){case 0:if(this.hasRTCCall()){this._logger.info("no need to update call info from rc notification call");return[2]}i=oe({},this._getCallEntity());i.session_id=e.telephonySessionId;i.party_id=e.partyId;i.direction=e.direction;i.connectingTime=Date.now();i.call_state=e.telephonyStatus===h.TELEPHONY_STATUS.Ringing||t&&e.telephonyStatus===h.TELEPHONY_STATUS.OnHold?E.CALL_STATE.IDLE:E.CALL_STATE.DISCONNECTING;i.from_tag=(n=e.sipData)===null||n===void 0?void 0:n.fromTag;i.to_tag=(o=e.sipData)===null||o===void 0?void 0:o.toTag;i.from_num=e.from;i.from_name=e.fromName;i.to_num=e.to;i.to_name=e.toName;a=e.direction===h.CALL_DIRECTION.INBOUND?i.from_num:i.to_num;l=i;s=[oe({},i.blfInfo)];c={isMultiPartyConf:a===h.MULTI_PARTY_CONF_CALL_NUMBER};return[4,(r=this._rcInfoModule)===null||r===void 0?void 0:r.isRCConferenceNumber(a)];case 1:l.blfInfo=oe.apply(void 0,s.concat([(c.isRCConf=u.sent(),c.isGroupCallPickup=q.t.isGCPPickupTarget(e.pickupTarget),c.isQueueCallPickup=q.t.isQCPPickupTarget(e.pickupTarget),c.pickupTargetExtensionId=e.pickupTarget&&q.t.getExtensionIdFromPickupTarget(e.pickupTarget),c)]));i.is_blf_call=true;i.is_delegator_call=e.isDelegatorCall;i.call_owner_extension_id=e.sourceExtension;this.updateCacheAndNotify(i);i.call_state===E.CALL_STATE.DISCONNECTING&&this.disconnectCall();return[2]}}))}))};TelephonyCallController.prototype.disconnectCall=function(){var e=oe({},this._getCallEntity());e.call_state=E.CALL_STATE.DISCONNECTED;e.disconnectTime=Date.now();this.updateCacheAndNotify(e)};TelephonyCallController.prototype.setRtcCall=function(e){var t;return re(this,void 0,void 0,(function(){var n,o,r,i,a,l,s,c,u,p,_;return ie(this,(function(C){switch(C.label){case 0:n=e.rtcCall,o=e.isSwitchCall,r=e.callOption,i=e.skipInit,a=i===void 0?false:i,l=e.blfInfo,s=e.delegatorExtensionId,c=e.confInfo,u=e.callOwnerExtensionId,p=e.isPickUpCall,_=e.callInfo;!a&&this._initCallEntity();this.updateCallToConnecting();this.createRTCCallDelegate();return[4,(t=this.getCallActionController())===null||t===void 0?void 0:t.setRTCCall({rtcCall:n,isSwitchCall:o,callOption:r,blfInfo:l,delegatorExtensionId:s,confInfo:c,callOwnerExtensionId:u,isPickUpCall:p,callInfo:_})];case 1:C.sent();return[2]}}))}))};TelephonyCallController.prototype.isOnHold=function(){var e=this._getCallEntity();return e?e.hold_state===E.HOLD_STATE.HELD:false};TelephonyCallController.prototype.lastHoldTime=function(){var e=this._getCallEntity();return(e===null||e===void 0?void 0:e.last_hold_time)||0};TelephonyCallController.prototype.isActiveCall=function(){var e=this._getCallEntity();return(e===null||e===void 0?void 0:e.call_state)===E.CALL_STATE.CONNECTED||(e===null||e===void 0?void 0:e.call_state)===E.CALL_STATE.CONNECTING};TelephonyCallController.prototype.getCallActionController=function(){if(!this._callActionController){this._logger.warn("should not get action controller when it is not ready")}return this._callActionController};TelephonyCallController.prototype.updateCallToConnecting=function(){var e=this._getCallEntity();(e===null||e===void 0?void 0:e.is_blf_call)&&this.updateCacheAndNotify(oe(oe({},e),{call_state:E.CALL_STATE.CONNECTING}))};TelephonyCallController.prototype.updateCallToDisconnecting=function(){var e=this._getCallEntity();this.updateCacheAndNotify(oe(oe({},e),{call_state:E.CALL_STATE.DISCONNECTING}))};TelephonyCallController.prototype.updateCacheAndNotify=function(e){E.CallDataUtils.getInstance().upsertCallEntity(e)};TelephonyCallController.prototype._getCallEntity=function(){return this._entityGetter(this.entityId)};Object.defineProperty(TelephonyCallController.prototype,"_logger",{get:function(){return p.k.tags("[TelephonyCallController]",this.entityId.toString())},enumerable:true,configurable:true});Object.defineProperty(TelephonyCallController.prototype,"_rcInfoModule",{get:function(){return(0,o.getModule)(l.oF)},enumerable:true,configurable:true});return TelephonyCallController}();var le=undefined&&undefined.__assign||function(){le=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++){t=arguments[n];for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r))e[r]=t[r]}return e};return le.apply(this,arguments)};var se=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var ce=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var ue=undefined&&undefined.__read||function(e,t){var n=typeof Symbol==="function"&&e[Symbol.iterator];if(!n)return e;var o=n.call(e),r,i=[],a;try{while((t===void 0||t-- >0)&&!(r=o.next()).done)i.push(r.value)}catch(e){a={error:e}}finally{try{if(r&&!r.done&&(n=o["return"]))n.call(o)}finally{if(a)throw a.error}}return i};var pe=undefined&&undefined.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(ue(arguments[t]));return e};var _e="[MakeCallController]";var Ce=p.k.tags(_e);var fe=function(){function MakeCallController(e){this._rtcAccount=e.rtcAccount;this._telephonyConfig=e.telephonyConfig;this._isRegistrationLimitExceeded=e.isRegistrationLimitExceeded;this._getRegistrationVdiVendorName=e.getRegistrationVdiVendorName;this._getMaxCallCnt=e.getMaxCallCnt}MakeCallController.prototype.tryMakeCall=function(e,t,n){return se(this,void 0,void 0,(function(){var o,r,a,l,s,c,u,p,C,d,T,R;return ce(this,(function(g){switch(g.label){case 0:o=i.HI.NO_ERROR;g.label=1;case 1:return[4,this._errorChecker({toNumber:e,isSwitchCall:t,callOptions:n,isBLFCall:false})];case 2:o=g.sent();if(o!==i.HI.NO_ERROR){q.t.doErrorTrackingInCommon(_.oy.MAKE_CALL+"_"+o,{toNumber:e,isSwitchCall:t,callOptions:n},pe(["toNumber"],_.my));return[3,13]}return[4,this._parserPhoneNumber(e)];case 3:r=g.sent();if(this._getRegistrationVdiVendorName()==="Citrix"){o=i.HI.REGISTRATION_VDI_IN_PROGRESS_ERROR;return[3,13]}else if(this._getRegistrationVdiVendorName()==="VMware"){o=i.HI.REGISTRATION_VDI_VMWARE_IN_PROGRESS_ERROR;return[3,13]}a=new ae(E.CallDataUtils.getInstance().generateId(),(function(e){return E.CallDataUtils.getInstance().getCallEntity(e)}));l=le({},n);if(!!t)return[3,8];c=n===null||n===void 0?void 0:n.fromNumber;if(c)return[3,5];return[4,this._getDefaultFromNumber(false)];case 4:c=g.sent();g.label=5;case 5:s=c;if(!s)return[3,8];if(!!this._isAnonymousNumber(s))return[3,7];return[4,this._phoneNumberModule.getE164PhoneNumber(s)];case 6:s=g.sent();g.label=7;case 7:l.fromNumber=s;g.label=8;case 8:u="";if(n&&n.accessCodeType===h.ACCESS_CODE_TYPE.NUMBER&&n.accessCode){u=r;r=r+",,"+n.accessCode+"#"+(n.pstnPassword?",,"+n.pstnPassword+"#":"");l=f().omit(l,["accessCode","accessCodeType","pstnPassword"])}return[4,this._rcInfoModule.getCurrentCountry()];case 9:p=g.sent().id;l.homeCountryId=p;C=l;return[4,this.canCurrentVersionSupportV2V()];case 10:C.canPromoteToVideo=g.sent();d=l;return[4,this._e911Module.isNoActualEA()];case 11:d.invalidEA=g.sent();Ce.debug("Place a call",l);T=a.createRTCCallDelegate(u);R=this._rtcAccount.makeCall(r,T,l);if(!R){o=i.HI.VOIP_CALLING_SERVICE_UNAVAILABLE;return[3,13]}return[2,{call:R,callController:a,errCode:o}];case 12:if(false){}g.label=13;case 13:Ce.log("failed to make call",{errCode:o,isSwitchCall:t,options:n});return[2,{errCode:o}]}}))}))};MakeCallController.prototype._parserPhoneNumber=function(e){return se(this,void 0,void 0,(function(){var t;return ce(this,(function(n){switch(n.label){case 0:return[4,this._phoneParserModule.getPhoneParser(e)];case 1:t=n.sent();if(t===null||t===void 0?void 0:t.isUKTextRelayService()){Ce.info("make a relayUK call",e);return[2,t===null||t===void 0?void 0:t.getDialableExtended(true)]}return[4,this._phoneNumberModule.getE164PhoneNumber(e)];case 2:return[2,n.sent()]}}))}))};MakeCallController.prototype.tryMonitorBLFCall=function(e,t){return se(this,void 0,void 0,(function(){var n,o,r,a,l;return ce(this,(function(s){switch(s.label){case 0:Ce.info("tryMonitorBLFCall",e,t);n=""+_.iN+e;return[4,this._errorChecker({toNumber:n,isSwitchCall:false,isBLFCall:true})];case 1:o=s.sent();if(o===i.HI.NO_ERROR){r=new ae(E.CallDataUtils.getInstance().generateId(),(function(e){return E.CallDataUtils.getInstance().getCallEntity(e)}));a=r.createRTCCallDelegate();l=this._rtcAccount.makeCall(n,a);if(l){Ce.debug("monitor call success",t);return[2,{rtcCall:l,callController:r}]}o=i.HI.VOIP_CALLING_SERVICE_UNAVAILABLE}Ce.debug("monitor call with error",t);q.t.doErrorTrackingInCommon(_.oy.MONITOR_BLF_CALL+"_"+o,{toNumber:n,extensionNumber:e,activeCall:t},pe(["toNumber","extensionNumber"],_.FN));throw new h.JRCError(o,o)}}))}))};MakeCallController.prototype.tryCallOnBehalfOf=function(e,t,n){return se(this,void 0,void 0,(function(){var o,r,a,l,s,c,u,p,C;return ce(this,(function(f){switch(f.label){case 0:Ce.info("tryCallOnBehalfOf",e,t);return[4,this._errorChecker({toNumber:t,isSwitchCall:false,isBLFCall:false,callOptions:{allowNoDefinedEmergencyAddress:n}})];case 1:o=f.sent();if(!(o===i.HI.NO_ERROR))return[3,4];r=new ae(E.CallDataUtils.getInstance().generateId(),(function(e){return E.CallDataUtils.getInstance().getCallEntity(e)}));return[4,this._phoneNumberModule.getE164PhoneNumber(t)];case 2:a=f.sent();l=r.createRTCCallDelegate();u=(c=this._rtcAccount).makeCall;p=[a,l];C={onBehalfKey:e};return[4,this._getDefaultFromNumber()];case 3:s=u.apply(c,p.concat([(C.fromNumber=f.sent(),C)]));if(s){Ce.debug("tryCallOnBehalfOf success",e,t);return[2,{rtcCall:s,callController:r,errorCode:o}]}o=i.HI.VOIP_CALLING_SERVICE_UNAVAILABLE;f.label=4;case 4:Ce.debug("tryCallOnBehalfOf with error",e,t);q.t.doErrorTrackingInCommon(_.oy.CALL_ON_BEHALF_OF+"_"+o,{toNumber:t,extensionId:e,allowNoDefinedEmergencyAddress:n},["toNumber"]);return[2,{errorCode:o}]}}))}))};MakeCallController.prototype.tryPromoteDelegatedCallToConf=function(e,t,n,o){return se(this,void 0,void 0,(function(){var r,a,l,s,c,u,p,C;return ce(this,(function(f){switch(f.label){case 0:Ce.info("tryPromoteDelegatedCallToConf",e,n,o);return[4,this._rcInfoModule.getRCConferenceRemoteAndLocal()];case 1:r=f.sent();a=r===null||r===void 0?void 0:r.phoneNumber;if(!a){return[2,{errorCode:i.HI.INVALID_PHONE_NUMBER}]}return[4,this._errorChecker({toNumber:a,isSwitchCall:false,isBLFCall:true})];case 2:l=f.sent();if(!(l===i.HI.NO_ERROR))return[3,7];s=new ae(E.CallDataUtils.getInstance().generateId(),(function(e){return E.CallDataUtils.getInstance().getCallEntity(e)}));c=s.createRTCCallDelegate();u={sessionId:e,conferencePinsCode:o,conferencePhoneNumber:a};p=void 0;f.label=3;case 3:f.trys.push([3,5,,6]);return[4,this._rtcAccount.promoteDelegatedCallToConf(u,a,c,{rcTapRcc:{accessCode:n,sessionData:_.Lj+t,skipShortPrtsPin:true}})];case 4:p=f.sent();return[3,6];case 5:C=f.sent();Ce.info("rtcAccount promoteDelegatedCallToConf failed",C);q.t.doErrorTrackingInCommon(_.oy.PROMOTE_DELEGATED_CALL_TO_CONF+"_FAIL",{conferencePhoneNumber:a,sessionId:e,currentExtensionId:t,hostCode:n,participantCode:o,error:C},["conferencePhoneNumber"]);return[3,6];case 6:if(p){Ce.debug("tryPromoteDelegatedCallToConf success",e,n,o,a);return[2,{rtcCall:p,callController:s,errorCode:l}]}l=i.HI.MERGE_CALL_ERROR;f.label=7;case 7:Ce.debug("tryPromoteDelegatedCallToConf with error",e,n,o,a);q.t.doErrorTrackingInCommon(_.oy.PROMOTE_DELEGATED_CALL_TO_CONF+"_"+l,{conferencePhoneNumber:a,sessionId:e,currentExtensionId:t,hostCode:n,participantCode:o},["conferencePhoneNumber"]);return[2,{errorCode:l}]}}))}))};MakeCallController.prototype.tryPickUpBLFCall=function(e,t,n){return se(this,void 0,void 0,(function(){var o,r,a,l;return ce(this,(function(s){switch(s.label){case 0:if(!t)return[3,8];return[4,this._errorChecker({toNumber:n,callOptions:e,isSwitchCall:false,isBLFCall:true})];case 1:o=s.sent();if(!(o===i.HI.NO_ERROR))return[3,7];r=null;a=t.isDelegatedCall();Ce.info("tryPickUpBLFCall,isDelegatedCall:",a);if(!a)return[3,3];t.updateCallToConnecting();return[4,this._pickUpDelegatedCall({sessionId:e.pickUpCallId||"",partyId:e.partyId||"",clientRefId:t.generateClientRefId()},t).catch((function(o){Ce.warn("_pickUpDelegatedCall,failed",o);t.disconnectCall();q.t.doErrorTrackingInCommon(_.oy.PICK_UP+"_FAIL",{callOptions:e,pickUpExtensionNumber:n},pe(["pickUpExtensionNumber"],_.my));throw new h.JRCError(i.HI.UNABLE_TO_PICK_UP_CALL_ERROR,JSON.stringify(o))}))];case 2:r=s.sent();return[3,4];case 3:l=t.createRTCCallDelegate();r=this._rtcAccount.makeCall(n,l,le({},e));s.label=4;case 4:if(!r)return[3,6];Ce.debug("pick up BLF call success",e);return[4,t.setRtcCall({rtcCall:r,callOption:{},isSwitchCall:false,skipInit:true,isPickUpCall:true})];case 5:s.sent();return[3,7];case 6:o=i.HI.VOIP_CALLING_SERVICE_UNAVAILABLE;s.label=7;case 7:if(o!==i.HI.NO_ERROR){Ce.debug("pick up BLF call with error",e);q.t.doErrorTrackingInCommon(_.oy.PROMOTE_DELEGATED_CALL_TO_CONF+"_"+o,{pickUpExtensionNumber:n,callOptions:e},pe(["pickUpExtensionNumber"],_.my));throw new h.JRCError(o,o)}s.label=8;case 8:return[2]}}))}))};MakeCallController.prototype._pickUpDelegatedCall=function(e,t){return se(this,void 0,Promise,(function(){return ce(this,(function(n){switch(n.label){case 0:return[4,this._rtcAccount.pickUpDelegatedCall(e)];case 1:n.sent();return[2,t.waitDelegatedCall(_.UA)]}}))}))};MakeCallController.prototype.tryPickUpParkLocation=function(e,t){return se(this,void 0,void 0,(function(){var n,o,r,a;return ce(this,(function(l){switch(l.label){case 0:Ce.info("tryPickUpParkLocation",e,t);return[4,this._errorChecker({toNumber:e,isSwitchCall:false,isBLFCall:false,parkLocation:true})];case 1:n=l.sent();if(n===i.HI.NO_ERROR){o=new ae(E.CallDataUtils.getInstance().generateId(),(function(e){return E.CallDataUtils.getInstance().getCallEntity(e)}));r=o.createRTCCallDelegate();a=this._rtcAccount.makeCall(e,r,t);if(a){Ce.debug("tryPickUpParkLocation success",e,t);return[2,{rtcCall:a,callController:o,errorCode:n}]}n=i.HI.VOIP_CALLING_SERVICE_UNAVAILABLE}Ce.debug("tryPickUpParkLocation with error",e,t);q.t.doErrorTrackingInCommon(_.oy.PROMOTE_DELEGATED_CALL_TO_CONF+"_"+n,{location:e,callOptions:t},pe(["location"],_.my));return[2,{errorCode:n}]}}))}))};MakeCallController.prototype.checkVoipStatus=function(){var e=i.HI.NO_ERROR;var t=this._rtcAccount.getSipProvFlags();do{if(!t){e=i.HI.VOIP_CALLING_SERVICE_UNAVAILABLE;Ce.warn("sip prov is not ready");break}if(t.voipCountryBlocked){Ce.warn("voip is country blocked");e=i.HI.THE_COUNTRY_BLOCKED_VOIP;break}if(!t.voipFeatureEnabled){Ce.warn("voip feature is disabled");e=i.HI.VOIP_CALLING_SERVICE_UNAVAILABLE;break}}while(false);return e};MakeCallController.prototype.isDefaultPhoneApp=function(){return se(this,void 0,void 0,(function(){var e,t;return ce(this,(function(n){switch(n.label){case 0:e=(0,o.getModule)(W.Kw);return[4,e.getById(v.O0.Phone_DefaultApp)];case 1:t=n.sent();return[2,t&&t.value!==v.hr.RINGCENTRAL]}}))}))};MakeCallController.prototype._isFederationExtension=function(e){return se(this,void 0,void 0,(function(){var t,n,o;return ce(this,(function(r){switch(r.label){case 0:return[4,this._phoneParserModule.getPhoneParser(e)];case 1:t=r.sent();n=t===null||t===void 0?void 0:t.getDialableNumber();o=t===null||t===void 0?void 0:t.getSubAddress();return[2,!!(n&&n.length>0&&o&&o.length>0)]}}))}))};MakeCallController.prototype._checkE911Status=function(e,t,n,o){var r;return se(this,void 0,void 0,(function(){var a,s,c,u,p,_;return ce(this,(function(C){switch(C.label){case 0:if(n){return[2,i.HI.NO_ERROR]}return[4,this._e911Module.requireE911Address()];case 1:if(!C.sent()){return[2,i.HI.NO_ERROR]}return[4,this._e911Module.isE911ServiceUnavailable()];case 2:if(C.sent()){return[2,i.HI.NO_ERROR]}if(!(o===null||o===void 0?void 0:o.fromNumber))return[3,4];return[4,this._rcInfoModule.getCallerIdByPhoneNumber(o.fromNumber)];case 3:s=C.sent();return[3,6];case 4:return[4,this._rcInfoModule.getDefaultCallerId()];case 5:s=C.sent();C.label=6;case 6:a=s;if(!a)return[3,8];if(a.paymentType===h.PhoneNumberPaymentType.ExternalNumberProvider){return[2,i.HI.NO_ERROR]}return[4,this._rcInfoModule.getDigitalLines()];case 7:c=(r=C.sent())===null||r===void 0?void 0:r.find((function(e){return l.te.getPhoneNumber(e)===(a===null||a===void 0?void 0:a.phoneNumber)}));if(c&&!l.te.getAddressRequire(c)){return[2,i.HI.NO_ERROR]}C.label=8;case 8:return[4,this._phoneNumberModule.isSpecialNumber(e)];case 9:u=C.sent();return[4,this._phoneNumberModule.isServiceFeatureNumber(e)];case 10:p=C.sent();_=!u&&!t&&!p&&((o===null||o===void 0?void 0:o.allowNoDefinedEmergencyAddress)?!this._e911Module.isEmergencyAddrConfirmed():!this._e911Module.isEmergencyAddrConfirmedWithValidAddr());return[2,!_?i.HI.NO_ERROR:i.HI.NO_EMERGENCY_CONFIRMED]}}))}))};MakeCallController.prototype._checkCanMakeExternalCall=function(e,t){return se(this,void 0,void 0,(function(){var n;return ce(this,(function(o){switch(o.label){case 0:if(e||t){return[2,i.HI.NO_ERROR]}return[4,this._hasPhoneLine()];case 1:n=o.sent();return[2,n?i.HI.NO_ERROR:i.HI.NO_DIGITAL_LINE_TO_CALL_LONG_NUMBER]}}))}))};MakeCallController.prototype._checkVoipCallPermission=function(){return se(this,void 0,void 0,(function(){var e;return ce(this,(function(t){switch(t.label){case 0:return[4,this._rcInfoModule.isVoipCallingAvailable()];case 1:e=t.sent();return[2,e?i.HI.NO_ERROR:i.HI.NO_VOIP_CALL_PERMISSION]}}))}))};MakeCallController.prototype._checkValidPhoneNumber=function(e){return se(this,void 0,void 0,(function(){var t;return ce(this,(function(n){switch(n.label){case 0:if(!this._phoneNumberModule.isValidNumber(e)){return[2,i.HI.INVALID_PHONE_NUMBER]}return[4,this._phoneNumberModule.getE164PhoneNumber(e)];case 1:t=n.sent();return[2,t?i.HI.NO_ERROR:i.HI.INVALID_PHONE_NUMBER]}}))}))};MakeCallController.prototype._checkInternetConnection=function(){var e=a.Pal.instance.networkStatus();if(!(e&&e.getStatus())){return i.HI.NO_INTERNET_CONNECTION}return i.HI.NO_ERROR};MakeCallController.prototype._checkDefaultPhoneApp=function(){return se(this,void 0,void 0,(function(){var e;return ce(this,(function(t){switch(t.label){case 0:return[4,this.isDefaultPhoneApp()];case 1:e=t.sent();return[2,e?i.HI.NO_ERROR:i.HI.NOT_DEFAULT_PHONE_APP]}}))}))};MakeCallController.prototype.checkMaxCallCount=function(){return this._getMaxCallCnt()<_.cG?i.HI.NO_ERROR:i.HI.CALL_COUNT_OVER_LIMIT};Object.defineProperty(MakeCallController.prototype,"_rcInfoModule",{get:function(){return(0,o.getModule)(l.gj)},enumerable:true,configurable:true});Object.defineProperty(MakeCallController.prototype,"_phoneNumberModule",{get:function(){return(0,o.getModule)(B.iJ)},enumerable:true,configurable:true});MakeCallController.prototype._isAnonymousNumber=function(e){return e===B.vX.PhoneNumberAnonymous};Object.defineProperty(MakeCallController.prototype,"_phoneParserModule",{get:function(){return(0,o.getModule)(j.PHONE_PARSER_MODULE)},enumerable:true,configurable:true});MakeCallController.prototype._checkEmergencyNumber=function(e){return se(this,void 0,void 0,(function(){var t,n,o;return ce(this,(function(r){switch(r.label){case 0:return[4,this._phoneNumberModule.isSpecialNumber(e)];case 1:t=r.sent();if(!t)return[3,5];return[4,this._matchPerson(e)];case 2:n=r.sent();o=n;if(o)return[3,4];return[4,this._hasPhoneLine()];case 3:o=r.sent();r.label=4;case 4:return[2,o?i.HI.NO_ERROR:i.HI.INVALID_PHONE_NUMBER];case 5:return[2,i.HI.NO_ERROR]}}))}))};MakeCallController.prototype._matchPerson=function(e){return se(this,void 0,void 0,(function(){var t,n,r,i,a,l,s,c;return ce(this,(function(u){switch(u.label){case 0:t=(0,o.getModule)(V.MODULE_NAME);if(!this._isMessageOn)return[3,3];i=(r=t).matchByPhoneNumber;a=[e,undefined];return[4,this._getGlipContactType()];case 1:return[4,i.apply(r,a.concat([u.sent()]))];case 2:n=!!u.sent().length;return[3,6];case 3:s=(l=t).matchByPhoneNumber;c=[e,undefined];return[4,this._getRCContactType()];case 4:return[4,s.apply(l,c.concat([u.sent()]))];case 5:n=!!u.sent().length;u.label=6;case 6:return[2,n]}}))}))};Object.defineProperty(MakeCallController.prototype,"_isMessageOn",{get:function(){var e=o.accountManager.getCurrent().context.entitlement;return!!e.get(x.H3.RCExtensionFeaturesId.Glip)},enumerable:true,configurable:true});MakeCallController.prototype._hasPhoneLine=function(){var e;return se(this,void 0,void 0,(function(){return ce(this,(function(t){switch(t.label){case 0:return[4,this._rcInfoModule.getDigitalLines()];case 1:return[2,!!((e=t.sent())===null||e===void 0?void 0:e.length)]}}))}))};MakeCallController.prototype._getDefaultFromNumber=function(e){return se(this,void 0,void 0,(function(){var t;return ce(this,(function(n){switch(n.label){case 0:return[4,this._rcInfoModule.getDefaultCallerId(e)];case 1:t=n.sent();return[2,t?t.id?t.phoneNumber:B.vX.PhoneNumberAnonymous:undefined]}}))}))};MakeCallController.prototype._errorChecker=function(e){return se(this,void 0,void 0,(function(){var t,n,o,r,a,l,s,c;return ce(this,(function(u){switch(u.label){case 0:t=i.HI.NO_ERROR;n=e.isBLFCall,o=e.isSwitchCall,r=e.toNumber,a=e.parkLocation;u.label=1;case 1:if(this._isRegistrationLimitExceeded()){t=i.HI.REGISTRATION_LIMIT_EXCEEDED_ERROR;return[3,14]}return[4,this._checkVoipCallPermission()];case 2:t=u.sent();if(t!==i.HI.NO_ERROR){return[3,14]}if(!(!n&&!a))return[3,4];return[4,this._checkValidPhoneNumber(r)];case 3:t=u.sent();if(t!==i.HI.NO_ERROR){return[3,14]}!o&&this._telephonyConfig.setLastCalledNumber(r);u.label=4;case 4:return[4,this._checkDefaultPhoneApp()];case 5:t=u.sent();if(t!==i.HI.NO_ERROR){return[3,14]}return[4,this._phoneNumberModule.isShortNumber(r)];case 6:s=u.sent();if(s)return[3,8];return[4,this._isFederationExtension(r)];case 7:s=u.sent();u.label=8;case 8:l=s;t=this._checkInternetConnection();if(t!==i.HI.NO_ERROR){return[3,14]}t=this.checkVoipStatus();if(t!==i.HI.NO_ERROR){return[3,14]}if(!!n)return[3,13];t=this.checkMaxCallCount();if(t!==i.HI.NO_ERROR){return[3,14]}return[4,this._checkCanMakeExternalCall(l,o)];case 9:t=u.sent();if(t!==i.HI.NO_ERROR){return[3,14]}return[4,this._checkE911Status(r,l,o,e.callOptions)];case 10:t=u.sent();if(t!==i.HI.NO_ERROR){return[3,14]}return[4,this._phoneNumberModule.getE164PhoneNumber(r)];case 11:c=u.sent();return[4,this._checkEmergencyNumber(c)];case 12:t=u.sent();if(t!==i.HI.NO_ERROR){return[3,14]}u.label=13;case 13:if(false){}u.label=14;case 14:return[2,t]}}))}))};MakeCallController.prototype._getGlipContactType=function(){return se(this,void 0,Promise,(function(){var e,t;return ce(this,(function(n){switch(n.label){case 0:e=(0,o.getModule)(T.COMMON_KEY_ACTION_MODULE).getKeyActionService().get(T.ACTION_KEY.GET_GLIP_CONTACT_TYPE);t=e===null||e===void 0?void 0:e.getAction;if(!t)return[3,2];return[4,e.getAction()];case 1:t=n.sent();n.label=2;case 2:return[2,t]}}))}))};MakeCallController.prototype._getRCContactType=function(){return se(this,void 0,Promise,(function(){var e,t;return ce(this,(function(n){switch(n.label){case 0:e=(0,o.getModule)(T.COMMON_KEY_ACTION_MODULE).getKeyActionService().get(T.ACTION_KEY.GET_RC_CONTACT_TYPE);t=e===null||e===void 0?void 0:e.getAction;if(!t)return[3,2];return[4,e.getAction()];case 1:t=n.sent();n.label=2;case 2:return[2,t]}}))}))};MakeCallController.prototype._isUsingRCV=function(){return se(this,void 0,Promise,(function(){var e,t;return ce(this,(function(n){switch(n.label){case 0:e=(0,o.getModule)(T.COMMON_KEY_ACTION_MODULE).getKeyActionService().get(T.ACTION_KEY.IS_USING_RCV);t=e===null||e===void 0?void 0:e.getAction;if(!t)return[3,2];return[4,e.getAction()];case 1:t=n.sent();n.label=2;case 2:return[2,t]}}))}))};MakeCallController.prototype.canPromoteCallToMeet=function(){return se(this,void 0,Promise,(function(){var e,t,n;return ce(this,(function(r){switch(r.label){case 0:e=o.accountManager.getCurrent().context.entitlement;t=(e===null||e===void 0?void 0:e.get(x.H3.RolePermissionId.PERMISSION_MEETINGS))&&(e===null||e===void 0?void 0:e.get(x.H3.RCExtensionFeaturesId.Meetings));n=t;if(!n)return[3,2];return[4,this._isUsingRCV()];case 1:n=r.sent();r.label=2;case 2:return[2,!!n]}}))}))};MakeCallController.prototype.canCurrentVersionSupportV2V=function(){return se(this,void 0,Promise,(function(){var e,t;return ce(this,(function(n){switch(n.label){case 0:return[4,this.canPromoteCallToMeet()];case 1:e=n.sent();t=a.Pal.instance.getPlatformUtils();if(t.isElectron()){return[2,e]}return[2,e&&(t.isBrowserSupport()||false)]}}))}))};Object.defineProperty(MakeCallController.prototype,"_e911Module",{get:function(){return(0,o.getModule)(c.l9)},enumerable:true,configurable:true});return MakeCallController}();var de=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var he=function(e){de(MultipleCallActionError,e);function MultipleCallActionError(t,n){return e.call(this,_.G1,t,t,n)||this}return MultipleCallActionError}(d.JError);var Te=undefined&&undefined.__assign||function(){Te=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++){t=arguments[n];for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r))e[r]=t[r]}return e};return Te.apply(this,arguments)};var Re=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var ge=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var Ee=undefined&&undefined.__read||function(e,t){var n=typeof Symbol==="function"&&e[Symbol.iterator];if(!n)return e;var o=n.call(e),r,i=[],a;try{while((t===void 0||t-- >0)&&!(r=o.next()).done)i.push(r.value)}catch(e){a={error:e}}finally{try{if(r&&!r.done&&(n=o["return"]))n.call(o)}finally{if(a)throw a.error}}return i};var ve=undefined&&undefined.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(Ee(arguments[t]));return e};var ye=p.k.tags("[TelephonyAccountController]");var Ae="UNHOLD_CALL_TASK";var me=20;var Ie=function(){function TelephonyAccountController(e,t,n){var r=this;this._telephonyConfig=e;this._telephonyEventLogController=t;this._isDisposing=false;this._callControllerMap=new Map;this._callGroupInfos=[];this._unHoldActionQueue=new o.SequenceProcessorHandler({name:Ae});this._ignoredBLFCallList=[];this._isRegistrationLimitExceeded=false;this._vdiVendorName="";this._handleRCNotificationCallQueue=new d.AsyncQueue;this._recentParkedSessionIds=[];this._handleCallStateChanged=function(e){if(e.type===o.EVENT_TYPES.UPDATE){var t=Array.from(e.body.entities.values());t.forEach((function(e){if(e.call_state===E.CALL_STATE.DISCONNECTED){r._processLogoutIfNeeded();r._removeControllerFromMap(e.id)}}))}};this._handleVDIConnectedEvent=function(e){ye.log("_handleVDIConnectedEvent",e);r._rtcAccount.handleVDIEvent(true,e)};this._handleVDIDisconnectedEvent=function(){r._rtcAccount.handleVDIEvent(false)};this._clearCallGroupInfo=function(e){var t=false;for(var n=r._callGroupInfos.length-1;n>=0;n--){var o=r._callGroupInfos[n];if(o.callIds.has(e)){t=true;o.callIds.delete(e)}if(o.callIds.size<2||o.fromCallId===e){r._callGroupInfos.splice(n,1)}}t&&r._notifyCallGroupChanged()};this._onCallActionFailed=function(e,t,n){var o;ye.log("call acton failed",{callId:e,callAction:t,code:n});if(t===u.RTC_CALL_ACTION.HOLD&&r._callControllerMap.size>1){var i=r._callControllerMap.get(e);if(i){ye.info("hold failed, mute call: "+e+" due to the failure of call hold");(o=i.getCallActionController())===null||o===void 0?void 0:o.muteAll()}}};this.getCalls=function(){var e=[];r._callControllerMap.forEach((function(t){var n;var o=(n=t.getCallActionController())===null||n===void 0?void 0:n.getRTCCall();o&&e.push(o)}));return e};this._getCallEntityFn=function(e){return E.CallDataUtils.getInstance().getCallEntity(e)};this._handleRCNotificationCalls=function(e){return Re(r,void 0,void 0,(function(){var t=this;return ge(this,(function(n){switch(n.label){case 0:ye.info("_handleRCNotificationCalls BLF call ids: ",e.map((function(e){return e.id})));return[4,Promise.all(e.map((function(e){return t._handleRCNotificationCallInQueue(e)})))];case 1:n.sent();return[2]}}))}))};this._rtcAccount=n.createAccount(this);this._subscribeNotifications()}TelephonyAccountController.prototype.handleProvisioning=function(){this._rtcAccount.handleProvisioning()};Object.defineProperty(TelephonyAccountController.prototype,"makeCallController",{get:function(){var e=this;if(!this._makeCallController){this._makeCallController=new fe({rtcAccount:this._rtcAccount,telephonyConfig:this._telephonyConfig,isRegistrationLimitExceeded:function(){return e.isRegistrationLimitExceeded()},getRegistrationVdiVendorName:function(){return e.getRegistrationVdiVendorName()},getMaxCallCnt:function(){return e.getCallCount()}})}return this._makeCallController},enumerable:true,configurable:true});TelephonyAccountController.prototype.getRTCAccount=function(){return this._rtcAccount};TelephonyAccountController.prototype._subscribeNotifications=function(){o.notificationCenter.on(E.FY.ENTITY.CALL,this._handleCallStateChanged);ye.log("subscribe on "+G.FY.VDI_CONNECTED+" event");var e=(0,o.getModule)(G.oF);var t=!!(e===null||e===void 0?void 0:e.isConnected());if(t){this._handleVDIConnectedEvent(e.getWebPhoneOptions())}o.notificationCenter.on(G.FY.VDI_CONNECTED,this._handleVDIConnectedEvent);o.notificationCenter.on(G.FY.VDI_DISCONNECTED,this._handleVDIDisconnectedEvent);o.notificationCenter.on(_.FY.CALL_ACTION_ERROR,this._onCallActionFailed);o.notificationCenter.on(_.FY.RC_NOTIFICATION_INCOMING_CALL,this._handleRCNotificationCalls)};TelephonyAccountController.prototype._unSubscribeNotifications=function(){o.notificationCenter.off(E.FY.ENTITY.CALL,this._handleCallStateChanged);o.notificationCenter.off(G.FY.VDI_CONNECTED,this._handleVDIConnectedEvent);o.notificationCenter.off(G.FY.VDI_DISCONNECTED,this._handleVDIDisconnectedEvent);o.notificationCenter.off(_.FY.CALL_ACTION_ERROR,this._onCallActionFailed);o.notificationCenter.off(_.FY.RC_NOTIFICATION_INCOMING_CALL,this._handleRCNotificationCalls)};TelephonyAccountController.prototype.getVoipState=function(){return this._rtcAccount.state()};TelephonyAccountController.prototype.getSipProv=function(){return this._rtcAccount.getSipProv()};TelephonyAccountController.prototype.getRtcCallCountStats=function(){return this._rtcAccount.getRtcCallCountStats()};TelephonyAccountController.prototype.refreshProv=function(){return Re(this,void 0,void 0,(function(){return ge(this,(function(e){switch(e.label){case 0:return[4,this._rtcAccount.refreshProv()];case 1:e.sent();return[2]}}))}))};TelephonyAccountController.prototype.getWebPhoneId=function(){var e=this._rtcAccount.getSipProv();if(e&&e.device){return e.device.id}return undefined};TelephonyAccountController.prototype._addControllerToMap=function(e,t){this._callControllerMap.set(e,t)};TelephonyAccountController.prototype._removeControllerFromMap=function(e){this._clearCallGroupInfo(e);this._callControllerMap.delete(e);E.CallDataUtils.getInstance().deleteCallEntity(e)};TelephonyAccountController.prototype.switchCall=function(e,t){return Re(this,void 0,void 0,(function(){var n,o,r,i,a,l,s,c,u,p,_,C;return ge(this,(function(f){switch(f.label){case 0:n=t.to,o=t.toName,r=t.from,i=t.fromName,a=t.direction,l=t.sipData,s=t.id,c=t.onBehalfOf;u=l.fromTag,p=l.toTag;_=a===h.CALL_DIRECTION.OUTBOUND;C={replacesCallId:s,replacesFromTag:u,replacesToTag:p,replaceName:_?o:i,replaceNumber:_?n:r,callDirection:a};ye.log("make switch call",(0,d.sensitive)(C,["replaceName","replaceNumber"]));return[4,this._makeCallInternal({toNumber:e,isSwitchCall:true,options:C,delegatorExtensionId:c})];case 1:return[2,f.sent()]}}))}))};TelephonyAccountController.prototype._checkInternetConnection=function(){var e=a.Pal.instance.networkStatus();if(!(e&&e.getStatus())){return i.HI.NO_INTERNET_CONNECTION}return i.HI.NO_ERROR};TelephonyAccountController.prototype._makeCallInternal=function(e){return Re(this,void 0,void 0,(function(){var t,n,o,r,a,l,s,c;return ge(this,(function(u){switch(u.label){case 0:t=e.toNumber,n=e.isSwitchCall,o=e.options,r=e.delegatorExtensionId;return[4,this.makeCallController.tryMakeCall(t,n,o)];case 1:a=u.sent(),l=a.errCode,s=a.call,c=a.callController;if(!(l===i.HI.NO_ERROR&&c&&s))return[3,3];return[4,this._setCall({callController:c,rtcCall:s,isSwitchCall:n,callOption:o,delegatorExtensionId:r})];case 2:u.sent();this._recordCallGroupInfo(c.getEntityId(),o);u.label=3;case 3:return[2,l]}}))}))};TelephonyAccountController.prototype._recordCallGroupInfo=function(e,t){if(t===null||t===void 0?void 0:t.callGroupInfo){var n=t===null||t===void 0?void 0:t.callGroupInfo;var o=this._callGroupInfos.find((function(e){var n;return e.type===((n=t.callGroupInfo)===null||n===void 0?void 0:n.callGroupType)&&e.callIds.has(t.callGroupInfo.fromCallId)}));if(o){o.callIds.add(e)}else{this._callGroupInfos.push({fromCallId:n.fromCallId,type:n.callGroupType,callIds:new Set([e,n.fromCallId])})}this._notifyCallGroupChanged()}};TelephonyAccountController.prototype._holdActiveCall=function(){var e=this._getActiveCallControllers(),t=e.controllers,n=e.callIds;ye.log("Trying to hold active call",n);return this._holdActiveCallByCalls(t.filter((function(e){return!e.isOnHold()})))};TelephonyAccountController.prototype._holdActiveCallByCalls=function(e){return Re(this,void 0,void 0,(function(){return ge(this,(function(t){switch(t.label){case 0:return[4,Promise.all(e.map((function(e){var t;return(t=e.getCallActionController())===null||t===void 0?void 0:t.hold()})))];case 1:t.sent();return[2]}}))}))};TelephonyAccountController.prototype._createRCConferenceCall=function(e){return Re(this,void 0,Promise,(function(){var t,n,o,r,a,l,s,c;return ge(this,(function(u){switch(u.label){case 0:t=e.hostCode,n=e.phoneNumber;if(this._checkInternetConnection()!==i.HI.NO_ERROR){return[2,Promise.reject(d.RESPONSE_STATUS_CODE.NETWORK_ERROR)]}return[4,this._holdActiveCall()];case 1:u.sent();o={accessCode:t,extraCall:true};return[4,this.makeCallController.tryMakeCall(n,false,o)];case 2:r=u.sent(),a=r.errCode,l=r.call,s=r.callController;if(!(a===i.HI.NO_ERROR&&s&&l))return[3,5];return[4,this._getConferenceIdByHostCode(e.hostCode)];case 3:c=u.sent();return[4,this._setCall({callController:s,rtcCall:l,isSwitchCall:false,callOption:o,delegatorExtensionId:this._currentUserExtId,confInfo:{is_host:true,participant_code:e.participantCode,host_code:e.hostCode,dynamic_conf_id:c}})];case 4:u.sent();return[2,s];case 5:return[2,Promise.reject(a)]}}))}))};TelephonyAccountController.prototype.getMergeCallConfirm=function(){return!!this._telephonyConfig.getMergeCallConfirm()};TelephonyAccountController.prototype.setMergeCallConfirm=function(){return this._telephonyConfig.setMergeCallConfirm()};TelephonyAccountController.prototype.getLastActivatedCallId=function(){var e;return(e=this._getLastActivatedCallController())===null||e===void 0?void 0:e.getEntityId()};TelephonyAccountController.prototype.mergeCall=function(e){var t=this._shouldUseMultiPartyConf(e);if(t){return this._mergeToMultiPartyCall(e)}return this.mergeToRCCCall(e.toMergeCallIds)};TelephonyAccountController.prototype._shouldUseMultiPartyConf=function(e){ye.info("check shouldUseMultiPartyConf",e);var t=e.toMergeCallIds,n=e.targetCallId;var o=false;do{var r=n?this._getCallControllerById(n):undefined;if(!(r===null||r===void 0?void 0:r.isMultiPartyConfCall())){var i=this._getLastActivatedCallController((function(e){return e.isMyHostRCConferenceCall()}));if(i){ye.info("has user hosted rcc call");break}}if(this._hasNeedMergeToRCCCalls(ve(t))){ye.info("call type not allow to MPC");break}o=true}while(false);ye.info("shouldUseMultiPartyConf:",{useMultiPartyConf:o});return o};TelephonyAccountController.prototype._hasNeedMergeToRCCCalls=function(e){var t=this;var n=e.map((function(e){return t._getCallControllerById(e)}));return n.some((function(e){return(e===null||e===void 0?void 0:e.isCallByCallOnBehalf())||(e===null||e===void 0?void 0:e.isMyHostRCConferenceCall())||(e===null||e===void 0?void 0:e.isPickUpCall())||(e===null||e===void 0?void 0:e.isTakeOverCall())}))};TelephonyAccountController.prototype.mergeToRCCCall=function(e,t){return Re(this,void 0,void 0,(function(){var n,o,r,i,a,l,s,c;var u=this;return ge(this,(function(p){switch(p.label){case 0:return[4,this._getOrCreateRCConference()];case 1:n=p.sent(),o=n.participantCode,r=n.phoneNumber,i=n.isInitialCall,a=n.conferenceCallController;if(!a){ye.error("can not merge call because cannot getOrCreate conferenceCallController");q.t.doErrorTrackingInCommon(_.oy.MERGE+"_GET_OR_CREATE_CONFERENCE_CALL_CONTROLLER_FAIL",{toMergeCallIds:e,phoneNumber:r,participantCode:o,isInitialCall:i},["phoneNumber"]);return[2,Promise.reject(d.RESPONSE_STATUS_CODE.DEFAULT)]}l=a.getCallActionController();if(!l){ye.error("can not merge call because target does not exist");q.t.doErrorTrackingInCommon(_.oy.MERGE+"_TARGET_NOT_EXIST",{toMergeCallIds:e,phoneNumber:r,participantCode:o,isInitialCall:i},["phoneNumber"]);return[2,Promise.reject(d.RESPONSE_STATUS_CODE.DEFAULT)]}s=e.map((function(e){return u._getCallActionController(e)})).filter((function(e){return e}));c=l.mergeCalls({toMergeActionControllers:s,isInitialCall:i,participantCode:o||"",phoneNumber:r||"",skipNotifySuccessResult:t});return[4,(0,d.timeoutPromise)(c,_.UA).catch((function(t){ye.warn("merge call error:",t);q.t.doErrorTrackingInCommon(_.oy.MERGE+"_FAIL",{toMergeCallIds:e,phoneNumber:r,participantCode:o,isInitialCall:i,err:t},["phoneNumber"]);throw t}))];case 2:p.sent();return[2,a.getEntityId()]}}))}))};TelephonyAccountController.prototype._mergeToMultiPartyCall=function(e){var t;return Re(this,void 0,void 0,(function(){var n,o,r,i,a;var l=this;return ge(this,(function(s){switch(s.label){case 0:n=Te({},e);o=!e.targetCallId;if(!!e.targetCallId)return[3,2];ye.info("no target, create new one");r=n;return[4,this._createMultipartConferenceCall()];case 1:r.targetCallId=s.sent();o=true;s.label=2;case 2:i=(t=this._getCallControllerById(n.targetCallId))===null||t===void 0?void 0:t.getCallActionController();a=n.toMergeCallIds.map((function(e){var t;return(t=l._getCallActionController(e))===null||t===void 0?void 0:t.getRTCCall()})).filter((function(e){return e}));if(!i){ye.error("can not merge call because target does not exist");q.t.doErrorTrackingInCommon(_.oy.MERGE+"_TARGET_NOT_EXIST",e,[]);return[2]}return[4,this._holdActiveCall()];case 3:s.sent();return[4,i===null||i===void 0?void 0:i.mergeToMultiPartyCall(a,o)];case 4:s.sent();return[2,n.targetCallId]}}))}))};TelephonyAccountController.prototype._createMultipartConferenceCall=function(){return Re(this,void 0,void 0,(function(){var e,t,n,o,r;return ge(this,(function(a){switch(a.label){case 0:if(this._checkInternetConnection()!==i.HI.NO_ERROR){return[2,Promise.reject(d.RESPONSE_STATUS_CODE.NETWORK_ERROR)]}e=new ae(E.CallDataUtils.getInstance().generateId(),this._getCallEntityFn);o=(n=this._rtcAccount).makeConference;r=[e.createRTCCallDelegate()];return[4,this._canCurrentVersionSupportV2V()];case 1:return[4,o.apply(n,r.concat([a.sent()]))];case 2:t=a.sent();return[4,this._setCall({callController:e,rtcCall:t,isSwitchCall:false})];case 3:a.sent();return[2,e.getEntityId()]}}))}))};TelephonyAccountController.prototype._getOrCreateRCConference=function(){return Re(this,void 0,void 0,(function(){var e,t,n,r,i;return ge(this,(function(a){switch(a.label){case 0:e={isInitialCall:false};e.conferenceCallController=this._getLastActivatedCallController((function(e){return e.isMyHostRCConferenceCall()}));if(!!e.conferenceCallController)return[3,4];ye.info("do not find confCall, create by rcConference");e.isInitialCall=true;return[4,(0,o.getModule)(l.gj).getRCConferenceRemoteAndLocal()];case 1:t=a.sent();n=t;if(!n)return[3,3];r=e;return[4,this._createRCConferenceCall(t)];case 2:n=r.conferenceCallController=a.sent();a.label=3;case 3:n;a.label=4;case 4:if(e.conferenceCallController){i=e.conferenceCallController.getConferenceInfo();e.hostCode=i===null||i===void 0?void 0:i.host_code;e.participantCode=i===null||i===void 0?void 0:i.participant_code;e.phoneNumber=e.conferenceCallController.getCallToNumber();e.callId=e.conferenceCallController.getEntityId()}return[2,e]}}))}))};TelephonyAccountController.prototype.getOrCreateRCConferenceForAddPeople=function(){return Re(this,void 0,Promise,(function(){var e,t,n;return ge(this,(function(o){switch(o.label){case 0:return[4,this._getOrCreateRCConference()];case 1:e=o.sent(),t=e.hostCode,n=e.callId;return[2,{hostCode:t,callId:n}]}}))}))};TelephonyAccountController.prototype.makeCall=function(e,t){return Re(this,void 0,Promise,(function(){var n,o;var r=this;return ge(this,(function(a){switch(a.label){case 0:n=this.makeCallController.checkMaxCallCount();if(n===i.HI.CALL_COUNT_OVER_LIMIT){return[2,n]}a.label=1;case 1:a.trys.push([1,3,,4]);return[4,this._raceOperation({action:function(){return r._holdActiveCall()},actionCode:_.iy.HOLD},{action:function(){return r._makeCallInternal({toNumber:e,isSwitchCall:false,options:t})},actionCode:_.iy.MAKE_CALL})];case 2:return[2,a.sent()];case 3:o=a.sent();o.code===_.iy.HOLD&&q.t.doErrorTrackingInCommon(_.oy.MAKE_CALL+"_"+_.iy.HOLD,{toNumber:e,callOptions:t},ve(["toNumber"],_.my));return[2,o.code===_.iy.HOLD?i.HI.HOLD_CURRENT_ACTIVE_CALL_ERROR:i.HI.NO_ERROR];case 4:return[2]}}))}))};TelephonyAccountController.prototype.monitorBLFCall=function(e,t){return Re(this,void 0,void 0,(function(){var n,o,r,i,a,l,s;return ge(this,(function(c){switch(c.label){case 0:return[4,this._holdActiveCall()];case 1:c.sent();return[4,this.makeCallController.tryMonitorBLFCall(e,t)];case 2:n=c.sent(),o=n.rtcCall,r=n.callController;i=this._getRealFromAndToFromBFLCall(e,t),a=i.from,l=i.to;s={monitorState:E.MONITOR_STATE.MONITORING,monitoredCall:{direction:t.direction,from:a,fromName:t.fromName,to:l,toName:t.toName}};return[4,this._setCall({callController:r,rtcCall:o,isSwitchCall:false,blfInfo:s})];case 3:c.sent();return[2]}}))}))};TelephonyAccountController.prototype._getCallControllerById=function(e){var t=this._callControllerMap.get(e);if(t){return t}ye.warn("No call controller found for call: "+e);return null};TelephonyAccountController.prototype._getCallControllerByClientRefId=function(e){return Array.from(this._callControllerMap.values()).find((function(t){return t.getClientRefId()===e}))};TelephonyAccountController.prototype.hangUp=function(e){var t;(t=this._getCallActionController(e))===null||t===void 0?void 0:t.hangUp()};TelephonyAccountController.prototype.reject=function(e){var t;ye.info("call rejected",e);(t=this._getCallActionController(e))===null||t===void 0?void 0:t.reject()};TelephonyAccountController.prototype.mute=function(e){var t;(t=this._getCallActionController(e))===null||t===void 0?void 0:t.mute()};TelephonyAccountController.prototype.unmute=function(e){var t;(t=this._getCallActionController(e))===null||t===void 0?void 0:t.unmute()};TelephonyAccountController.prototype.hold=function(e){var t;return(t=this._getCallActionController(e))===null||t===void 0?void 0:t.hold()};TelephonyAccountController.prototype.unhold=function(e){var t=this;if(!(0,_.Gg)())return Promise.reject(i.q$.NOT_NETWORK);return new Promise((function(n,o){var r=new(function(){function class_1(e){this._controller=e}class_1.prototype.name=function(){return Ae+"_"+Date.now()};class_1.prototype.process=function(){var t,r,i;return Re(this,void 0,void 0,(function(){var a,l,s;var c=this;return ge(this,(function(u){switch(u.label){case 0:a=this._controller._getActiveCallControllers().controllers.filter((function(e){return!e.isOnHold()}));l=this._controller._getCallControllerById(e);(t=l===null||l===void 0?void 0:l.getCallActionController())===null||t===void 0?void 0:t.updateCallHoldState(E.HOLD_STATE.IDLE);u.label=1;case 1:u.trys.push([1,3,,4]);return[4,this._controller._raceOperation({action:function(){return c._controller._holdActiveCallByCalls(a)},actionCode:_.iy.HOLD},{action:function(){return Re(c,void 0,void 0,(function(){var t,n;return ge(this,(function(o){switch(o.label){case 0:return[4,(n=(t=this._controller._getCallControllerById(e))===null||t===void 0?void 0:t.getCallActionController())===null||n===void 0?void 0:n.unhold()];case 1:o.sent();return[2]}}))}))},actionCode:_.iy.UNHOLD})];case 2:u.sent();n();return[2,true];case 3:s=u.sent();(i=(r=this._controller._getCallControllerById(e))===null||r===void 0?void 0:r.getCallActionController())===null||i===void 0?void 0:i.updateCallHoldState(E.HOLD_STATE.HELD);o(s);q.t.doErrorTrackingInCommon(_.oy.UNHOLD+"_FAIL",{callId:e,error:s},[]);return[2,false];case 4:return[2]}}))}))};return class_1}())(t);t._unHoldActionQueue.addProcessor(r)}))};TelephonyAccountController.prototype.startRecord=function(e){var t;return(t=this._getCallActionController(e))===null||t===void 0?void 0:t.startRecord()};TelephonyAccountController.prototype.stopRecord=function(e){var t;return(t=this._getCallActionController(e))===null||t===void 0?void 0:t.stopRecord()};TelephonyAccountController.prototype.dtmf=function(e,t){var n;(n=this._getCallActionController(e))===null||n===void 0?void 0:n.dtmf(t)};TelephonyAccountController.prototype.answer=function(e){return this._answerInternal(e)};TelephonyAccountController.prototype.addCallPromotedToRCVListener=function(e,t){var n;(n=this._getCallActionController(e))===null||n===void 0?void 0:n.addCallPromotedToRCVListener(t)};TelephonyAccountController.prototype.removeCallPromotedToRCVListener=function(e,t){var n;(n=this._getCallActionController(e))===null||n===void 0?void 0:n.removeCallPromotedToRCVListener(t)};TelephonyAccountController.prototype.sendToVoiceMail=function(e){var t;(t=this._getCallActionController(e))===null||t===void 0?void 0:t.sendToVoiceMail()};TelephonyAccountController.prototype.park=function(e,t){return Re(this,void 0,void 0,(function(){var n,o,r;return ge(this,(function(i){switch(i.label){case 0:n=this._getCallActionController(e);if(!n){return[2]}if(!t)return[3,2];o=n.getRTCCall().getCallInfo().sessionId;return[4,n.parkToLocation(q.t.buildParkLocationId(t))];case 1:r=i.sent();this._recordRecentParkedSessionId(o);return[2,r];case 2:return[2,n.park()]}}))}))};TelephonyAccountController.prototype._recordRecentParkedSessionId=function(e){if(this._recentParkedSessionIds.includes(e)){return}this._recentParkedSessionIds.length>=me&&this._recentParkedSessionIds.pop();this._recentParkedSessionIds.unshift(e)};TelephonyAccountController.prototype.flip=function(e,t){var n;return(n=this._getCallActionController(e))===null||n===void 0?void 0:n.flip(t)};TelephonyAccountController.prototype.forward=function(e,t){var n;return(n=this._getCallActionController(e))===null||n===void 0?void 0:n.forward(t)};TelephonyAccountController.prototype.transfer=function(e,t,n){var o;return(o=this._getCallActionController(e))===null||o===void 0?void 0:o.transfer(t,n)};TelephonyAccountController.prototype.ignore=function(e){var t;var n=this._getCallControllerById(e);if(n===null||n===void 0?void 0:n.isBLFCall()){this._updateBLFCallIgnoreInfo(e)}else{(t=this._getCallActionController(e))===null||t===void 0?void 0:t.ignore()}};TelephonyAccountController.prototype.answerAndHold=function(e){return Re(this,void 0,void 0,(function(){var t=this;return ge(this,(function(n){switch(n.label){case 0:return[4,this._raceOperation({action:function(){return t._holdActiveCall()},actionCode:_.iy.HOLD},{action:function(){return t._answerInternal(e)},actionCode:_.iy.ANSWER})];case 1:n.sent();return[2]}}))}))};TelephonyAccountController.prototype.answerAndEnd=function(e){var t=this._getActiveCallControllers().controllers;t.map((function(e){var t;return(t=e.getCallActionController())===null||t===void 0?void 0:t.hangUp()}));return this._answerInternal(e)};TelephonyAccountController.prototype._getExtensionIdByCaller=function(e,t){return Re(this,void 0,void 0,(function(){var n;return ge(this,(function(o){switch(o.label){case 0:return[4,this._phoneContactModule.matchPhoneContact(H.PhoneContactUtils.buildPhoneContactId({phoneNumber:e,displayName:t}))];case 1:n=o.sent();return[2,n&&this._contactModule.getExtensionIdByContactId(n)]}}))}))};TelephonyAccountController.prototype._assembleCallInfo=function(e,t){return Re(this,void 0,Promise,(function(){var n,o,r;return ge(this,(function(i){switch(i.label){case 0:n=q.t.isGCPPickupTarget(e.pickupTarget)||q.t.isQCPPickupTarget(e.pickupTarget)?e.pickupTarget:t;if(!(q.t.isQCPPickupTarget(e.pickupTarget)||q.t.isGCPPickupTarget(e.pickupTarget)))return[3,2];return[4,this._getExtensionIdByCaller(e.to,e.toName)];case 1:r=i.sent();return[3,3];case 2:r=e.sourceExtension;i.label=3;case 3:o=r;return[2,Te(Te(Te({},e),n?this._getRealFromAndToFromBFLCall(n,e):{}),{sourceExtension:o})]}}))}))};TelephonyAccountController.prototype.pickUpBLFCall=function(e,t){return Re(this,void 0,void 0,(function(){var n,o;return ge(this,(function(r){switch(r.label){case 0:return[4,this._assembleCallInfo(e,t)];case 1:n=r.sent();o=this._getMatchedCallControllerByCallInfo(n);if(!o)return[3,3];return[4,o.updateRCNotificationCall(n,true)];case 2:r.sent();return[3,5];case 3:this._assertCallLimitation();return[4,this._setRCNotificationCall(n,true)];case 4:o=r.sent();r.label=5;case 5:ye.log("pickUpBLFCall",n);return[2,this._pickUpBLFCallByCallController(o)]}}))}))};TelephonyAccountController.prototype._answerInternal=function(e){var t;return Re(this,void 0,void 0,(function(){var n,o,r,i,a;return ge(this,(function(l){switch(l.label){case 0:n=this._getCallControllerById(e);if(!n)return[3,6];if(!n.isBLFCall())return[3,2];return[4,this._pickUpBLFCallByCallController(n)];case 1:l.sent();return[3,6];case 2:if(!((t=this._getCallActionController(e))===null||t===void 0))return[3,3];o=void 0;return[3,5];case 3:i=(r=t).answer;a={};return[4,this._canCurrentVersionSupportV2V()];case 4:o=i.apply(r,[(a.canPromoteToVideo=l.sent(),a)]);l.label=5;case 5:o;l.label=6;case 6:return[2]}}))}))};TelephonyAccountController.prototype._pickUpBLFCallByCallController=function(e){return Re(this,void 0,void 0,(function(){var t,n,o,r;return ge(this,(function(i){switch(i.label){case 0:return[4,this._holdActiveCall()];case 1:i.sent();t=this._getCallEntityFn(e.getEntityId());o=(n=this.makeCallController).tryPickUpBLFCall;r={partyId:t.party_id,pickUpCallId:t.session_id,pickUpToTag:t.from_tag,pickUpFromTag:t.to_tag};return[4,this._canCurrentVersionSupportV2V()];case 2:return[4,o.apply(n,[(r.canPromoteToVideo=i.sent(),r),e,t.direction===h.CALL_DIRECTION.OUTBOUND?t.from_num:t.to_num])];case 3:i.sent();return[2]}}))}))};TelephonyAccountController.prototype._raceOperation=function(e,t){return Re(this,void 0,Promise,(function(){var n,o,r;return ge(this,(function(i){switch(i.label){case 0:n=false;i.label=1;case 1:i.trys.push([1,4,,5]);return[4,Promise.race([e.action().catch((function(e){return e})),new Promise((function(e){setTimeout((function(){return e()}),_.mf)}))])];case 2:o=i.sent();if(o instanceof Error){n=true;throw o}return[4,t.action()];case 3:return[2,i.sent()];case 4:r=i.sent();ye.log("multiple action failed",r);throw new he(n?e.actionCode:t.actionCode,{rawError:r});case 5:return[2]}}))}))};TelephonyAccountController.prototype.startReply=function(e){var t;(t=this._getCallActionController(e))===null||t===void 0?void 0:t.startReply()};TelephonyAccountController.prototype.replyWithMessage=function(e,t){var n;(n=this._getCallActionController(e))===null||n===void 0?void 0:n.replyWithMessage(t)};TelephonyAccountController.prototype.replyWithPattern=function(e,t,n,o){var r;(r=this._getCallActionController(e))===null||r===void 0?void 0:r.replyWithPattern(t,n,o)};TelephonyAccountController.prototype.onAccountStateChanged=function(e){if(e===u.RTC_ACCOUNT_STATE.REGISTERED){this._vdiVendorName="";o.notificationCenter.emit(_.FY.RTC_ACCOUNT_REGISTERED)}if(this._isRegistrationLimitExceeded&&e===u.RTC_ACCOUNT_STATE.REGISTERED){this._isRegistrationLimitExceeded=false;o.notificationCenter.emit(_.FY.REGISTRATION_LIMIT_EXCEEDED,i.WL.NORMAL)}};TelephonyAccountController.prototype.onVdiReRegister=function(e,t){this._vdiVendorName=t};TelephonyAccountController.prototype.onUserAgentForbidden=function(){ye.log("User agent forbidden");this._removeEndpointId();if(!this._isRegistrationLimitExceeded){this._isRegistrationLimitExceeded=true;o.notificationCenter.emit(_.FY.REGISTRATION_LIMIT_EXCEEDED,i.WL.EXCEEDED)}};TelephonyAccountController.prototype.isRegistrationLimitExceeded=function(){return this._isRegistrationLimitExceeded};TelephonyAccountController.prototype.getRegistrationVdiVendorName=function(){return this._vdiVendorName};TelephonyAccountController.prototype.onAskForCallQualityFeedback=function(e){o.notificationCenter.emitKVChange(_.TM,e)};TelephonyAccountController.prototype.onNoAudioStateEvent=function(e,t){this._telephonyEventLogController.reportNoAudioStateEvent(t)};TelephonyAccountController.prototype.onNoAudioDataEvent=function(e,t){this._telephonyEventLogController.reportNoAudioDataEvent(t)};TelephonyAccountController.prototype.onProvisioningFailed=function(e,t){ye.log("onProvisioningFailed triggered. response code: "+e+" error code: "+t);var n=t&&_.gE.includes(t);if(n){ye.log("Provisioning failed");this._removeEndpointId()}};TelephonyAccountController.prototype._removeEndpointId=function(){ye.log("should remove endpoint id");r.Lh.removeEndpointId()};TelephonyAccountController.prototype._shouldShowIncomingCall=function(){return Re(this,void 0,void 0,(function(){var e,t;return ge(this,(function(n){switch(n.label){case 0:e=false;n.label=1;case 1:return[4,this._rcInfoModule.isVoipCallingAvailable()];case 2:if(!n.sent()){ye.warn("voip feature permission is not enabled");return[3,5]}return[4,this.makeCallController.isDefaultPhoneApp()];case 3:t=n.sent();if(!t){ye.log("Jupiter is not default phone app");return[3,5]}if(this.getCallCount()>=_.cG){ye.log("over max call count");return[3,5]}e=true;n.label=4;case 4:if(false){}n.label=5;case 5:return[2,e]}}))}))};TelephonyAccountController.prototype._setCall=function(e){return Re(this,void 0,void 0,(function(){var t,n,o,r,i,a,l,s,c;return ge(this,(function(u){switch(u.label){case 0:t=e.callController,n=e.rtcCall,o=e.isSwitchCall,r=e.callOption,i=e.blfInfo,a=e.delegatorExtensionId,l=e.confInfo,s=e.callOwnerExtensionId,c=e.callInfo;return[4,t.setRtcCall({rtcCall:n,isSwitchCall:o,callOption:r,blfInfo:i,delegatorExtensionId:a,confInfo:l,callOwnerExtensionId:s,callInfo:c})];case 1:u.sent();this._addControllerToMap(t.getEntityId(),t);ye.log("new call set",t.getEntityId());return[2]}}))}))};TelephonyAccountController.prototype.onReceiveIncomingCall=function(e){var t,n,o;return Re(this,void 0,void 0,(function(){var r,a,l,s,c;return ge(this,(function(p){switch(p.label){case 0:ye.log("onReceiveIncomingCall, start",(t=e===null||e===void 0?void 0:e.getCallInfo())===null||t===void 0?void 0:t.uuid);r=(n=e===null||e===void 0?void 0:e.getCallInfo())===null||n===void 0?void 0:n.clientRefId;a=r&&this._getCallControllerByClientRefId(r);ye.log("onReceiveIncomingCall,refId:",r,",isDelegatedCall:",!!a);if(a){a.onReceiveDelegatedIncomingCall(e);return[2]}return[4,this._shouldShowIncomingCall()];case 1:l=p.sent();if(!l){ye.log("onReceiveIncomingCall, ends, should not show call");return[2]}s=this.makeCallController.checkVoipStatus();if(s!==i.HI.NO_ERROR){return[2]}if(e.getCallState()===u.RTC_CALL_STATE.DISCONNECTED){ye.info("Call: "+e.getCallInfo().uuid+" is disconnected already, no need to create call");return[2]}c=new ae(E.CallDataUtils.getInstance().generateId(),this._getCallEntityFn);return[4,this._setCall({callController:c,rtcCall:e,isSwitchCall:false})];case 2:p.sent();ye.log("onReceiveIncomingCall, ends, set rtc call",c===null||c===void 0?void 0:c.getEntityId(),(o=e===null||e===void 0?void 0:e.getCallInfo())===null||o===void 0?void 0:o.uuid);return[2]}}))}))};TelephonyAccountController.prototype.getCallCount=function(){return this._callControllerMap.size};TelephonyAccountController.prototype.getCallIdList=function(){return ve(this._callControllerMap.keys())};TelephonyAccountController.prototype.onReceiveSipProv=function(e,t){ye.debug("onReceiveSipProv");return this._e911Module.onReceiveSipProv(e,t)};TelephonyAccountController.prototype.onReceiveNewProvFlags=function(e){ye.debug("onReceiveNewProvFlags",e)};TelephonyAccountController.prototype._processLogoutIfNeeded=function(){if(this._isDisposing&&this._rtcAccount.callCount()===1){ye.info("processing logout request");this._rtcAccount.logout();this._isDisposing=false;if(this._logoutCallback){this._logoutCallback()}this._unSubscribeNotifications()}};TelephonyAccountController.prototype.logout=function(e){var t=this._rtcAccount.callCount();this._logoutCallback=e;if(t>0){this._isDisposing=true}else{this._rtcAccount.logout();if(this._logoutCallback){this._logoutCallback()}this._unSubscribeNotifications()}};TelephonyAccountController.prototype.promoteToVideo=function(e){var t;return Re(this,void 0,void 0,(function(){var n,o;return ge(this,(function(r){switch(r.label){case 0:return[4,(t=this._getCallActionController(e))===null||t===void 0?void 0:t.promoteToVideo({rcv:{}})];case 1:n=r.sent();o=this.responseParser.parse(n);if(o){q.t.doErrorTrackingInCommon(_.oy.PROMOTE_TO_VIDEO+"_FAIL",{callId:e,error:o},[]);throw o}return[2]}}))}))};TelephonyAccountController.prototype.getCallGroupByCallId=function(e){return this._callGroupInfos.find((function(t){return t.callIds.has(e)}))};Object.defineProperty(TelephonyAccountController.prototype,"responseParser",{get:function(){if(!this._responseParser){this._responseParser=new o.CommonResponseParser}return this._responseParser},enumerable:true,configurable:true});TelephonyAccountController.prototype.isOverMaximumCallLimit=function(){return this.makeCallController.checkMaxCallCount()!==i.HI.NO_ERROR};TelephonyAccountController.prototype._canCurrentVersionSupportV2V=function(){return this.makeCallController.canCurrentVersionSupportV2V()};TelephonyAccountController.prototype.canPromoteCallToMeet=function(){return this.makeCallController.canPromoteCallToMeet()};TelephonyAccountController.prototype._notifyCallGroupChanged=function(){o.notificationCenter.emit(_.FY.CALL_GROUP_CHANGED)};TelephonyAccountController.prototype._getActiveCallControllers=function(){var e=Array.from(this._callControllerMap.values()).reduce((function(e,t){!t.isOnHold()&&t.isActiveCall()&&e.push(t);return e}),[]);return{controllers:e,callIds:e.map((function(e){return e.getEntityId()}))}};TelephonyAccountController.prototype._getLastActivatedCallController=function(e){var t;var n=0;Array.from(this._callControllerMap.values()).find((function(o){if(e&&!e(o)){return false}if(o.isActiveCall()){if(!o.isOnHold()){t=o;return true}var r=o.lastHoldTime();if(r>n){n=r;t=o}}return false}));return t};TelephonyAccountController.prototype._getCallActionController=function(e){var t=this._getCallControllerById(e);var n=t===null||t===void 0?void 0:t.getCallActionController();if(!n){ye.trace("call action controller not exist",e)}return n};TelephonyAccountController.prototype._handleRCNotificationCallInQueue=function(e){var t=this;return this._handleRCNotificationCallQueue.execute((function(){return Re(t,void 0,void 0,(function(){var t;return ge(this,(function(n){switch(n.label){case 0:n.trys.push([0,2,,3]);return[4,this._handleRCNotificationCall(e)];case 1:n.sent();return[3,3];case 2:t=n.sent();q.t.doErrorTrackingInCommon(_.oy.HANDLE_NOTIFICATION_CALL+"_FAIL",e,_.FN);ye.warn("_handleRCNotificationCallsInQueue with error",t);return[3,3];case 3:return[2]}}))}))}))};TelephonyAccountController.prototype._handleRCNotificationCall=function(e){return Re(this,void 0,void 0,(function(){var t,n,o;return ge(this,(function(r){switch(r.label){case 0:if(this._isIgnoredNotificationCall(e)){return[2]}return[4,this._assembleCallInfo(e)];case 1:t=r.sent();n=this._getMatchedCallControllerByCallInfo(t);o=t.telephonyStatus===h.TELEPHONY_STATUS.Ringing;if(n&&n.isBLFCall()&&!o){this._disconnectBLFCall(n)}if(!(!n&&o))return[3,5];return[4,this._shouldShowIncomingCall()];case 2:if(!r.sent())return[3,4];return[4,this._setRCNotificationCall(t)];case 3:r.sent();return[3,5];case 4:ye.debug("_handleRCNotificationCalls, should not show incoming call");r.label=5;case 5:return[2]}}))}))};TelephonyAccountController.prototype._disconnectBLFCall=function(e){e.updateCallToDisconnecting();e.disconnectCall();this._removeControllerFromMap(e.getEntityId())};TelephonyAccountController.prototype._setRCNotificationCall=function(e,t){if(t===void 0){t=false}return Re(this,void 0,void 0,(function(){var n,o;return ge(this,(function(r){switch(r.label){case 0:n=E.CallDataUtils.getInstance().generateId();o=new ae(n,this._getCallEntityFn);return[4,o.setRCNotificationCall(e,t)];case 1:r.sent();this._addControllerToMap(n,o);return[2,o]}}))}))};TelephonyAccountController.prototype._getMatchedCallControllerByCallInfo=function(e){var t=this;if(!this._callControllerMap.size){return undefined}var n=Array.from(this._callControllerMap.values()).map((function(e){return t._getCallEntityFn(e.getEntityId())})).filter((function(e){return e}));var o=n.find((function(n){return t._getIsSameCallForBLF(n,e)}));return o&&this._getCallControllerById(o.id)};TelephonyAccountController.prototype._getIsSameCallForBLF=function(e,t){return e.session_id===t.telephonySessionId&&(e.is_blf_call&&e.direction===t.direction||!e.is_blf_call)};TelephonyAccountController.prototype._isIgnoredNotificationCall=function(e){return!!this._ignoredBLFCallList.find((function(t){return h.CallUtils.isSameCall(t,h.CallUtils.activeCall2UniqueCallInfo(e))}))};TelephonyAccountController.prototype._updateBLFCallIgnoreInfo=function(e){var t=this._getCallEntityFn(e);if(t){this._addBLFCallToIgnoreList(t);var n=this._getCallControllerById(t.id);n&&this._disconnectBLFCall(n)}};TelephonyAccountController.prototype._addBLFCallToIgnoreList=function(e){var t=q.t.callEntity2UniqueCallInfo(e);var n=this._ignoredBLFCallList.some((function(e){return h.CallUtils.isSameCall(e,t)}));if(!n){this._ignoredBLFCallList.unshift(t);if(this._ignoredBLFCallList.length>_.ug){this._ignoredBLFCallList.pop()}}};TelephonyAccountController.prototype._getRealFromAndToFromBFLCall=function(e,t){return{from:t.direction===h.CALL_DIRECTION.OUTBOUND?e:t.from,to:t.direction===h.CALL_DIRECTION.INBOUND?e:t.to}};TelephonyAccountController.prototype.whisper=function(e){var t;return(t=this._getCallActionController(e))===null||t===void 0?void 0:t.whisper()};TelephonyAccountController.prototype.barge=function(e){var t;return(t=this._getCallActionController(e))===null||t===void 0?void 0:t.barge()};TelephonyAccountController.prototype.takeOver=function(e){var t;return(t=this._getCallActionController(e))===null||t===void 0?void 0:t.takeOver()};TelephonyAccountController.prototype.getTakeOverConfirm=function(){return Re(this,void 0,void 0,(function(){return ge(this,(function(e){switch(e.label){case 0:return[4,this._telephonyConfig.getTakeOverConfirm()];case 1:return[2,!!e.sent()]}}))}))};TelephonyAccountController.prototype.setTakeOverConfirm=function(){return this._telephonyConfig.setTakeOverConfirm()};TelephonyAccountController.prototype.reportCallQualityFeedback=function(e){var t={event:{type:_.M_,details:{feature:_.M_,data:e}}};this._telephonyEventLogController.reportEvent(t)};TelephonyAccountController.prototype.getFeedbackIssuesList=function(){var e=_.rG.slice();var t=e.length;var n;while(t>1){n=Math.random()*t-->>>0;var o=e[t];e[t]=e[n];e[n]=o}e.push(_.CR.OTHER);return e};TelephonyAccountController.prototype.callOnBehalfOf=function(e,t,n){return Re(this,void 0,void 0,(function(){var o,r,a,l;return ge(this,(function(s){switch(s.label){case 0:return[4,this._holdActiveCall()];case 1:s.sent();return[4,this.makeCallController.tryCallOnBehalfOf(e,t,n)];case 2:o=s.sent(),r=o.rtcCall,a=o.callController,l=o.errorCode;if(!(l===i.HI.NO_ERROR&&r&&a))return[3,4];return[4,this._setCall({callController:a,rtcCall:r,isSwitchCall:false,delegatorExtensionId:e,callOwnerExtensionId:e})];case 3:s.sent();s.label=4;case 4:return[2,l]}}))}))};TelephonyAccountController.prototype.promoteDelegatedCallToConf=function(e){return Re(this,void 0,void 0,(function(){var t,n,o,r,a;return ge(this,(function(l){switch(l.label){case 0:return[4,this._holdActiveCall()];case 1:l.sent();return[4,this.makeCallController.tryPromoteDelegatedCallToConf(e.telephonySessionId,this._currentUserExtensionId,e.hostCode,e.participantCode)];case 2:t=l.sent(),n=t.rtcCall,o=t.callController,r=t.errorCode;if(!(r===i.HI.NO_ERROR&&n&&o))return[3,4];a={participant_code:e.participantCode,host_code:e.hostCode,dynamic_conf_id:e.dynamicConferenceId,is_host:true};return[4,this._setCall({callController:o,rtcCall:n,isSwitchCall:false,confInfo:a,delegatorExtensionId:e.onBehalfOf||this._currentUserExtensionId})];case 3:l.sent();l.label=4;case 4:return[2,r]}}))}))};Object.defineProperty(TelephonyAccountController.prototype,"_rcInfoModule",{get:function(){return(0,o.getModule)(l.gj)},enumerable:true,configurable:true});Object.defineProperty(TelephonyAccountController.prototype,"_currentUserExtensionId",{get:function(){return(0,r.gT)().userConfig.getExtensionId().toString()},enumerable:true,configurable:true});TelephonyAccountController.prototype.makeConference=function(e){return Re(this,void 0,Promise,(function(){var t,n,o,r,a,l,s,c,u,p,C,f,d;return ge(this,(function(T){switch(T.label){case 0:return[4,this._holdActiveCall()];case 1:T.sent();t=e.toNumber,n=e.delegatorExtensionId,o=e.isHost,r=e.hostCode,a=e.participantCode;l=o?r:a;s=Te(Te({},e.options),{rcTapRcc:{accessCode:l,sessionData:_.Lj+this._currentUserExtensionId,skipShortPrtsPin:true},accessCodeType:h.ACCESS_CODE_TYPE.HEADER});return[4,this.makeCallController.tryMakeCall(t,false,s)];case 2:c=T.sent(),u=c.errCode,p=c.call,C=c.callController;d=o&&r;if(!d)return[3,4];return[4,this._getConferenceIdByHostCode(r)];case 3:d=T.sent();T.label=4;case 4:f=d;if(!(u===i.HI.NO_ERROR&&C&&p))return[3,6];return[4,this._setCall({callController:C,rtcCall:p,isSwitchCall:false,callOption:s,delegatorExtensionId:n||this._currentUserExtensionId,confInfo:{participant_code:a,host_code:r,dynamic_conf_id:f,is_host:o}})];case 5:T.sent();T.label=6;case 6:return[2,u]}}))}))};TelephonyAccountController.prototype.pickUpParkLocation=function(e){return Re(this,void 0,void 0,(function(){var t,n,o,r,a,l,s;return ge(this,(function(c){switch(c.label){case 0:this._assertCallLimitation();return[4,this._holdActiveCall()];case 1:c.sent();n={pickUpCallId:e.telephonySessionId,pickUpToTag:e.fromTag,pickUpFromTag:e.toTag};return[4,this._canCurrentVersionSupportV2V()];case 2:t=(n.canPromoteToVideo=c.sent(),n);return[4,this.makeCallController.tryPickUpParkLocation(e.parkLocationId,t)];case 3:o=c.sent(),r=o.errorCode,a=o.rtcCall,l=o.callController;if(r===i.HI.NO_ERROR&&l&&a){s=Te(Te({},a.getCallInfo()),{toNum:e.destinationNumber,toName:e.displayName});this._setCall({callController:l,rtcCall:a,isSwitchCall:false,callOption:t,callInfo:s})}else{q.t.doErrorTrackingInCommon(_.oy.PICK_UP+"_"+r,e,_.V$);throw new h.JRCError(r,r)}return[2]}}))}))};TelephonyAccountController.prototype.getRecentParkedSessionIds=function(){return this._recentParkedSessionIds};TelephonyAccountController.prototype._assertCallLimitation=function(){if(this.makeCallController.checkMaxCallCount()===i.HI.CALL_COUNT_OVER_LIMIT){q.t.doErrorTrackingInCommon(_.oy.PICK_UP+"_"+i.HI.CALL_COUNT_OVER_LIMIT,{},[]);throw new h.JRCError(i.HI.CALL_COUNT_OVER_LIMIT,i.HI.CALL_COUNT_OVER_LIMIT)}};Object.defineProperty(TelephonyAccountController.prototype,"_currentUserExtId",{get:function(){var e;return(e=(0,r.gT)())===null||e===void 0?void 0:e.userConfig.getExtensionId().toString()},enumerable:true,configurable:true});Object.defineProperty(TelephonyAccountController.prototype,"_getConferenceIdByHostCodeKeyAction",{get:function(){var e=(0,o.getModule)(T.COMMON_KEY_ACTION_MODULE).getKeyActionService().get(T.ACTION_KEY.GET_CONFERENCE_ID_BY_HOST_CODE);if(!e){ye.warn("key action: getConferenceIdByHostCode is not ready")}return e},enumerable:true,configurable:true});Object.defineProperty(TelephonyAccountController.prototype,"_phoneContactModule",{get:function(){return(0,o.getModule)(H.Po)},enumerable:true,configurable:true});Object.defineProperty(TelephonyAccountController.prototype,"_contactModule",{get:function(){return(0,o.getModule)(V.MODULE_NAME)},enumerable:true,configurable:true});TelephonyAccountController.prototype._getConferenceIdByHostCode=function(e){var t;return Re(this,void 0,void 0,(function(){var n,o,r;return ge(this,(function(i){switch(i.label){case 0:o=(t=this._getConferenceIdByHostCodeKeyAction)===null||t===void 0?void 0:t.getAction;if(!o)return[3,2];return[4,this._getConferenceIdByHostCodeKeyAction.getAction()];case 1:o=i.sent();i.label=2;case 2:n=o;r=n;if(!r)return[3,4];return[4,n(e)];case 3:r=i.sent();i.label=4;case 4:return[2,r]}}))}))};Object.defineProperty(TelephonyAccountController.prototype,"_e911Module",{get:function(){return(0,o.getModule)(c.l9)},enumerable:true,configurable:true});return TelephonyAccountController}();var Se=function(){function VoIPDaoClient(e){this._telephonyConfig=e}VoIPDaoClient.prototype.put=function(e,t){this._telephonyConfig.putConfig(e,t)};VoIPDaoClient.prototype.get=function(e){return this._telephonyConfig.getConfig(e)};VoIPDaoClient.prototype.remove=function(e){this._telephonyConfig.removeConfig(e)};return VoIPDaoClient}();var Ne=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var Oe=function(e){Ne(VoIPEvent,e);function VoIPEvent(t,n,o,r){return e.call(this,t,n,o,r)||this}return VoIPEvent}(d.BaseEvent);var be=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var Le=function(e){be(VoIPNoAudioDataEvent,e);function VoIPNoAudioDataEvent(t,n,o,r){return e.call(this,t,n,o,r)||this}return VoIPNoAudioDataEvent}(d.BaseEvent);var De=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var Pe=function(e){De(VoIPNoAudioStateEvent,e);function VoIPNoAudioStateEvent(t,n,o,r){return e.call(this,t,n,o,r)||this}return VoIPNoAudioStateEvent}(d.BaseEvent);var Me=function(){function TelephonyEventLogController(){}TelephonyEventLogController.prototype.reportEvent=function(e){d.dataTracerInstance.traceData(new Oe(e.event.type,e.event.details.feature,e.event.details.data))};TelephonyEventLogController.prototype.reportNoAudioStateEvent=function(e){d.dataTracerInstance.traceData(new Pe(e.event.type,e.event.details.feature))};TelephonyEventLogController.prototype.reportNoAudioDataEvent=function(e){d.dataTracerInstance.traceData(new Le(e.event.type,e.event.details.feature,e.event.details.data))};return TelephonyEventLogController}();var we=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var Fe=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var ke="[TelephonyEngineController]";var Ue=p.k.tags(ke);var Ge=function(){function TelephonyEngineController(e){var t=this;this._telephonyConfig=e;this._preCallingPermission=false;this.onPermissionUpdated=function(){return we(t,void 0,void 0,(function(){var e;return Fe(this,(function(t){switch(t.label){case 0:return[4,this._rcInfoModule.isVoipCallingAvailable()];case 1:e=t.sent();Ue.debug("onPermissionUpdated voipCalling: "+e+" "+this._preCallingPermission);if(e===this._preCallingPermission){Ue.debug("No permission change");return[2]}if(e){this._preCallingPermission=true;this.createAccount();o.notificationCenter.emitKVChange(_.FY.VOIP_CALLING,true)}else{Ue.info("voip calling permission is revoked");this.logout()}return[2]}}))}))};this.voipDaoDelegate=new Se(this._telephonyConfig);this._telephonyEventLogController=new Me;this.subscribeNotifications()}TelephonyEngineController.prototype.subscribeNotifications=function(){this._onCallRecoveryEnabled();this._onCallQualityFeedback();this._onRestrictWebRTCIpPolicy()};Object.defineProperty(TelephonyEngineController.prototype,"_featureFlagModule",{get:function(){return(0,o.getModule)(s.FEATURE_FLAG_MODULE)},enumerable:true,configurable:true});TelephonyEngineController.prototype._onCallRecoveryEnabled=function(){var e=this;this._featureFlagModule.observeFeatureFlag(s.G.USE_CALL_RECOVERY,(function(t){e._handleOnCallRecoveryEnabled(t)}))};TelephonyEngineController.prototype._handleOnCallRecoveryEnabled=function(e){if(e){Ue.info("call recovery is enabled by LD")}this.rtcEngine.setCallRecoveryEnabled(e)};TelephonyEngineController.prototype._onRestrictWebRTCIpPolicy=function(){var e=this;this._featureFlagModule.observeFeatureFlag(s.G.D_USE_RESTRICT_WEBRTC_IP_POLICY,(function(t){e._handleOnRestrictWebRTCIpPolicy(t)}))};TelephonyEngineController.prototype._handleOnRestrictWebRTCIpPolicy=function(e){if(e){Ue.info("restrict webRTC ip policy is enabled by LD")}Ue.debug(e?"Enable restrict WebRTC IP policy":"Disable restrict WebRTC IP policy");var t=e?"default_public_interface_only":"default";a.Pal.instance.getIpc().invoke(_.Gw.SET_WEB_RTC_IP_HANDLING_POLICY,t).catch((function(e){Ue.info("Failed to invoke SET_WEB_RTC_IP_HANDLING_POLICY",e)}))};TelephonyEngineController.prototype._onCallQualityFeedback=function(){var e=this;this._featureFlagModule.observeFeatureFlag(s.G.D_USE_CALL_QUALITY_FEEDBACK,(function(t){return we(e,void 0,void 0,(function(){var e;return Fe(this,(function(n){switch(n.label){case 0:e=t;if(!e)return[3,2];return[4,this._handleOnCallQualityFeedback(t)];case 1:e=n.sent();n.label=2;case 2:e;return[2]}}))}))}))};TelephonyEngineController.prototype._handleOnCallQualityFeedback=function(e){return we(this,void 0,void 0,(function(){var t=this;return Fe(this,(function(n){switch(n.label){case 0:if(!e)return[3,2];return[4,this._getCallQualityFeedbackParams().then((function(e){t.rtcEngine.setCallQualityFeedbackParams(e)}))];case 1:n.sent();n.label=2;case 2:return[2]}}))}))};TelephonyEngineController.prototype._getCallQualityFeedbackParams=function(){return we(this,void 0,Promise,(function(){var e;return Fe(this,(function(t){switch(t.label){case 0:return[4,this._featureFlagModule.getFeatureFlag(s.G.D_USE_CALL_QUALITY_FEEDBACK,true)];case 1:e=t.sent();if(!e){return[2,{enable:false,starLimited:1,enableForSendLog:false,chanceWithCall:.5,chanceNoCall:.5,decreaseRate:.5}]}return[2,{enable:e["enable"],starLimited:e["starLimited"],enableForSendLog:e["enableForSendLog"],chanceWithCall:e["chanceWithCall"],chanceNoCall:e["chanceNoCall"],decreaseRate:e["decreaseRate"]}]}}))}))};TelephonyEngineController.prototype.initEngine=function(){u.RTCEngine.setLogger(new U(this._telephonyEventLogController));this.rtcEngine=u.RTCEngine.getInstance();this.rtcEngine.setNetworkDelegate((0,r.gT)().buildNetworkClient());this.rtcEngine.setTelephonyDaoDelegate(this.voipDaoDelegate)};TelephonyEngineController.prototype.initialTelephony=function(){this._rcInfoModule.DBConfig.on(l.Uz.EXTENSION_INFO,this.onPermissionUpdated)};TelephonyEngineController.prototype.createAccount=function(){return we(this,void 0,void 0,(function(){var e,t,n;return Fe(this,(function(o){switch(o.label){case 0:e=this;return[4,this._rcInfoModule.isVoipCallingAvailable()];case 1:e._preCallingPermission=o.sent();n=(t=this.rtcEngine).setUserInfo;return[4,this.getUserInfo()];case 2:n.apply(t,[o.sent()]);if(this._preCallingPermission&&!this._accountController){Ue.debug("creating telephony account");this._accountController=new Ie(this._telephonyConfig,this._telephonyEventLogController,this.rtcEngine);this._e911Module.initial(this._accountController.getRTCAccount());this._callSwitchController=new M(this._accountController);this._callSwitchController.start();this._accountController.handleProvisioning()}return[2]}}))}))};TelephonyEngineController.prototype.getRtcCallCountStats=function(){return this._accountController.getRtcCallCountStats()};TelephonyEngineController.prototype.getSipProv=function(){return this._accountController.getSipProv()};TelephonyEngineController.prototype.getUserInfo=function(){var e;return we(this,void 0,void 0,(function(){var t,n,o,i;return Fe(this,(function(l){switch(l.label){case 0:t=(0,r.gT)();return[4,this._rcInfoModule.getRCBrandId()];case 1:n=l.sent();return[4,this._rcInfoModule.getRCAccountId()];case 2:o=l.sent();i=t.userConfig.getExtensionId();return[2,{rcBrandId:n,rcAccountId:o,rcExtensionId:i,endpointId:((e=t.userConfig.getToken())===null||e===void 0?void 0:e.endpoint_id)||"",userAgent:a.Pal.instance.getPlatformUtils().buildUserAgentForTelephony()}]}}))}))};Object.defineProperty(TelephonyEngineController.prototype,"_rcInfoModule",{get:function(){return(0,o.getModule)(l.gj)},enumerable:true,configurable:true});TelephonyEngineController.prototype.getAccountController=function(){return this._accountController};TelephonyEngineController.prototype.logout=function(){var e=this;if(this._accountController){this._accountController.logout((function(){e._preCallingPermission=false;o.notificationCenter.emitKVChange(_.FY.VOIP_CALLING,false);delete e._accountController}))}};TelephonyEngineController.prototype.getSwitchCall=function(){var e;return(e=this._callSwitchController)===null||e===void 0?void 0:e.getSwitchCall()};TelephonyEngineController.prototype.hideSwitchCall=function(){var e;return(e=this._callSwitchController)===null||e===void 0?void 0:e.hideSwitchCall()};Object.defineProperty(TelephonyEngineController.prototype,"_e911Module",{get:function(){return(0,o.getModule)(c.l9)},enumerable:true,configurable:true});return TelephonyEngineController}();var He=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var Ve=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var Be=p.k.tags("[RCConferenceInviteController]");var xe=function(){function RCConferenceInviteController(){}Object.defineProperty(RCConferenceInviteController.prototype,"_rcInfoModule",{get:function(){return(0,o.getModule)(l.oF)},enumerable:true,configurable:true});RCConferenceInviteController.prototype.getConferenceInvitationInfo=function(e){return He(this,void 0,Promise,(function(){var t,n,o,i,a,l,s,c;return Ve(this,(function(u){switch(u.label){case 0:return[4,this._rcInfoModule.getRCConferenceRemoteAndLocal()];case 1:t=u.sent();i=t===null||t===void 0?void 0:t.phoneNumbers.find((function(e){return e.phoneNumber===t.phoneNumber}));if(!i)return[3,3];s={country:i.country.name,location:i.location};return[4,this._getCanonical(i.phoneNumber)];case 2:l=[(s.phoneNumber=u.sent(),s)];return[3,4];case 3:l=[];u.label=4;case 4:a=l;c=(0,r.gT)().userConfig.getExtensionId().toString();if(!(c!==e))return[3,6];return[4,this._getParticipantAccessByExtensionId(e)];case 5:o=u.sent();return[3,7];case 6:o=t===null||t===void 0?void 0:t.participantCode;n=t===null||t===void 0?void 0:t.tapToJoinUri;u.label=7;case 7:return[2,{dialInNumberList:a,participantAccess:o,conferenceLink:n}]}}))}))};RCConferenceInviteController.prototype._getCanonical=function(e){return He(this,void 0,Promise,(function(){var t,n;return Ve(this,(function(r){switch(r.label){case 0:t=(0,o.getModule)(j.PHONE_PARSER_MODULE);return[4,t.getPhoneParser(e)];case 1:n=r.sent();return[2,n?n.getCanonical(true):e]}}))}))};RCConferenceInviteController.prototype._getParticipantAccessByExtensionId=function(e){var t;return He(this,void 0,void 0,(function(){var n,o;return Ve(this,(function(r){switch(r.label){case 0:o=(t=this._rcHudKeyAction)===null||t===void 0?void 0:t.getAction;if(!o)return[3,2];return[4,this._rcHudKeyAction.getAction()];case 1:o=r.sent();r.label=2;case 2:n=o;return[2,n&&n(e)]}}))}))};Object.defineProperty(RCConferenceInviteController.prototype,"_rcHudKeyAction",{get:function(){var e=(0,o.getModule)(T.COMMON_KEY_ACTION_MODULE).getKeyActionService().get(T.ACTION_KEY.GET_PARTICIPANT_ACCESS_BY_EXTENSION_ID);if(!e){Be.warn("key action: getParticipantAccessByExtensionId is not ready")}return e},enumerable:true,configurable:true});return RCConferenceInviteController}();var We=n(724773);var je=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var Ye=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var qe=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var Ke=function(e){je(TelephonyService,e);function TelephonyService(){var t=e.call(this)||this;t.replyWithMessage=function(e,n){t.telephonyController.getAccountController().replyWithMessage(e,n)};t.replyWithPattern=function(e,n,o,r){t.telephonyController.getAccountController().replyWithPattern(e,n,o,r)};t.getVoipState=function(){var e=t.telephonyController.getAccountController();return e?e.getVoipState():""};t.getWebPhoneId=function(){var e=t.telephonyController.getAccountController();return e?e.getWebPhoneId():undefined};t.getCallIdList=function(){return t.telephonyController.getAccountController().getCallIdList()};t.getSipProv=function(){return t.telephonyController.getSipProv()};t.getRtcCallCountStats=function(){return t.telephonyController.getRtcCallCountStats()};t.getPhoneSettingInfo=function(){return Ye(t,void 0,void 0,(function(){var e,t;var n=this;var o;return qe(this,(function(r){switch(r.label){case 0:e=(o=this.getSettingManager())===null||o===void 0?void 0:o.getProviderMap();t={};return[4,Promise.all(v.xZ.map((function(o){return Ye(n,void 0,void 0,(function(){var n,r,i;return qe(this,(function(a){switch(a.label){case 0:n=e[o];r=t;i=o;return[4,n.getSettingInfo()];case 1:r[i]=a.sent();return[2]}}))}))})))];case 1:r.sent();return[2,t]}}))}))};t.telephonyController.initEngine();return t}TelephonyService.prototype.onStarted=function(){e.prototype.onStarted.call(this);this.getSettingManager().load();this._initialTelephony()};TelephonyService.prototype.onStopped=function(){this.telephonyController.logout();this.getSettingManager().unload();e.prototype.onStopped.call(this)};Object.defineProperty(TelephonyService.prototype,"telephonyController",{get:function(){if(!this._telephonyEngineController){this._telephonyEngineController=new Ge(this.userConfig)}return this._telephonyEngineController},enumerable:true,configurable:true});Object.defineProperty(TelephonyService.prototype,"rcConferenceInviteController",{get:function(){if(!this._rcConferenceInviteController){this._rcConferenceInviteController=new xe}return this._rcConferenceInviteController},enumerable:true,configurable:true});TelephonyService.prototype.getConferenceInvitationInfo=function(e){return this.rcConferenceInviteController.getConferenceInvitationInfo(e)};TelephonyService.prototype.getSettingManager=function(){if(!this._settingManager){this._settingManager=new v.tR}return this._settingManager};Object.defineProperty(TelephonyService.prototype,"userConfig",{get:function(){if(!this._userConfig){this._userConfig=new We.h}return this._userConfig},enumerable:true,configurable:true});TelephonyService.prototype._initialTelephony=function(){var e=this;var t;(t=(0,r.gT)())===null||t===void 0?void 0:t.onLoginResult((function(t){var n=t.success;if(n){e.telephonyController.initialTelephony();e.telephonyController.createAccount()}}))};TelephonyService.prototype.getAllCallCount=function(){var e=this.telephonyController.getAccountController();return e?e.getCallCount():0};TelephonyService.prototype.isInCall=function(){return this.getAllCallCount()>0};TelephonyService.prototype.setLastCalledNumber=function(e){this.userConfig.setLastCalledNumber(e)};TelephonyService.prototype.getLastActivatedCallId=function(){var e;return(e=this.telephonyController)===null||e===void 0?void 0:e.getAccountController().getLastActivatedCallId()};TelephonyService.prototype.mergeToRCConferenceCall=function(e,t){var n=this.telephonyController.getAccountController();if(n){return this.telephonyController.getAccountController().mergeToRCCCall(e,t)}return Promise.resolve(undefined)};TelephonyService.prototype.mergeCall=function(e){var t=this.telephonyController.getAccountController();if(t){return this.telephonyController.getAccountController().mergeCall(e)}return Promise.resolve(undefined)};TelephonyService.prototype.makeCall=function(e,t){var n=this.telephonyController.getAccountController();if(n){return this.telephonyController.getAccountController().makeCall(e,t)}return Promise.resolve(i.HI.INVALID_STATE)};TelephonyService.prototype.switchCall=function(e,t){var n=this.telephonyController.getAccountController();if(n){return this.telephonyController.getAccountController().switchCall(e,t)}return Promise.resolve(i.HI.INVALID_STATE)};TelephonyService.prototype.hangUp=function(e){return this.telephonyController.getAccountController().hangUp(e)};TelephonyService.prototype.reject=function(e){return this.telephonyController.getAccountController().reject(e)};TelephonyService.prototype.mute=function(e){this.telephonyController.getAccountController().mute(e)};TelephonyService.prototype.unmute=function(e){this.telephonyController.getAccountController().unmute(e)};TelephonyService.prototype.hold=function(e){return this.telephonyController.getAccountController().hold(e)};TelephonyService.prototype.unhold=function(e){return this.telephonyController.getAccountController().unhold(e)};TelephonyService.prototype.answerAndHold=function(e){return this.telephonyController.getAccountController().answerAndHold(e)};TelephonyService.prototype.answerAndEnd=function(e){return this.telephonyController.getAccountController().answerAndEnd(e)};TelephonyService.prototype.startRecord=function(e){return this.telephonyController.getAccountController().startRecord(e)};TelephonyService.prototype.stopRecord=function(e){return this.telephonyController.getAccountController().stopRecord(e)};TelephonyService.prototype.dtmf=function(e,t){return this.telephonyController.getAccountController().dtmf(e,t)};TelephonyService.prototype.answer=function(e){return this.telephonyController.getAccountController().answer(e)};TelephonyService.prototype.sendToVoiceMail=function(e){return this.telephonyController.getAccountController().sendToVoiceMail(e)};TelephonyService.prototype.ignore=function(e){return this.telephonyController.getAccountController().ignore(e)};TelephonyService.prototype.startReply=function(e){return this.telephonyController.getAccountController().startReply(e)};TelephonyService.prototype.park=function(e,t){return this.telephonyController.getAccountController().park(e,t)};TelephonyService.prototype.flip=function(e,t){return this.telephonyController.getAccountController().flip(e,t)};TelephonyService.prototype.forward=function(e,t){return this.telephonyController.getAccountController().forward(e,t)};TelephonyService.prototype.transfer=function(e,t,n){return this.telephonyController.getAccountController().transfer(e,t,n)};TelephonyService.prototype.promoteToVideo=function(e){return this.telephonyController.getAccountController().promoteToVideo(e)};TelephonyService.prototype.addCallPromotedToRCVListener=function(e,t){return this.telephonyController.getAccountController().addCallPromotedToRCVListener(e,t)};TelephonyService.prototype.removeCallPromotedToRCVListener=function(e,t){return this.telephonyController.getAccountController().removeCallPromotedToRCVListener(e,t)};TelephonyService.prototype.getSwitchCall=function(){return this.telephonyController.getSwitchCall()};TelephonyService.prototype.hideSwitchCall=function(){return this.telephonyController.hideSwitchCall()};TelephonyService.prototype.getCallGroupByCallId=function(e){return this.telephonyController.getAccountController().getCallGroupByCallId(e)};TelephonyService.prototype.isOverMaximumCallLimit=function(){return this.telephonyController.getAccountController().isOverMaximumCallLimit()};TelephonyService.prototype.monitorBLFCall=function(e,t){return this.telephonyController.getAccountController().monitorBLFCall(e,t)};TelephonyService.prototype.pickUpBLFCall=function(e,t){return this.telephonyController.getAccountController().pickUpBLFCall(e,t)};TelephonyService.prototype.whisper=function(e){return this.telephonyController.getAccountController().whisper(e)};TelephonyService.prototype.barge=function(e){return this.telephonyController.getAccountController().barge(e)};TelephonyService.prototype.takeOver=function(e){return this.telephonyController.getAccountController().takeOver(e)};TelephonyService.prototype.getTakeOverConfirm=function(){return this.telephonyController.getAccountController().getTakeOverConfirm()};TelephonyService.prototype.setTakeOverConfirm=function(){return this.telephonyController.getAccountController().setTakeOverConfirm()};TelephonyService.prototype.getMergeCallConfirm=function(){return this.telephonyController.getAccountController().getMergeCallConfirm()};TelephonyService.prototype.setMergeCallConfirm=function(){return this.telephonyController.getAccountController().setMergeCallConfirm()};TelephonyService.prototype.reportCallQualityFeedback=function(e){this.telephonyController.getAccountController().reportCallQualityFeedback(e)};TelephonyService.prototype.getFeedbackIssuesList=function(){return this.telephonyController.getAccountController().getFeedbackIssuesList()};TelephonyService.prototype.callOnBehalfOf=function(e,t,n){return this.telephonyController.getAccountController().callOnBehalfOf(e,t,n)};TelephonyService.prototype.getOrCreateRCConferenceForAddPeople=function(){var e=this.telephonyController.getAccountController();return e===null||e===void 0?void 0:e.getOrCreateRCConferenceForAddPeople()};TelephonyService.prototype.promoteDelegatedCallToConf=function(e){return this.telephonyController.getAccountController().promoteDelegatedCallToConf(e)};TelephonyService.prototype.makeConference=function(e){return this.telephonyController.getAccountController().makeConference(e)};TelephonyService.prototype.pickUpParkLocation=function(e){return this.telephonyController.getAccountController().pickUpParkLocation(e)};TelephonyService.prototype.canPromoteCallToMeet=function(){var e;return(e=this.telephonyController.getAccountController())===null||e===void 0?void 0:e.canPromoteCallToMeet()};TelephonyService.prototype.getRecentParkedSessionIds=function(){return this.telephonyController.getAccountController().getRecentParkedSessionIds()};TelephonyService.prototype.getType=function(){return _.oF};return TelephonyService}(o.MicroService)},439126:(e,t,n)=>{"use strict";n.d(t,{hr:()=>s.hr,tR:()=>w,O0:()=>s.O0,xZ:()=>s.xZ});var o=n(696206);var r=n(187933);var i=n(707938);var a=n(531616);var l=n(306502);var s=n(224022);var c=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var u=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var p=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var _=function(e){c(IncomingCallsAudioSettingItemProvider,e);function IncomingCallsAudioSettingItemProvider(){return e.call(this,{id:s.O0.Audio_IncomingCalls,source:{type:r.Pe.CONSTANT,defaultValue:l.RingsList},value:{type:r.Pe.STORAGE,defaultValue:l.RingsList.find((function(e){return e.id===l.RINGS_TYPE.High_Gong}))}})||this}IncomingCallsAudioSettingItemProvider.prototype.buildStateProvider=function(){var e=this;return this.buildBaseItemValueProvider({getter:function(){return u(e,void 0,void 0,(function(){var e,t;return p(this,(function(n){switch(n.label){case 0:e=a.Ye.ENABLE;return[4,this.getSettingModule().getSettingItemValue(s.O0.Phone_DefaultApp)];case 1:t=n.sent();if(t===s.hr.RINGCENTRAL){e=a.Ye.INVISIBLE}return[2,e]}}))}))}})};IncomingCallsAudioSettingItemProvider.prototype.onLoad=function(){var e=this;this.onSettingUpdate(s.O0.Phone_DefaultApp,(function(){e.getStateProvider().notifyChange()}))};return IncomingCallsAudioSettingItemProvider}(i.t);var C=n(298784);var f=n.n(C);var d=n(361722);var h=n(498807);var T=n(302186);var R=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var g=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var E=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var v=function(e){R(IncomingCallsSettingItemProvider,e);function IncomingCallsSettingItemProvider(){return e.call(this,{id:s.O0.Notification_IncomingCalls,source:{type:r.Pe.CONSTANT,defaultValue:[h.Q.OFF,h.Q.ON]},value:{type:r.Pe.STORAGE,defaultValue:h.Q.ON}})||this}IncomingCallsSettingItemProvider.prototype.buildStateProvider=function(){var e=this;return this.buildBaseItemValueProvider({getter:function(){return g(e,void 0,void 0,(function(){var e,t,n;return E(this,(function(o){switch(o.label){case 0:e=a.Ye.ENABLE;return[4,this.getSettingModule().getSettingItemValue(d.hf.Notification_Browser)];case 1:t=o.sent();if(!f().get(t,"desktopNotifications",false)&&!T.Pal.instance.getPlatformUtils().isElectron()){e=a.Ye.DISABLE}return[4,this.getSettingModule().getSettingItemValue(s.O0.Phone_DefaultApp)];case 2:n=o.sent();if(n===s.hr.RINGCENTRAL){e=a.Ye.INVISIBLE}return[2,e]}}))}))}})};IncomingCallsSettingItemProvider.prototype.onLoad=function(){var e=this;this.onSettingUpdate(d.hf.Notification_Browser,(function(){e.getStateProvider().notifyChange()}));this.onSettingUpdate(s.O0.Phone_DefaultApp,(function(){e.getStateProvider().notifyChange()}))};return IncomingCallsSettingItemProvider}(i.t);var y=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var A=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var m=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var I=function(e){y(MissedCallAndNewVoicemailsSettingItemProvider,e);function MissedCallAndNewVoicemailsSettingItemProvider(){return e.call(this,{id:s.O0.Notification_MissCallAndNewVoiceMails,source:{type:r.Pe.CONSTANT,defaultValue:[h.Q.OFF,h.Q.ON]},value:{type:r.Pe.STORAGE,defaultValue:h.Q.ON}})||this}MissedCallAndNewVoicemailsSettingItemProvider.prototype.buildStateProvider=function(){var e=this;return this.buildBaseItemValueProvider({getter:function(){return A(e,void 0,void 0,(function(){var e,t,n;return m(this,(function(o){switch(o.label){case 0:e=a.Ye.ENABLE;return[4,this.getSettingModule().getSettingItemValue(d.hf.Notification_Browser)];case 1:t=o.sent();if(!f().get(t,"desktopNotifications",false)&&!T.Pal.instance.getPlatformUtils().isElectron()){e=a.Ye.DISABLE}return[4,this.getSettingModule().getSettingItemValue(s.O0.Phone_DefaultApp)];case 2:n=o.sent();if(n===s.hr.RINGCENTRAL){e=a.Ye.INVISIBLE}return[2,e]}}))}))}})};MissedCallAndNewVoicemailsSettingItemProvider.prototype.onLoad=function(){var e=this;this.onSettingUpdate(d.hf.Notification_Browser,(function(){e.getStateProvider().notifyChange()}));this.onSettingUpdate(s.O0.Phone_DefaultApp,(function(){e.getStateProvider().notifyChange()}))};return MissedCallAndNewVoicemailsSettingItemProvider}(i.t);var S=n(461197);var N=n(379269);var O=n(147877);var b=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var L=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var D=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var P=function(e){b(DefaultAppSettingItemProvider,e);function DefaultAppSettingItemProvider(){return e.call(this,{id:s.O0.Phone_DefaultApp,source:{type:o.Pe.CONSTANT,defaultValue:[s.hr.GLIP,s.hr.RINGCENTRAL]},value:{type:o.Pe.STORAGE,defaultValue:s.hr.GLIP}})||this}DefaultAppSettingItemProvider.prototype.buildStateProvider=function(){var e=this;return this.buildBaseItemValueProvider({getter:function(){return L(e,void 0,void 0,(function(){var e,t,n;return D(this,(function(o){switch(o.label){case 0:e=(0,S.getModule)(N.oF);n=e;if(!n)return[3,2];return[4,e.isVoipCallingAvailable()];case 1:n=o.sent();o.label=2;case 2:t=n;return[2,t?a.Ye.ENABLE:a.Ye.INVISIBLE]}}))}))}})};DefaultAppSettingItemProvider.prototype.onLoad=function(){var e=this;this.on(O.FY.VOIP_CALLING,(function(){return e.getStateProvider().notifyChange()}))};return DefaultAppSettingItemProvider}(i.t);var M=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var w=function(e){M(PhoneSettingManager,e);function PhoneSettingManager(){return e!==null&&e.apply(this,arguments)||this}PhoneSettingManager.prototype.getProviderMap=function(){var e;if(!this.phoneSettingProvider){this.phoneSettingProvider=(e={},e[s.O0.Phone_DefaultApp]=new P,e[s.O0.Notification_IncomingCalls]=new v,e[s.O0.Audio_IncomingCalls]=new _,e[s.O0.Notification_MissCallAndNewVoiceMails]=new I,e)}return this.phoneSettingProvider};return PhoneSettingManager}(o.AbstractModuleSettingProviderManager)},224022:(e,t,n)=>{"use strict";n.d(t,{O0:()=>o.O0,xZ:()=>i,hr:()=>o.hr});var o=n(782117);var r;(function(e){e[e["OFF"]=0]="OFF";e[e["ON"]=1]="ON"})(r||(r={}));var i=[o.O0.Phone_DefaultApp,o.O0.Notification_IncomingCalls,o.O0.Audio_IncomingCalls,o.O0.Notification_MissCallAndNewVoiceMails];var a;(function(e){e[e["ENABLE"]=0]="ENABLE";e[e["DISABLE"]=1]="DISABLE"})(a||(a={}))},266800:(e,t,n)=>{"use strict";n.d(t,{HI:()=>a,q$:()=>l,Jn:()=>s,tP:()=>i.TRANSFER_TYPE,Gh:()=>c,WL:()=>u});var o=n(343398);var r=n(827027);var i=n(386321);var a;(function(e){e["NO_ERROR"]="NO_ERROR";e["INVALID_PHONE_NUMBER"]="INVALID_PHONE_NUMBER";e["NO_INTERNET_CONNECTION"]="NO_INTERNET_CONNECTION";e["THE_COUNTRY_BLOCKED_VOIP"]="THE_COUNTRY_BLOCKED_VOIP";e["VOIP_CALLING_SERVICE_UNAVAILABLE"]="VOIP_CALLING_SERVICE_UNAVAILABLE";e["INVALID_STATE"]="INVALID_STATE";e["NOT_DEFAULT_PHONE_APP"]="NOT_DEFAULT_PHONE_APP";e["NO_VOIP_CALL_PERMISSION"]="NO_VOIP_CALL_PERMISSION";e["NO_DIGITAL_LINE_TO_CALL_LONG_NUMBER"]="NO_DIGITAL_LINE_TO_CALL_LONG_NUMBER";e["NO_EMERGENCY_CONFIRMED"]="NO_EMERGENCY_CONFIRMED";e["CALL_COUNT_OVER_LIMIT"]="CALL_COUNT_OVER_LIMIT";e["HOLD_CURRENT_ACTIVE_CALL_ERROR"]="HOLD_CURRENT_ACTIVE_CALL_ERROR";e["REGISTRATION_LIMIT_EXCEEDED_ERROR"]="REGISTRATION_LIMIT_EXCEEDED_ERROR";e["REGISTRATION_VDI_VMWARE_IN_PROGRESS_ERROR"]="REGISTRATION_VDI_VMWARE_IN_PROGRESS_ERROR";e["REGISTRATION_VDI_IN_PROGRESS_ERROR"]="REGISTRATION_VDI_IN_PROGRESS_ERROR";e["UNABLE_TO_PICK_UP_CALL_ERROR"]="UNABLE_TO_PICK_UP_CALL_ERROR";e["MERGE_CALL_ERROR"]="MERGE_CALL_ERROR";e["MEETING_NOT_EXISTS"]="MEETING_NOT_EXISTS"})(a||(a={}));var l;(function(e){e[e["NO_ERROR"]=0]="NO_ERROR";e[e["INVALID"]=-1]="INVALID";e[e["OTHER_ACTION_IN_PROGRESS"]=-6]="OTHER_ACTION_IN_PROGRESS";e[e["ACR_ON"]=-8]="ACR_ON";e[e["NOT_NETWORK"]=-9]="NOT_NETWORK";e[e["INVALID_PHONE_NUMBER"]=-10]="INVALID_PHONE_NUMBER";e[e["OTHERS"]=-9]="OTHERS"})(l||(l={}));var s;(function(e){e["ALL"]="all";e["OFF"]="off";e["DEFAULT"]="default"})(s||(s={}));var c;(function(e){e[e["MERGE"]=0]="MERGE";e[e["TRANSFER"]=1]="TRANSFER"})(c||(c={}));var u;(function(e){e[e["EXCEEDED"]=0]="EXCEEDED";e[e["NORMAL"]=1]="NORMAL"})(u||(u={}))},172414:(e,t,n)=>{"use strict";n.d(t,{t:()=>d});var o=n(667489);var r=n.n(o);var i=n(862926);var a=n.n(i);var l=n(642107);var s=n(831270);var c=n(379269);var u=n(827027);var p=n(166418);var _=n(147877);var C=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var f=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var d=function(){function TelephonyUtils(){}TelephonyUtils.callEntity2UniqueCallInfo=function(e){return{callId:e.session_id,fromTag:e.from_tag,toTag:e.to_tag}};TelephonyUtils.buildFederationNumber=function(e,t){var n;return C(this,void 0,Promise,(function(){var r,i,a,p,_,C,d,h,T;return f(this,(function(f){switch(f.label){case 0:if(!t){return[2,e]}r=(0,o.getModule)(l.PHONE_PARSER_MODULE);return[4,r.getPhoneParser(e)];case 1:i=f.sent();a=(0,o.getModule)(s.MODULE_NAME);return[4,a.getPhoneNumbersByContactId(t)];case 2:p=f.sent();_=(i===null||i===void 0?void 0:i.isShortNumber())||p.some((function(t){return t.usageType===u.PhoneNumberUsageType.Extension&&t.phoneNumber===e}));if(!_){return[2,e]}C=a.getContactGroupId(t);d=a.getCurrentContactGroupIdByType(s.ContactUtils.getTypeById(t));if(!C||!d||C===d){return[2,e]}h=(0,o.getModule)(c.oF);return[4,h.getFederationAccountInfo(C)];case 3:T=f.sent();return[2,((n=T===null||T===void 0?void 0:T.mainNumber)===null||n===void 0?void 0:n.phoneNumber)?T.mainNumber.phoneNumber+"*"+e:e]}}))}))};TelephonyUtils.buildParkLocationId=function(e){return _.tw+e};TelephonyUtils.getExtensionIdFromPickupTarget=function(e){if(TelephonyUtils.isGCPPickupTarget(e)){return e.replace(_.w2.GCP,"")}if(TelephonyUtils.isQCPPickupTarget(e)){return e.replace(_.w2.QCP,"")}return undefined};TelephonyUtils.isGCPPickupTarget=function(e){return!!(e&&e.startsWith(_.w2.GCP))};TelephonyUtils.isQCPPickupTarget=function(e){return!!(e&&e.startsWith(_.w2.QCP))};TelephonyUtils.isCurrentUserCall=function(e){return C(this,void 0,void 0,(function(){var t,n,r,i,a;return f(this,(function(l){switch(l.label){case 0:t=(0,o.getModule)(s.MODULE_NAME);n=(0,o.getModule)(p.Po);return[4,n.matchPhoneContact(p.PhoneContactUtils.buildPhoneContactId({phoneNumber:e.to,displayName:e.toName}))];case 1:r=l.sent();return[4,n.matchPhoneContact(p.PhoneContactUtils.buildPhoneContactId({phoneNumber:e.from,displayName:e.fromName}))];case 2:i=l.sent();a=t.getUserContactId();return[2,a===r||a===i]}}))}))};TelephonyUtils.doErrorTrackingInCommon=function(e,t,n){(0,i.doErrorTracking)(i.EVENT_DATA_FEATURE.COMMON,{key:_.oy.PREFIX+"_"+e,message:JSON.stringify((0,i.sanitize)(t,{$depth:5,$exclude:[],$mask:n})),level:i.LOG_CONTROL_LEVEL.HIGH})};return TelephonyUtils}()},226417:(e,t,n)=>{"use strict";n.d(t,{t:()=>o.t});var o=n(172414)},386321:(e,t,n)=>{"use strict";n.d(t,{TRANSFER_TYPE:()=>r.t});var o=n(290869);var r=n(239117);if(/^(130|388)3$/.test(n.j)){var i=n(728978)}if(n.o(i,"Caller"))n.d(t,{Caller:function(){return i.Caller}});if(n.o(i,"UriModel"))n.d(t,{UriModel:function(){return i.UriModel}})},290869:()=>{"use strict";var e;(function(e){e["INTERNATIONAL_CALLING_DISABLED"]="InternationalCallingDisabled";e["DESTINATION_COUNTRY_DISABLED"]="DestinationCountryDisabled";e["NO_ANSWER"]="NoAnswer";e["LINE_BUSY"]="LineBusy";e["CALLER_HUNG_UP"]="CallerHungUp";e["UNKNOWN_COUNTRY_CODE"]="UnknownCountryCode";e["INVALID_NUMBER"]="InvalidNumber";e["NOT_ACCEPTED"]="NotAccepted";e["CALL_DECLINED"]="CallDeclined";e["TOO_MANY_CALLS_PER_LINE"]="TooManyCallsPerLine";e["NOT_ENOUGH_CREDITS"]="NotEnoughCredits";e["SENT_PARTIALLY"]="SentPartially";e["CALL_FAILED"]="CallFailed"})(e||(e={}));var t;(function(e){e["QUEUED"]="Queued";e["SENT"]="Sent";e["DELIVERED"]="Delivered";e["DELIVERY_FAILED"]="DeliveryFailed";e["SENDING_FAILED"]="SendingFailed";e["RECEIVED"]="Received"})(t||(t={}))},239117:(e,t,n)=>{"use strict";n.d(t,{t:()=>o});var o;(function(e){e[e["BLIND_TRANSFER"]=0]="BLIND_TRANSFER";e[e["TO_VOICEMAIL"]=1]="TO_VOICEMAIL";e[e["WARM_TRANSFER"]=2]="WARM_TRANSFER"})(o||(o={}));var r;(function(e){e[e["MERGE"]=0]="MERGE";e[e["TRANSFER"]=1]="TRANSFER"})(r||(r={}))},326081:(e,t,n)=>{"use strict";if(/^(130|388)3$/.test(n.j)){var o=n(24038);var r=n.n(o)}if(n.o(o,"Caller"))n.d(t,{Caller:function(){return o.Caller}});if(n.o(o,"UriModel"))n.d(t,{UriModel:function(){return o.UriModel}})},24038:()=>{},728978:(e,t,n)=>{"use strict";if(/^(130|388)3$/.test(n.j)){var o=n(419278);var r=n.n(o)}if(n.o(o,"Caller"))n.d(t,{Caller:function(){return o.Caller}});if(n.o(o,"UriModel"))n.d(t,{UriModel:function(){return o.UriModel}});if(/^(130|388)3$/.test(n.j)){var i=n(326081)}if(n.o(i,"Caller"))n.d(t,{Caller:function(){return i.Caller}});if(n.o(i,"UriModel"))n.d(t,{UriModel:function(){return i.UriModel}})},419278:()=>{},591477:()=>{},264633:()=>{},344323:()=>{},826585:()=>{},343398:(e,t,n)=>{"use strict";n.d(t,{LOG_LEVEL:()=>A,RECORD_STATE:()=>i.M,RTCEngine:()=>jn,RTC_ACCOUNT_STATE:()=>i.Ty,RTC_CALL_ACTION:()=>i.VB,RTC_CALL_ACTION_DIRECTION:()=>i.$X,RTC_CALL_ACTION_ERROR_CODE:()=>i.QP,RTC_CALL_ERROR_EVENT:()=>i.Ao,RTC_CALL_STATE:()=>i.JG,RTC_REPLY_MSG_PATTERN:()=>i.UV,RTC_REPLY_MSG_TIME_UNIT:()=>i.mo,VOICE_QUALITY:()=>i.kX});var o=n(796084);var r=n(228164);var i=n(507450);var a=n(375960);var l=8;var s=3600;var c=7200;var u=24*3600;var p=3600;var _=9;var C="anonymous";var f=30;var d=1*1e3;var h=2;var T={appName:"RingCentral Jupiter",builtinEnabled:false,audioHelper:{enabled:true},logLevel:10,enableQos:true};var R=[{min:2,max:6},{min:10,max:20},{min:20,max:40},{min:40,max:80},{min:80,max:120},{min:80,max:120},{min:80,max:120},{min:80,max:120},{min:80,max:120},{min:120,max:240},{min:240,max:480},{min:480,max:960},{min:960,max:1920},{min:1920,max:3840}];var g=.5;var E=null&&["SPR-101","SPR-102","SPR-114","SPR-118"];var v=n(591477);var y=n(264633);var A;(function(e){e[e["FATAL"]=5e4]="FATAL";e[e["ERROR"]=4e4]="ERROR";e[e["WARN"]=3e4]="WARN";e[e["INFO"]=2e4]="INFO";e[e["DEBUG"]=1e4]="DEBUG";e[e["TRACE"]=5e3]="TRACE"})(A||(A={}));var m=n(862926);var I=function(){function RTCLoggerProxy(){}RTCLoggerProxy.prototype.setLogger=function(e){this._logger=e};RTCLoggerProxy.prototype.info=function(e,t){this._doLog(A.INFO,e,t)};RTCLoggerProxy.prototype.debug=function(e,t){this._doLog(A.DEBUG,e,t)};RTCLoggerProxy.prototype.warn=function(e,t){this._doLog(A.WARN,e,t)};RTCLoggerProxy.prototype.error=function(e,t){this._doLog(A.ERROR,e,t)};RTCLoggerProxy.prototype.fatal=function(e,t){this._doLog(A.FATAL,e,t)};RTCLoggerProxy.prototype.trace=function(e,t){this._doLog(A.TRACE,e,t)};RTCLoggerProxy.prototype.record=function(e,t){this._doLog(A.WARN,e,JSON.stringify(t))};RTCLoggerProxy.prototype.report=function(e,t){this._logger&&this._logger.report(e,t)};RTCLoggerProxy.prototype.reportEvent=function(e){this._logger&&this._logger.reportEvent(e)};RTCLoggerProxy.prototype.ensureApiBeenCalledLog=function(e,t){this.info(e,"the "+t+" of VoIP is called")};RTCLoggerProxy.prototype._logLevelName=function(e){switch(e){case A.FATAL:return"Fatal";case A.WARN:return"Warning";case A.ERROR:return"Error";case A.DEBUG:return"Debug";case A.INFO:return"Info";case A.TRACE:return"Trace";default:return"Warning"}};RTCLoggerProxy.prototype._doLog=function(e,t,n){if(!this._logger){var o=this._formatMsg(t,n);m.mainLogger.info("["+(new Date).toISOString()+"]["+this._logLevelName(e)+"] "+o);return}var r=this._formatMsg(t,n);this._logger.doLog(e,r)};RTCLoggerProxy.prototype._formatMsg=function(e,t){var n=e+": "+t;return n};RTCLoggerProxy.prototype.loggerConnector=function(e,t,n,o){var r="VoIP-Sip: "+t+" ["+n+"]";switch(e){case"debug":this.debug(r,o);break;case"log":this.info(r,o);break;case"warn":this.warn(r,o);break;case"error":this.error(r,o);break;default:break}};return RTCLoggerProxy}();var S=new I;var N="subscribePermissionChange";function subscribePermissionChange(e,t){if(navigator.permissions){navigator.permissions.query({name:e}).then((function(e){var n=e.state;e.addEventListener("change",(function(){if(n!==e.state){var o=n;n=e.state;t(e.state,o)}}))})).catch((function(e){rtcLogger.warn(N,""+e.message)}))}}var O=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var b=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var L="RTCRestApiManager";var D=function(){function RTCRestApiManager(){}RTCRestApiManager.instance=function(){if(!RTCRestApiManager._singleton){RTCRestApiManager._singleton=new RTCRestApiManager}return RTCRestApiManager._singleton};RTCRestApiManager.destroy=function(){RTCRestApiManager._singleton=null};RTCRestApiManager.prototype.sendRequest=function(e,t,n){return O(this,void 0,Promise,(function(){return b(this,(function(o){switch(o.label){case 0:return[4,RTCRestApiManager.networkClient.rawRequest({via:t.via,path:e,method:t.method,data:t.data,headers:t.headers,params:t.params,authFree:t.authFree,retryCount:t.retryCount,requestConfig:t.requestConfig},n)];case 1:return[2,o.sent()]}}))}))};RTCRestApiManager.prototype.cancelRequest=function(e){if(!e.request){return}S.debug(L,"Cancel request: "+e.request.path);RTCRestApiManager.networkClient.cancelRequest(e.request)};RTCRestApiManager.prototype.getClient=function(){return RTCRestApiManager.networkClient};RTCRestApiManager._singleton=null;return RTCRestApiManager}();var P;(function(e){e["kProvisioningInfoKey"]="sip-info";e["kInstanceIdKey"]="sip-instance-id"})(P||(P={}));var M;(function(e){e["NETWORK_CHANGE"]="networkChange";e["MEDIA_CONNECTION_FAILED"]="mediaConnectionFailed";e["WINDOW_BEFOREUNLOAD"]="windowBeforeunload"})(M||(M={}));var w;(function(e){e["ONLINE"]="online";e["OFFLINE"]="offline"})(w||(w={}));var F;(function(e){e["API_SIP_PROVISION"]="/v1.0/client-info/sip-provision";e["API_ORIGINATE_CONFERENCE"]="/v1.0/account/~/telephony/conference"})(F||(F={}));var k=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var U=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var G="RTCRequestManager";var H=function(){function RTCRequestManager(){this._requestHolders=[]}RTCRequestManager.sendSipProvRequest=function(){return k(this,void 0,void 0,(function(){var e,t;return U(this,(function(n){switch(n.label){case 0:S.info(G,"start send SipProv Request");e=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.POST).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).setData({sipInfo:[{transport:"WSS"}]}).build();t=m.RequestPath.buildRequestPath(F.API_SIP_PROVISION);return[4,D.instance().sendRequest(t,e)];case 1:return[2,n.sent()]}}))}))};RTCRequestManager.movePartiesToConf=function(e,t){return k(this,void 0,Promise,(function(){var n,o,r;return U(this,(function(i){switch(i.label){case 0:if(!e){S.warn(G,"move parties to conference failed: params error");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}n=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.POST).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).setData(t).build();o=m.RequestPath.buildRequestPath("/v1.0/account/~/telephony/sessions/"+m.FORMAT_MARK+"/parties/move",e);return[4,D.instance().sendRequest(o,n)];case 1:r=i.sent();if(r.status!==201){S.warn(G,"move delegated call parties to RCConf failed: "+r.status);return[2,Promise.reject(r.status)]}return[2]}}))}))};RTCRequestManager.getConfStatus=function(e){return k(this,void 0,Promise,(function(){var t,n,o;return U(this,(function(r){switch(r.label){case 0:if(!e){S.warn(G,"get conference status failed: params error");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}t=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.GET).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).build();n=m.RequestPath.buildRequestPath("/v1.0/account/~/telephony/sessions/"+m.FORMAT_MARK,e);return[4,D.instance().sendRequest(n,t)];case 1:o=r.sent();if(o.status!==200){S.warn(G,"receive error code when get RCConference status: "+o.status);return[2,Promise.reject(o.status)]}return[2,o.data]}}))}))};RTCRequestManager.originateConference=function(){return k(this,void 0,Promise,(function(){var e,t,n;return U(this,(function(o){switch(o.label){case 0:e=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.POST).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).build();t=m.RequestPath.buildRequestPath(F.API_ORIGINATE_CONFERENCE);return[4,D.instance().sendRequest(t,e)];case 1:n=o.sent();if(n.status!==201){S.warn(G,"receive error code when originate conference: "+n.status);return[2,Promise.reject(n.status)]}return[2,n.data]}}))}))};RTCRequestManager.pickUpDelegatedCall=function(e,t){return k(this,void 0,Promise,(function(){var n,o,r;return U(this,(function(i){switch(i.label){case 0:if(!e.sessionId||!e.partyId){S.warn(G,"Pick up delegated call failed: params error");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}n=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.POST).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).setData({deviceId:t}).setHeaders({"Client-Ref":e.clientRefId}).build();o=m.RequestPath.buildRequestPath("/v1.0/account/~/telephony/sessions/"+m.FORMAT_MARK+"/parties/"+m.FORMAT_MARK+"/replace",e.sessionId,e.partyId);return[4,D.instance().sendRequest(o,n)];case 1:r=i.sent();if(r.status!==201){S.warn(G,"receive error code when pick-up a delegated call: "+r.status);return[2,Promise.reject(r.status)]}return[2]}}))}))};RTCRequestManager.prototype.addPartyMember=function(e,t,n){return k(this,void 0,Promise,(function(){var o,r,i;return U(this,(function(a){switch(a.label){case 0:o=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.POST).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).setData({sessionId:t,partyId:n}).build();r=m.RequestPath.buildRequestPath("/v1.0/account/~/telephony/sessions/"+m.FORMAT_MARK+"/parties/bring-in",e);return[4,this._sendRequest(r,o)];case 1:i=a.sent();if(i.status!==201){S.warn(G,"receive error code when add party: "+i.status);if(i.status===403&&i.data.errors&&i.data.errors.length>0&&i.data.errors[0].message==="Maximum number of participants exceeded"){S.info(G,"Maximum number of participants exceeded");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.MAXIMUM_NUMBER_EXCEEDED)]}return[2,Promise.reject(i.status)]}return[2,i.data]}}))}))};RTCRequestManager.prototype.removePartyMember=function(e,t){return k(this,void 0,Promise,(function(){var n,o,r;return U(this,(function(i){switch(i.label){case 0:n=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.DELETE).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).build();o=m.RequestPath.buildRequestPath("/v1.0/account/~/telephony/sessions/"+m.FORMAT_MARK+"/parties/"+m.FORMAT_MARK,e,t);return[4,this._sendRequest(o,n)];case 1:r=i.sent();if(r.status!==204){S.warn(G,"receive error code when remove party: "+r.status);return[2,Promise.reject(r.status)]}return[2,r.data]}}))}))};RTCRequestManager.prototype.getConferenceStatus=function(e){return k(this,void 0,Promise,(function(){var t,n,o;return U(this,(function(r){switch(r.label){case 0:t=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.GET).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).build();n=m.RequestPath.buildRequestPath("/v1.0/account/~/telephony/sessions/"+m.FORMAT_MARK,e);return[4,this._sendRequest(n,t)];case 1:o=r.sent();if(o.status!==200){S.warn(G,"receive error code when getting conference status: "+o.status);return[2,Promise.reject(o.status)]}return[2,o.data]}}))}))};RTCRequestManager.prototype.promoteToVideo=function(e,t){var n=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.POST).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).setData(t).build();var o=m.RequestPath.buildRequestPath("/v1.0/account/~/telephony/sessions/"+m.FORMAT_MARK+"/parties/promote-to-rcv",e);return this._sendRequest(o,n)};RTCRequestManager.prototype.cancelRequests=function(){S.debug(G,this._requestHolders.length+" Requests remains when call end. Cancel all of them");this._requestHolders.forEach((function(e){D.instance().cancelRequest(e)}));this._requestHolders=[]};RTCRequestManager.prototype._sendRequest=function(e,t){return k(this,void 0,Promise,(function(){var n,o;return U(this,(function(r){switch(r.label){case 0:n={request:t};this._requestHolders.push(n);S.debug(G,"Before sending request. requests size: "+this._requestHolders.length);return[4,D.instance().sendRequest(e,t,n)];case 1:o=r.sent();this._removeRequestHolder(n);S.debug(G,"Request promise returned. Remove request from requests list. requests size: "+this._requestHolders.length);return[2,o]}}))}))};RTCRequestManager.prototype._removeRequestHolder=function(e){var t=this;this._requestHolders.forEach((function(n,o){if(n===e){t._requestHolders.splice(o,1)}}))};RTCRequestManager.prototype.setRecording=function(e,t,n,o){return k(this,void 0,Promise,(function(){var r,i,a;return U(this,(function(l){switch(l.label){case 0:r=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.PATCH).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).setData({active:e}).build();i=m.RequestPath.buildRequestPath("/v1.0/account/~/telephony/sessions/"+m.FORMAT_MARK+"/parties/"+m.FORMAT_MARK+"/recordings/"+m.FORMAT_MARK,t,n,o);return[4,this._sendRequest(i,r)];case 1:a=l.sent();if(a.status>=300||a.status<200){S.warn(G,"Set recording "+e+" failed for "+a.status);return[2,Promise.reject(a.status)]}return[2,a.data]}}))}))};RTCRequestManager.prototype.getPartyInfo=function(e,t){return k(this,void 0,Promise,(function(){var n,o,r;return U(this,(function(i){switch(i.label){case 0:n=(new m.NetworkRequestBuilder).setMethod(m.NETWORK_METHOD.GET).setAuthFree(false).setVia(m.NETWORK_VIA.HTTP).build();o=m.RequestPath.buildRequestPath("/v1.0/account/~/telephony/sessions/"+m.FORMAT_MARK+"/parties/"+m.FORMAT_MARK,e,t);return[4,this._sendRequest(o,n)];case 1:r=i.sent();if(r.status!==200){S.warn(G,"Get party info failed for "+r.status);return[2,Promise.reject(r.status)]}return[2,r.data]}}))}))};return RTCRequestManager}();var V="RTCDaoMananger";var B=function(){function RTCDaoManager(){this._delegate=null}RTCDaoManager.instance=function(){if(!RTCDaoManager._singleton){return RTCDaoManager._singleton=new RTCDaoManager}return RTCDaoManager._singleton};RTCDaoManager.destroy=function(){RTCDaoManager._singleton=null};RTCDaoManager.prototype.setDaoDelegate=function(e){this._delegate=e};RTCDaoManager.prototype.save=function(e,t){if(!this._delegate){S.warn(V,"Failed to save info. DAO delegate is null");return}this._delegate.put(e,t)};RTCDaoManager.prototype.read=function(e){if(!this._delegate){S.warn(V,"Failed to read info. DAO delegate is null");return null}return this._delegate.get(e)};RTCDaoManager.prototype.remove=function(e){if(!this._delegate){S.warn(V,"Failed to remove info. DAO delegate is null");return}S.debug(V,"remove "+e+" info in DAO");this._delegate.remove(e)};RTCDaoManager._singleton=null;return RTCDaoManager}();var x=n(879321);var W=n(804722);var j=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var Y="RTCMediaElementManager";var q=function(e){j(RTCMediaElementManager,e);function RTCMediaElementManager(){var t=e.call(this)||this;t._mediaRootElement=null;t._volumeManager=W.l.instance();t._volumeManager.addObserver((function(e){return t.setVolume(e)}));return t}RTCMediaElementManager.instance=function(){if(!RTCMediaElementManager._singleton){RTCMediaElementManager._singleton=new RTCMediaElementManager}return RTCMediaElementManager._singleton};RTCMediaElementManager.prototype.destroy=function(){RTCMediaElementManager._singleton=null};RTCMediaElementManager.prototype.setVolume=function(e){var t=this;if(e<0||e>1){S.warn(Y,"Failed to set volume "+e+". Volume value must be in [0, 1]");return}S.debug(Y,"Set volume: "+e);this._volumeManager.setVolume(e);var n=document.querySelectorAll(".rc-phone-audio");n.forEach((function(n){t._setVolumeInVideoElement(n,e)}));this.emit(i.CO.VOLUME_CHANGED,e)};RTCMediaElementManager.prototype.getVolume=function(){return this._volumeManager.getVolume()};RTCMediaElementManager.prototype.createMediaElement=function(e){this._initMediaRoot();if(!this._mediaRootElement){return null}var t=document.createElement("audio");t.hidden=true;t.id="remote-audio-"+e;t.className="rc-phone-audio";t.volume=this._volumeManager.getVolume();t.autoplay=true;this._mediaRootElement.appendChild(t);return t};RTCMediaElementManager.prototype.getMediaElementByCallId=function(e){return document.getElementById("remote-audio-"+e)};RTCMediaElementManager.prototype.removeMediaElement=function(e){if(!this._mediaRootElement){return}var t=document.getElementById("remote-audio-"+e);if(t&&t.parentNode){t.parentNode.removeChild(t)}};RTCMediaElementManager.prototype._initMediaRoot=function(){var e=document.getElementById("root");this._mediaRootElement=document.getElementById("rc_audio_div");if(e&&!this._mediaRootElement){this._mediaRootElement=document.createElement("div");this._mediaRootElement.setAttribute("id","rc_audio_div");e.appendChild(this._mediaRootElement)}};RTCMediaElementManager.prototype._setVolumeInVideoElement=function(e,t){e.volume=t};RTCMediaElementManager._singleton=null;return RTCMediaElementManager}(x.EventEmitter2);var K=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var Q=function(e){K(RTCNetworkNotificationCenter,e);function RTCNetworkNotificationCenter(){var t=e.call(this)||this;t._isOnline=true;t._listenEvent();return t}RTCNetworkNotificationCenter.instance=function(){if(!RTCNetworkNotificationCenter._singleton){RTCNetworkNotificationCenter._singleton=new RTCNetworkNotificationCenter}return RTCNetworkNotificationCenter._singleton};RTCNetworkNotificationCenter.prototype.destroy=function(){RTCNetworkNotificationCenter._singleton=null};RTCNetworkNotificationCenter.prototype.notifyMediaConnectionFailed=function(){this.emit(M.MEDIA_CONNECTION_FAILED)};RTCNetworkNotificationCenter.prototype._onOnline=function(){this._isOnline=true;this.emit(M.NETWORK_CHANGE,w.ONLINE)};RTCNetworkNotificationCenter.prototype._onOffline=function(){this._isOnline=false;this.emit(M.NETWORK_CHANGE,w.OFFLINE)};RTCNetworkNotificationCenter.prototype._onWindowBeforeunload=function(){this.emit(M.WINDOW_BEFOREUNLOAD)};RTCNetworkNotificationCenter.prototype._listenEvent=function(){var e=this;window.addEventListener("online",(function(){e._onOnline()}));window.addEventListener("offline",(function(){e._onOffline()}));window.addEventListener("beforeunload",(function(){e._onWindowBeforeunload()}))};RTCNetworkNotificationCenter.prototype.isOnline=function(){return this._isOnline};RTCNetworkNotificationCenter._singleton=null;return RTCNetworkNotificationCenter}(x.EventEmitter2);var J=n(667489);var X=n(38942);var $=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var z=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};function isNotEmptyString(e){return typeof e==="string"&&e.length>0}function isFireFox(){var e=navigator.userAgent;return e&&e.indexOf("Firefox")>-1}function isSafari(){var e=navigator.userAgent.toLowerCase();return e&&e.indexOf("safari")>-1&&e.indexOf("chrome")<0}function opusPTInRtpmap(e){var t=e.find((function(e){var t=/a=rtpmap.*opus.*48000.*/gi;return t.test(e)}));if(!t){throw new Error("Opus 48k is not found")}var n=/rtpmap:(\d*).*/gi;var o=n.exec(t);return o?o[1]:"0"}function customizedOpusFmtp(e,t,n){var o=["a=fmtp:"+e,"minptime=10;","useinbandfec=1;","maxaveragebitrate="+t+";","sprop-maxcapturerate="+n+";","maxplaybackrate="+n+";","stereo=0;","sprop-stereo=0;","ptime=20"];return o.join(" ")}function opusModifier(e){var t;return $(this,void 0,Promise,(function(){var n,o,r,i,a,l;return z(this,(function(s){switch(s.label){case 0:if(!e||!e.sdp){return[2,Promise.resolve(e)]}n=e.sdp.split("\n");o=32e3;r=16e3;i="0";return[4,(t=(0,J.getModule)(X.FEATURE_FLAG_MODULE))===null||t===void 0?void 0:t.hasPermission(X.G.D_USE_ADAPTIVE_BITRATE)];case 1:a=s.sent();if(a){S.debug("opusModifier","Set max bitrate to 40000 since adaptive bitrate is on");o=4e4}try{i=opusPTInRtpmap(n)}catch(t){S.error("opusModifier",""+t);return[2,Promise.resolve(e)]}l=n.map((function(e){var t=new RegExp("a=fmtp:"+i,"gi");if(t.test(e)){return customizedOpusFmtp(i,o,r)}return e}));e.sdp=l.join("\n");return[2,Promise.resolve(e)]}}))}))}function randomBetween(e,t){return Math.floor(Math.random()*(t-e))+e}function randomChance(e){if(e>=1){return true}if(e<=0){return false}return Math.random()<=e}function isElectron(){return navigator.userAgent.toLowerCase().indexOf(" electron/")>-1}function b64EncodeUnicode(e){return btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(parseInt(t,16))})))}function b64DecodeUnicode(e){return decodeURIComponent(atob(e).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))}var Z=n(711719);var ee=n.n(Z);var te="LogInsight Tag";var ne;(function(e){e["USER"]="user";e["CALL_ACTION"]="callAction";e["ERROR_REPORT"]="errorReport";e["MEDIA"]="media";e["DEVICE"]="device";e["SESSION"]="session";e["SYSTEM"]="system";e["NETWORK"]="network";e["BACKEND"]="backend"})(ne||(ne={}));var oe;(function(e){e["APP"]="app";e["VOIP"]="voip"})(oe||(oe={}));var re;(function(e){e["START"]="start";e["STOP"]="stop";e["STEP"]="step";e["INFO"]="info";e["OTHER"]="other"})(re||(re={}));var ie;(function(e){e["METADATA"]="metadata";e["EVENT"]="event"})(ie||(ie={}));var ae;(function(e){e["WARN"]="warn";e["ERROR"]="error"})(ae||(ae={}));var le=function(){function RTCEventLogger(e,t,n){this._tid=(0,Z.v4)();this._component=e;this._name=t;this._pid=n;this._doLog({flag:re.START,component:this._component,name:this._name,pid:this._pid})}RTCEventLogger.metadata=function(e){RTCEventLogger._doLog({type:ie.METADATA,info:e})};RTCEventLogger._formatMsg=function(e){return""+JSON.stringify(Object.assign({timestamp:Date.now()},e))};RTCEventLogger._doLog=function(e,t){if(t===void 0){t=A.INFO}switch(t){case A.WARN:S.warn(te,RTCEventLogger._formatMsg(e));break;case A.ERROR:S.error(te,RTCEventLogger._formatMsg(e));break;default:S.info(te,RTCEventLogger._formatMsg(e));break}};RTCEventLogger.prototype.info=function(e){this._doLog({flag:re.INFO,info:e})};RTCEventLogger.prototype.step=function(e,t,n,o){if(n===void 0){n=ne.USER}this._doLog({flag:re.STEP,name:e,message:t,tag:n,level:o},o)};RTCEventLogger.prototype.other=function(e,t){this._doLog({flag:re.OTHER,tag:e,info:t})};RTCEventLogger.prototype.destroy=function(e,t){if(e===void 0){e=0}this._doLog({flag:re.STOP,quality:e,optional:t})};Object.defineProperty(RTCEventLogger.prototype,"tid",{get:function(){return this._tid},enumerable:true,configurable:true});RTCEventLogger.prototype._doLog=function(e,t){var n=Object.assign({type:ie.EVENT,tid:this._tid},e);if(ae.WARN===t){RTCEventLogger._doLog(n,A.WARN)}else if(ae.ERROR===t){RTCEventLogger._doLog(n,A.ERROR)}else{RTCEventLogger._doLog(n)}};return RTCEventLogger}();var se=function(){function RTCAudioAdaptation(e){if(e===void 0){e=2*60}this._loss=0;this._rtt=0;this._counter=0;this._lastSwitch=0;this._banCounter=0;this._lastDirection=0;this._karma=0;this._logTag="RTCAudioAdaptation";this._bitrateChangedTimes=0;this._banLimit=e}RTCAudioAdaptation.prototype.adapt=function(e,t,n){if(t===void 0){t=0}if(n===void 0){n=0}t=t*100;this._smoothStats(t,n);if(!e.getParameters||!e.getParameters().encodings||!e.setParameters){S.warn(this._logTag,"Browser doesn't support RTPSender parameters");return-1}var o=e.getParameters();var r=o.encodings;if(r.length===0){S.warn(this._logTag,"Encodings is empty");return-1}var i=r[0];var a=i.maxBitrate?i.maxBitrate:4e4;var l=this._calcBitrate(a,this._loss,this._rtt);if(a!==l){this._bitrateChangedTimes+=1}else{this._bitrateChangedTimes=0}var s=false;if(this._bitrateChangedTimes>1&&this._counter-this._lastSwitch>5){s=true;var c=0;if(l<a){c=-1;if(this._lastDirection>=0){this._karma++}this._banCounter=Math.min(this._karma*this._karma*16,this._banLimit);S.info(this._logTag,"direction="+c+" karma="+this._karma+" set ban="+this._banCounter)}else{c=1;l=Math.min(a+4*1e3,l);if(this._banCounter>0){this._banCounter--}s=this._banCounter===0}if(s){i.maxBitrate=l;e.setParameters(o);this._lastDirection=c;this._lastSwitch=this._counter}}this._counter++;if(s){return l}return 0};RTCAudioAdaptation.prototype._smoothStats=function(e,t){this._loss=(this._loss*7+e)/8;this._rtt=this._rtt===0?t:(this._rtt*7+t)/8};RTCAudioAdaptation.prototype._calcBitrate=function(e,t,n){var o=Math.floor(e/1e3);var r=40;var i=Math.max(Math.min(Math.floor(n),3e3),0);if(i<250){r=40}else if(i<800){r=o}else if(i<2e3){r=o-4}else{r=Math.floor(o/2)}var a=8;if(i<100){a=16}r=r>a?r:a;var l=Math.max(Math.min(Math.round(t)-8,32),0);l=Math.floor(l/4);var s=Math.max(1-l/8,0);var c=Math.floor(a+(r-a)*s);return c*1e3};return RTCAudioAdaptation}();var ce=function(){function PacketLossFractionCalculator(){this._totalPackets=0;this._totalLost=0;this._fractionLost=0;this._minInterval=3e3}PacketLossFractionCalculator.prototype.update=function(e,t){var n=Date.now();if(typeof this._lastUpdate==="undefined"){this._totalLost=t;this._totalPackets=e;this._lastUpdate=n}else{var o=n-this._lastUpdate;if(o>=this._minInterval){if(e<this._totalPackets){this._totalPackets=0;this._totalLost=0}if(this._totalLost>t){this._totalLost=t}var r=e-this._totalPackets;var i=Math.min(t-this._totalLost,r);if(r<=0){this._fractionLost=0}else{this._fractionLost=i/r}this._lastUpdate=n;this._totalPackets=e;this._totalLost=t}}};PacketLossFractionCalculator.prototype.getFractionLost=function(){return this._fractionLost};return PacketLossFractionCalculator}();var ue=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var pe="RTCPubnubListener";var _e;(function(e){e["SESSION_STATUS_WITH_RECORDINGS"]="sessionStatusWithRecordings"})(_e||(_e={}));var Ce=function(e){ue(RTCPubnubListener,e);function RTCPubnubListener(){var t=e!==null&&e.apply(this,arguments)||this;t._handleACRNotification=function(e){S.info(pe,"Receive acr notification "+JSON.stringify(e));if(t._checkACRNotificationData(e)){e.parties.forEach((function(e){t.emit(""+_e.SESSION_STATUS_WITH_RECORDINGS+e.id,e)}))}};return t}RTCPubnubListener.instance=function(){if(!RTCPubnubListener._singleton){return RTCPubnubListener._singleton=new RTCPubnubListener}return RTCPubnubListener._singleton};RTCPubnubListener.destroy=function(){RTCPubnubListener._singleton=null};RTCPubnubListener.prototype.subscribe=function(e){var t;S.info(pe,"subscribe pubnub "+e);(t=(0,J.getModule)(r.MODULE_NAME))===null||t===void 0?void 0:t.subscribe(e,this._handleACRNotification)};RTCPubnubListener.prototype.unsubscribe=function(e){var t;S.info(pe,"unsubscribe pubnub "+e);(t=(0,J.getModule)(r.MODULE_NAME))===null||t===void 0?void 0:t.unsubscribe(e,this._handleACRNotification)};RTCPubnubListener.prototype._checkACRNotificationData=function(e){var t;return((t=e===null||e===void 0?void 0:e.parties)===null||t===void 0?void 0:t.length)>0};RTCPubnubListener._singleton=null;return RTCPubnubListener}(x.EventEmitter2);var fe="RTCCallManager";var de=function(){function RTCCallManager(){this._calls=[]}RTCCallManager.prototype.addCall=function(e){this._calls.push(e);S.debug(fe,"Call "+e.getCallInfo().uuid+" added into call manager. Calls: "+this._calls.length)};RTCCallManager.prototype.removeCall=function(e){this._calls=this._calls.filter((function(t){return t.getCallInfo().uuid!==e}));S.debug(fe,"Call "+e+" removed from call manager. Calls: "+this._calls.length)};RTCCallManager.prototype.allowCall=function(){return this._calls.length<_};RTCCallManager.prototype.allowConference=function(){return this._calls.length<=_};RTCCallManager.prototype.callList=function(){return this._calls};RTCCallManager.prototype.callCount=function(){return this._calls.length};RTCCallManager.prototype.connectedCallList=function(){return this._calls.filter((function(e){return e.getCallState()===i.JG.CONNECTED}))};RTCCallManager.prototype.connectedCallCount=function(){return this.connectedCallList().length};RTCCallManager.prototype.getCallByUuid=function(e){return this._calls.find((function(t){return t.getCallInfo().uuid===e}))||null};RTCCallManager.prototype.getVdiVendorName=function(){var e="";this._calls.forEach((function(t){if(!e){e=t.getVdiVendorName()}}));return e};RTCCallManager.prototype.notifyAccountReady=function(){this._calls.forEach((function(e){e.onAccountReady()}))};RTCCallManager.prototype.notifyRecoverStart=function(){this._calls.forEach((function(e){e.recoverStart()}))};RTCCallManager.prototype.recoverCalls=function(){this._calls.forEach((function(e){e.recoverCall()}))};RTCCallManager.prototype.endAllCalls=function(){this._calls.forEach((function(e){e.hangup()}))};return RTCCallManager}();var he=n(271170);var Te=n.n(he);var Re;(function(e){e["NEW_PROV"]="newProv";e["PROV_ARRIVE"]="provArrive";e["PROV_FAILED"]="provFailed"})(Re||(Re={}));var ge;(function(e){e[e["SERVER_TIME_OUT"]=504]="SERVER_TIME_OUT";e[e["UNAUTHORIZED"]=401]="UNAUTHORIZED";e[e["FORBIDDEN"]=403]="FORBIDDEN";e[e["PROXY_AUTHENTICATION_REQUIRED"]=407]="PROXY_AUTHENTICATION_REQUIRED";e[e["TOO_MANY_CONTACTS"]=603]="TOO_MANY_CONTACTS"})(ge||(ge={}));var Ee;(function(e){e["PROVISION_READY"]="provisionReady";e["RE_REGISTER"]="reRegister";e["VDI_RE_REGISTER"]="vdiReRegister";e["ACCOUNT_STATE_CHANGED"]="accountStateChanged";e["MAKE_OUTGOING_CALL_TASK"]="makeOutgoingCallTask";e["RECEIVE_INCOMING_INVITE_TASK"]="receiveIncomingInviteTask";e["UA_REGISTER_SUCCESS"]="uaRegisterSuccess";e["UA_REGISTER_FAILED"]="uaRegisterFailed";e["UA_REGISTER_TIMEOUT"]="uaRegisterTimeout";e["UA_UNREGISTER"]="uaUnregister";e["UA_UNREGISTERED"]="uaUnregistered";e["UA_TRANSPORT_ERROR"]="uaTransportError";e["UA_SWITCH_BACK_PROXY"]="uaSwitchBackProxy";e["LOGOUT"]="logout";e["LOGOUT_ACTION"]="logoutAction";e["RECEIVE_INCOMING_INVITE"]="receiveIncomingInvite";e["REFRESH_PROV"]="refreshProvisioning";e["SWITCH_BACK_PROXY_ACTION"]="switchBackProxyAction";e["TRANSPORT_CONNECTED"]="transportConnected";e["UNREGISTER_WEBPHONE"]="unregisterWebphone"})(Ee||(Ee={}));var ve;(function(e){e["IDLE"]="idle";e["IN_PROGRESS"]="inProgress";e["READY"]="ready";e["FAILURE"]="failure";e["UNREGISTERED"]="unregistered"})(ve||(ve={}));var ye;(function(e){e["REG_IN_PROGRESS"]="onInProgress";e["READY"]="onReady";e["REG_FAILURE"]="onFailure";e["UN_REGISTERED"]="onUnregistered"})(ye||(ye={}));var Ae=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var me=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var Ie=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var Se;(function(e){e[e["REQUEST_ERROR"]=0]="REQUEST_ERROR";e[e["PARAMS_ERROR"]=1]="PARAMS_ERROR"})(Se||(Se={}));var Ne="RTCProvManager";var Oe=function(e){Ae(RTCProvManager,e);function RTCProvManager(){var t=e!==null&&e.apply(this,arguments)||this;t._sipProvisionInfo=null;t._requestErrorRetryInterval=l;t._reFreshInterval=u;t._reFreshTimerId=null;t._canAcquireSipProv=true;t._isRefreshedWithinTime=false;t._isAcquireProvWhenTimeArrived=false;t._refreshByRegFailedTimer=null;t._refreshByRegFailedInterval=p;t._retrySeconds=0;return t}Object.defineProperty(RTCProvManager.prototype,"retrySeconds",{get:function(){return this._retrySeconds},set:function(e){this._retrySeconds=e},enumerable:true,configurable:true});RTCProvManager.prototype.acquireSipProv=function(){return me(this,void 0,void 0,(function(){var e;return Ie(this,(function(t){switch(t.label){case 0:e=B.instance().read(P.kProvisioningInfoKey);if(e){S.info(Ne,"SIP provisioning info FOUND in DAO");this._sipProvisionInfo=e;this.emit(Re.NEW_PROV,{info:this._sipProvisionInfo})}else{S.info(Ne,"There's no SIP provisioning info in DAO")}if(!this._canAcquireSipProv){return[2]}return[4,this._sendSipProvRequest()];case 1:t.sent();return[2]}}))}))};RTCProvManager.prototype.refreshSipProv=function(e){if(e===void 0){e=false}return me(this,void 0,void 0,(function(){var t=this;return Ie(this,(function(n){switch(n.label){case 0:S.info(Ne,"start refresh Sip Provisioning");if(!e&&this._isRefreshedWithinTime){this._isAcquireProvWhenTimeArrived=true;S.info(Ne,"waiting to refresh Sip Provisioning when time arrives");return[2]}this._isRefreshedWithinTime=true;return[4,this._sendSipProvRequest().then((function(){t._setRefreshByRegFailedTimer()}))];case 1:n.sent();return[2]}}))}))};RTCProvManager.prototype._setRefreshByRegFailedTimer=function(){var e=this;if(this._refreshByRegFailedTimer){clearTimeout(this._refreshByRegFailedTimer);this._refreshByRegFailedTimer=null}this._refreshByRegFailedTimer=setTimeout((function(){e._refreshSipProvWhenTimeArrived()}),this._refreshByRegFailedInterval*1e3)};RTCProvManager.prototype._refreshSipProvWhenTimeArrived=function(){var e=this;if(this._isAcquireProvWhenTimeArrived){S.info(Ne,"during the timer call refresh api then refresh sip provisioning when time arrives");this._isAcquireProvWhenTimeArrived=false;this._sendSipProvRequest().then((function(){e._setRefreshByRegFailedTimer()}));return}this._isRefreshedWithinTime=false};RTCProvManager.prototype.initRefreshState=function(){this._isRefreshedWithinTime=false;this._isAcquireProvWhenTimeArrived=false;if(this._refreshByRegFailedTimer){clearTimeout(this._refreshByRegFailedTimer);this._refreshByRegFailedTimer=null}};RTCProvManager.prototype.clearProvInfo=function(){S.debug(Ne,"clear provisioning info");this._clearFreshTimer();this._sipProvisionInfo=null;B.instance().remove(P.kProvisioningInfoKey)};RTCProvManager.prototype._sendSipProvRequest=function(){return me(this,void 0,void 0,(function(){var e,t,n,o;return Ie(this,(function(r){switch(r.label){case 0:S.info(Ne,"start send SipProv Request");e=null;r.label=1;case 1:r.trys.push([1,3,,4]);return[4,H.sendSipProvRequest()];case 2:e=r.sent();return[3,4];case 3:t=r.sent();S.error(Ne,"the request error is: "+t);return[3,4];case 4:if(!e){S.error(Ne,"the response is null");return[2]}if(e.status<200||e.status>=400){S.info(Ne,"the response is error:"+e.status);this._maybeNotifyProvisioningError(e);this._errorHandling(Se.REQUEST_ERROR,e.retryAfter);return[2]}n=e.data;if(!this._checkSipProvInfoParams(n)){S.info(Ne,"the response param is error");this._errorHandling(Se.PARAMS_ERROR,e.retryAfter);return[2]}this._resetFreshTimer();this._requestErrorRetryInterval=l;S.info(Ne,"Reset SIP provisioning info error retry interval to "+this._requestErrorRetryInterval);o=Te().cloneDeep(this._sipProvisionInfo);if(!this._sipProvisionInfo||!Te().isEqual(n,this._sipProvisionInfo)){S.info(Ne,"Received new SIP provisioning info from server");if(!this._sipProvisionInfo||!Te().isEqual(n.sipInfo,this._sipProvisionInfo.sipInfo)||!Te().isEqual(n.sipFlags,this._sipProvisionInfo.sipFlags)||!Te().isEqual(n.sipErrorCodes,this._sipProvisionInfo.sipErrorCodes)){S.info(Ne,"SIP info changed in new SIP Provisioning");this.emit(Re.NEW_PROV,{info:n})}this._sipProvisionInfo=n;B.instance().save(P.kProvisioningInfoKey,this._sipProvisionInfo)}else{S.info(Ne,"New SIP provisioning info from server is same as old one. Ignore it")}this.emit(Re.PROV_ARRIVE,n,o);return[2]}}))}))};RTCProvManager.prototype._resetFreshTimer=function(){var e=this;S.info(Ne,"set fresh timer");this._clearFreshTimer();this._reFreshTimerId=setTimeout((function(){e._sendSipProvRequest()}),this._reFreshInterval*1e3)};RTCProvManager.prototype._clearFreshTimer=function(){if(this._reFreshTimerId){clearTimeout(this._reFreshTimerId)}this._reFreshTimerId=null};RTCProvManager.prototype._maybeNotifyProvisioningError=function(e){var t;this.emit(Re.PROV_FAILED,e.status,(t=e.data)===null||t===void 0?void 0:t.errorCode)};RTCProvManager.prototype._errorHandling=function(e,t){var n=0;switch(e){case Se.REQUEST_ERROR:n=t?Math.max(this._requestErrorRetryInterval,t):this._requestErrorRetryInterval;this._retryRequestForError(n);this._requestErrorRetryInterval=Math.min(this._requestErrorRetryInterval*2,s);break;case Se.PARAMS_ERROR:n=t?Math.max(c,t):c;this._retryRequestForError(n);break;default:S.error(Ne,"the error type "+e+" is not defined");break}};RTCProvManager.prototype._retryRequestForError=function(e){var t=this;S.info(Ne,"set "+e+" s error retry timer");this._clearFreshTimer();this._canAcquireSipProv=false;this.retrySeconds=e;setTimeout((function(){t._canAcquireSipProv=true;t._sendSipProvRequest()}),e*1e3)};RTCProvManager.prototype._checkSipProvInfoParams=function(e){S.info(Ne,"the prov info: "+JSON.stringify((0,m.sensitive)(e)));var t=false;try{var n=e.sipInfo instanceof Array?e.sipInfo[0]:e.sipInfo;t=isNotEmptyString(n.authorizationId)&&isNotEmptyString(n.domain)&&isNotEmptyString(n.outboundProxy)&&isNotEmptyString(n.password)&&isNotEmptyString(n.transport)&&isNotEmptyString(n.username)}catch(e){S.error(Ne,"the Prov Info Params error is: "+e)}return t};RTCProvManager.prototype.getCurrentSipProvisionInfo=function(){return this._sipProvisionInfo};return RTCProvManager}(x.EventEmitter2);var be=n(990883);var Le=n.n(be);var De=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var Pe;(function(e){e["PROVISION_READY"]="provisionReady";e["REG_SUCCEED"]="regSuccess";e["REG_FAILED"]="regFailed";e["UNREGISTER"]="unregister";e["UNREGISTERED"]="unregistered";e["TRANSPORT_ERROR"]="transportError";e["SWITCH_BACK_PROXY"]="switchBackProxy";e["RE_REGISTER"]="reRegister";e["VDI_RE_REGISTER"]="vdiReRegister";e["MAKE_OUTGOING_CALL"]="makeOutgoingCall";e["RECEIVE_INCOMING_INVITE"]="receiveIncomingInvite";e["UNREGISTER_WEBPHONE"]="unregisterWebphone"})(Pe||(Pe={}));var Me=function(e){De(RTCRegistrationFSM,e);function RTCRegistrationFSM(t){var n=e.call(this,{init:ve.IDLE,transitions:[{name:Pe.PROVISION_READY,from:[ve.IDLE,ve.IN_PROGRESS,ve.READY,ve.FAILURE],to:function(e,n){t.onProvisionReadyAction(e,n);return ve.IN_PROGRESS}},{name:Pe.RE_REGISTER,from:[ve.IN_PROGRESS,ve.FAILURE,ve.READY,ve.UNREGISTERED],to:function(e){t.onReRegisterAction(e);return ve.IN_PROGRESS}},{name:Pe.VDI_RE_REGISTER,from:[ve.IN_PROGRESS,ve.FAILURE,ve.READY,ve.UNREGISTERED],to:function(e,n,o){t.onVDIReRegisterAction(e,n,o);return ve.IN_PROGRESS}},{name:Pe.MAKE_OUTGOING_CALL,from:ve.FAILURE,to:function(){t.onReRegisterAction(true);return ve.IN_PROGRESS}},{name:Pe.RECEIVE_INCOMING_INVITE,from:[ve.IN_PROGRESS,ve.FAILURE,ve.READY],to:function(e,n){t.onReceiveIncomingInviteAction(e);return n}},{name:Pe.REG_FAILED,from:[ve.IN_PROGRESS,ve.READY],to:ve.FAILURE},{name:Pe.TRANSPORT_ERROR,from:[ve.IN_PROGRESS,ve.READY],to:ve.FAILURE},{name:Pe.UNREGISTER,from:[ve.READY,ve.FAILURE,ve.IN_PROGRESS,ve.IDLE],to:function(){t.onUnregisterAction();return ve.UNREGISTERED}},{name:Pe.UNREGISTERED,from:ve.READY,to:ve.FAILURE},{name:Pe.UNREGISTER_WEBPHONE,from:[ve.READY,ve.IN_PROGRESS],to:function(){t.onUnregisterWebphoneAction();return ve.UNREGISTERED}},{name:Pe.REG_SUCCEED,from:[ve.READY,ve.IN_PROGRESS,ve.FAILURE],to:ve.READY},{name:Pe.SWITCH_BACK_PROXY,from:[ve.IN_PROGRESS,ve.READY,ve.FAILURE],to:function(){t.onSwitchBackProxyAction();return n.state}}],methods:{onTransition:function(e){S.debug("RTC_ACCOUNT_FSM","Transition: "+e.transition+" from: "+e.from+" to: "+e.to);return true},onInvalidTransition:function(e,t,n){S.debug("RTC_ACCOUNT_FSM","Invalid transition: "+e+" from: "+t+" to: "+n)},onPendingTransition:function(e,t,n){S.debug("RTC_ACCOUNT_FSM","Pending transition: "+e+" from: "+t+" to: "+n)}}})||this;return n}return RTCRegistrationFSM}(Le());var we=n(193415);var Fe=n(245697);var ke;(function(e){e["REG_SUCCESS"]="uaRegisterSuccess";e["REG_FAILED"]="uaRegisterFailed";e["REG_UNREGISTER"]="uaUnRegister";e["REG_UNREGISTERED"]="uaUnRegistered";e["RECEIVE_INVITE"]="uaReceiveInvite";e["TRANSPORT_ERROR"]="uaTransportError";e["TRANSPORT_CONNECTED"]="uaTransportConnected";e["SWITCH_BACK_PROXY"]="uaSwitchBackProxy";e["PROVISION_UPDATE"]="uaProvisionUpdate"})(ke||(ke={}));var Ue;(function(e){e["ACCEPTED"]="accepted";e["CONFIRMED"]="confirmed";e["BYE"]="bye";e["FAILED"]="failed";e["PROGRESS"]="progress";e["REINVITE_ACCEPTED"]="reinviteAccepted";e["REINVITE_FAILED"]="reinviteFailed";e["RENEGOTIATION_ERROR"]="renegotiationError"})(Ue||(Ue={}));var Ge;(function(e){e["RC_P_RC"]="P-Rc";e["RC_API_IDS"]="P-Rc-Api-Ids";e["RC_ALERT_INFO"]="Alert-Info";e["RC_API_CLIENT_REF"]="P-Rc-Api-Client-Ref"})(Ge||(Ge={}));var He;(function(e){e["REFER_REQUEST_ACCEPTED"]="referRequestAccepted";e["REFER_REQUEST_REJECTED"]="referRequestRejected";e["REFER_NOTIFY"]="notify"})(He||(He={}));var Ve;(function(e){e["SDH_CREATED"]="SessionDescriptionHandler-created";e["ADD_TRACK"]="addTrack";e["ADD_STREAM"]="addStream";e["LOADED_DATA"]="loadeddata";e["USER_MEDIA_FAILED"]="userMediaFailed";e["SET_LOCAL_PC_FAILED"]="peerConnection-SetLocalDescriptionFailed";e["SET_REMOTE_PC_FAILED"]="peerConnection-setRemoteDescriptionFailed";e["PC_CREATE_ANSWER_FAILED"]="peerConnection-createAnswerFailed";e["PC_CREATE_OFFER_FAILED"]="peerConnection-createOfferFailed";e["RC_MOVE_TO_RCV"]="moveToRcv";e["UPDATE_RECEIVED"]="updateReceived"})(Ve||(Ve={}));var Be;(function(e){e["MEDIA_CONNECTION_STATE_CHANGED"]="mediaConnectionStateChanged";e["MEDIA_CONNECTION_NEW"]="mediaConnectionStateNew";e["MEDIA_CONNECTION_CHECKING"]="mediaConnectionStateChecking";e["MEDIA_CONNECTION_CONNECTED"]="mediaConnectionStateConnected";e["MEDIA_CONNECTION_COMPLETED"]="mediaConnectionStateCompleted";e["MEDIA_CONNECTION_FAILED"]="mediaConnectionStateFailed";e["MEDIA_CONNECTION_DISCONNECTED"]="mediaConnectionStateDisconnected";e["MEDIA_CONNECTION_CLOSED"]="mediaConnectionStateClosed"})(Be||(Be={}));var xe;(function(e){e["DEBUG"]="debug";e["LOG"]="log";e["WARN"]="warn";e["ERROR"]="error"})(xe||(xe={}));var We=/^unable to acquire streams:.*/;var je;(function(e){e[e["BAD"]=60]="BAD";e[e["POOR"]=43]="POOR";e[e["FAIR"]=16]="FAIR"})(je||(je={}));var Ye;(function(e){e["INBOUND_RTP"]="inbound-rtp";e["OUTBOUND_RTP"]="outbound-rtp";e["CANDIDATE_PAIR"]="candidate-pair";e["LOCAL_CANDIDATE"]="local-candidate";e["REMOTE_CANDIDATE"]="remote-candidate";e["MEDIA_SOURCE"]="media-source";e["TRACK"]="track";e["TRANSPORT"]="transport"})(Ye||(Ye={}));var qe;(function(e){e["BYTES_RECEIVED"]="bytesReceived";e["PACKETS_RECEIVED"]="packetsReceived";e["JITTER"]="jitter";e["JITTER_BUFFER_DELAY"]="jitterBufferDelay";e["JITTER_BUFFER_EMITTED_COUNT"]="jitterBufferEmittedCount";e["PACKETS_LOST"]="packetsLost";e["FRACTION_LOST"]="fractionLost";e["TOTAL_AUDIO_ENERGY"]="totalAudioEnergy";e["TOTAL_SAMPLES_DURATION"]="totalSamplesDuration";e["CONCEALED_SAMPLES"]="concealedSamples";e["TOTAL_SAMPLES_RECEIVED"]="totalSamplesReceived";e["MEDIA_TYPE"]="mediaType";e["ROUND_TRIP_TIME"]="roundTripTime";e["BYTES_SENT"]="bytesSent";e["PACKETS_SENT"]="packetsSent";e["CURRENT_ROUND_TRIP_TIME"]="currentRoundTripTime";e["ID"]="id";e["IS_REMOTE"]="isRemote";e["IP"]="ip";e["CANDIDATE_TYPE"]="candidateType";e["NETWORK_TYPE"]="networkType";e["PRIORITY"]="priority";e["PORT"]="port";e["DTLS_STATE"]="dtlsState";e["SELECTED_CANDIDATE_PAIR_CHANGES"]="selectedCandidatePairChanges";e["SELECTED_CANDIDATE_PAIR_ID"]="selectedCandidatePairId"})(qe||(qe={}));var Ke="VOICE_QUALITY_CHANGED_EVENT";var Qe="bitrateChangedEvent";var Je=function(){function Accumulator(e){this._m=0;this._s=0;this._N=0;this._key=e}Accumulator.prototype.addDateValue=function(e){this._N++;this._s=e-this._m?this._s+(this._N-1)/this._N*(e-this._m)*(e-this._m):0;this._m=this._m+(e-this._m)/this._N};Object.defineProperty(Accumulator.prototype,"value",{get:function(){return this._N-1?+Math.sqrt(this._s/(this._N-1)).toFixed(5):0},enumerable:true,configurable:true});Object.defineProperty(Accumulator.prototype,"prop",{get:function(){return this._key},enumerable:true,configurable:true});return Accumulator}();const Xe=Je;var $e=["jitter","fractionLost","currentRoundTripTime","packetsReceived","bytesReceived","packetsLost","packetsSent","bytesSent"];var deepClone=function(e){return JSON.parse(JSON.stringify(e))};var defaultItems=function(){return $e.reduce((function(e,t){e[t]=0;return e}),Object.create(null))};var ze=undefined&&undefined.__read||function(e,t){var n=typeof Symbol==="function"&&e[Symbol.iterator];if(!n)return e;var o=n.call(e),r,i=[],a;try{while((t===void 0||t-- >0)&&!(r=o.next()).done)i.push(r.value)}catch(e){a={error:e}}finally{try{if(r&&!r.done&&(n=o["return"]))n.call(o)}finally{if(a)throw a.error}}return i};var Ze=function(){function MediaReport(){this._queue=[];this._outcome=null;this._accumulator=Object.create(null);this._sum=Object.create(null);this._total=0;this._init()}MediaReport.prototype._init=function(){var e=this;this._queue=[defaultItems()];this._accumulator=Object.create(null);this._sum=Object.create(null);this._outcome=null;this._total=0;$e.forEach((function(t){e._accumulator[t]=new Xe(t);e._sum[t]=0}))};MediaReport.instance=function(){return MediaReport._singleton||(MediaReport._singleton=new MediaReport)};MediaReport.prototype.destroySingleton=function(){MediaReport._singleton=null};MediaReport.prototype._generateItem=function(e){var t=e.headMin,n=e.headMax,o=e.tailMin,r=e.tailMax;return{min:Math.min(t,o),max:Math.max(n,r)}};MediaReport.prototype._getAverage=function(e){return+(this._sum[e]/this._total).toFixed(5)};MediaReport.prototype._NeedCalculateDiff=function(e){return e!=="jitter"&&e!=="fractionLost"&&e!=="currentRoundTripTime"};MediaReport.prototype._calculationDiff=function(e){var t=this;var n=ze(e,2),o=n[0],r=n[1],i=r===void 0?{none:true}:r;var a=Object.create(null);$e.forEach((function(e){if(i.none)i[e]=0;if(!t._NeedCalculateDiff(e)){a[e]=t._generateItem({headMin:i[e],headMax:i[e],tailMin:i[e],tailMax:i[e]});t._sum[e]+=i[e];t._accumulator[e].addDateValue(i[e]);return}a[e]=i[e]-o[e];t._accumulator[e].addDateValue(a[e])}));return a};MediaReport.prototype._calculationOutCome=function(e){var t=this;return $e.reduce((function(n,o){if(t._NeedCalculateDiff(o)){t._sum[o]+=e[o]}var r=!t._NeedCalculateDiff(o)?e[o].min:e[o];var i=!t._NeedCalculateDiff(o)?e[o].max:e[o];n[o]=t._generateItem({headMin:t._outcome?t._outcome[o].min:r,headMax:t._outcome?t._outcome[o].max:i,tailMin:r,tailMax:i});return n}),Object.create(null))};MediaReport.prototype._parse=function(e){return $e.reduce((function(t,n){if(e.inboundRtpReport&&e.inboundRtpReport[n]!==undefined){t[n]=e.inboundRtpReport[n]}else if(e.outboundRtpReport&&e.outboundRtpReport[n]!==undefined){t[n]=e.outboundRtpReport[n]}else if(e.rttMS&&e.rttMS[n]!==undefined){t[n]=e.rttMS[n]}return t}),Object.create(null))};MediaReport.prototype._start=function(e){this._queue.push(e);this._total++;if(this._queue.length>=2){this._outcome=this._calculationOutCome(this._calculationDiff(this._queue));this._queue.shift()}};MediaReport.prototype.startAnalysis=function(e){if(!e||typeof e!=="object"||!e.inboundRtpReport)return;this._start(this._parse(e))};MediaReport.prototype.stopAnalysis=function(){var e=deepClone(this.outcome);this.destroySingleton();return e};Object.defineProperty(MediaReport.prototype,"outcome",{get:function(){var e=this;if(!this._outcome)return null;$e.forEach((function(t){if(e._outcome){e._outcome[t].variance=e._accumulator[t].value;e._outcome[t].average=e._getAverage(t)}}));return this._outcome},enumerable:true,configurable:true});MediaReport._singleton=null;return MediaReport}();var et="Call and Media Report";var tt=function(){function CallReport(e){this.id="";this.createTime=null;this.sessionId="";this.ua=null;this.direction="";this.establishment=Object.create(null);this.events=[];this.fsmStatus=[];this.media=null;this.audioInputEvents=[];this.audioOutputEvents=[];this.invalidEA=false;this._eventLogger=e}CallReport.prototype.update=function(e,t){this[e]=t};CallReport.prototype.updateByPipe=function(e){var t=this;e.map((function(e){return t[e.key]=e.value}))};CallReport.prototype.updateFsmStatus=function(e){var t;(t=this._eventLogger)===null||t===void 0?void 0:t.other("fsm",{state:e});this.fsmStatus.push({name:e,timestamp:(new Date).toISOString()})};CallReport.prototype.updateAudioInputEvents=function(e){var t;(t=this._eventLogger)===null||t===void 0?void 0:t.step("audio device","input device: "+e,ne.DEVICE);this.audioInputEvents.push({name:e,timestamp:(new Date).toISOString()})};CallReport.prototype.updateAudioOutputEvents=function(e){var t;(t=this._eventLogger)===null||t===void 0?void 0:t.step("audio device","output device: "+e,ne.DEVICE);this.audioOutputEvents.push({name:e,timestamp:(new Date).toISOString()})};CallReport.prototype.updateCallEvent=function(e,t){this.events.push({name:e,info:t,timestamp:(new Date).toISOString()})};CallReport.prototype.updateEstablishment=function(e){if(this.establishment[e])return;this.establishment[e]=+new Date};CallReport.prototype._calculationEstablishDurationBulk=function(){var e=this,t=e.establishment,n=e.direction;var o=t.startTime,r=t.received200OkTime,i=t.answerTime,a=t.receivedAckTime;var l;var s;if(n==="outgoing"&&r){l=o;s=r}if(n==="incoming"&&a){l=i;s=a}if(l&&s){var c=s-l;this.establishment.establishDurationBulk=c+"ms"}};CallReport.prototype._report=function(){var e=this,t=e.id,n=e.createTime,o=e.sessionId,r=e.ua,i=e.direction,a=e.establishment,l=e.events,s=e.fsmStatus,c=e.media,u=e.audioInputEvents,p=e.audioOutputEvents;var _=JSON.stringify({id:t,createTime:n,sessionId:o,ua:r,direction:i,establishment:a,events:l,fsmStatus:s,media:c,audioInputEvents:u,audioOutputEvents:p});S.info(et,_)};CallReport.prototype._beforeDestroy=function(){this._calculationEstablishDurationBulk()};CallReport.prototype.destroy=function(){this._beforeDestroy();this.media=Ze.instance().stopAnalysis();this._report()};CallReport.prototype.getCallReportInfo=function(){return this};return CallReport}();var nt;(function(e){e["START_TIME"]="startTime";e["INVITE_SENT_TIME"]="inviteSentTime";e["RECEIVED_183_TIME"]="received183Time";e["RECEIVED_200_OK_TIME"]="received200OkTime";e["SENT_200_OK_TIME"]="sent200OkTime";e["ANSWER_TIME"]="answerTime";e["RECEIVED_ACK_TIME"]="receivedAckTime";e["MEDIA_CONNECTED_TIME"]="mediaConnectedTime";e["ESTABLISH_DURATION_BULK"]="establishDurationBulk";e["ID"]="id";e["SESSION_ID"]="sessionId";e["CREATE_TIME"]="createTime";e["UA"]="ua";e["DIRECTION"]="direction";e["ESTABLISHMENT"]="establishment";e["FSM_STATUS"]="fsmStatus"})(nt||(nt={}));var ot;(function(e){e["InviteError"]="InviteError";e["RegistrationError"]="RegistrationError";e["MediaEvent"]="MediaEvent";e["NetworkEvent"]="NetworkEvent";e["CallAction"]="CallAction";e["CallActionSuccess"]="CallActionSuccess";e["CallActionFailed"]="CallActionFailed"})(ot||(ot={}));var rt;(function(e){e["SET_LOCAL_FAILED"]="setLocalFailed";e["SET_REMOTE_FAILED"]="setRemoteFailed";e["CREATE_OFFER_FAILED"]="createOfferFailed";e["CREATE_ANSWER_FAILED"]="createAnswerFailed"})(rt||(rt={}));var it;(function(e){e["USER_MEDIA_FAILED"]="User media failed";e["NO_MICROPHONE_PERMISSION"]="No microphone permission";e["REGISTRATION_FAILED"]="Registration failed";e["INVITER_FAILED"]="Invite failed";e["INVITE_TERMINATED"]="Invite terminated";e["SHORT_RING"]="Short ring";e["ANSWER_FAILED"]="Answer failed";e["ANSWER_TERMINATED"]="Answer terminated";e["CALL_RECOVER_REINVITE_FAILED"]="Call recover reInvite failed";e["CALL_RECOVER_REINVITE_NOT_SENT"]="Call recover reInvite not sent";e["CALL_ACTION_FAILED"]="Call action failed";e["PEER_CONNECTION_FAILED"]="Peer connection failed";e["ICE_CANDIDATES_FAILED"]="ICE candidates failed";e["ICE_CONNECTION_STATE_NOT_CONNECTED"]="ICE connection state not connected";e["NO_RTP"]="No rtp";e["NO_AUDIO_LEVEL"]="No audio level";e["CALL_RECOVER_NO_RTP"]="Call recover no rtp";e["CALL_RECOVER_NO_AUDIO_LEVEL"]="Call recover no audio level";e["PLAY_REMOTE_TRACK_FAILED"]="Play remote track failed";e["CALL_ESTABLISH_TOO_LONG"]="Call establish too long";e["ANSWER_CALL_TOO_LONG"]="Answer call too long";e["CALL_RECOVER_TOO_LONG"]="Call recover too long";e["FIRST_RTP_TOO_LONG"]="First RTP too long";e["HIGH_PACKET_LOSS"]="High packet loss";e["LOST_RTP"]="Lost RTP";e["HIGH_RTT"]="High RTT";e["HIGH_JITTER"]="High jitter";e["LOW_BANDWIDTH"]="Low bandwidth"})(it||(it={}));var at;(function(e){e["P0"]="P0";e["P1"]="P1";e["P2"]="P2"})(at||(at={}));var lt;(function(e){e["TWO_WAY"]="two-way";e["NO_LOCAL"]="no-local";e["NO_REMOTE"]="no-remote"})(lt||(lt={}));var st=new Map([[it.USER_MEDIA_FAILED,at.P0],[it.NO_MICROPHONE_PERMISSION,at.P0],[it.REGISTRATION_FAILED,at.P0],[it.INVITER_FAILED,at.P0],[it.INVITE_TERMINATED,at.P0],[it.ANSWER_FAILED,at.P0],[it.ANSWER_TERMINATED,at.P0],[it.CALL_RECOVER_REINVITE_FAILED,at.P0],[it.CALL_RECOVER_REINVITE_NOT_SENT,at.P0],[it.CALL_ACTION_FAILED,at.P0],[it.PEER_CONNECTION_FAILED,at.P0],[it.ICE_CANDIDATES_FAILED,at.P0],[it.ICE_CONNECTION_STATE_NOT_CONNECTED,at.P0],[it.NO_RTP,at.P0],[it.NO_AUDIO_LEVEL,at.P0],[it.CALL_RECOVER_NO_RTP,at.P0],[it.CALL_RECOVER_NO_AUDIO_LEVEL,at.P0],[it.PLAY_REMOTE_TRACK_FAILED,at.P0],[it.CALL_ESTABLISH_TOO_LONG,at.P1],[it.ANSWER_CALL_TOO_LONG,at.P1],[it.CALL_RECOVER_TOO_LONG,at.P1],[it.FIRST_RTP_TOO_LONG,at.P1],[it.HIGH_PACKET_LOSS,at.P1],[it.LOST_RTP,at.P1],[it.HIGH_RTT,at.P1],[it.HIGH_JITTER,at.P1],[it.LOW_BANDWIDTH,at.P1],[it.SHORT_RING,at.P2]]);var ct;(function(e){e["Device"]="Device";e["Signaling"]="Signaling";e["Media"]="Media";e["Unknown"]="Unknown"})(ct||(ct={}));var ut=new Map([[it.USER_MEDIA_FAILED,ct.Device],[it.NO_MICROPHONE_PERMISSION,ct.Device],[it.REGISTRATION_FAILED,ct.Signaling],[it.INVITER_FAILED,ct.Signaling],[it.INVITE_TERMINATED,ct.Signaling],[it.SHORT_RING,ct.Signaling],[it.ANSWER_FAILED,ct.Signaling],[it.ANSWER_TERMINATED,ct.Signaling],[it.CALL_RECOVER_REINVITE_FAILED,ct.Signaling],[it.CALL_RECOVER_REINVITE_NOT_SENT,ct.Signaling],[it.CALL_ACTION_FAILED,ct.Signaling],[it.PEER_CONNECTION_FAILED,ct.Media],[it.ICE_CANDIDATES_FAILED,ct.Media],[it.ICE_CONNECTION_STATE_NOT_CONNECTED,ct.Media],[it.NO_RTP,ct.Media],[it.NO_AUDIO_LEVEL,ct.Media],[it.CALL_RECOVER_NO_RTP,ct.Media],[it.CALL_RECOVER_NO_AUDIO_LEVEL,ct.Media],[it.PLAY_REMOTE_TRACK_FAILED,ct.Media],[it.CALL_ESTABLISH_TOO_LONG,ct.Signaling],[it.ANSWER_CALL_TOO_LONG,ct.Signaling],[it.CALL_RECOVER_TOO_LONG,ct.Signaling],[it.FIRST_RTP_TOO_LONG,ct.Media],[it.HIGH_PACKET_LOSS,ct.Media],[it.LOST_RTP,ct.Media],[it.HIGH_RTT,ct.Media],[it.HIGH_JITTER,ct.Media],[it.LOW_BANDWIDTH,ct.Media]]);var pt;(function(e){e["GOOD"]="good";e["POOR"]="poor";e["BAD"]="bad"})(pt||(pt={}));var _t="RTCCallErrorReporter";var Ct=function(){function RTCCallErrorReporter(e,t,n,o){this._reportInfo={};this._vdiVendorName="";this._reportInfo.username=e;this._reportInfo.callUuid=t;this._reportInfo.app=n;this._reportInfo.proxy=o;this._reportInfo.createdTime=Date.now()}RTCCallErrorReporter.prototype.record=function(e,t){if(t===void 0){t={}}var n=Te().cloneDeep(this._reportInfo);this._setCategoryAndPriority(n,e);n.info=t;S.record(_t,n)};RTCCallErrorReporter.prototype.reportCallQuality=function(e){var t=Object.assign({proxy:this._reportInfo.proxy,outboundRtpCodec:this._reportInfo.outboundRtpCodec||"Unknown"},e);var n={event:{type:"call-quality",details:{feature:"call-quality",data:t}}};this._report(n)};RTCCallErrorReporter.prototype.reportEvent=function(e,t){if(t===void 0){t={}}var n=Te().cloneDeep(this._reportInfo);this._setCategoryAndPriority(n,e);n.info=t;var o={event:{type:"call-error",details:{feature:n.category?n.category:"",data:n}}};this._report(o)};RTCCallErrorReporter.prototype._report=function(e){S.info(_t,JSON.stringify(e));if(this._vdiVendorName){S.info(_t,"It is a "+this._vdiVendorName+" call, do not report call info to edc")}else{S.reportEvent(e)}};RTCCallErrorReporter.prototype.notifyUploadLog=function(){S.report(_t,"upload telephony log")};RTCCallErrorReporter.prototype._setCategoryAndPriority=function(e,t){e.name=t;e.category=this.getErrorCategory(e.name);e.priority=this.getErrorPriority(e.name)};RTCCallErrorReporter.prototype.getErrorPriority=function(e){return st.get(e)};RTCCallErrorReporter.prototype.getErrorCategory=function(e){return ut.get(e)};RTCCallErrorReporter.prototype.setPartyId=function(e){this._reportInfo.partyId=e};RTCCallErrorReporter.prototype.setDirection=function(e){this._reportInfo.direction=e};RTCCallErrorReporter.prototype.setSessionId=function(e){this._reportInfo.telephonySessionId=e};RTCCallErrorReporter.prototype.setSipCallId=function(e){this._reportInfo.sipCallId=e};RTCCallErrorReporter.prototype.updateProxyServer=function(e){S.info(_t,"update proxy server: "+e);this._reportInfo.proxy=e};RTCCallErrorReporter.prototype.setUserAgent=function(e){this._reportInfo.userAgent=e};RTCCallErrorReporter.prototype.setOutboundRtpCodec=function(e){this._reportInfo.outboundRtpCodec=e};RTCCallErrorReporter.prototype.setVDIVendorName=function(e){this._vdiVendorName=e};return RTCCallErrorReporter}();var ft=300;var dt=5e3;var ht=5e3;var Tt="toMainProxy";var Rt="toBackupProxy";var gt=function(){function RTCCallRecoverEvent(){this._recoverStartTime=Date.now();this._reinviteSentTime=-1;this._reinviteSuccessTime=-1;this._error="";this._isInterrupted=false}RTCCallRecoverEvent.prototype.markReInviteSent=function(){if(this._reinviteSentTime>0){return}this._reinviteSentTime=Date.now()};RTCCallRecoverEvent.prototype.markReInviteSuccess=function(){if(this._reinviteSuccessTime>0){return}this._reinviteSuccessTime=Date.now()};RTCCallRecoverEvent.prototype.markInterrupt=function(){if(this._error){return}if(this._reinviteSentTime<0||this._reinviteSuccessTime<0){this._isInterrupted=true}};RTCCallRecoverEvent.prototype.markRecoverErrorMessage=function(e){this._error=e};RTCCallRecoverEvent.prototype.markRecoverWhenHold=function(){this._isInterrupted=true};RTCCallRecoverEvent.prototype.getRecoverError=function(){if(this._isInterrupted){return undefined}if(this._reinviteSentTime<0){return it.CALL_RECOVER_REINVITE_NOT_SENT}if(this._reinviteSuccessTime<0){return it.CALL_RECOVER_REINVITE_FAILED}return undefined};RTCCallRecoverEvent.prototype.getRecoverErrorMsg=function(){return this._error};RTCCallRecoverEvent.prototype.getRecoverStartTime=function(){return this._recoverStartTime};RTCCallRecoverEvent.prototype.isInterrupted=function(){return this._isInterrupted};RTCCallRecoverEvent.prototype.isCallRecoverySucceed=function(){return this._reinviteSuccessTime>0};return RTCCallRecoverEvent}();var Et;(function(e){e["ACCEPTED"]="callSessionAccepted";e["CONFIRMED"]="callSessionConfirmed";e["DISCONNECTED"]="callSessionDisconnected";e["ERROR"]="callSessionError";e["PROGRESS"]="callSessionProgress";e["REINVITE_ACCEPTED"]="callSessionReinviteAccepted";e["REINVITE_FAILED"]="callSessionReinviteFailed";e["RECONNECT_MEDIA_FAILED"]="reconnectMediaFailed";e["RENEGOTIATION_ERROR"]="callSessionRenegotiationError";e["ACQUIRE_STREAM_ERROR"]="acquireStreamError";e["MEDIA_CONNECTION_FAILED"]="mediaConnectionFailed";e["MEDIA_BROKEN"]="mediaBroken";e["REINVITE_TIMEOUT"]="callSessionReinviteTimeout";e["MOVE_TO_RCV"]="moveToRcv";e["RECEIVE_ASSERTED_IDENTITY"]="receiveAssertedIdentity"})(Et||(Et={}));var vt;(function(e){e["ON_ANSWERING"]="onAnswering";e["ON_PENDING"]="onPending";e["ON_CONNECTING"]="onConnecting";e["ON_CONNECTED"]="onConnected";e["ON_DISCONNECTED"]="onDisconnected";e["ON_LEAVE_CONNECTED"]="onLeaveConnected";e["ENTER_ANSWERING"]="enterAnswering";e["ENTER_PENDING"]="enterPending";e["ENTER_CONNECTING"]="enterConnecting";e["ENTER_CONNECTED"]="enterConnected";e["ENTER_DISCONNECTED"]="enterDisconnected";e["LEAVE_CONNECTED"]="leaveConnected";e["ANSWER_ACTION"]="answerAction";e["REJECT_ACTION"]="rejectAction";e["SEND_TO_VOICEMAIL_ACTION"]="sendToVoicemailAction";e["HANGUP_ACTION"]="hangupAction";e["CREATE_OUTGOING_CALL_SESSION"]="createOutgoingCallSession";e["FLIP_ACTION"]="flipAction";e["BARGE_ACTION"]="bargeAction";e["TRANSFER_TO_CONF_ACTION"]="transferToConfAction";e["WHISPER_ACTION"]="whisperAction";e["TRANSFER_ACTION"]="transferAction";e["WARM_TRANSFER_ACTION"]="warmTransferAction";e["FORWARD_ACTION"]="forwardAction";e["START_RECORD_ACTION"]="startRecordAction";e["STOP_RECORD_ACTION"]="stopRecordAction";e["MUTE_ACTION"]="muteAction";e["UNMUTE_ACTION"]="unmuteAction";e["CALL_ACTION_SUCCESS"]="callActionSuccess";e["CALL_ACTION_FAILED"]="callActionFailed";e["HOLD_ACTION"]="holdAction";e["UNHOLD_ACTION"]="unholdAction";e["HOLD_SUCCESS_ACTION"]="holdSuccessAction";e["UNHOLD_SUCCESS_ACTION"]="unholdSuccessAction";e["HOLD_FAILED_ACTION"]="holdFailedAction";e["UNHOLD_FAILED_ACTION"]="unholdFailedAction";e["PARK_ACTION"]="parkAction";e["PARK_TO_LOCATION_ACTION"]="parkToLocationAction";e["DTMF_ACTION"]="dtmfAction";e["START_REPLY_ACTION"]="startReplyAction";e["REPLY_WITH_PATTERN_ACTION"]="replyWithPatternAction";e["REPLY_WITH_MESSAGE_ACTION"]="replyWithMessageAction";e["RECOVER_CALL_ACTION"]="recoverCallAction"})(vt||(vt={}));var yt={IDLE:"idle",PENDING:"pending",ANSWERING:"answering",REPLYING:"replying",FORWARDING:"forwarding",CONNECTING:"connecting",CONNECTED:"connected",HOLDING:"holding",HOLDED:"holded",UNHOLDING:"unholding",DISCONNECTED:"disconnected"};var At="RTCCallErrorCalculator";var mt=5*1e3;var It=10*1e3;var St=10;var Nt=function(){function RTCCallTagCalculator(e,t,n,o,r,i){this._callRecoverEventList=[];this._answerTime=-1;this._establishTime=-1;this._shouldUploadLog=false;this._quality=pt.GOOD;this._mediaConnectedTime=-1;this._errorEvents={};this._adaptiveBitrateEvents=[];this._featureFlags={adaptiveBitrate:false};S.info(At,"new RTCCallTagCalculator");this._reporter=new Ct(e,t,n,o);this._startTime=Date.now();this._isIncomingCall=r;this._isIncomingCall?this._reporter.setDirection("incoming"):this._reporter.setDirection("outgoing");this._eventLogger=i}RTCCallTagCalculator.prototype.isAnswered=function(){return this._isIncomingCall&&this._answerTime>0};RTCCallTagCalculator.prototype.getDuration=function(){var e=Date.now();if(this._isIncomingCall&&this.isAnswered()){return e-this._answerTime}if(!this._isIncomingCall){return e-this._startTime}return-1};RTCCallTagCalculator.prototype.getQuality=function(){return this._quality};RTCCallTagCalculator.prototype.markBitrateChanged=function(e){if(this._adaptiveBitrateEvents.length<St){this._adaptiveBitrateEvents.push(e)}else{this._adaptiveBitrateEvents.shift();this._adaptiveBitrateEvents.push(e)}};RTCCallTagCalculator.prototype.setFeatureFlags=function(e){this._featureFlags=e};RTCCallTagCalculator.prototype.markCallAnswered=function(){if(this._answerTime<0){this._answerTime=Date.now()}};RTCCallTagCalculator.prototype.markCallEstablished=function(){if(this._establishTime===-1){this._establishTime=Date.now()}};RTCCallTagCalculator.prototype.callActionEvent=function(e){var t=Date.now()-this._startTime;if(e===i.VB.HANGUP&&t<It&&t>mt){(this._fsmStatus===yt.CONNECTING||this._fsmStatus===yt.PENDING)&&!this._isIncomingCall&&this._establishTime<0&&this._report(it.INVITE_TERMINATED);this._fsmStatus===yt.ANSWERING&&this._report(it.ANSWER_TERMINATED)}};RTCCallTagCalculator.prototype.reportMediaErrorEvents=function(e){var t=this;e.forEach((function(e){t._report(e.name,e.info)}))};RTCCallTagCalculator.prototype.reportPCFailed=function(e,t){this._report(it.PEER_CONNECTION_FAILED,{type:e,info:t})};RTCCallTagCalculator.prototype.reportPlayRemoteTrackFailed=function(e){this._report(it.PLAY_REMOTE_TRACK_FAILED,{error:e})};RTCCallTagCalculator.prototype.reportICEConnectFailed=function(){this._mediaConnectedTime<0&&this._report(it.ICE_CANDIDATES_FAILED)};RTCCallTagCalculator.prototype.markMediaConnected=function(){this._mediaConnectedTime<0&&(this._mediaConnectedTime=Date.now())};RTCCallTagCalculator.prototype.reportUserMediaFailed=function(){this._report(it.USER_MEDIA_FAILED)};RTCCallTagCalculator.prototype.updateFsmStatus=function(e){this._fsmStatus=e};RTCCallTagCalculator.prototype.recordStartRing=function(){this._startRingTime=Date.now()};RTCCallTagCalculator.prototype.callHangupTimerReached=function(e){e>=400&&this._report(it.REGISTRATION_FAILED,{regStatusCode:e})};RTCCallTagCalculator.prototype.callActionFailed=function(e,t,n){this._report(it.CALL_ACTION_FAILED,{callAction:e,code:t,error:n})};RTCCallTagCalculator.prototype.stopRing=function(){if(!this._startRingTime){S.warn(At,"Not start ring so can not do stop ring");return}var e=Date.now()-this._startRingTime;if(e<ft){this._report(it.SHORT_RING)}this._startRingTime=0};RTCCallTagCalculator.prototype._report=function(e,t){if(t===void 0){t={}}var n;var o=ae.WARN;if(this._reporter.getErrorPriority(e)===at.P0){this._reporter.reportEvent(e,t);this._shouldUploadLog=true;this._quality=pt.BAD;o=ae.ERROR}else{this._reporter.reportEvent(e,t);this._quality!==pt.BAD?this._quality=pt.POOR:this._quality=pt.BAD}var r=this._reporter.getErrorCategory(e)||ct.Unknown;var i=this._reporter.getErrorPriority(e)||at.P2;(n=this._eventLogger)===null||n===void 0?void 0:n.step(e,JSON.stringify(t),ne.ERROR_REPORT,o);if(this._errorEvents[e]){this._errorEvents[e].count+=1;this._errorEvents[e].lastTime=Date.now()}else{this._errorEvents[e]={category:r,priority:i,firstTime:Date.now(),lastTime:0,count:1}}};RTCCallTagCalculator.prototype.callDestroy=function(e){var t,n,o,r,i;var a=-1;if(this._establishTime>=0){a=Date.now()-this._establishTime}var l=this._quality;this._checkAndReportCallRecoverError();this._checkAndReportCallEstablishEvent();var s=this._getCallRecoveryStaticData();var c=Object.assign({callQuality:l,callDuration:a,callRecovery:s,errorEvents:this._errorEvents,volume:W.l.instance().getVolume(),adaptiveBitrateEvents:this._adaptiveBitrateEvents,featureFlags:this._featureFlags},e);this._reporter.reportCallQuality(c);this._shouldUploadLog&&this._reporter.notifyUploadLog();return{callDuration:c.callDuration,callId:c.id,sessionId:c.sessionId,direction:c.direction,fromName:((t=c.callInfo)===null||t===void 0?void 0:t.fromName)||"",toName:((n=c.callInfo)===null||n===void 0?void 0:n.toName)||"",fromNumber:((o=c.callInfo)===null||o===void 0?void 0:o.fromNumber)||"",toNumber:((r=c.callInfo)===null||r===void 0?void 0:r.toNumber)||"",isQueueCall:(i=c.callInfo)===null||i===void 0?void 0:i.isQueueCall}};RTCCallTagCalculator.prototype.setPartyId=function(e){this._reporter.setPartyId(e)};RTCCallTagCalculator.prototype.setSessionId=function(e){this._reporter.setSessionId(e)};RTCCallTagCalculator.prototype.setSipCallId=function(e){this._reporter.setSipCallId(e)};RTCCallTagCalculator.prototype.updateProxyServer=function(e){S.info(At,"update proxy server: "+e);this._reporter.updateProxyServer(e)};RTCCallTagCalculator.prototype.setUserAgent=function(e){this._reporter.setUserAgent(e)};RTCCallTagCalculator.prototype.setOutboundRtpCodec=function(e){this._reporter.setOutboundRtpCodec(e)};RTCCallTagCalculator.prototype.setVDIVendorName=function(e){this._reporter.setVDIVendorName(e)};RTCCallTagCalculator.prototype.markNewCallRecover=function(){var e=new gt;var t=Te().last(this._callRecoverEventList);t&&t.markInterrupt();this._callRecoverEventList.push(e)};RTCCallTagCalculator.prototype.markCallRecoverReinviteSent=function(){var e=Te().last(this._callRecoverEventList);e&&e.markReInviteSent()};RTCCallTagCalculator.prototype.markCallRecoverReInviteSuccess=function(){var e=Te().last(this._callRecoverEventList);e&&e.markReInviteSuccess()};RTCCallTagCalculator.prototype.markCallRecoverErrorMsg=function(e){var t=Te().last(this._callRecoverEventList);t&&t.markRecoverErrorMessage(e)};RTCCallTagCalculator.prototype.markCallRecoverWhenHold=function(){var e=Te().last(this._callRecoverEventList);e&&e.markRecoverWhenHold()};RTCCallTagCalculator.prototype.sessionError=function(e,t){if(We.test(e)){this._report(it.NO_MICROPHONE_PERMISSION)}else if(e==="Canceled"){this.stopRing()}else if(this._isIncomingCall&&this._answerTime>0){this._report(it.ANSWER_FAILED)}else if(!this._isIncomingCall&&this._fsmStatus===yt.CONNECTING&&this._establishTime<0){this._report(it.INVITER_FAILED,{info:t})}else{S.warn(At,"Undefined session error "+e)}};RTCCallTagCalculator.prototype.markNoRtpOrNoAudio=function(e,t,n,o,r){if(!e&&!t){if(this._mediaConnectedTime>0){this._report(it.NO_RTP,{direction:lt.TWO_WAY,transport:r})}else{this._report(it.ICE_CONNECTION_STATE_NOT_CONNECTED,{transport:r})}return}if(!e){this._report(it.NO_RTP,{direction:lt.NO_LOCAL,transport:r});if(!o){this._report(it.NO_AUDIO_LEVEL,{direction:lt.NO_REMOTE,transport:r,volume:W.l.instance().getVolume()})}return}if(!t){this._report(it.NO_RTP,{direction:lt.NO_REMOTE,transport:r});if(!n){this._report(it.NO_AUDIO_LEVEL,{direction:lt.NO_LOCAL,transport:r,volume:W.l.instance().getVolume()})}return}if(!n&&!o){this._report(it.NO_AUDIO_LEVEL,{direction:lt.TWO_WAY,transport:r,volume:W.l.instance().getVolume()});return}if(!n){this._report(it.NO_AUDIO_LEVEL,{direction:lt.NO_LOCAL,transport:r,volume:W.l.instance().getVolume()})}if(!o){this._report(it.NO_AUDIO_LEVEL,{direction:lt.NO_REMOTE,transport:r,volume:W.l.instance().getVolume()})}};RTCCallTagCalculator.prototype._getCallRecoveryStaticData=function(){var e=this._callRecoverEventList.length;var t=0;var n=0;var o=0;this._callRecoverEventList.forEach((function(e){if(e.isInterrupted()){t++}else if(e.isCallRecoverySucceed()){n++}else if(e.getRecoverError()){o++}}));return{total:e,succeed:n,failed:o,interrupted:t}};RTCCallTagCalculator.prototype._checkAndReportCallEstablishEvent=function(){if(this._establishTime<0){return}if(this._isIncomingCall&&this._answerTime>0&&this._establishTime-this._answerTime>ht){var e=this._establishTime-this._answerTime;S.warn(At,"Answer call too long "+e+" ms");this._report(it.ANSWER_CALL_TOO_LONG,{duration:e});return}if(!this._isIncomingCall&&this._establishTime-this._startTime>dt){var e=this._establishTime-this._startTime;S.warn(At,"Establish call too long "+e+" ms");this._report(it.CALL_ESTABLISH_TOO_LONG,{duration:e});return}};RTCCallTagCalculator.prototype._checkAndReportCallRecoverError=function(){var e=this;if(this._callRecoverEventList.length===0){return}var t=Te().last(this._callRecoverEventList);if(!t||!t.getRecoverError()){return}this._callRecoverEventList.forEach((function(t){var n=t.getRecoverError();n&&e._report(n,{error:t.getRecoverErrorMsg()})}))};return RTCCallTagCalculator}();var Ot="RTCAccountEventReporter";var bt=function(){function RTCAccountEventReporter(){}RTCAccountEventReporter.prototype.updateProxy=function(e){this._proxy=e};RTCAccountEventReporter.prototype.accountSwitchProxy=function(e){var t={event:{type:"voip-account-event",details:{feature:"switch-proxy",data:{direction:e?Rt:Tt,destination:e?this._proxy.backupProxy:this._proxy.mainProxy}}}};this._report(t)};RTCAccountEventReporter.prototype._report=function(e){S.info(Ot,JSON.stringify(e));S.reportEvent(e)};return RTCAccountEventReporter}();var Lt=1*60*1e3;var Dt=3*60*1e3;var Pt=5*1e3;var Mt=3;var wt=5;var Ft=5;var kt=.3;var Ut=300;var Gt=100;var Ht=3;var Vt=.2;var Bt="idle";var xt=30*1e3;var Wt={transferToConf:{reqid:8,command:"transfer",type:"rcc",number:"",code:""}};var jt=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var Yt=undefined&&undefined.__read||function(e,t){var n=typeof Symbol==="function"&&e[Symbol.iterator];if(!n)return e;var o=n.call(e),r,i=[],a;try{while((t===void 0||t-- >0)&&!(r=o.next()).done)i.push(r.value)}catch(e){a={error:e}}finally{try{if(r&&!r.done&&(n=o["return"]))n.call(o)}finally{if(a)throw a.error}}return i};var qt=undefined&&undefined.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(Yt(arguments[t]));return e};var Kt="RTCMediaStatsManager";var Qt=function(e){jt(RTCMediaStatsManager,e);function RTCMediaStatsManager(t,n){var o=e.call(this)||this;o._hasSentPackages=false;o._hasReceivedPackages=false;o._mediaStatsReport={timestamp:0};o._mediaTransportInfo={dtlsState:Bt,packetsSent:0,packetsReceived:0,selectedCandidatePairChanges:0,selectedCandidatePairIdList:[],localCandidates:[],remoteCandidates:[]};o._bandwidth={total:0,min:-1,max:-1};o._noPacketReceivedCount=0;o._totalNoPacketReceivedCount=0;o._totalReportCount=0;o._highPacketLossCount=0;o._highRttCount=0;o._highJitterCount=0;o._lowBandwidthCount=0;o._lastMedia={hasConfirmed:false,hasConnected:false,hasSent:false,hasRecv:false};o._recvPacketsLossList=[0,0,0];o._voiceQuality=i.kX.GOOD;o._isLocalMuted=false;o._isAlwaysLocalMutedWhenGetStats=true;o._uuid=t;o._eventLogger=n;return o}Object.defineProperty(RTCMediaStatsManager.prototype,"localMute",{set:function(e){this._isLocalMuted=e},enumerable:true,configurable:true});RTCMediaStatsManager.prototype.isLastMediaValid=function(){return this._lastMedia.hasConfirmed&&this._lastMedia.hasConnected&&this._lastMedia.hasSent&&this._lastMedia.hasRecv};RTCMediaStatsManager.prototype.resetLastMedia=function(){this._lastMedia.hasConfirmed=false;this._lastMedia.hasConnected=false;this._lastMedia.hasSent=false;this._lastMedia.hasRecv=false};RTCMediaStatsManager.prototype.getMediaTransportInfo=function(){return this._mediaTransportInfo};RTCMediaStatsManager.prototype.getMediaStatsReport=function(){return this._mediaStatsReport};RTCMediaStatsManager.prototype.markLastMediaConfirmed=function(){S.debug(Kt,"mark last media confirmed");this._lastMedia.hasConfirmed=true};RTCMediaStatsManager.prototype.markLastMediaConnected=function(){S.debug(Kt,"mark last media ICE connected");this._lastMedia.hasConnected=true};RTCMediaStatsManager.prototype.hasSentPackages=function(){return this._hasSentPackages};RTCMediaStatsManager.prototype.hasReceivedPackages=function(){return this._hasReceivedPackages};RTCMediaStatsManager.prototype.hasLocalAudioLevel=function(){var e,t;if(this._isAlwaysLocalMutedWhenGetStats){S.info(Kt,"Local audio is muted all the time, so return true");return true}if(((t=(e=this._mediaStatsReport)===null||e===void 0?void 0:e.outboundRtpReport)===null||t===void 0?void 0:t.totalAudioEnergy)!==undefined){return this._mediaStatsReport.outboundRtpReport.totalAudioEnergy>Math.pow(10,-6)}return true};RTCMediaStatsManager.prototype.hasRemoteAudioLevel=function(){var e,t;if(((t=(e=this._mediaStatsReport)===null||e===void 0?void 0:e.inboundRtpReport)===null||t===void 0?void 0:t.totalAudioEnergy)!==undefined){return this._mediaStatsReport.inboundRtpReport.totalAudioEnergy>Math.pow(10,-6)}return true};RTCMediaStatsManager.prototype.getNoPacketReceivedCount=function(){return this._noPacketReceivedCount};RTCMediaStatsManager.prototype.resetNoPacketReceivedCount=function(){this._noPacketReceivedCount=0};RTCMediaStatsManager.prototype.mediaDisconnect=function(){if(this._voiceQuality!==i.kX.BAD){this._voiceQuality=i.kX.BAD;S.info(Kt,"Media disconnect and voice quality changed to "+this._voiceQuality);this.notifyVoiceQualityChanged()}};RTCMediaStatsManager.prototype.getMediaErrorEvents=function(){var e=[];if(this._meetThreshold(this._highPacketLossCount,Vt)){e.push({name:it.HIGH_PACKET_LOSS,info:{}})}if(this._meetThreshold(this._highRttCount,Vt)){e.push({name:it.HIGH_RTT,info:{}})}if(this._meetThreshold(this._highJitterCount,Vt)){e.push({name:it.HIGH_JITTER,info:{}})}if(this._meetThreshold(this._lowBandwidthCount,Vt)){e.push({name:it.LOW_BANDWIDTH,info:{max:this._bandwidth.max,min:this._bandwidth.min,avg:this._averageBandwidth()}})}if(this._totalNoPacketReceivedCount>0){e.push({name:it.LOST_RTP,info:{}})}return e};RTCMediaStatsManager.prototype._calculateFractionLostInPercent=function(e,t){var n=this._mediaStatsReport.outboundRtpReport&&this._mediaStatsReport.outboundRtpReport.packetsSent?this._mediaStatsReport.outboundRtpReport.packetsSent:0;var o=this._mediaStatsReport.inboundRtpReport&&this._mediaStatsReport.inboundRtpReport.packetsReceived?this._mediaStatsReport.inboundRtpReport.packetsReceived:0;var r=n-e;var i=o-t;var a=r<=0?100:(1-i/r)*100;a=a<100?a:100;a=a>0?a:0;a=Math.round(a);return a};Object.defineProperty(RTCMediaStatsManager.prototype,"voiceQuality",{get:function(){return this._voiceQuality},enumerable:true,configurable:true});RTCMediaStatsManager.prototype._calculateVoiceQuality=function(e,t){var n=this._calculateFractionLostInPercent(e,t);this._recvPacketsLossList.unshift(n);this._recvPacketsLossList.pop();var o=Math.max.apply(Math,qt(this._recvPacketsLossList));var r=Math.min.apply(Math,qt(this._recvPacketsLossList));var a=i.kX.GOOD;var l=this._voiceQuality;if(r>=je.BAD){a=i.kX.BAD}else if(r>=je.POOR){a=i.kX.POOR}else if(r>=je.FAIR){a=i.kX.FAIR}if(this._voiceQuality>=a){this._voiceQuality=a}else{if(o<je.FAIR){a=i.kX.GOOD}else if(o<je.POOR){a=i.kX.FAIR}else if(o<je.BAD){a=i.kX.POOR}else{a=i.kX.BAD}if(this._voiceQuality<=a){this._voiceQuality=a}}if(l!==this._voiceQuality){this.notifyVoiceQualityChanged();S.info(Kt,"Voice quality changed from: "+l+"  to "+this._voiceQuality)}};RTCMediaStatsManager.prototype.notifyVoiceQualityChanged=function(){this.emit(Ke,this._voiceQuality)};RTCMediaStatsManager.prototype.processMediaStatsReport=function(e){var t,n,o,r,i,a,l,s,c,u,p,_,C,f,d,h,T;if(!this._isLocalMuted){this._isAlwaysLocalMutedWhenGetStats=false}var R=this._mediaStatsReport.inboundRtpReport&&this._mediaStatsReport.inboundRtpReport.packetsReceived?this._mediaStatsReport.inboundRtpReport.packetsReceived:0;var g=this._mediaStatsReport.outboundRtpReport&&this._mediaStatsReport.outboundRtpReport.packetsSent?this._mediaStatsReport.outboundRtpReport.packetsSent:0;this._updateLowBandwidthCount(e);this._formatMediaStatsReport(e);this._calculateVoiceQuality(g,R);Ze.instance().startAnalysis(this._mediaStatsReport);this._totalReportCount++;S.info(Kt," ["+this._uuid+"] Got mediaStats "+JSON.stringify(this._mediaStatsReport));this._calculateMediaStats(e);(t=this._eventLogger)===null||t===void 0?void 0:t.other("mediaStats",{audioLevel:{local:(o=(n=this._mediaStatsReport.outboundRtpReport)===null||n===void 0?void 0:n.rtpLocalAudioLevel)!==null&&o!==void 0?o:0,remote:(i=(r=this._mediaStatsReport.inboundRtpReport)===null||r===void 0?void 0:r.rtpRemoteAudioLevel)!==null&&i!==void 0?i:0},bytes:{local:(l=(a=this._mediaStatsReport.outboundRtpReport)===null||a===void 0?void 0:a.bytesSent)!==null&&l!==void 0?l:0,remote:(c=(s=this._mediaStatsReport.inboundRtpReport)===null||s===void 0?void 0:s.bytesReceived)!==null&&c!==void 0?c:0},packets:{local:(p=(u=this._mediaStatsReport.outboundRtpReport)===null||u===void 0?void 0:u.packetsSent)!==null&&p!==void 0?p:0,remote:(C=(_=this._mediaStatsReport.inboundRtpReport)===null||_===void 0?void 0:_.packetsReceived)!==null&&C!==void 0?C:0},jitter:(d=(f=this._mediaStatsReport.inboundRtpReport)===null||f===void 0?void 0:f.jitter)!==null&&d!==void 0?d:0,rtt:(T=(h=this._mediaStatsReport.rttMS)===null||h===void 0?void 0:h.currentRoundTripTime)!==null&&T!==void 0?T:0});this._updateHighPacketLossCount();this._updateHighRttCount();this._updateHighJitterCount();if(this._mediaStatsReport.inboundRtpReport&&this._mediaStatsReport.inboundRtpReport.packetsReceived>0){this._hasReceivedPackages=true;if(R!==this._mediaStatsReport.inboundRtpReport.packetsReceived){this._noPacketReceivedCount=0}else{this._noPacketReceivedCount++;this._totalNoPacketReceivedCount++}Math.abs(this._mediaStatsReport.inboundRtpReport.packetsReceived-R)>1&&(this._lastMedia.hasRecv=true)}else{this._noPacketReceivedCount++;this._totalNoPacketReceivedCount++}if(this._mediaStatsReport.outboundRtpReport&&this._mediaStatsReport.outboundRtpReport.packetsSent>0){this._hasSentPackages=true;if(this._mediaStatsReport.outboundRtpReport.packetsSent!==g){this._lastMedia.hasSent=true}}this._processMediaTransportInfo(e)};RTCMediaStatsManager.prototype._MergeCandidatesList=function(e,t){if(e){e.forEach((function(e){var n;var o=((n=e.id)===null||n===void 0?void 0:n.split("_"))||[];if(o.length===0)return;var r=t.find((function(e){return e.id===o[1]}));if(!r){e.id=o[1];t.push(e)}}))}};RTCMediaStatsManager.prototype._mergeCandidatesPairList=function(e,t){var n=e.split("_");if(n.length===3){var o=t.find((function(e){return e.localCandidate===n[1]&&e.remoteCandidate===n[2]}));if(!o){t.push({localCandidate:n[1],remoteCandidate:n[2]});this._eventLogger.step("new candidate pair","local: "+n[1]+", remote: "+n[2],ne.MEDIA)}}};RTCMediaStatsManager.prototype._processMediaTransportInfo=function(e){if(e.localCandidates){this._MergeCandidatesList(e.localCandidates,this._mediaTransportInfo.localCandidates)}if(e.remoteCandidates){this._MergeCandidatesList(e.remoteCandidates,this._mediaTransportInfo.remoteCandidates)}if(e.transport&&e.transport.dtlsState){this._mediaTransportInfo.dtlsState=e.transport.dtlsState}if(e.transport&&e.transport.selectedCandidatePairChanges){this._mediaTransportInfo.selectedCandidatePairChanges=e.transport.selectedCandidatePairChanges}if(e.transport&&e.transport.packetsSent){this._mediaTransportInfo.packetsSent=e.transport.packetsSent}if(e.transport&&e.transport.packetsReceived){this._mediaTransportInfo.packetsReceived=e.transport.packetsReceived}if(e.transport&&e.transport.selectedCandidatePairId.length>0){this._mergeCandidatesPairList(e.transport.selectedCandidatePairId,this._mediaTransportInfo.selectedCandidatePairIdList)}};RTCMediaStatsManager.prototype._updateHighPacketLossCount=function(){if(this._mediaStatsReport.inboundRtpReport&&this._mediaStatsReport.inboundRtpReport.fractionLost&&this._mediaStatsReport.inboundRtpReport.fractionLost>kt){this._highPacketLossCount++}};RTCMediaStatsManager.prototype._updateHighRttCount=function(){if(this._mediaStatsReport.rttMS&&this._mediaStatsReport.rttMS.currentRoundTripTime&&this._mediaStatsReport.rttMS.currentRoundTripTime>Ut){this._highRttCount++}};RTCMediaStatsManager.prototype._updateHighJitterCount=function(){if(this._mediaStatsReport.inboundRtpReport&&this._mediaStatsReport.inboundRtpReport.jitter&&this._mediaStatsReport.inboundRtpReport.jitter*1e3>Gt){this._highJitterCount++}};RTCMediaStatsManager.prototype._updateLowBandwidthCount=function(e){if(this._mediaStatsReport.timestamp===0||!this._hasByteReceived(this._mediaStatsReport)||!this._hasByteReceived(e)){return}var t=(Date.now()-this._mediaStatsReport.timestamp)/1e3;if(t<=0){return}var n=e.inboundRtpReport.bytesReceived-this._mediaStatsReport.inboundRtpReport.bytesReceived;var o=n<0?0:n;var r=o/t*8/1e3;if(r<Ht){this._lowBandwidthCount++}S.debug(Kt,"Inbound bandwidth: "+r+" kbps");this._bandwidth.total+=r;if(r>this._bandwidth.max){this._bandwidth.max=r}if(this._bandwidth.min<0||r<this._bandwidth.min){this._bandwidth.min=r}};RTCMediaStatsManager.prototype._hasByteReceived=function(e){return e&&e.inboundRtpReport&&e.inboundRtpReport.bytesReceived};RTCMediaStatsManager.prototype._meetThreshold=function(e,t){return this._totalReportCount>0&&e/this._totalReportCount>t};RTCMediaStatsManager.prototype._formatMediaStatsReport=function(e){this._mediaStatsReport.timestamp=Date.now();if(e.inboundRtpReport){this._mediaStatsReport.inboundRtpReport=e.inboundRtpReport}if(e.outboundRtpReport){this._mediaStatsReport.outboundRtpReport=e.outboundRtpReport}if(e.rttMS){this._mediaStatsReport.rttMS=e.rttMS}};RTCMediaStatsManager.prototype._averageBandwidth=function(){if(this._totalReportCount===0){return 0}return this._bandwidth.total/this._totalReportCount};RTCMediaStatsManager.prototype._calculateMediaStats=function(e){var t=0;var n=e.outboundRtpReport;if(n){if(n.totalAudioEnergy!==undefined&&n.totalSamplesDuration!==0){t=n.totalAudioEnergy/n.totalSamplesDuration}}var o=0;var r=0;var i=0;var a=e.inboundRtpReport;if(a){if(a.totalAudioEnergy!==undefined&&a.totalSamplesDuration!==0){o=a.totalAudioEnergy/a.totalSamplesDuration}r=a.jitterBufferMs;if(a.totalSamplesReceived!==0){i=a.concealedSamples/a.totalSamplesReceived}}S.info(Kt," ["+this._uuid+"] average local audio-level is  "+t+", average remote audio-level is  "+o+", jitter buffer is "+r+"ms, choppy is  "+i+".\n      ")};return RTCMediaStatsManager}(x.EventEmitter2);var Jt=n(401727);var Xt=n.n(Jt);var $t=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var zt={ACCOUNT_READY:"accountReady",ACCOUNT_NOT_READY:"accountNotReady",ANSWER:"answer",REJECT:"reject",IGNORE:"ignore",SEND_TO_VOICEMAIL:"sendToVoicemail",HANGUP:"hangup",FLIP:"flip",TRANSFER_TO_CONF:"transferToConf",BARGE:"barge",WHISPER:"whisper",MUTE:"mute",UNMUTE:"Unmute",TRANSFER:"transfer",WARM_TRANSFER:"warmTransfer",FORWARD:"forward",START_RECORD:"startRecord",STOP_RECORD:"stopRecord",HOLD:"hold",UNHOLD:"unhold",PARK:"park",PARK_TO_LOCATION:"parkToLocation",DTMF:"dtmf",START_REPLY:"startReplyWithMessage",REPLY_WITH_MESSAGE:"replyWithMessage",REPLY_WITH_PATTERN:"replyWithPattern",SESSION_ACCEPTED:"sessionAccepted",SESSION_CONFIRMED:"sessionConfirmed",SESSION_DISCONNECTED:"sessionDisconnected",SESSION_ERROR:"sessionError",HOLD_SUCCESS:"holdSuccess",HOLD_FAILED:"holdFailed",UNHOLD_SUCCESS:"unholdSuccess",UNHOLD_FAILED:"unholdFailed",RECOVER_CALL:"recoverCall",GOTO:"goto"};var Zt=function(e){$t(RTCCallFsmTable,e);function RTCCallFsmTable(t){var n=e.call(this,{init:yt.IDLE,transitions:[{name:zt.ACCOUNT_READY,from:[yt.IDLE,yt.PENDING],to:function(){t.onCreateOutCallSession();return yt.CONNECTING}},{name:zt.ACCOUNT_NOT_READY,from:yt.IDLE,to:yt.PENDING},{name:zt.ANSWER,from:[yt.IDLE,yt.REPLYING],to:function(){t.onAnswerAction();return yt.ANSWERING}},{name:zt.REJECT,from:[yt.IDLE,yt.REPLYING],to:function(){t.onRejectAction();return yt.DISCONNECTED}},{name:zt.IGNORE,from:[yt.IDLE,yt.REPLYING],to:yt.DISCONNECTED},{name:zt.SEND_TO_VOICEMAIL,from:[yt.IDLE,yt.REPLYING],to:function(){t.onSendToVoicemailAction();return yt.DISCONNECTED}},{name:zt.START_REPLY,from:yt.IDLE,to:function(){t.onStartReplyAction();return yt.REPLYING}},{name:zt.START_REPLY,from:[yt.ANSWERING,yt.PENDING,yt.CONNECTING,yt.CONNECTED,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING,yt.REPLYING,yt.DISCONNECTED],to:function(){t.onReportCallActionFailed(i.VB.START_REPLY);return n.state}},{name:zt.REPLY_WITH_MESSAGE,from:yt.REPLYING,to:function(e){t.onReplyWithMessageAction(e);return yt.DISCONNECTED}},{name:zt.REPLY_WITH_MESSAGE,from:[yt.IDLE,yt.ANSWERING,yt.PENDING,yt.CONNECTING,yt.CONNECTED,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING,yt.DISCONNECTED],to:function(){t.onReportCallActionFailed(i.VB.REPLY_WITH_MSG);return n.state}},{name:zt.REPLY_WITH_PATTERN,from:yt.REPLYING,to:function(e,n,o){t.onReplyWithPatternAction(e,n,o);return yt.DISCONNECTED}},{name:zt.REPLY_WITH_PATTERN,from:[yt.IDLE,yt.ANSWERING,yt.PENDING,yt.CONNECTING,yt.CONNECTED,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING],to:function(){t.onReportCallActionFailed(i.VB.REPLY_WITH_PATTERN);return n.state}},{name:zt.HANGUP,from:[yt.IDLE,yt.ANSWERING,yt.PENDING,yt.CONNECTING,yt.CONNECTED,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING,yt.REPLYING],to:function(){t.onHangupAction();return yt.DISCONNECTED}},{name:zt.FLIP,from:yt.CONNECTED,to:function(e){t.onFlipAction(e);return yt.CONNECTED}},{name:zt.TRANSFER_TO_CONF,from:yt.CONNECTED,to:function(e){t.onTransferToConfAction(e);return yt.CONNECTED}},{name:zt.BARGE,from:yt.CONNECTED,to:function(){t.onBargeAction();return yt.CONNECTED}},{name:zt.WHISPER,from:yt.CONNECTED,to:function(){t.onWhisperAction();return yt.CONNECTED}},{name:zt.MUTE,from:yt.CONNECTED,to:function(e){t.onMuteAction(e);return yt.CONNECTED}},{name:zt.UNMUTE,from:yt.CONNECTED,to:function(e){t.onUnmuteAction(e);return yt.CONNECTED}},{name:zt.TRANSFER,from:[yt.CONNECTED,yt.HOLDING,yt.HOLDED,yt.UNHOLDING],to:function(e){t.onTransferAction(e);return yt.CONNECTED}},{name:zt.WARM_TRANSFER,from:[yt.CONNECTED,yt.HOLDING,yt.HOLDED,yt.UNHOLDING],to:function(e){t.onWarmTransferAction(e);return n.state}},{name:zt.FORWARD,from:[yt.IDLE,yt.REPLYING],to:function(e){t.onForwardAction(e);return yt.FORWARDING}},{name:zt.PARK,from:yt.CONNECTED,to:function(){t.onParkAction();return yt.CONNECTED}},{name:zt.PARK,from:[yt.IDLE,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING],to:function(){t.onReportCallActionFailed(i.VB.PARK);return undefined}},{name:zt.PARK_TO_LOCATION,from:yt.CONNECTED,to:function(e,n){t.onParkToLocationAction(e);return n}},{name:zt.PARK_TO_LOCATION,from:[yt.IDLE,yt.REPLYING,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING],to:function(e,n){t.onReportCallActionFailed(i.VB.PARK_TO_LOCATION);return n}},{name:zt.TRANSFER,from:[yt.IDLE,yt.REPLYING,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.FORWARDING],to:function(e,n){t.onReportCallActionFailed(i.VB.TRANSFER);return n}},{name:zt.WARM_TRANSFER,from:[yt.IDLE,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.FORWARDING,yt.REPLYING],to:function(e,n){t.onReportCallActionFailed(i.VB.WARM_TRANSFER);return n}},{name:zt.FORWARD,from:[yt.CONNECTED,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING],to:function(e,n){t.onReportCallActionFailed(i.VB.FORWARD);return n}},{name:zt.FLIP,from:[yt.IDLE,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING],to:function(e,n){t.onReportCallActionFailed(i.VB.FLIP);return n}},{name:zt.TRANSFER_TO_CONF,from:[yt.IDLE,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING,yt.REPLYING],to:function(e,n){t.onReportCallActionFailed(i.VB.TRANSFER_TO_CONF);return n}},{name:zt.BARGE,from:[yt.IDLE,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING,yt.REPLYING],to:function(){t.onReportCallActionFailed(i.VB.BARGE);return undefined}},{name:zt.WHISPER,from:[yt.IDLE,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING,yt.REPLYING],to:function(){t.onReportCallActionFailed(i.VB.WHISPER);return undefined}},{name:zt.START_RECORD,from:yt.CONNECTED,to:function(){t.onStartRecordAction();return yt.CONNECTED}},{name:zt.START_RECORD,from:[yt.IDLE,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING],to:function(){t.onReportCallActionFailed(i.VB.START_RECORD);return undefined}},{name:zt.STOP_RECORD,from:yt.CONNECTED,to:function(){t.onStopRecordAction();return yt.CONNECTED}},{name:zt.STOP_RECORD,from:[yt.IDLE,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING],to:function(){t.onReportCallActionFailed(i.VB.STOP_RECORD);return undefined}},{name:zt.HOLD,from:yt.CONNECTED,to:function(){t.onHoldAction();return yt.HOLDING}},{name:zt.HOLD,from:[yt.HOLDING,yt.HOLDED],to:function(e,n){t.onHoldSuccessAction();return n}},{name:zt.HOLD,from:[yt.IDLE,yt.REPLYING,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.UNHOLDING,yt.FORWARDING],to:function(e,n){t.onReportCallActionFailed(i.VB.HOLD);return n}},{name:zt.HOLD_SUCCESS,from:yt.HOLDING,to:function(){t.onHoldSuccessAction();return yt.HOLDED}},{name:zt.HOLD_FAILED,from:yt.HOLDING,to:function(){t.onHoldFailedAction();return yt.CONNECTED}},{name:zt.UNHOLD,from:yt.HOLDED,to:function(){t.onUnholdAction();return yt.UNHOLDING}},{name:zt.UNHOLD,from:[yt.UNHOLDING,yt.CONNECTED],to:function(e,n){t.onUnholdSuccessAction();return n}},{name:zt.UNHOLD,from:[yt.IDLE,yt.REPLYING,yt.ANSWERING,yt.CONNECTING,yt.DISCONNECTED,yt.PENDING,yt.HOLDING,yt.FORWARDING],to:function(e,n){t.onReportCallActionFailed(i.VB.UNHOLD);return n}},{name:zt.UNHOLD_SUCCESS,from:yt.UNHOLDING,to:function(){t.onUnholdSuccessAction();return yt.CONNECTED}},{name:zt.UNHOLD_FAILED,from:yt.UNHOLDING,to:function(){t.onUnholdFailedAction();return yt.HOLDED}},{name:zt.DTMF,from:[yt.CONNECTING,yt.CONNECTED,yt.ANSWERING,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING],to:function(e){t.onDtmfAction(e);return undefined}},{name:zt.SESSION_ACCEPTED,from:yt.CONNECTING,to:yt.CONNECTED},{name:zt.SESSION_CONFIRMED,from:yt.ANSWERING,to:yt.CONNECTED},{name:zt.SESSION_DISCONNECTED,from:[yt.IDLE,yt.ANSWERING,yt.REPLYING,yt.CONNECTING,yt.CONNECTED,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING],to:yt.DISCONNECTED},{name:zt.SESSION_ERROR,from:[yt.IDLE,yt.ANSWERING,yt.REPLYING,yt.CONNECTING,yt.CONNECTED,yt.HOLDING,yt.HOLDED,yt.UNHOLDING,yt.FORWARDING],to:yt.DISCONNECTED},{name:zt.RECOVER_CALL,from:[yt.CONNECTED,yt.HOLDED],to:function(){t.onRecoverCallAction();return undefined}},{name:zt.GOTO,from:"*",to:function(e){return e}}],methods:{onTransition:function(e){t&&t.onUpdateFsmState(e.to);S.debug("RTC_Call_FSM","Transition: "+e.transition+" from: "+e.from+" to: "+e.to);return true},onInvalidTransition:function(e,t,n){S.debug("RTC_Call_FSM","Invalid transition: "+e+" from: "+t+" to: "+n)},onPendingTransition:function(e,t,n){S.debug("RTC_Call_FSM","Pending transition: "+e+" from: "+t+" to: "+n)}}})||this;return n}return RTCCallFsmTable}(Le());var en=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var tn={HANGUP:"hangupEvent",FLIP:"flipEvent",TRANSFER_TO_CONF:"transferToConfEvent",BARGE:"bargeEvent",WHISPER:"whisperEvent",START_RECORD:"startRecordEvent",STOP_RECORD:"stopRecordEvent",MUTE:"muteEvent",UNMUTE:"unmuteEvent",TRANSFER:"transferEvent",WARM_TRANSFER:"warmTransferEvent",FORWARD:"forwardEvent",ANSWER:"answerEvent",REJECT:"rejectEvent",IGNORE:"ignoreEvent",SEND_TO_VOICEMAIL:"sendToVoicemailEvent",HOLD:"holdEvent",UNHOLD:"unholdEvent",PARK:"parkEvent",PARK_TO_LOCATION:"parkToLocationEvent",DTMF:"dtmfEvent",START_REPLY:"startReplyEvent",REPLY_WITH_MSG:"replyWithMsgEvent",REPLY_WITH_PATTERN:"replyWithPatternEvent",ACCOUNT_READY:"accountReadyEvent",ACCOUNT_NOT_READY:"accountNotReadyEvent",SESSION_ACCEPTED:"sessionAcceptedEvent",SESSION_CONFIRMED:"sessionConfirmedEvent",SESSION_DISCONNECTED:"sessionDisconnectedEvent",SESSION_ERROR:"sessionErrorEvent",RECOVER_CALL:"recoverCallEvent",HOLD_SUCCESS:"holdSuccessEvent",HOLD_FAILED:"holdFailedEvent",UNHOLD_SUCCESS:"unholdSuccessEvent",UNHOLD_FAILED:"unholdFailedEvent"};var nn=function(e){en(RTCCallFsm,e);function RTCCallFsm(t,n){var o=e.call(this)||this;o._report=t;o._callTagCalculator=n;o._callFsmTable=new Zt(o);o._eventQueue=Xt().queue((function(e,t){t(e.data)}));o._callFsmTable.observe(vt.ON_ANSWERING,(function(){return o._onEnterAnswering()}));o._callFsmTable.observe(vt.ON_PENDING,(function(){return o._onEnterPending()}));o._callFsmTable.observe(vt.ON_CONNECTING,(function(){return o._onEnterConnecting()}));o._callFsmTable.observe(vt.ON_CONNECTED,(function(){return o._onEnterConnected()}));o._callFsmTable.observe(vt.ON_DISCONNECTED,(function(){return o._onEnterDisconnected()}));o._callFsmTable.observe(vt.ON_LEAVE_CONNECTED,(function(){return o._onLeaveConnected()}));return o}RTCCallFsm.prototype.state=function(){return this._callFsmTable.state};RTCCallFsm.prototype.goto=function(e){return this._callFsmTable.goto(e)};RTCCallFsm.prototype.answer=function(){var e=this;this._eventQueue.push({name:tn.ANSWER},(function(){e._onAnswer()}))};RTCCallFsm.prototype.reject=function(){var e=this;this._eventQueue.push({name:tn.REJECT},(function(){e._onReject()}))};RTCCallFsm.prototype.ignore=function(){var e=this;this._eventQueue.push({name:tn.IGNORE},(function(){e._callFsmTable.ignore()}))};RTCCallFsm.prototype.sendToVoicemail=function(){var e=this;this._eventQueue.push({name:tn.SEND_TO_VOICEMAIL},(function(){e._onSendToVoicemail()}))};RTCCallFsm.prototype.hangup=function(){var e=this;this._eventQueue.push({name:tn.HANGUP},(function(){e._onHangup()}))};RTCCallFsm.prototype.flip=function(e){var t=this;this._eventQueue.push({name:tn.FLIP,data:{targetNumber:e}},(function(e){t._onFlip(e.targetNumber)}))};RTCCallFsm.prototype.transferToConf=function(e){var t=this;this._eventQueue.push({name:tn.TRANSFER_TO_CONF,data:{params:e}},(function(e){t._onTransferToConf(e.params)}))};RTCCallFsm.prototype.barge=function(){var e=this;this._eventQueue.push({name:tn.BARGE},(function(){e._onBarge()}))};RTCCallFsm.prototype.whisper=function(){var e=this;this._eventQueue.push({name:tn.WHISPER},(function(){e._onWhisper()}))};RTCCallFsm.prototype.startRecord=function(){var e=this;this._eventQueue.push({name:tn.START_RECORD},(function(){e._onStartRecord()}))};RTCCallFsm.prototype.stopRecord=function(){var e=this;this._eventQueue.push({name:tn.STOP_RECORD},(function(){e._onStopRecord()}))};RTCCallFsm.prototype.mute=function(e){var t=this;this._eventQueue.push({name:tn.MUTE},(function(){t._onMute(e)}))};RTCCallFsm.prototype.unmute=function(e){var t=this;this._eventQueue.push({name:tn.UNMUTE},(function(){t._onUnmute(e)}))};RTCCallFsm.prototype.park=function(){var e=this;this._eventQueue.push({name:tn.PARK},(function(){e._onPark()}))};RTCCallFsm.prototype.parkToLocation=function(e){var t=this;this._eventQueue.push({name:tn.PARK_TO_LOCATION,data:{locationNumber:e}},(function(e){t._callFsmTable.parkToLocation(e.locationNumber)}))};RTCCallFsm.prototype.transfer=function(e){var t=this;this._eventQueue.push({name:tn.TRANSFER,data:{targetNumber:e}},(function(e){t._onTransfer(e.targetNumber)}))};RTCCallFsm.prototype.warmTransfer=function(e){var t=this;this._eventQueue.push({name:tn.WARM_TRANSFER,data:{target:e}},(function(e){t._onWarmTransfer(e.target)}))};RTCCallFsm.prototype.forward=function(e){var t=this;this._eventQueue.push({name:tn.FORWARD,data:{targetNumber:e}},(function(e){t._onForward(e.targetNumber)}))};RTCCallFsm.prototype.hold=function(){var e=this;this._eventQueue.push({name:tn.HOLD},(function(){e._onHold()}))};RTCCallFsm.prototype.unhold=function(){var e=this;this._eventQueue.push({name:tn.UNHOLD},(function(){e._onUnhold()}))};RTCCallFsm.prototype.dtmf=function(e){var t=this;this._eventQueue.push({name:tn.DTMF,data:{input:e}},(function(e){t._onDtmf(e.input)}))};RTCCallFsm.prototype.startReplyWithMessage=function(){var e=this;this._eventQueue.push({name:tn.START_REPLY},(function(){e._onStartReplyWithMessage()}))};RTCCallFsm.prototype.replyWithMessage=function(e){var t=this;this._eventQueue.push({name:tn.REPLY_WITH_MSG},(function(){t._callFsmTable.replyWithMessage(e)}))};RTCCallFsm.prototype.replyWithPattern=function(e,t,n){var o=this;this._eventQueue.push({name:tn.REPLY_WITH_MSG},(function(){o._callFsmTable.replyWithPattern(e,t,n)}))};RTCCallFsm.prototype.accountReady=function(){var e=this;this._eventQueue.push({name:tn.ACCOUNT_READY},(function(){e._onAccountReady()}))};RTCCallFsm.prototype.accountNotReady=function(){var e=this;this._eventQueue.push({name:tn.ACCOUNT_NOT_READY},(function(){e._onAccountNotReady()}))};RTCCallFsm.prototype.sessionAccepted=function(){var e=this;this._eventQueue.push({name:tn.SESSION_ACCEPTED},(function(){e._onSessionAccepted()}))};RTCCallFsm.prototype.sessionConfirmed=function(){var e=this;this._eventQueue.push({name:tn.SESSION_CONFIRMED},(function(){e._onSessionConfirmed()}))};RTCCallFsm.prototype.sessionDisconnected=function(){var e=this;this._eventQueue.push({name:tn.SESSION_DISCONNECTED},(function(){e._onSessionDisconnected()}))};RTCCallFsm.prototype.holdSuccess=function(){var e=this;this._eventQueue.push({name:tn.HOLD_SUCCESS},(function(){e._onHoldSuccess()}))};RTCCallFsm.prototype.holdFailed=function(){var e=this;this._eventQueue.push({name:tn.HOLD_FAILED},(function(){e._onHoldFailed()}))};RTCCallFsm.prototype.unholdSuccess=function(){var e=this;this._eventQueue.push({name:tn.UNHOLD_SUCCESS},(function(){e._onUnholdSuccess()}))};RTCCallFsm.prototype.unholdFailed=function(){var e=this;this._eventQueue.push({name:tn.UNHOLD_FAILED},(function(){e._onUnholdFailed()}))};RTCCallFsm.prototype.sessionError=function(){var e=this;this._eventQueue.push({name:tn.SESSION_ERROR},(function(){e._onSessionError()}))};RTCCallFsm.prototype.recoverCall=function(){var e=this;this._eventQueue.push({name:tn.RECOVER_CALL},(function(){e._callFsmTable.recoverCall()}))};RTCCallFsm.prototype.onAnswerAction=function(){this.emit(vt.ANSWER_ACTION)};RTCCallFsm.prototype.onRejectAction=function(){this.emit(vt.REJECT_ACTION)};RTCCallFsm.prototype.onSendToVoicemailAction=function(){this.emit(vt.SEND_TO_VOICEMAIL_ACTION)};RTCCallFsm.prototype.onHangupAction=function(){this.emit(vt.HANGUP_ACTION)};RTCCallFsm.prototype.onCreateOutCallSession=function(){this.emit(vt.CREATE_OUTGOING_CALL_SESSION)};RTCCallFsm.prototype.onFlipAction=function(e){this.emit(vt.FLIP_ACTION,e)};RTCCallFsm.prototype.onTransferToConfAction=function(e){this.emit(vt.TRANSFER_TO_CONF_ACTION,e)};RTCCallFsm.prototype.onBargeAction=function(){this.emit(vt.BARGE_ACTION)};RTCCallFsm.prototype.onWhisperAction=function(){this.emit(vt.WHISPER_ACTION)};RTCCallFsm.prototype.onTransferAction=function(e){this.emit(vt.TRANSFER_ACTION,e)};RTCCallFsm.prototype.onWarmTransferAction=function(e){this.emit(vt.WARM_TRANSFER_ACTION,e)};RTCCallFsm.prototype.onForwardAction=function(e){this.emit(vt.FORWARD_ACTION,e)};RTCCallFsm.prototype.onParkAction=function(){this.emit(vt.PARK_ACTION)};RTCCallFsm.prototype.onParkToLocationAction=function(e){this.emit(vt.PARK_TO_LOCATION_ACTION,e)};RTCCallFsm.prototype.onStartRecordAction=function(){this.emit(vt.START_RECORD_ACTION)};RTCCallFsm.prototype.onStopRecordAction=function(){this.emit(vt.STOP_RECORD_ACTION)};RTCCallFsm.prototype.onMuteAction=function(e){this.emit(vt.MUTE_ACTION,e)};RTCCallFsm.prototype.onUnmuteAction=function(e){this.emit(vt.UNMUTE_ACTION,e)};RTCCallFsm.prototype.onReportCallActionFailed=function(e){this.emit(vt.CALL_ACTION_FAILED,e,i.QP.FSM_STATUS_INCORRECT)};RTCCallFsm.prototype.onHoldAction=function(){this.emit(vt.HOLD_ACTION)};RTCCallFsm.prototype.onUnholdAction=function(){this.emit(vt.UNHOLD_ACTION)};RTCCallFsm.prototype.onHoldSuccessAction=function(){this.emit(vt.HOLD_SUCCESS_ACTION)};RTCCallFsm.prototype.onHoldFailedAction=function(){this.emit(vt.HOLD_FAILED_ACTION)};RTCCallFsm.prototype.onUnholdSuccessAction=function(){this.emit(vt.UNHOLD_SUCCESS_ACTION)};RTCCallFsm.prototype.onUnholdFailedAction=function(){this.emit(vt.UNHOLD_FAILED_ACTION)};RTCCallFsm.prototype.onDtmfAction=function(e){this.emit(vt.DTMF_ACTION,e)};RTCCallFsm.prototype.onStartReplyAction=function(){this.emit(vt.START_REPLY_ACTION)};RTCCallFsm.prototype.onReplyWithPatternAction=function(e,t,n){this.emit(vt.REPLY_WITH_PATTERN_ACTION,e,t,n)};RTCCallFsm.prototype.onReplyWithMessageAction=function(e){this.emit(vt.REPLY_WITH_MESSAGE_ACTION,e)};RTCCallFsm.prototype.onRecoverCallAction=function(){this.emit(vt.RECOVER_CALL_ACTION)};RTCCallFsm.prototype._onHangup=function(){this._callFsmTable.hangup()};RTCCallFsm.prototype._onFlip=function(e){this._callFsmTable.flip(e)};RTCCallFsm.prototype._onTransferToConf=function(e){this._callFsmTable.transferToConf(e)};RTCCallFsm.prototype._onBarge=function(){this._callFsmTable.barge()};RTCCallFsm.prototype._onWhisper=function(){this._callFsmTable.whisper()};RTCCallFsm.prototype._onTransfer=function(e){this._callFsmTable.transfer(e)};RTCCallFsm.prototype._onWarmTransfer=function(e){this._callFsmTable.warmTransfer(e)};RTCCallFsm.prototype._onForward=function(e){this._callFsmTable.forward(e)};RTCCallFsm.prototype._onPark=function(){this._callFsmTable.park()};RTCCallFsm.prototype._onStartRecord=function(){this._callFsmTable.startRecord()};RTCCallFsm.prototype._onStopRecord=function(){this._callFsmTable.stopRecord()};RTCCallFsm.prototype._onMute=function(e){this._callFsmTable.mute(e)};RTCCallFsm.prototype._onUnmute=function(e){this._callFsmTable.unmute(e)};RTCCallFsm.prototype._onAnswer=function(){this._callFsmTable.answer()};RTCCallFsm.prototype._onReject=function(){this._callFsmTable.reject()};RTCCallFsm.prototype._onSendToVoicemail=function(){this._callFsmTable.sendToVoicemail()};RTCCallFsm.prototype._onHold=function(){this._callFsmTable.hold()};RTCCallFsm.prototype._onUnhold=function(){this._callFsmTable.unhold()};RTCCallFsm.prototype._onDtmf=function(e){this._callFsmTable.dtmf(e)};RTCCallFsm.prototype._onStartReplyWithMessage=function(){this._callFsmTable.startReplyWithMessage()};RTCCallFsm.prototype._onAccountReady=function(){this._callFsmTable.accountReady()};RTCCallFsm.prototype._onAccountNotReady=function(){this._callFsmTable.accountNotReady()};RTCCallFsm.prototype._onSessionAccepted=function(){this._callFsmTable.sessionAccepted()};RTCCallFsm.prototype._onSessionConfirmed=function(){this._callFsmTable.sessionConfirmed()};RTCCallFsm.prototype._onSessionDisconnected=function(){this._callFsmTable.sessionDisconnected()};RTCCallFsm.prototype._onSessionError=function(){this._callFsmTable.sessionError()};RTCCallFsm.prototype._onHoldSuccess=function(){this._callFsmTable.holdSuccess()};RTCCallFsm.prototype._onHoldFailed=function(){this._callFsmTable.holdFailed()};RTCCallFsm.prototype._onUnholdSuccess=function(){this._callFsmTable.unholdSuccess()};RTCCallFsm.prototype._onUnholdFailed=function(){this._callFsmTable.unholdFailed()};RTCCallFsm.prototype._onEnterAnswering=function(){this.emit(vt.ENTER_ANSWERING)};RTCCallFsm.prototype._onEnterPending=function(){this.emit(vt.ENTER_PENDING)};RTCCallFsm.prototype._onEnterConnecting=function(){this.emit(vt.ENTER_CONNECTING)};RTCCallFsm.prototype._onEnterConnected=function(){this.emit(vt.ENTER_CONNECTED)};RTCCallFsm.prototype._onEnterDisconnected=function(){this.emit(vt.ENTER_DISCONNECTED)};RTCCallFsm.prototype._onLeaveConnected=function(){this.emit(vt.LEAVE_CONNECTED)};RTCCallFsm.prototype.onUpdateFsmState=function(e){this._report.updateFsmStatus(e);this._callTagCalculator.updateFsmStatus(e)};return RTCCallFsm}(x.EventEmitter2);var on="RTCMediaStatsCollector";var rn=function(){function RTCMediaStatsCollector(){this._preRTTCurrentRoundTripTime=0;this._mediaStatsTimer=null;this._session=null;this._mediaStatsCallback=null;this._roundTripTime=-1;this._jitterBufferDelay=0;this._jitterBufferEmittedCount=0;this._mediaStatsReport={timestamp:0}}RTCMediaStatsCollector.prototype.getMediaStats=function(e,t,n){var o=this;if(this._mediaStatsTimer){this.stopMediaStats()}this._session=e;this._mediaStatsCallback=t;this._mediaStatsTimer=setInterval((function(){return o._onMediaStatsTimeOut()}),n)};RTCMediaStatsCollector.prototype.stopMediaStats=function(){this._mediaStatsTimer&&clearInterval(this._mediaStatsTimer);this._mediaStatsTimer=null;this._session=null;this._mediaStatsCallback=null};RTCMediaStatsCollector.prototype._parseInboundRtpStasts=function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case qe.BYTES_RECEIVED:t._mediaStatsReport.inboundRtpReport.bytesReceived=e[n];break;case qe.PACKETS_RECEIVED:t._mediaStatsReport.inboundRtpReport.packetsReceived=e[n];break;case qe.JITTER:t._mediaStatsReport.inboundRtpReport.jitter=e[n];break;case qe.PACKETS_LOST:t._mediaStatsReport.inboundRtpReport.packetsLost=e[n];break;case qe.FRACTION_LOST:t._mediaStatsReport.inboundRtpReport.fractionLost=e[n];break;case qe.MEDIA_TYPE:t._mediaStatsReport.inboundRtpReport.mediaType=e[n];break;case qe.ROUND_TRIP_TIME:t._roundTripTime=e[n];break;case qe.JITTER_BUFFER_DELAY:t._jitterBufferDelay=e[n];break;case qe.JITTER_BUFFER_EMITTED_COUNT:t._jitterBufferEmittedCount=e[n];break;case qe.TOTAL_AUDIO_ENERGY:t._mediaStatsReport.inboundRtpReport.totalAudioEnergy=e[n];break;case qe.TOTAL_SAMPLES_DURATION:t._mediaStatsReport.inboundRtpReport.totalSamplesDuration=e[n];break;case qe.CONCEALED_SAMPLES:t._mediaStatsReport.inboundRtpReport.concealedSamples=e[n];break;case qe.TOTAL_SAMPLES_RECEIVED:t._mediaStatsReport.inboundRtpReport.totalSamplesReceived=e[n];break;default:break}}))};RTCMediaStatsCollector.prototype._parseOutboundRtpStasts=function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case qe.BYTES_SENT:t._mediaStatsReport.outboundRtpReport.bytesSent=e[n];break;case qe.PACKETS_SENT:t._mediaStatsReport.outboundRtpReport.packetsSent=e[n];break;case qe.MEDIA_TYPE:t._mediaStatsReport.outboundRtpReport.mediaType=e[n];break;default:break}}))};RTCMediaStatsCollector.prototype._parseCandidatePairStasts=function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case qe.CURRENT_ROUND_TRIP_TIME:t._mediaStatsReport.rttMS.currentRoundTripTime=e[n];break;default:break}}))};RTCMediaStatsCollector.prototype._parseLocalCandidateStasts=function(e){var t={id:"",isRemote:false,ip:"",port:"",priority:"",candidateType:"",networkType:""};Object.keys(e).forEach((function(n){switch(n){case qe.ID:t.id=e[n];break;case qe.IS_REMOTE:t.isRemote=e[n];break;case qe.IP:t.ip=e[n];break;case qe.CANDIDATE_TYPE:t.candidateType=e[n];break;case qe.NETWORK_TYPE:t.networkType=e[n];break;case qe.PRIORITY:t.priority=e[n];break;case qe.PORT:t.port=e[n];break;default:break}}));this._mediaStatsReport.localCandidates.push(t)};RTCMediaStatsCollector.prototype._parseRemoteCandidateStasts=function(e){var t={id:"",isRemote:true,ip:"",port:"",priority:"",candidateType:"",networkType:""};Object.keys(e).forEach((function(n){switch(n){case qe.ID:t.id=e[n];break;case qe.IS_REMOTE:t.isRemote=e[n];break;case qe.IP:t.ip=e[n];break;case qe.PRIORITY:t.priority=e[n];break;case qe.PORT:t.port=e[n];break;case qe.CANDIDATE_TYPE:t.candidateType=e[n];break;default:break}}));this._mediaStatsReport.remoteCandidates.push(t)};RTCMediaStatsCollector.prototype._parseMediaSourceStasts=function(e){this._mediaStatsReport.outboundRtpReport.rtpLocalAudioLevel=e.audioLevel?e.audioLevel:0;this._mediaStatsReport.outboundRtpReport.totalAudioEnergy=e.totalAudioEnergy?e.totalAudioEnergy:0;this._mediaStatsReport.outboundRtpReport.totalSamplesDuration=e.totalSamplesDuration?e.totalSamplesDuration:0};RTCMediaStatsCollector.prototype._parseTrackStasts=function(e){if(!e.remoteSource){return}this._mediaStatsReport.inboundRtpReport.rtpRemoteAudioLevel=e.audioLevel?e.audioLevel:0};RTCMediaStatsCollector.prototype._parseTransportStasts=function(e){var t=this;Object.keys(e).forEach((function(n){switch(n){case qe.DTLS_STATE:t._mediaStatsReport.transport.dtlsState=e[n];break;case qe.PACKETS_SENT:t._mediaStatsReport.transport.packetsSent=e[n];break;case qe.PACKETS_RECEIVED:t._mediaStatsReport.transport.packetsReceived=e[n];break;case qe.SELECTED_CANDIDATE_PAIR_CHANGES:t._mediaStatsReport.transport.selectedCandidatePairChanges=e[n];break;case qe.SELECTED_CANDIDATE_PAIR_ID:t._mediaStatsReport.transport.selectedCandidatePairId=e[n];break;default:break}}))};RTCMediaStatsCollector.prototype._onMediaStatsTimeOut=function(){var e=this;if(!this._session||!this._session.sessionDescriptionHandler||!this._session.sessionDescriptionHandler.peerConnection){S.error(on,"the peer connection cannot be null");this.stopMediaStats();return}var t=this._session.sessionDescriptionHandler.peerConnection;var n=t.iceConnectionState;if(n!=="connected"&&n!=="completed"){S.error(on,"the connection state is not connected or completed");this._preRTTCurrentRoundTripTime=0;return}this._mediaStatsReport={timestamp:0,inboundRtpReport:{bytesReceived:0,fractionLost:0,jitter:0,mediaType:"",packetsLost:0,packetsReceived:0,jitterBufferMs:0,totalSamplesDuration:0,concealedSamples:0,totalSamplesReceived:0},outboundRtpReport:{bytesSent:0,mediaType:"",packetsSent:0,totalSamplesDuration:0},rttMS:{currentRoundTripTime:-1},localCandidates:[],remoteCandidates:[],transport:{dtlsState:"",packetsSent:0,packetsReceived:0,selectedCandidatePairChanges:0,selectedCandidatePairId:""}};this._roundTripTime=-1;this._jitterBufferDelay=0;this._jitterBufferEmittedCount=0;t.getStats().then((function(t){t.forEach((function(t){switch(t.type){case Ye.INBOUND_RTP:e._parseInboundRtpStasts(t);break;case Ye.OUTBOUND_RTP:e._parseOutboundRtpStasts(t);break;case Ye.CANDIDATE_PAIR:e._parseCandidatePairStasts(t);break;case Ye.LOCAL_CANDIDATE:{e._parseLocalCandidateStasts(t);break}case Ye.REMOTE_CANDIDATE:{e._parseRemoteCandidateStasts(t);break}case Ye.MEDIA_SOURCE:e._parseMediaSourceStasts(t);break;case Ye.TRACK:e._parseTrackStasts(t);break;case Ye.TRANSPORT:e._parseTransportStasts(t);break;default:break}}));if(e._mediaStatsReport.rttMS.currentRoundTripTime===-1){if(e._roundTripTime===-1){e._mediaStatsReport.rttMS.currentRoundTripTime=e._preRTTCurrentRoundTripTime}else{e._mediaStatsReport.rttMS.currentRoundTripTime=e._roundTripTime}}else{e._mediaStatsReport.rttMS.currentRoundTripTime=Math.round(e._mediaStatsReport.rttMS.currentRoundTripTime*1e3)}e._preRTTCurrentRoundTripTime=e._mediaStatsReport.rttMS.currentRoundTripTime;e._mediaStatsReport.inboundRtpReport.jitterBufferMs=e._jitterBufferEmittedCount===0?0:e._jitterBufferDelay/e._jitterBufferEmittedCount*1e3;if(e._mediaStatsCallback){e._mediaStatsCallback(e._mediaStatsReport)}})).catch((function(e){S.error(on,"get media stats failed: "+JSON.stringify(e))}))};return RTCMediaStatsCollector}();var an=n(615477);var ln=n(654700);var sn=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var cn=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var un=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var pn=n(60227);var _n=function(e){sn(RTCSipCallSession,e);function RTCSipCallSession(t,n,r,i){var a=e.call(this)||this;a._session=null;a._uuid="";a._restartIce=false;a._isReferAccepted=false;a._referTimeout=null;a._reinviteTimeout=null;a._canSetAudioInput=false;a._postponeAudioInput=null;a._iceGatheringTimeout=null;a._vdiVendorName="";a._webAdapterController=an.zm.instance();a._audioAdaptationTimer=null;a._audioAdaptationInterval=1e3;a._enableAdaptiveBitrate=false;a._onInputDeviceChanged=function(){var e=o.p.instance().getCurrentExactAudioInput();S.info(a._logTag,"set input audio device "+e+" when input device changed");a._setAudioInputDevice(e)};a._onOutputDeviceChanged=function(){var e=o.p.instance().getCurrentExactAudioOutput();S.info(a._logTag,"set output audio device "+e+" when output device changed");a._setAudioOutputDevice(e)};a._logTag="RTCSipCallSession".concat(" ["+t+"]");a._uuid=t;a._report=n;a._calculator=r;a._eventLogger=i;a._mediaStatsManager=new Qt(t,i);a._audioAdaptation=new se;a._mediaStatsCollector=new rn;return a}RTCSipCallSession.prototype.destroy=function(){this._clearIceGatheringTimeout();this._clearReinviteTimeout();if(!this._session){return}this._session.onMediaConnectionStateChange=null;this._session.removeAllListeners();this._clearAudioAdaptationTimer();this._releaseMediaStreams();if(this._session.sessionDescriptionHandler){this._session.sessionDescriptionHandler.removeAllListeners()}o.p.instance().off(i.CO.INPUT_DEVICE_CHANGED,this._onInputDeviceChanged);o.p.instance().off(i.CO.OUTPUT_DEVICE_CHANGED,this._onOutputDeviceChanged);if(this._session.transaction&&this._session.transaction.resendProvisionalTimer){clearTimeout(this._session.transaction.resendProvisionalTimer);this._session.transaction.resendProvisionalTimer=undefined}this._session.close();q.instance().removeMediaElement(this._uuid);this._session.sessionDescriptionHandler=null;this._session=null};RTCSipCallSession.prototype.getMediaTransportInfo=function(){return this._mediaStatsManager.getMediaTransportInfo()};RTCSipCallSession.prototype.getMediaStatsInfo=function(){var e,t,n,o;var r=this._mediaStatsManager.getMediaStatsReport();var i={localTotalAudioEnergy:(e=r.outboundRtpReport)===null||e===void 0?void 0:e.totalAudioEnergy,localTotalSamplesDuration:(t=r.outboundRtpReport)===null||t===void 0?void 0:t.totalSamplesDuration,remoteTotalAudioEnergy:(n=r.inboundRtpReport)===null||n===void 0?void 0:n.totalAudioEnergy,remoteTotalSamplesDuration:(o=r.inboundRtpReport)===null||o===void 0?void 0:o.totalSamplesDuration};return i};RTCSipCallSession.prototype.hasSentPackages=function(){return this._mediaStatsManager.hasSentPackages()};RTCSipCallSession.prototype.hasReceivedPackages=function(){return this._mediaStatsManager.hasReceivedPackages()};RTCSipCallSession.prototype.hasLocalAudioLevel=function(){return this._mediaStatsManager.hasLocalAudioLevel()};RTCSipCallSession.prototype.hasRemoteAudioLevel=function(){return this._mediaStatsManager.hasRemoteAudioLevel()};RTCSipCallSession.prototype._patchIceGatheringTimeout=function(){var e=this;if(!isFireFox()){return}if(!this._session||!this._session.sessionDescriptionHandler||!this._session.sessionDescriptionHandler.peerConnection||this._session.sessionDescriptionHandler.peerConnection.iceGatheringState==="complete"){return}S.debug(this._logTag,"Patch ICE Gathering timeout for Firefox");this._clearIceGatheringTimeout();this._iceGatheringTimeout=setTimeout((function(){S.debug(e._logTag,"RTCIceChecking Timeout Triggered after 500 milliseconds");e._session.sessionDescriptionHandler.iceGatheringTimeout=true;e._session.sessionDescriptionHandler.triggerIceGatheringComplete();e._iceGatheringTimeout=null}),500)};RTCSipCallSession.prototype._clearIceGatheringTimeout=function(){this._iceGatheringTimeout&&clearTimeout(this._iceGatheringTimeout);this._iceGatheringTimeout=null};RTCSipCallSession.prototype._scheduleReinviteTimeout=function(){var e=this;this._clearReinviteTimeout();S.debug(this._logTag,"Schedule reinvite timeout 5s");this._reinviteTimeout=setTimeout((function(){S.debug(e._logTag,"Reinvite timeout reached");e.emit(Et.REINVITE_TIMEOUT)}),Ft*1e3)};RTCSipCallSession.prototype._clearReinviteTimeout=function(){this._reinviteTimeout&&clearTimeout(this._reinviteTimeout);this._reinviteTimeout=null};RTCSipCallSession.prototype._prepareSipSession=function(){var e=this;if(!this._session){return}if(!this._session.onMediaConnectionStateChange){this._session.onMediaConnectionStateChange=function(t,n){t.emit(Be.MEDIA_CONNECTION_STATE_CHANGED,n);e._onMediaEvent("connection state changed",n)}}this._session.on(Ue.ACCEPTED,(function(t){e._inviteResponse=t;e._onSessionAccepted()}));this._session.on(Ue.CONFIRMED,(function(t){e._onSessionConfirmed(t)}));this._session.on(Ue.BYE,(function(){e._onSessionDisconnected()}));this._session.on(Ue.FAILED,(function(t,n){e._onSessionError(t,n)}));this._session.on(Ue.PROGRESS,(function(t){e._onSessionProgress(t)}));this._session.on(Ve.SDH_CREATED,(function(){e._session.mediaStreams=new pn.default(e._session);if(e._session.sessionDescriptionHandler.vendorName){e._vdiVendorName=e._session.sessionDescriptionHandler.vendorName;e._calculator.setVDIVendorName(e._vdiVendorName)}e._initSDHListener();e._onSessionEvent("sdh created")}));this._session.on(Ue.REINVITE_ACCEPTED,(function(t){e._onSessionReinviteAccepted(t)}));this._session.on(Ue.REINVITE_FAILED,(function(t,n){e._onSessionReinviteFailed(t,n)}));this._session.on(Ue.RENEGOTIATION_ERROR,(function(t){e._onSessionRenegotiationError(t===null||t===void 0?void 0:t.message)}));this._session.on(Be.MEDIA_CONNECTION_STATE_CHANGED,(function(t){e._onMediaConnectionStateChange(t)}));this._session.on(Ve.RC_MOVE_TO_RCV,(function(t){t.rcv.audioInput=o.p.instance().getAudioInputNameById(o.p.instance().getCurrentAudioInput());t.rcv.audioOutput=o.p.instance().getAudioOutputNameById(o.p.instance().getCurrentAudioOutput());e.emit(Et.MOVE_TO_RCV,t);e._session.sendMoveResponse(t.reqId,0,"Succeed");e._onSessionEvent("move to rcv")}));this._session.on(Ve.UPDATE_RECEIVED,(function(t){var n=t.getHeader("P-Asserted-Identity");if(!n){return}var o=ln.Grammar.nameAddrHeaderParse(n);if(!o){S.warn(e._logTag,"Can not parse assertedIdentity from "+n);return}var r=o.displayName;var i=o.uri.user;S.info(e._logTag,"Receive P-Asserted-Identity displayName: "+r+", callerId: "+i);e.emit(Et.RECEIVE_ASSERTED_IDENTITY,r,i)}));o.p.instance().on(i.CO.INPUT_DEVICE_CHANGED,this._onInputDeviceChanged);o.p.instance().on(i.CO.OUTPUT_DEVICE_CHANGED,this._onOutputDeviceChanged);this._mediaStatsManager.on(Ke,(function(t){e.emit(Ke,t)}))};RTCSipCallSession.prototype._onSignalingStateChange=function(e){var t=this;if(e.signalingState!=="stable"){return}S.info(this._logTag,"PC signaling enter stable");e.getStats().then((function(e){var n="";var o=[];e.forEach((function(e){if(e.type==="codec"){o.push(e)}if(e.type==="outbound-rtp"){n=e["codecId"]}}));var r=o.find((function(e){return e.id===n}));if(r){t._calculator.setOutboundRtpCodec(r.mimeType)}else{S.warn(t._logTag,"Can not find outbound rtp codec")}})).catch((function(e){S.warn(t._logTag,"Can not get RTP codec for "+(e===null||e===void 0?void 0:e.message))}))};RTCSipCallSession.prototype.getVoiceQuality=function(){return this._mediaStatsManager.voiceQuality};RTCSipCallSession.prototype._initSDHListener=function(){var e=this;this._session.sessionDescriptionHandler.on(Ve.ADD_TRACK,(function(t){e._onSessionTrackAdded(t);e._onSessionEvent("add track")}));this._session.sessionDescriptionHandler.on(Ve.ADD_STREAM,(function(t){e._onSessionTrackAdded(t);e._onSessionEvent("add steam")}));this._session.sessionDescriptionHandler.on(Ve.SET_LOCAL_PC_FAILED,(function(t){e._calculator.reportPCFailed(rt.SET_LOCAL_FAILED,t);e._onSessionEvent("set local PC failed",t,ae.ERROR)}));this._session.sessionDescriptionHandler.on(Ve.SET_REMOTE_PC_FAILED,(function(t){e._calculator.reportPCFailed(rt.SET_REMOTE_FAILED,t);e._onSessionEvent("set remote PC failed",t,ae.ERROR)}));this._session.sessionDescriptionHandler.on(Ve.PC_CREATE_ANSWER_FAILED,(function(t){e._calculator.reportPCFailed(rt.CREATE_ANSWER_FAILED,t);e._onSessionEvent("create answer failed",t,ae.ERROR)}));this._session.sessionDescriptionHandler.on(Ve.PC_CREATE_OFFER_FAILED,(function(t){e._calculator.reportPCFailed(rt.CREATE_OFFER_FAILED,t);e._onSessionEvent("create offer failed",t,ae.ERROR)}));this._session.sessionDescriptionHandler.on(Ve.USER_MEDIA_FAILED,(function(t){S.warn(e._logTag,JSON.stringify(t));e._calculator.reportUserMediaFailed();e._onSessionEvent("Request user media failed","",ae.ERROR)}));var t=this._session.sessionDescriptionHandler.peerConnection;if(!t){S.info(this._logTag,"Can not find pc when listen signaling state change event");return}t.onsignalingstatechange=function(){e._onSignalingStateChange(t)}};RTCSipCallSession.prototype._onSessionEvent=function(e,t,n){if(t===void 0){t=""}this._eventLogger.step(e,t,ne.SESSION,n)};RTCSipCallSession.prototype._onMediaEvent=function(e,t){if(t===void 0){t=""}this._eventLogger.step(e,t,ne.MEDIA)};RTCSipCallSession.prototype._onSessionAccepted=function(){this._canSetAudioInput=true;this._clearReinviteTimeout();this._mediaStatsManager.markLastMediaConfirmed();this.emit(Et.ACCEPTED)};RTCSipCallSession.prototype._onSessionConfirmed=function(e){this._canSetAudioInput=true;this._clearReinviteTimeout();this._mediaStatsManager.markLastMediaConfirmed();this.emit(Et.CONFIRMED,e)};RTCSipCallSession.prototype._onSessionDisconnected=function(){this._clearReinviteTimeout();this.emit(Et.DISCONNECTED)};RTCSipCallSession.prototype._onSessionError=function(e,t){this._clearReinviteTimeout();var n="";if(e&&e.statusCode&&e.reasonPhrase){n=e.statusCode+" "+e.reasonPhrase;this._report.updateCallEvent(ot.InviteError,n)}this._calculator.sessionError(t,n);if(t){S.warn(this._logTag,t);We.test(t)&&this.emit(Et.ACQUIRE_STREAM_ERROR,i.Ao.ACQUIRE_STREAM_NOT_ALLOWED)}this.emit(Et.ERROR)};RTCSipCallSession.prototype._onSessionProgress=function(e){this.emit(Et.PROGRESS,e)};RTCSipCallSession.prototype.getInviteResponse=function(){return this._inviteResponse};RTCSipCallSession.prototype._createMediaElement=function(){this._mediaElement&&q.instance().removeMediaElement(this._uuid);this._mediaElement=q.instance().createMediaElement(this._uuid)};RTCSipCallSession.prototype._onSessionTrackAdded=function(e){return cn(this,void 0,Promise,(function(){var t,n;var o=this;return un(this,(function(r){switch(r.label){case 0:if(!this._hasPeerConnection()){S.warn(this._logTag,"Failed to process onSessionTrackAdded. PeerConnection is invalid");return[2]}this._createMediaElement();if(!this._mediaElement){S.warn(this._logTag,"Failed to process onSessionTrackAdded. Media element is null");return[2]}this._webAdapterController.mapAudioElement(this._mediaElement);t=this._getRemoteStream(e);if(!t)return[3,2];return[4,this._playRemoteStream(t)];case 1:n=r.sent();return[3,3];case 2:n=this._calculator.reportPlayRemoteTrackFailed("remote stream invalid");r.label=3;case 3:n;this.getMediaStats((function(e){o._mediaStatsManager.processMediaStatsReport(e);if(!isFireFox()&&o._mediaStatsManager.getNoPacketReceivedCount()===Mt){S.debug(o._logTag,"No audio for 6 sec. Try to trigger recover process once");o.emit(Et.MEDIA_BROKEN,o._isLastMediaValid())}}),h*1e3);this._maybeStartAdaptAudio();return[2]}}))}))};RTCSipCallSession.prototype._maybeStartAdaptAudio=function(){var e=this;S.debug(this._logTag,"adaptive bitrate feature is "+(this._enableAdaptiveBitrate?"enable":"Disable"));if(this._enableAdaptiveBitrate){this._clearAudioAdaptationTimer();this._audioAdaptationTimer=setInterval((function(){return e._adaptAudio()}),this._audioAdaptationInterval)}};RTCSipCallSession.prototype.setAdaptiveBitrateFlag=function(e){this._enableAdaptiveBitrate=e};RTCSipCallSession.prototype.leaveConnected=function(){S.info(this._logTag,"Call leaves connected state");this._clearAudioAdaptationTimer()};RTCSipCallSession.prototype._clearAudioAdaptationTimer=function(){this._audioAdaptationTimer&&clearInterval(this._audioAdaptationTimer);this._audioAdaptationTimer=null};RTCSipCallSession.prototype._getRemoteStream=function(e){var t=this;if(e.streams&&e.streams.length===1){S.debug(this._logTag,"Receiver stream from RTCTrackEvent added");return e.streams[0]}var n;if(e.type==="track"&&e.track){S.debug(this._logTag,"Receiver track from RTCTrackEvent added");n=this._createNewMediaStream();n.addTrack(e.track);return n}var o=this._session.sessionDescriptionHandler.peerConnection;var r=o.getReceivers&&o.getReceivers();if(r&&r.length>0){n=this._createNewMediaStream();r.forEach((function(e){var o=e.track;if(o){S.debug(t._logTag,"Receiver track from peer connection receivers added");n.addTrack(o)}}));return n}var i=o.getRemoteStreams&&o.getRemoteStreams();if(i&&i.length>0){S.debug(this._logTag,"Receiver stream from peer connection added");return i[0]}S.warn(this._logTag,"Failed to get remote stream. no stream or track in event or peer connection");return undefined};RTCSipCallSession.prototype._createNewMediaStream=function(){return new MediaStream};RTCSipCallSession.prototype._playRemoteStream=function(e){return cn(this,void 0,void 0,(function(){var t,n;return un(this,(function(r){switch(r.label){case 0:t=o.p.instance().getCurrentExactAudioOutput();return[4,this._setAudioOutputDevice(t)];case 1:r.sent();this._mediaElement.srcObject=e;r.label=2;case 2:r.trys.push([2,4,,5]);return[4,this._mediaElement.play()];case 3:r.sent();return[3,5];case 4:n=r.sent();this._calculator.reportPlayRemoteTrackFailed(n.message);return[3,5];case 5:return[2]}}))}))};RTCSipCallSession.prototype._hasPeerConnection=function(){return this._session&&this._session.sessionDescriptionHandler&&this._session.sessionDescriptionHandler.peerConnection};RTCSipCallSession.prototype._onSessionReinviteAccepted=function(e){this._clearReinviteTimeout();this._restartIce=false;this._mediaStatsManager.markLastMediaConfirmed();this._mediaStatsManager.resetNoPacketReceivedCount();this.emit(Et.REINVITE_ACCEPTED,e)};RTCSipCallSession.prototype._onSessionReinviteFailed=function(e,t){this._clearReinviteTimeout();this.emit(Et.REINVITE_FAILED,e,t)};RTCSipCallSession.prototype._onSessionRenegotiationError=function(e){if(e===void 0){e=i.W6.UNKNOWN}this.emit(Et.RENEGOTIATION_ERROR,e)};RTCSipCallSession.prototype._onMediaConnectionStateChange=function(e){this._report.updateCallEvent(ot.MediaEvent,e);switch(e){case Be.MEDIA_CONNECTION_DISCONNECTED:this._mediaStatsManager.resetNoPacketReceivedCount();this._mediaStatsManager.mediaDisconnect();!isFireFox()&&this.emit(Et.MEDIA_CONNECTION_FAILED,this._isLastMediaValid());break;case Be.MEDIA_CONNECTION_FAILED:this._mediaStatsManager.resetNoPacketReceivedCount();this._mediaStatsManager.mediaDisconnect();this._calculator.reportICEConnectFailed();break;case Be.MEDIA_CONNECTION_CONNECTED:this._report.updateEstablishment(nt.MEDIA_CONNECTED_TIME);this._mediaStatsManager.markLastMediaConnected();this._calculator.markMediaConnected();this._canSetAudioInput=true;this._postponeAudioInput&&this._setAudioInputDevice(this._postponeAudioInput);break;default:break}};RTCSipCallSession.prototype._releaseMediaStreams=function(){this.stopMediaStats();if(this._session&&this._session.mediaStreams){this._session.mediaStreams.release();if(this._session.mediaStreams.mediaStreamsImpl){this._session.mediaStreams.mediaStreamsImpl.session=null}this._session.mediaStreams.mediaStreamsImpl=null;this._session.mediaStreams=null}};RTCSipCallSession.prototype._getRejectedMessage=function(e){if(e instanceof Error){return e.message}if(typeof e==="string"){return e}if(typeof e==="object"){return JSON.stringify(e)}S.warn(this._logTag,"Cant find the error type");return"Unknown"};RTCSipCallSession.prototype.hangup=function(){if(this._session!=null){try{this._session.terminate()}catch(e){S.error(this._logTag,"Exception when hangup call: "+e)}}};RTCSipCallSession.prototype.flip=function(e){var t=this;this._session.flip(e).then((function(){t.emit(vt.CALL_ACTION_SUCCESS,i.VB.FLIP)})).catch((function(e){t.emit(vt.CALL_ACTION_FAILED,i.VB.FLIP,t._getRejectedMessage(e))}))};RTCSipCallSession.prototype.transferToConf=function(e){var t=this;this._transferToConf(e).then((function(){t.emit(vt.CALL_ACTION_SUCCESS,i.VB.TRANSFER_TO_CONF)})).catch((function(e){t.emit(vt.CALL_ACTION_FAILED,i.VB.TRANSFER_TO_CONF,t._getRejectedMessage(e))}))};RTCSipCallSession.prototype._transferToConf=function(e){return this._session.sendReceive(this._session,Wt.transferToConf,{number:e.number,code:e.code,extraHeaders:["rc-tap: skipShortPrtsPin="+e.skipShortPrtsPin]})};RTCSipCallSession.prototype.barge=function(){var e=this;this._session.barge().then((function(){e.emit(vt.CALL_ACTION_SUCCESS,i.VB.BARGE)})).catch((function(t){e.emit(vt.CALL_ACTION_FAILED,i.VB.BARGE,e._getRejectedMessage(t))}))};RTCSipCallSession.prototype.whisper=function(){var e=this;this._session.whisper().then((function(){e.emit(vt.CALL_ACTION_SUCCESS,i.VB.WHISPER)})).catch((function(t){e.emit(vt.CALL_ACTION_FAILED,i.VB.WHISPER,e._getRejectedMessage(t))}))};RTCSipCallSession.prototype._onNotifyMessage=function(e,t){if(!this._isReferAccepted){S.info(this._logTag,"refer request is not accepted, ignore notify request");return}var n=ln.Grammar.parse(e.body,"sipfrag");switch(true){case/^1[0-9]{2}$/.test(n.status_code):break;case/^2[0-9]{2}$/.test(n.status_code):this.emit(vt.CALL_ACTION_SUCCESS,t);this._isReferAccepted=false;this._clearReferTimeout();break;default:this.emit(vt.CALL_ACTION_FAILED,t,n===null||n===void 0?void 0:n.reason_phrase);this._isReferAccepted=false;this._clearReferTimeout();break}};RTCSipCallSession.prototype._clearReferTimeout=function(){this._referTimeout&&clearTimeout(this._referTimeout);this._referTimeout=null};RTCSipCallSession.prototype._listenReferEvent=function(e,t){var n=this;if(this._referTimeout){S.warn(this._logTag,"Refer timer is not null when starting to listen refer event");clearTimeout(this._referTimeout)}S.info(this._logTag,"Schedule refer timeout "+xt+"s");this._referTimeout=setTimeout((function(){S.warn(n._logTag,"Refer timeout");n._referTimeout=null;n.emit(vt.CALL_ACTION_FAILED,t,i.W6.TIMEOUT);n._isReferAccepted=false}),xt);this._referClientContext=e;this._referClientContext.on(He.REFER_REQUEST_REJECTED,(function(){n.emit(vt.CALL_ACTION_FAILED,t,i.W6.REFER_REJECTED);n._clearReferTimeout()}));this._referClientContext.on(He.REFER_REQUEST_ACCEPTED,(function(){n._isReferAccepted=true}));this._referClientContext.on(He.REFER_NOTIFY,(function(e){try{n._onNotifyMessage(e,t)}catch(e){S.error(n._logTag,"catch error when received notify message "+(e===null||e===void 0?void 0:e.message));n.emit(vt.CALL_ACTION_FAILED,t,e===null||e===void 0?void 0:e.message);n._clearReferTimeout()}}))};RTCSipCallSession.prototype.transfer=function(e){var t=this;this._session.transfer(e).then((function(e){t._listenReferEvent(e,i.VB.TRANSFER)})).catch((function(e){t.emit(vt.CALL_ACTION_FAILED,i.VB.TRANSFER,t._getRejectedMessage(e))}))};RTCSipCallSession.prototype.warmTransfer=function(e){var t=this;if(this._session&&!this._session.localHold){this._patchIceGatheringTimeout()}this._session.warmTransfer(e).then((function(e){t._listenReferEvent(e,i.VB.WARM_TRANSFER)})).catch((function(e){t.emit(vt.CALL_ACTION_FAILED,i.VB.WARM_TRANSFER,t._getRejectedMessage(e))}))};RTCSipCallSession.prototype.forward=function(e){var t=this;this._session.forward(e).then((function(){t.emit(vt.CALL_ACTION_SUCCESS,i.VB.FORWARD)})).catch((function(e){t.emit(vt.CALL_ACTION_FAILED,i.VB.FORWARD,t._getRejectedMessage(e))}))};RTCSipCallSession.prototype.park=function(){var e=this;this._session.park().then((function(t){var n={parkExtension:"*"+t["park extension"]};e.emit(vt.CALL_ACTION_SUCCESS,i.VB.PARK,n)})).catch((function(t){e.emit(vt.CALL_ACTION_FAILED,i.VB.PARK,e._getRejectedMessage(t))}))};RTCSipCallSession.prototype.parkToLocation=function(e){var t=this;this._session.transfer(e).then((function(e){t._listenReferEvent(e,i.VB.PARK_TO_LOCATION)})).catch((function(e){S.warn(t._logTag,"Failed to process parkToLocation. error: "+e);t.emit(vt.CALL_ACTION_FAILED,i.VB.PARK_TO_LOCATION,t._getRejectedMessage(e))}))};RTCSipCallSession.prototype.startRecord=function(){var e=this;this._session.startRecord().then((function(){e.emit(vt.CALL_ACTION_SUCCESS,i.VB.START_RECORD)})).catch((function(t){console.log("This is a test",t);e.emit(vt.CALL_ACTION_FAILED,i.VB.START_RECORD,e._getRejectedMessage(t))}))};RTCSipCallSession.prototype.stopRecord=function(){var e=this;this._session.stopRecord().then((function(){e.emit(vt.CALL_ACTION_SUCCESS,i.VB.STOP_RECORD)})).catch((function(t){e.emit(vt.CALL_ACTION_FAILED,i.VB.STOP_RECORD,e._getRejectedMessage(t))}))};RTCSipCallSession.prototype.mute=function(e){var t,n;if(this._session){if(e===i.$X.LOCAL){S.info(this._logTag,"Mute Local media steams success");if((n=(t=this._session.sessionDescriptionHandler)===null||t===void 0?void 0:t.peerConnection)===null||n===void 0?void 0:n.toggleMute){this._session.sessionDescriptionHandler.peerConnection.toggleMute(true)}this._session.mute();this._mediaStatsManager.localMute=true}else{S.info(this._logTag,"Mute Remote media steams success");this.toggleRemoteMute(true)}}};RTCSipCallSession.prototype.unmute=function(e){var t,n;if(this._session){if(e===i.$X.LOCAL){S.info(this._logTag,"Unmute Local media steams success");if((n=(t=this._session.sessionDescriptionHandler)===null||t===void 0?void 0:t.peerConnection)===null||n===void 0?void 0:n.toggleMute){this._session.sessionDescriptionHandler.peerConnection.toggleMute(false)}this._session.unmute();this._mediaStatsManager.localMute=false}else{S.info(this._logTag,"Unmute Remote media steams success");this.toggleRemoteMute(false)}}};RTCSipCallSession.prototype.toggleRemoteMute=function(e){if(!this._session.sessionDescriptionHandler||!this._session.sessionDescriptionHandler.peerConnection){S.warn(this._logTag,"there is not peer connection so mute remote failed");return}var t=this._session.sessionDescriptionHandler.peerConnection;if(t.getReceivers){t.getReceivers().forEach((function(t){if(t.track){t.track.enabled=!e}}))}};RTCSipCallSession.prototype.answer=function(e){return cn(this,void 0,Promise,(function(){var t,n,r,i;return un(this,(function(a){switch(a.label){case 0:if(!this._session){return[2]}a.label=1;case 1:a.trys.push([1,3,,4]);t=o.p.instance().getCurrentExactAudioInput();this._report.updateAudioInputEvents(o.p.instance().getAudioInputNameById(t));n={};if(t){S.info(this._logTag,"set input audio device "+t+" when answer incoming call");r={constraints:{audio:{deviceId:{exact:t}},video:false}};n.sessionDescriptionHandlerOptions=r}else{S.info(this._logTag,"Cannot set exact input device when answer incoming call since we cannot get device list")}if(e&&e.canPromoteToVideo){n.extraHeaders=["p-rc-capabilities: promote-rcv"]}return[4,this._session.accept(n)];case 2:a.sent();return[3,4];case 3:i=a.sent();S.warn(this._logTag,"Answer exception: "+i.message);return[3,4];case 4:return[2]}}))}))};RTCSipCallSession.prototype.reject=function(){var e=this;var t;(t=this._session)===null||t===void 0?void 0:t.ignore().catch((function(t){S.warn(e._logTag,"Reject call exception: "+(t===null||t===void 0?void 0:t.message))}))};RTCSipCallSession.prototype.sendToVoicemail=function(){var e=this;var t;(t=this._session)===null||t===void 0?void 0:t.toVoicemail().catch((function(t){S.warn(e._logTag,"Send to voicemail exception: "+(t===null||t===void 0?void 0:t.message))}))};RTCSipCallSession.prototype.hold=function(){var e=this;if(this._session){this._session.localHold=false;this._patchIceGatheringTimeout();this._session.hold().catch((function(t){e.emit(vt.CALL_ACTION_FAILED,i.VB.HOLD,e._getRejectedMessage(t))}))}};RTCSipCallSession.prototype.unhold=function(){var e=this;if(!this._session){return}if(!this._restartIce){this._session.localHold=true;this._patchIceGatheringTimeout();this._session.unhold().catch((function(t){e.emit(vt.CALL_ACTION_FAILED,i.VB.UNHOLD,e._getRejectedMessage(t))}))}else{this._session.localHold=false;this._session.mediaStreams.reconnectMedia().catch((function(t){S.debug(e._logTag,"unhold call failed. Error: "+t);e.emit(vt.CALL_ACTION_FAILED,i.VB.UNHOLD,"reconnectMedia failed error: "+e._getRejectedMessage(t))}))}};RTCSipCallSession.prototype.dtmf=function(e){var t,n;if(this._session){try{if((n=(t=this._session.sessionDescriptionHandler)===null||t===void 0?void 0:t.peerConnection)===null||n===void 0?void 0:n.sendDTMF){var o={duration:100,interToneGap:50};this._session.sessionDescriptionHandler.peerConnection.sendDTMF(e,o)}this._session.dtmf(e,100,50)}catch(e){S.warn(this._logTag,e.message)}}};RTCSipCallSession.prototype.startReply=function(){var e=this;var t;(t=this._session)===null||t===void 0?void 0:t.sendSessionMessage({reqid:13}).catch((function(t){S.warn(e._logTag,"Start reply exception: "+(t===null||t===void 0?void 0:t.message))}))};RTCSipCallSession.prototype.replyWithPattern=function(e,t,n){var o=this;var r;var a=1;var l=0;var s=0;switch(e){case i.UV.WILL_CALL_YOU_BACK_LATER:if(t>0){a=1}else{a=4}break;case i.UV.IN_A_MEETING:a=5;break;case i.UV.ON_MY_WAY:a=2;break;case i.UV.ON_THE_OTHER_LINE:a=6;break;case i.UV.CALL_ME_BACK_LATER:if(t>0){a=1}else{a=4}l=1;break;default:break}switch(n){case i.mo.MINUTE:s=0;break;case i.mo.HOUR:s=1;break;case i.mo.DAY:s=2;break;default:break}(r=this._session)===null||r===void 0?void 0:r.replyWithMessage({replyType:a,callbackDirection:l,timeUnits:s,timeValue:t}).catch((function(e){S.warn(o._logTag,"Reply with message exception: "+e)}))};RTCSipCallSession.prototype.replyWithMessage=function(e){var t=this;var n;(n=this._session)===null||n===void 0?void 0:n.replyWithMessage({replyType:0,replyText:e}).catch((function(e){S.warn(t._logTag,"Reply with message exception: "+(e===null||e===void 0?void 0:e.message))}))};RTCSipCallSession.prototype.setSession=function(e,t){if(t===void 0){t=true}if(e){this._session=e;this._prepareSipSession()}if(!t){var n=o.p.instance().getCurrentExactAudioInput();this._report.updateAudioInputEvents(o.p.instance().getAudioInputNameById(n))}};RTCSipCallSession.prototype.getSession=function(){return this._session};RTCSipCallSession.prototype.getVdiVendorName=function(){return this._vdiVendorName};RTCSipCallSession.prototype.recoverCall=function(){var e=this;this._clearReinviteTimeout();S.debug(this._logTag,"Try to start recover call ...");if(!this._session||!this._session.mediaStreams){S.warn(this._logTag,"Failed to recover call. Session or session mediaStreams is null");this._calculator.markCallRecoverErrorMsg("session or media stream is null");return}if(this._session&&this._session.sessionDescriptionHandler&&this._session.sessionDescriptionHandler.peerConnection&&this._session.sessionDescriptionHandler.peerConnection.signalingState&&this._session.sessionDescriptionHandler.peerConnection.signalingState==="closed"){S.debug(this._logTag,"Peer connection is closed when try to recover call. Terminate it");this._clearReinviteTimeout();this._calculator.markCallRecoverErrorMsg("PeerConnection closed");this.emit(Et.REINVITE_FAILED,this._session,"PeerConnection closed");return}this._mediaStatsManager.resetLastMedia();if(this._session.localHold){this._restartIce=true;S.debug(this._logTag,"Set restartICE true when try to recover call when call in hold");this._calculator.markCallRecoverWhenHold();return}this._session.pendingReinvite=false;this._session.mediaStreams.reconnectMedia().then((function(){e._calculator.markCallRecoverReinviteSent();e._scheduleReinviteTimeout()})).catch((function(t){e._calculator.markCallRecoverErrorMsg(e._getRejectedMessage(t));S.debug(e._logTag,"recover call failed. Error: "+e._getRejectedMessage(t));e.emit(Et.RECONNECT_MEDIA_FAILED,e._getRejectedMessage(t))}))};RTCSipCallSession.prototype.getMediaStats=function(e,t){if(this._mediaStatsCollector){var n=t;if(!t||t<0){n=1e3}this._mediaStatsCollector.getMediaStats(this._session,e,n)}else{S.warn(this._logTag,"Failed to set media stats callback. media stats collector is null")}};RTCSipCallSession.prototype.stopMediaStats=function(){if(this._mediaStatsCollector){this._mediaStatsCollector.stopMediaStats()}};RTCSipCallSession.prototype.getMediaErrorEvents=function(){return this._mediaStatsManager.getMediaErrorEvents()};RTCSipCallSession.prototype._setAudioInputDevice=function(e){var t=this;if(!this._session||!this._session.sessionDescriptionHandler||!this._session.sessionDescriptionHandler.peerConnection||!this._canSetAudioInput){S.debug(this._logTag,"Postpone set audio input device since peer connection is not ready");this._postponeAudioInput=e;return}this._report.updateAudioInputEvents(o.p.instance().getAudioInputNameById(e));S.debug(this._logTag,"Set audio input device id: "+e);this._webAdapterController.getUserMedia({audio:{deviceId:{exact:e}},video:false}).then((function(e){S.info(t._logTag,"Length of AudioTracks: "+e.getAudioTracks().length);t._postponeAudioInput=null;t._updatePeerConnection(e)})).catch((function(e){S.warn(t._logTag,"Cannot switch audio input device because : "+(e===null||e===void 0?void 0:e.message))}))};RTCSipCallSession.prototype._updatePeerConnection=function(e){var t=this;if(!this._session||!this._session.sessionDescriptionHandler||!this._session.sessionDescriptionHandler.peerConnection){return}var n=e.getAudioTracks()[0];S.info(this._logTag,"AudioTrack label: "+n.label+" enabled:"+n.enabled+" muted:"+n.muted+" readyState:"+n.readyState);var o=this._session.sessionDescriptionHandler.peerConnection;o.getSenders().forEach((function(e){if(e.track&&e.track.kind===n.kind){S.info(t._logTag,"Find audio track in sender, label: "+e.track.label+" enabled:"+e.track.enabled+" muted:"+e.track.muted+" readyState:"+e.track.readyState);n.enabled=e.track.enabled;var o=e.track;e.replaceTrack(n).then((function(){S.info(t._logTag,"Replace track succeed");o.stop()})).catch((function(){S.warn(t._logTag,"Replace track failed")}))}}))};RTCSipCallSession.prototype._isLastMediaValid=function(){return this._mediaStatsManager.isLastMediaValid()};RTCSipCallSession.prototype._setAudioOutputDevice=function(e){return cn(this,void 0,Promise,(function(){var t;return un(this,(function(n){switch(n.label){case 0:this._report.updateAudioOutputEvents(o.p.instance().getAudioOutputNameById(e));if(!e){return[2]}if(!this._mediaElement){S.warn(this._logTag,"Failed to set audio output. Invalid mediaElement");return[2]}S.debug(this._logTag,"Set audio output device id: "+e);n.label=1;case 1:n.trys.push([1,3,,4]);return[4,this._mediaElement.setSinkId(e)];case 2:n.sent();S.debug(this._logTag,"Media element setSinkId success");return[3,4];case 3:t=n.sent();S.warn(this._logTag,"setSinkId failed with: "+t.message);return[3,4];case 4:return[2]}}))}))};RTCSipCallSession.prototype._adaptAudio=function(){if(!this._hasPeerConnection()){S.warn(this._logTag,"Can not find pc when adapting audio");return}var e=this._session.sessionDescriptionHandler.peerConnection;if(!e.getSenders){S.warn(this._logTag,"Can not find getSenders func in pc when adapting audio");return}var t=e.getSenders();var n=t.find((function(e){var t;return((t=e===null||e===void 0?void 0:e.track)===null||t===void 0?void 0:t.kind)==="audio"}));if(!n){S.warn(this._logTag,"Can not find audio track when adapting audio");return}if(n.track&&n.track.enabled){this._calculateAndAdaptAudio(e,n)}else{S.warn(this._logTag,"Can not find enable audio track in pc")}};RTCSipCallSession.prototype._calculateAndAdaptAudio=function(e,t){var n=this;if(!this._fractionLostCalculator){S.info(this._logTag,"Create PacketLossFractionCalculator");this._fractionLostCalculator=new ce}e.getStats().then((function(e){var o=0;var r=0;var i=0;var a="";var l=[];e.forEach((function(e){if(e.type==="codec"){l.push(e)}if(e.type==="remote-inbound-rtp"){Object.keys(e).forEach((function(t){if(t==="roundTripTime"){o=Number(e[t])*1e3||0}else if(t==="packetsLost"){i=Number(e[t])||0}}))}if(e.type==="outbound-rtp"){Object.keys(e).forEach((function(t){if(t==="packetsSent"){r=Number(e[t])||0}}));a=e["codecId"]}}));var s=l.find((function(e){return e.id===a}));if(!s||s.mimeType.toLowerCase()!=="audio/opus"||s.clockRate!==48e3){S.warn(n._logTag,"Does not support adaptive bitrate due to outbound rtp codec is not opus 48000");n._clearAudioAdaptationTimer();return}n._fractionLostCalculator.update(r,i);var c=n._fractionLostCalculator.getFractionLost();var u=n._audioAdaptation.adapt(t,c,o);if(u>0){n._notifyBitrateChanged({bitrate:u,fractionLost:c,rtt:o})}else if(u<0){S.warn(n._logTag,"Doesn't support adaptive bitrate, clear the timer");n._clearAudioAdaptationTimer()}})).catch((function(e){S.warn(n._logTag,"Failed t o get stats for "+(e===null||e===void 0?void 0:e.message))}))};RTCSipCallSession.prototype._notifyBitrateChanged=function(e){this.emit(Qe,e)};return RTCSipCallSession}(x.EventEmitter2);var Cn=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var fn=n(191190);var dn="RTCSipUserAgent";var hn;(function(e){e["REG_SUCCESS"]="registered";e["REG_FAILED"]="registrationFailed";e["REG_UNREGISTERED"]="unregistered";e["INVITE"]="invite";e["TRANSPORT_CREATED"]="transportCreated";e["TRANSPORT_ERROR"]="transportError";e["TRANSPORT_CONNECTED"]="connected";e["SWITCH_BACK_PROXY"]="switchBackProxy";e["PROVISION_UPDATE"]="provisionUpdate"})(hn||(hn={}));var Tn=function(e){Cn(RTCSipUserAgent,e);function RTCSipUserAgent(t){var n=e.call(this)||this;n._statusCode=-1;n._switchBackTimer=null;n._regExpiredTimer=null;n._provisionInfo=null;n._provisionOptions=null;n._turnServersInfo={enableTurnServers:false,turnServers:[],useRelayTransportPolicy:false};n._reporter=t;return n}RTCSipUserAgent.prototype.restartUA=function(e,t){if(e===void 0){e=null}if(t===void 0){t=null}var n;if(this._webphone){this._destroy()}e&&(this._provisionInfo=e);t&&(this._provisionOptions=t);le.metadata({appName:(n=this._provisionOptions)===null||n===void 0?void 0:n.appName});if(this._provisionInfo&&this._provisionOptions){var o=Te().cloneDeep(this._provisionOptions);this._createWebPhone(this._provisionInfo,o)}};RTCSipUserAgent.prototype._destroy=function(){S.debug(dn,"Destroy User Agent ...");this._clearSwitchbackTimer();this._clearRegExpiredTimer();try{this._webphone.userAgent.removeAllListeners();if(this._webphone.userAgent.transport){this._webphone.userAgent.transport.removeAllListeners();if(this._webphone.userAgent.transport.reconnectTimer){clearTimeout(this._webphone.userAgent.transport.reconnectTimer);this._webphone.userAgent.transport.reconnectTimer=undefined}this._webphone.userAgent.transport.disconnect({force:true}).catch((function(e){S.warn(dn,"Failed to disconnect transport: "+e)}))}this._webphone.userAgent.stop();delete this._webphone;this._webphone=null}catch(e){S.warn(dn,"Error when destroy web phone "+e)}};RTCSipUserAgent.prototype._createWebPhone=function(e,t){var n,o,r;var i=[];i.push(opusModifier);if(isFireFox()){t.enableMidLinesInSDP=true}t.enableDefaultModifiers=true;t.modifiers=i;t.enablePlanB=false;if(J.apiConfiguration.getConfig()){t.appKey=(n=J.apiConfiguration.getConfig())===null||n===void 0?void 0:n.rc.clientId}else{S.warn(dn,"Cannot get client ID from apiConfiguration")}if(((o=e.sipInfo)===null||o===void 0?void 0:o.length)>0&&e.sipInfo[0].stunServers&&e.sipInfo[0].stunServers.length>0){t.stunServers=e.sipInfo[0].stunServers}else{t.stunServers=["stun:stun.l.google.com:19302"]}if(this._turnServersInfo.enableTurnServers&&this._turnServersInfo.turnServers.length>0){t.enableTurnServers=true;t.turnServers=this._turnServersInfo.turnServers;S.info(dn,"Enable turn servers "+JSON.stringify(t.turnServers))}if(this._turnServersInfo.useRelayTransportPolicy){t.iceTransportPolicy="relay";S.info(dn,"Use relay transport policy")}S.info(dn,"Stun servers are "+JSON.stringify(t.stunServers));t.enableQos=t.enableQos&&!isFireFox()&&!isSafari();t.connector=function(e,t,n,o){switch(e){case xe.ERROR:S.warn("RC_WEBPHONE","["+t+"] [Error] "+o);break;case xe.WARN:S.warn("RC_WEBPHONE","["+t+"] "+o);break;default:S.debug("RC_WEBPHONE","["+t+"] "+o)}};this._webphone=new fn.default(e,t);this._initListener();if(((r=e.sipInfo)===null||r===void 0?void 0:r.length)>0){this._reporter.updateProxy({mainProxy:e.sipInfo[0].outboundProxy,backupProxy:e.sipInfo[0].outboundProxyBackup?e.sipInfo[0].outboundProxyBackup:""})}else{S.warn(dn,"there is no sipInfo in provisionData, and can not update proxy")}};RTCSipUserAgent.prototype.makeCall=function(e,t){if(!this._webphone){return null}var n={};n.extraHeaders=n.extraHeaders||[];t.homeCountryId?n.homeCountryId=t.homeCountryId:n.homeCountryId="1";if(t.fromNumber){n.fromNumber=t.fromNumber}if(t.replacesCallId&&t.replacesFromTag&&t.replacesToTag){n.extraHeaders.push("Replaces: "+t.replacesCallId+";to-tag="+t.replacesFromTag+";from-tag="+t.replacesToTag,"RC-call-type: replace");S.info(dn,"switch over call to "+n.extraHeaders)}if(t.accessCode){n.extraHeaders.push("rc-tap: rcc;accessCode="+t.accessCode)}if(t.canPromoteToVideo){var r="p-rc-capabilities: promote-rcv";if(t.invalidEA){r="p-rc-capabilities: promote-rcv; invalid-911-address"}n.extraHeaders.push(r)}else if(t.invalidEA){n.extraHeaders.push("p-rc-capabilities: invalid-911-address")}if(t.onBehalfKey){n.extraHeaders.push("p-rc-call-on-behalf: "+t.onBehalfKey)}if(t.pickUpCallId&&t.pickUpToTag&&t.pickUpFromTag){n.extraHeaders.push("Replaces: "+t.pickUpCallId+";to-tag="+t.pickUpToTag+";from-tag="+t.pickUpFromTag+";early-only")}if(t.rcTapRcc&&t.rcTapRcc.accessCode){var i="rc-tap: rcc;accessCode="+t.rcTapRcc.accessCode;if(t.rcTapRcc.sessionData&&t.rcTapRcc.skipShortPrtsPin!==undefined){i=i+";sessionData="+t.rcTapRcc.sessionData+";skipShortPrtsPin="+t.rcTapRcc.skipShortPrtsPin}n.extraHeaders.push(i)}var a=o.p.instance().getCurrentExactAudioInput();if(a){S.info(dn,"set input audio device "+a+" when make outgoing call");var l={constraints:{audio:{deviceId:{exact:a}},video:false}};n.sessionDescriptionHandlerOptions=l}else{S.info(dn,"Cannot set exact input device when make outgoing call since we cannot get device list")}if(n.extraHeaders.length===0){delete n.extraHeaders}return this._webphone.userAgent.invite(e,n)};RTCSipUserAgent.prototype.reRegister=function(){S.debug(dn,"Try to restart register with new transport");if(!this._webphone||!this._provisionInfo||!this._provisionOptions){return}if(this._webphone.userAgent.transport){this._webphone.userAgent.transport.removeAllListeners();if(this._webphone.userAgent.transport.reconnectTimer){clearTimeout(this._webphone.userAgent.transport.reconnectTimer);this._webphone.userAgent.transport.reconnectTimer=undefined}if(this._webphone.userAgent.transport.connectionTimeout){clearTimeout(this._webphone.userAgent.transport.connectionTimeout);this._webphone.userAgent.transport.connectionTimeout=undefined}this._webphone.userAgent.transport.disconnect({force:true}).catch((function(e){S.warn(dn,"Failed to close transport: "+e)}));this._webphone.userAgent.transport.disposeWs()}if(this._webphone.userAgent.registerContext){this._webphone.userAgent.registerContext.onTransportDisconnected()}if(this._webphone.userAgent.transport.noAvailableServers()){this._webphone.userAgent.transport.resetServerErrorStatus()}var e=this._webphone.userAgent.transport.server===this._webphone.userAgent.transport.configuration.wsServers[0];this._webphone.userAgent.transport=new this._webphone.userAgent.configuration.transportConstructor(this._webphone.userAgent.getLogger("sip.transport"),this._webphone.userAgent.configuration.transportOptions);this._webphone.userAgent.setTransportListeners();this._initTransportListener();if(!e){this._webphone.userAgent.transport.configuration.wsServers[0].isError=true}this._webphone.userAgent.transport.connect()};RTCSipUserAgent.prototype.unregister=function(){this.unregisterWebphone();this._destroy()};RTCSipUserAgent.prototype.unregisterWebphone=function(){if(!this._webphone){return}this._webphone.userAgent.unregister()};RTCSipUserAgent.prototype.getStatusCode=function(){return this._statusCode};RTCSipUserAgent.prototype._initListener=function(){var e=this;if(!this._webphone||!this._webphone.userAgent){return}this._webphone.userAgent.on(hn.REG_SUCCESS,(function(){e._statusCode=200;e._clearRegExpiredTimer();e.emit(ke.REG_SUCCESS)}));this._webphone.userAgent.on(hn.REG_UNREGISTERED,(function(t,n){S.warn(dn,"Account unregistered: "+n);if(!t&&n==="Expires"){e._clearRegExpiredTimer();e._regExpiredTimer=setTimeout((function(){e._statusCode=-1;e.emit(ke.REG_UNREGISTERED)}),Pt)}}));this._webphone.userAgent.on(hn.REG_FAILED,(function(t,n){var o,r,i;if(!t){return}e._clearRegExpiredTimer();e._statusCode=-1;if(t.statusCode){e._statusCode=t.statusCode;S.info(dn,"Register failed and status code is "+e._statusCode)}var a=t.data||t;if(a&&typeof a==="string"&&!((i=(r=(o=e._webphone)===null||o===void 0?void 0:o.userAgent)===null||r===void 0?void 0:r.transport)===null||i===void 0?void 0:i.isSipErrorCode(a))){e.emit(ke.REG_FAILED,t,n)}}));this._webphone.userAgent.on(hn.INVITE,(function(t){e.emit(ke.RECEIVE_INVITE,t)}));this._webphone.userAgent.on(hn.PROVISION_UPDATE,(function(){S.debug(dn,"Provision update signal from web phone");e.emit(ke.PROVISION_UPDATE)}));if(this._webphone.userAgent.transport){this._initTransportListener()}else{this._webphone.userAgent.on(hn.TRANSPORT_CREATED,(function(){e._initTransportListener()}))}};RTCSipUserAgent.prototype._initTransportListener=function(){var e=this;this._webphone.userAgent.transport.on(hn.TRANSPORT_ERROR,(function(){var t,n,o;if(e._webphone.userAgent.transport.noAvailableServers()){S.warn(dn,"Transport error");e.emit(ke.TRANSPORT_ERROR)}if((o=(n=(t=e._webphone.userAgent)===null||t===void 0?void 0:t.transport)===null||n===void 0?void 0:n.server)===null||o===void 0?void 0:o.isError){e._reporter.accountSwitchProxy(true)}}));this._webphone.userAgent.transport.on(hn.TRANSPORT_CONNECTED,(function(){S.debug(dn,"Transport "+e._webphone.userAgent.transport.server.wsUri+" connected");e.emit(ke.TRANSPORT_CONNECTED,e._webphone.userAgent.transport.server.wsUri)}));this._webphone.userAgent.transport.on(hn.SWITCH_BACK_PROXY,(function(){e._onSwitchBackProxy()}))};RTCSipUserAgent.prototype._onSwitchBackProxy=function(){var e=this;this._clearSwitchbackTimer();var t=randomBetween(Lt,Dt);this._switchBackTimer=setTimeout((function(){e.emit(ke.SWITCH_BACK_PROXY);e._reporter.accountSwitchProxy(false)}),t);S.debug(dn,"Switch back to main proxy signal from web phone. Schedule switch back in "+t/1e3+" sec")};RTCSipUserAgent.prototype._clearSwitchbackTimer=function(){this._switchBackTimer&&clearTimeout(this._switchBackTimer);this._switchBackTimer=null};RTCSipUserAgent.prototype._clearRegExpiredTimer=function(){this._regExpiredTimer&&clearTimeout(this._regExpiredTimer);this._regExpiredTimer=null};RTCSipUserAgent.prototype.getServer=function(){var e,t,n,o;var r=(o=(n=(t=(e=this._webphone)===null||e===void 0?void 0:e.userAgent)===null||t===void 0?void 0:t.transport)===null||n===void 0?void 0:n.server)===null||o===void 0?void 0:o.wsUri;return typeof r==="string"?r:""};RTCSipUserAgent.prototype.setTurnServers=function(e){this._turnServersInfo=e};RTCSipUserAgent.prototype.getTurnServers=function(){return this._turnServersInfo};return RTCSipUserAgent}(x.EventEmitter2);var Rn=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var gn="RTCRegistrationManager";var En=function(e){Rn(RTCRegistrationManager,e);function RTCRegistrationManager(t,n){var o=e.call(this)||this;if(t){o._userInfo=t}o._fsm=new Me(o);o._userAgent=new Tn(n);o._initInstanceId();o._eventQueue=Xt().queue((function(e,t){t(e.data)}));o._initUserAgentListener();o._initFsmObserve();return o}RTCRegistrationManager.prototype.onReRegisterAction=function(e){if(this._userAgent){e?this._userAgent.restartUA(null,null):this._userAgent.reRegister()}};RTCRegistrationManager.prototype.onVDIReRegisterAction=function(e,t,n){this.emit(Ee.VDI_RE_REGISTER,e,t);if(this._userAgent){this._userAgent.unregisterWebphone();this._userAgent.restartUA(null,n)}};RTCRegistrationManager.prototype.onProvisionReadyAction=function(e,t){t.instanceId=this._instanceId;S.debug(gn,"provision ready then restart user agent");this._restartUA(e,t)};RTCRegistrationManager.prototype.onUnregisterAction=function(){var e=this;this.emit(Ee.LOGOUT_ACTION);setTimeout((function(){if(e._userAgent){e._userAgent.unregister()}}),0);B.instance().remove(P.kInstanceIdKey)};RTCRegistrationManager.prototype.onReceiveIncomingInviteAction=function(e){this.emit(Ee.RECEIVE_INCOMING_INVITE,e)};RTCRegistrationManager.prototype.onSwitchBackProxyAction=function(){this.emit(Ee.SWITCH_BACK_PROXY_ACTION)};RTCRegistrationManager.prototype._initInstanceId=function(){var e=B.instance().read(P.kInstanceIdKey);if(e){this._instanceId=e}else{this._instanceId=ee()();isElectron()&&B.instance().save(P.kInstanceIdKey,this._instanceId)}};RTCRegistrationManager.prototype._onEnterReady=function(){this.emit(Ee.ACCOUNT_STATE_CHANGED,i.Ty.REGISTERED)};RTCRegistrationManager.prototype._onEnterRegInProgress=function(){this.emit(Ee.ACCOUNT_STATE_CHANGED,i.Ty.IN_PROGRESS)};RTCRegistrationManager.prototype._onEnterRegFailure=function(){this.emit(Ee.ACCOUNT_STATE_CHANGED,i.Ty.FAILED)};RTCRegistrationManager.prototype._onEnterUnRegistered=function(){this.emit(Ee.ACCOUNT_STATE_CHANGED,i.Ty.UNREGISTERED)};RTCRegistrationManager.prototype._initFsmObserve=function(){var e=this;this._fsm.observe(ye.REG_IN_PROGRESS,(function(){e._onEnterRegInProgress()}));this._fsm.observe(ye.READY,(function(){e._onEnterReady()}));this._fsm.observe(ye.REG_FAILURE,(function(){e._onEnterRegFailure()}));this._fsm.observe(ye.UN_REGISTERED,(function(){e._onEnterUnRegistered()}))};RTCRegistrationManager.prototype._initUserAgentListener=function(){var e=this;this._userAgent.on(ke.REG_SUCCESS,(function(){e._onUARegSuccess()}));this._userAgent.on(ke.REG_FAILED,(function(t){e._onUARegFailed(t)}));this._userAgent.on(ke.REG_UNREGISTERED,(function(){e._eventQueue.push({name:Ee.UA_UNREGISTERED},(function(){e._fsm.unregistered()}))}));this._userAgent.on(ke.RECEIVE_INVITE,(function(t){e._onUAReceiveInvite(t)}));this._userAgent.on(ke.REG_UNREGISTER,(function(){e._onUADeRegister()}));this._userAgent.on(ke.TRANSPORT_ERROR,(function(){e._onUATransportError()}));this._userAgent.on(ke.TRANSPORT_CONNECTED,(function(t){e.emit(Ee.TRANSPORT_CONNECTED,t)}));this._userAgent.on(ke.SWITCH_BACK_PROXY,(function(){e._onUASwitchBackProxy()}));this._userAgent.on(ke.PROVISION_UPDATE,(function(){e._onUAProvisionUpdate(true)}))};RTCRegistrationManager.prototype.setTurnServers=function(e){this._userAgent.setTurnServers(e)};RTCRegistrationManager.prototype.getTurnServers=function(){return this._userAgent.getTurnServers()};RTCRegistrationManager.prototype.provisionReady=function(e,t){var n=this;this._eventQueue.push({name:Ee.PROVISION_READY,data:{provData:e,provOptions:t}},(function(e){n._fsm.provisionReady(e.provData,e.provOptions)}))};RTCRegistrationManager.prototype.reRegister=function(e){var t=this;this._eventQueue.push({name:Ee.RE_REGISTER,data:{restart:e}},(function(e){t._fsm.reRegister(e.restart)}))};RTCRegistrationManager.prototype.vdiReRegister=function(e,t,n){var o=this;this._eventQueue.push({name:Ee.VDI_RE_REGISTER,data:{isConnected:e,vdiVendorName:t,provisionOptions:n}},(function(e){o._fsm.vdiReRegister(e.isConnected,t,e.provisionOptions)}))};RTCRegistrationManager.prototype.unregisterWebphone=function(){var e=this;this._eventQueue.push({name:Ee.UNREGISTER_WEBPHONE},(function(){e._fsm.unregisterWebphone()}))};RTCRegistrationManager.prototype.onUnregisterWebphoneAction=function(){S.info(gn,"On unregister webphone action");this._userAgent&&this._userAgent.unregisterWebphone()};RTCRegistrationManager.prototype.getRegistrationStatusCode=function(){return!this._userAgent?-1:this._userAgent.getStatusCode()};RTCRegistrationManager.prototype.makeCall=function(e,t,n){var o=this;this._eventQueue.push({name:Ee.MAKE_OUTGOING_CALL_TASK,data:{toNumber:e,callDelegate:t,callOptions:n}},(function(e){o._fsm.makeOutgoingCall(e.toNumber,e.callDelegate,e.callOptions)}))};RTCRegistrationManager.prototype.createOutgoingCallSession=function(e,t){return this._userAgent.makeCall(e,t)};RTCRegistrationManager.prototype.logout=function(){var e=this;this._eventQueue.push({name:Ee.LOGOUT},(function(){e._fsm.unregister()}))};RTCRegistrationManager.prototype._onUARegSuccess=function(){var e=this;this._eventQueue.push({name:Ee.UA_REGISTER_SUCCESS},(function(){e._fsm.regSuccess()}))};RTCRegistrationManager.prototype._onUADeRegister=function(){var e=this;this._eventQueue.push({name:Ee.UA_UNREGISTER},(function(){e._fsm.unregister()}))};RTCRegistrationManager.prototype._onUARegFailed=function(e){var t=this;if(e&&e.statusCode&&(ge.UNAUTHORIZED===e.statusCode||ge.PROXY_AUTHENTICATION_REQUIRED===e.statusCode)){S.info(gn,"receive register error status code = "+e.statusCode);this._onUAProvisionUpdate(false)}this._eventQueue.push({name:Ee.UA_REGISTER_FAILED},(function(){t._fsm.regFailed()}))};RTCRegistrationManager.prototype._onUATransportError=function(){var e=this;this._eventQueue.push({name:Ee.UA_TRANSPORT_ERROR},(function(){e._fsm.transportError()}))};RTCRegistrationManager.prototype._onUASwitchBackProxy=function(){var e=this;this._eventQueue.push({name:Ee.UA_SWITCH_BACK_PROXY},(function(){e._fsm.switchBackProxy()}))};RTCRegistrationManager.prototype._onUAProvisionUpdate=function(e){if(e===void 0){e=false}this.emit(Ee.REFRESH_PROV,e)};RTCRegistrationManager.prototype._onUAReceiveInvite=function(e){this._fsm.receiveIncomingInvite(e)};RTCRegistrationManager.prototype._restartUA=function(e,t){var n=Te().cloneDeep(t);if(this._userInfo){if(this._userInfo.endpointId&&this._userInfo.endpointId.length>0){n.uuid=this._userInfo.endpointId}if(this._userInfo.userAgent&&this._userInfo.userAgent.length>0){n.appName=this._userInfo.userAgent}}this._userAgent.restartUA(e,n)};RTCRegistrationManager.prototype.getServer=function(){return this._userAgent.getServer()};return RTCRegistrationManager}(x.EventEmitter2);var vn="RTCVoipConfigManager";var yn=function(){function RTCVoipConfigManager(){this._enableCallRecovery=false;this._callQualityFeedbackParam={enable:true,starLimited:5,enableForSendLog:false,chanceWithCall:.3,chanceNoCall:.5,decreaseRate:.2}}RTCVoipConfigManager.instance=function(){if(!RTCVoipConfigManager._singleton){RTCVoipConfigManager._singleton=new RTCVoipConfigManager}return RTCVoipConfigManager._singleton};RTCVoipConfigManager.prototype.destroy=function(){RTCVoipConfigManager._singleton=undefined};RTCVoipConfigManager.prototype.setEnableCallRecovery=function(e){S.debug(vn,e?"Enable call recovery feature":"Disable call recovery feature");this._enableCallRecovery=e};RTCVoipConfigManager.prototype.isCallRecoveryEnabled=function(){return this._enableCallRecovery};RTCVoipConfigManager.prototype.setCallQualityFeedbackParams=function(e){S.debug(vn,"Set call quality feedback params: "+JSON.stringify(e));this._callQualityFeedbackParam=e};RTCVoipConfigManager.prototype.getCallQualityFeedbackParams=function(){return this._callQualityFeedbackParam};return RTCVoipConfigManager}();var An="sip-info";var mn=300;var In=5e3;var Sn=5e3;var Nn=10*1e3;var On=24*3600*1e3;var bn=On*7;var Ln="Auto Answer";var Dn=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var Pn=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var Mn;(function(e){e["SEND_ONLY"]="sendonly";e["SEND_RECV"]="sendrecv"})(Mn||(Mn={}));var wn;(function(e){e["DEFAULT"]="default";e["CITRIX"]="citrix";e["VMWARE"]="vmware"})(wn||(wn={}));var Fn=function(){function RTCCall(e,t,n,o,r,a,l,s){var c=this;var u,p,_;this._callState=i.JG.IDLE;this._callInfo={fromName:"",fromNum:"",toName:"",toNum:"",uuid:"",partyId:"",sessionId:"",queueCallInfo:{}};this._recordState=i.M.IDLE;this._isLocalMute=false;this._isRemoteMute=false;this._options={};this._isAnonymous=false;this._hangupInvalidCallTimer=undefined;this._connectedTimestamp=undefined;this._userAgent="";this._retryRecoverCallTimer=undefined;this._recoverStarted=false;this._requestManager=new H;this._isQueueCall=false;this._enableCallRecovery=false;this._movedToRcv=false;this._enableAdaptiveBitrate=false;this._hasStartRecordSucceed=false;this._partyStatusChanged=function(e){var t;if(e.id!==c._callInfo.partyId){S.warn(c._logTag,"Party id is not same as this call");return}if(c._hasStartRecordSucceed){S.info(c._logTag,"Start record succeed before, ignore this notification");return}var n=e.recordings&&e.recordings.length>0&&e.recordings[0].id;if(!n){S.warn(c._logTag,"Can not find recordings id");return}if(e.recordings[0].active&&c._recordState===i.M.IDLE){S.info(c._logTag,"Receive the first acr notification");c._recordingId=n;c._recordState=i.M.RECORDING;(t=c._delegate)===null||t===void 0?void 0:t.onFirstACRNotification()}else{S.warn(c._logTag,"Receive an acr notification with "+e+" when record state is "+i.M.IDLE)}};this._callInfo.uuid=(0,Z.v4)();this._logTag="RTCCall".concat(" ["+this._callInfo.uuid+"]");this._account=o;if(r!=null){this._delegate=r}if(a){this._options=a;if(this._options.fromNumber===C){this._isAnonymous=true}}var f;this._isIncomingCall=e;this._isMultiPartyConf=!!s;this._eventLogger=new le(oe.VOIP,this._isIncomingCall?"incoming":"outgoing");this._report=new tt(this._eventLogger);this._callTagCalculator=new Nt(this._account.getUsername(),this._callInfo.uuid,this._account.getAppName(),this._account.getServer(),this._isIncomingCall,this._eventLogger);this._eventLogger.info({"Current Calls":this._account.callCount()+1,"Account State":this._account.state(),"Server Address":this._account.getServer()});this._fsm=new nn(this._report,this._callTagCalculator);this._callSession=new _n(this._callInfo.uuid,this._report,this._callTagCalculator,this._eventLogger);if(this._isIncomingCall){this._callInfo.fromName=n.remoteIdentity.displayName;this._callInfo.toName=((u=n.rcHeaders)===null||u===void 0?void 0:u.toNm)||"";this._callInfo.fromNum=n.remoteIdentity.uri.aor.split("@")[0];this._callInfo.toNum=((p=n.rcHeaders)===null||p===void 0?void 0:p.to)||"";this._setQueueCallInfo(n);this.setCallSession(n);this._callTagCalculator.recordStartRing();var d=(_=n.request)===null||_===void 0?void 0:_.headers;if(d&&d[Ge.RC_ALERT_INFO]&&d[Ge.RC_ALERT_INFO][0].raw===Ln){S.info(this._logTag,"Received a auto answer incoming call, auto answer it");this.answer();if(d[Ge.RC_API_CLIENT_REF]){this._callInfo.clientRefId=d[Ge.RC_API_CLIENT_REF][0].raw}else{S.warn(this._logTag,"Server error: not add P-Rc-Api-Client-Ref in auto answer call")}this._callInfo.isAutoAnswered=true}f="incoming"}else{this._addHangupTimer();this._callInfo.toNum=t;this._callInfo.toName=(a===null||a===void 0?void 0:a.toName)||"";this._callInfo.fromName=(a===null||a===void 0?void 0:a.fromName)||"";f="outgoing";this._report.updateEstablishment(nt.START_TIME)}if(s){this._isMultiPartyConf=true;this._conferenceStatus=s}if(l&&l.userAgent){this._userAgent=l.userAgent;this._callTagCalculator.setUserAgent(this._userAgent)}this._report.updateByPipe([{key:nt.ID,value:this._callInfo.uuid},{key:nt.DIRECTION,value:f},{key:nt.CREATE_TIME,value:new Date},{key:nt.UA,value:l}]);this._enableCallRecovery=yn.instance().isCallRecoveryEnabled();this._readFeatureFlags();this._prepare()}RTCCall.prototype._readFeatureFlags=function(){var e;return Dn(this,void 0,void 0,(function(){var t;return Pn(this,(function(n){switch(n.label){case 0:t=this;return[4,(e=(0,J.getModule)(X.FEATURE_FLAG_MODULE))===null||e===void 0?void 0:e.hasPermission(X.G.D_USE_ADAPTIVE_BITRATE)];case 1:t._enableAdaptiveBitrate=n.sent();this._callSession.setAdaptiveBitrateFlag(this._enableAdaptiveBitrate);this._callTagCalculator.setFeatureFlags({adaptiveBitrate:this._enableAdaptiveBitrate});return[2]}}))}))};RTCCall.prototype._setQueueCallInfo=function(e){var t=e.rcHeaders;if(!t){S.warn(this._logTag,"Cant find rcHeaders");return}if(t.srvLvlExt){var n=Number(e.rcHeaders.srvLvlExt);this._isQueueCall=(n&i.hn.TIERS_PHS_AGENT_QUEUE_CALL/4294967296)!==0}var o=t.callerId,r=t.displayInfo,a=t.displayInfoSub;this._callInfo.queueCallInfo.callerId=o;this._callInfo.queueCallInfo.displayInfo=r;this._callInfo.queueCallInfo.displayInfoSub=a;this._callInfo.queueCallInfo.displayInfoValue=t[r];this._callInfo.queueCallInfo.displayInfoValueSub=t[a];S.info(this._logTag,"is Queue call: "+this._isQueueCall+" "+JSON.stringify(this._callInfo.queueCallInfo))};RTCCall.prototype.isQueueCall=function(){return this._isQueueCall};RTCCall.prototype.getVdiVendorName=function(){return this._callSession.getVdiVendorName()};RTCCall.prototype.isAnonymous=function(){return this._isAnonymous};RTCCall.prototype.isMultiPartyConf=function(){return this._isMultiPartyConf};RTCCall.prototype.isRccConf=function(){return this._options&&this._options.accessCode};RTCCall.prototype.isAnswered=function(){return this._callTagCalculator.isAnswered()};RTCCall.prototype.getDuration=function(){return this._callTagCalculator.getDuration()};RTCCall.prototype.forbiddenQualityFeedback=function(){if(this.isIncomingCall()&&!this.isAnswered()){S.debug(this._logTag,"Incoming not answered. Do not ask for feedback");return true}if(this._movedToRcv){S.debug(this._logTag,"Call2Video processed. Do not ask for feedback");return true}if(this.getDuration()<Nn){S.debug(this._logTag,"Call duration too short. Do not ask for feedback");return true}return false};RTCCall.prototype.getCallQualityFeedback=function(){return{uuid:this._callInfo.uuid,username:this._account.getUsername(),calculatedScore:this._callTagCalculator.getQuality()}};RTCCall.prototype._addHangupTimer=function(){var e=this;this._hangupInvalidCallTimer=setTimeout((function(){S.info(e._logTag,"call time out and be hangup");e._onCallActionFailed(i.VB.CALL_TIME_OUT,i.QP.INVALID);var t=e._account.getRegistrationStatusCode();e._callTagCalculator.callHangupTimerReached(t);if(e._delegate&&t===ge.TOO_MANY_CONTACTS){S.warn(e._logTag,"Notify call delegate receive register error code 603 when make call");e._delegate.onCallError(i.Ao.REGISTER_TOO_MANY_CONTACTS)}e.hangup()}),f*1e3)};RTCCall.prototype.setCallDelegate=function(e){this._delegate=e};RTCCall.prototype.setCallState=function(e){this._callState=e};RTCCall.prototype.getCallState=function(){return this._callState};RTCCall.prototype.isIncomingCall=function(){return this._isIncomingCall};RTCCall.prototype.getCallInfo=function(){return this._callInfo};RTCCall.prototype.getRecordState=function(){return this._recordState};RTCCall.prototype.isMuted=function(){return this._isLocalMute};RTCCall.prototype.isRemoteMuted=function(){return this._isRemoteMute};RTCCall.prototype.answer=function(e){S.ensureApiBeenCalledLog(this._logTag,"answer");this._account.addAnsweredCall();this._answerOptions=e;this._reportCallActionEvent(i.VB.ANSWER);this._callTagCalculator.markCallAnswered();this._fsm.answer()};RTCCall.prototype.reject=function(){S.ensureApiBeenCalledLog(this._logTag,"reject");this._reportCallActionEvent(i.VB.REJECT);this._fsm.reject()};RTCCall.prototype.ignore=function(){S.ensureApiBeenCalledLog(this._logTag,"ignore");this._reportCallActionEvent(i.VB.IGNORE);this._fsm.ignore()};RTCCall.prototype.sendToVoicemail=function(){S.ensureApiBeenCalledLog(this._logTag,"sendToVoicemail");this._reportCallActionEvent(i.VB.SEND_TO_VM);this._fsm.sendToVoicemail()};RTCCall.prototype.startReply=function(){S.ensureApiBeenCalledLog(this._logTag,"startReply");this._reportCallActionEvent(i.VB.START_REPLY);if(!this.isIncomingCall()){this._onCallActionFailed(i.VB.START_REPLY,i.QP.NO_SUPPORT,i.W6.NOT_AN_INCOMING_CALL);return}this._fsm.startReplyWithMessage()};RTCCall.prototype.replyWithMessage=function(e){S.ensureApiBeenCalledLog(this._logTag,"replyWithMessage");this._reportCallActionEvent(i.VB.REPLY_WITH_MSG);if(!e||e.length===0){this._onCallActionFailed(i.VB.REPLY_WITH_MSG,i.QP.PARAMS_ERROR,"Message is empty");return}if(!this.isIncomingCall()){this._onCallActionFailed(i.VB.REPLY_WITH_MSG,i.QP.NO_SUPPORT,i.W6.NOT_AN_INCOMING_CALL);return}this._fsm.replyWithMessage(e)};RTCCall.prototype.replyWithPattern=function(e,t,n){if(t===void 0){t=0}if(n===void 0){n=i.mo.MINUTE}S.ensureApiBeenCalledLog(this._logTag,"replyWithPattern");this._reportCallActionEvent(i.VB.REPLY_WITH_PATTERN);if(!this.isIncomingCall()){this._onCallActionFailed(i.VB.REPLY_WITH_PATTERN,i.QP.NO_SUPPORT,i.W6.NOT_AN_INCOMING_CALL);return}this._fsm.replyWithPattern(e,t,n)};RTCCall.prototype.hangup=function(){S.ensureApiBeenCalledLog(this._logTag,i.VB.HANGUP);this._reportCallActionEvent(i.VB.HANGUP);this._callTagCalculator.callActionEvent(i.VB.HANGUP);this._fsm.hangup();this._account.removeCallFromCallManager(this._callInfo.uuid)};RTCCall.prototype.flip=function(e){S.ensureApiBeenCalledLog(this._logTag,"flip");this._reportCallActionEvent(i.VB.FLIP);this._fsm.flip(e)};RTCCall.prototype.transferToConf=function(e){S.ensureApiBeenCalledLog(this._logTag,"transferToConf");if(!e.code||!e.number){this._onCallActionFailed(i.VB.TRANSFER_TO_CONF,i.QP.PARAMS_ERROR,"Code: "+e.code+" number: "+e.number);return}this._reportCallActionEvent(i.VB.TRANSFER_TO_CONF);this._fsm.transferToConf(e)};RTCCall.prototype.barge=function(){S.ensureApiBeenCalledLog(this._logTag,"barge");this._reportCallActionEvent(i.VB.BARGE);this._fsm.barge()};RTCCall.prototype.whisper=function(){S.ensureApiBeenCalledLog(this._logTag,"whisper");this._reportCallActionEvent(i.VB.WHISPER);this._fsm.whisper()};RTCCall.prototype.startRecord=function(){S.ensureApiBeenCalledLog(this._logTag,"startRecord");this._reportCallActionEvent(i.VB.START_RECORD);this._fsm.startRecord()};RTCCall.prototype.stopRecord=function(){S.ensureApiBeenCalledLog(this._logTag,"stopRecord");this._reportCallActionEvent(i.VB.STOP_RECORD);this._fsm.stopRecord()};RTCCall.prototype.hold=function(){S.ensureApiBeenCalledLog(this._logTag,"hold");this._reportCallActionEvent(i.VB.HOLD);this._fsm.hold()};RTCCall.prototype.unhold=function(){S.ensureApiBeenCalledLog(this._logTag,"unhold");this._reportCallActionEvent(i.VB.UNHOLD);this._fsm.unhold()};RTCCall.prototype.mute=function(e){if(e===void 0){e=i.$X.LOCAL}S.ensureApiBeenCalledLog(this._logTag,"mute");if(e===i.$X.LOCAL){this._reportCallActionEvent(i.VB.LOCAL_MUTE);this._isLocalMute=true}if(e===i.$X.REMOTE){this._reportCallActionEvent(i.VB.REMOTE_MUTE);this._isRemoteMute=true}this._fsm.mute(e);this._onCallActionSuccess(i.VB.MUTE,{actionDirection:e})};RTCCall.prototype.unmute=function(){S.ensureApiBeenCalledLog(this._logTag,"unmute");this._isLocalMute=false;this._isRemoteMute=false;this._reportCallActionEvent(i.VB.UNMUTE);this._fsm.unmute(i.$X.LOCAL);this._fsm.unmute(i.$X.REMOTE);this._onCallActionSuccess(i.VB.UNMUTE,{})};RTCCall.prototype.park=function(){S.ensureApiBeenCalledLog(this._logTag,"park");this._reportCallActionEvent(i.VB.PARK);this._fsm.park()};RTCCall.prototype.parkToLocation=function(e){S.ensureApiBeenCalledLog(this._logTag,"parkToLocation");this._reportCallActionEvent(i.VB.PARK_TO_LOCATION);if(e.length===0){this._onCallActionFailed(i.VB.PARK_TO_LOCATION,i.QP.PARAMS_ERROR,"Location is empty");return}this._fsm.parkToLocation(e)};RTCCall.prototype.transfer=function(e){S.ensureApiBeenCalledLog(this._logTag,"transfer");this._reportCallActionEvent(i.VB.TRANSFER);if(e.length===0){this._onCallActionFailed(i.VB.TRANSFER,i.QP.PARAMS_ERROR,"Target is empty");return}this._fsm.transfer(e)};RTCCall.prototype.warmTransfer=function(e){S.ensureApiBeenCalledLog(this._logTag,i.VB.WARM_TRANSFER);this._reportCallActionEvent(i.VB.WARM_TRANSFER);var t=this._account.getCallByUuid(e);if(!t||!t.getCallSession()){S.warn(this._logTag,"Cant get call or call session from input call uuid");this._onCallActionFailed(i.VB.WARM_TRANSFER,i.QP.PARAMS_ERROR,"Cant get a valid target call by call id: "+e);return}this._fsm.warmTransfer(t.getCallSession())};RTCCall.prototype.forward=function(e){S.ensureApiBeenCalledLog(this._logTag,"forward");this._reportCallActionEvent(i.VB.FORWARD);if(e.length===0){this._onCallActionFailed(i.VB.FORWARD,i.QP.PARAMS_ERROR,"Target is empty");return}if(!this._isIncomingCall){this._onCallActionFailed(i.VB.FORWARD,i.QP.NO_SUPPORT,i.W6.NOT_AN_INCOMING_CALL);return}this._fsm.forward(e)};RTCCall.prototype.dtmf=function(e){S.ensureApiBeenCalledLog(this._logTag,"dtmf");this._reportCallActionEvent(i.VB.DTMF);if(e.length===0){return}this._fsm.dtmf(e)};RTCCall.prototype.addConferenceParty=function(e,t){return Dn(this,void 0,Promise,(function(){var n,o,r;return Pn(this,(function(i){switch(i.label){case 0:if(!this._isMultiPartyConf){S.warn(this._logTag,"This call is not conference call, could not add party");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}i.label=1;case 1:i.trys.push([1,3,,4]);return[4,this._requestManager.addPartyMember(this._callInfo.sessionId,e,t)];case 2:n=i.sent();o=Object.assign({sessionId:e},n);this._conferenceStatus.parties.push(o);S.debug(this._logTag,"Add party success: "+JSON.stringify(o));return[2,o];case 3:r=i.sent();S.warn(this._logTag,"Failed to add party into conference: "+r);return[2,Promise.reject(r)];case 4:return[2]}}))}))};RTCCall.prototype._reportCallActionEvent=function(e){this._eventLogger.step(e,"start",ne.CALL_ACTION);this._report.updateCallEvent(ot.CallAction,e)};RTCCall.prototype.onAccountReady=function(){if(!this.isIncomingCall()){this._fsm.accountReady()}if(!this._enableCallRecovery){S.debug(this._logTag,"Call recovery is disabled. ReInvite will NOT be sent")}else if(!isFireFox()&&this._recoverStarted){this.recoverCall()}};RTCCall.prototype.recoverStart=function(){if(!this._enableCallRecovery){S.debug(this._logTag,"Call recover is disabled. Do not mark recover start");return}S.debug(this._logTag,"Notify start recover process. So block media signal");this._recoverStarted=true};RTCCall.prototype.onAccountNotReady=function(){if(!this.isIncomingCall()){this._fsm.accountNotReady();this._report.updateCallEvent(ot.RegistrationError,""+this._account.getRegistrationStatusCode())}};RTCCall.prototype.setCallSession=function(e){var t;this._callSession.setSession(e,this._isIncomingCall);var n=(t=e===null||e===void 0?void 0:e.request)===null||t===void 0?void 0:t.headers;if(this._isIncomingCall&&n){this._parseRcApiIds(n);this._parseRcToPhn(n)}};RTCCall.prototype.recoverCall=function(){this._recoverStarted=true;this._callTagCalculator.markNewCallRecover();this._fsm.recoverCall()};RTCCall.prototype.getCallSession=function(){return this._callSession.getSession()};RTCCall.prototype._prepare=function(){var e=this;this._callSession.on(Et.ACCEPTED,(function(){var t=e._callSession.getInviteResponse();if(t&&t.headers){var n=e._isIncomingCall?nt.SENT_200_OK_TIME:nt.RECEIVED_200_OK_TIME;e._report.updateEstablishment(n);e._parseRcApiIds(t.headers)}else{S.warn(e._logTag,"Can't get invite response for parsing partyid and sessionid")}!e._isIncomingCall&&e._callTagCalculator.markCallEstablished();e._onSessionAccepted()}));this._callSession.on(Et.CONFIRMED,(function(t){if(e._isIncomingCall&&t&&t.headers){e._report.updateEstablishment(nt.RECEIVED_ACK_TIME)}e.isIncomingCall()&&e._callTagCalculator.markCallEstablished();e._onSessionConfirmed()}));this._callSession.on(Et.DISCONNECTED,(function(){e._onSessionDisconnected()}));this._callSession.on(Et.ERROR,(function(){e._onSessionError()}));this._callSession.on(Et.ACQUIRE_STREAM_ERROR,(function(t){if(e._delegate){S.warn(e._logTag,"Notify call delegate call failed due to: "+t);e._delegate.onCallError(t)}}));this._callSession.on(Et.PROGRESS,(function(t){e._onSessionProgress(t)}));this._callSession.on(Et.REINVITE_ACCEPTED,(function(t){e._onSessionReinviteAccepted(t)}));this._callSession.on(Et.REINVITE_FAILED,(function(t){e._onSessionReinviteFailed(t)}));this._callSession.on(Et.RENEGOTIATION_ERROR,(function(t){S.info(e._logTag,"Renegotiation error: "+t);e._callTagCalculator.markCallRecoverErrorMsg("Renegotiation error: "+t)}));this._callSession.on(vt.CALL_ACTION_SUCCESS,(function(t,n){if(n===void 0){n={}}e._onCallActionSuccess(t,n)}));this._callSession.on(vt.CALL_ACTION_FAILED,(function(t,n,o){if(n===void 0){n=i.W6.UNKNOWN}if(o===void 0){o=i.QP.DEPENDENCY_ERROR}e._onCallActionFailed(t,o,n)}));this._callSession.on(Et.MEDIA_CONNECTION_FAILED,(function(t){e._onMediaConnectionFailed(t)}));this._callSession.on(Et.MEDIA_BROKEN,(function(t){e._onMediaConnectionFailed(t)}));this._callSession.on(Et.REINVITE_TIMEOUT,(function(){e._callTagCalculator.markCallRecoverErrorMsg("Reinvite timeout");e._setupRetryRecoverCallTimer()}));this._callSession.on(Et.RECONNECT_MEDIA_FAILED,(function(t){e._callTagCalculator.markCallRecoverErrorMsg("Reconnect media failed for: "+t);e._setupRetryRecoverCallTimer()}));this._callSession.on(Ke,(function(t){e._delegate&&e._delegate.onVoiceQualityChange(t)}));this._callSession.on(Qe,(function(t){var n,o;if(e._connectedTimestamp){t.timeAnchor=(Date.now()-((n=e._connectedTimestamp)===null||n===void 0?void 0:n.valueOf()))/1e3}else{t.timeAnchor=-1}e._callTagCalculator.markBitrateChanged(t);(o=e._eventLogger)===null||o===void 0?void 0:o.other("adaptiveBitrate",t)}));this._callSession.on(Et.MOVE_TO_RCV,(function(t){if(t.command!=="move"||t.target!=="rcv"||t.sessionId!==e._callInfo.sessionId){S.warn(e._logTag,"Cannot process move to rcv. Invalid content: "+JSON.stringify(t));return}t.rcv.isLocalAudioMute=e._isLocalMute;e._movedToRcv=true;e._delegate&&e._delegate.onPromoteToRcv(e._callInfo.uuid,t.rcv)}));this._callSession.on(Et.RECEIVE_ASSERTED_IDENTITY,(function(t,n){e._delegate&&e._delegate.onReceiveIdentity(e._callInfo.uuid,t,n)}));this._fsm.on(vt.ENTER_ANSWERING,(function(){e._onCallStateChange(i.JG.CONNECTING)}));this._fsm.on(vt.ENTER_PENDING,(function(){e._onCallStateChange(i.JG.CONNECTING)}));this._fsm.on(vt.ENTER_CONNECTING,(function(){e._onCallStateChange(i.JG.CONNECTING)}));this._fsm.on(vt.ENTER_CONNECTED,(function(){if(!e._connectedTimestamp){e._connectedTimestamp=new Date}e._setSipInfoIntoCallInfo();e._clearHangupTimer();e._isLocalMute?e._callSession.mute(i.$X.LOCAL):e._callSession.unmute(i.$X.LOCAL);e._isRemoteMute?e._callSession.mute(i.$X.REMOTE):e._callSession.unmute(i.$X.REMOTE);e._onCallStateChange(i.JG.CONNECTED);Ce.instance().on(""+_e.SESSION_STATUS_WITH_RECORDINGS+e._callInfo.partyId,e._partyStatusChanged)}));this._fsm.on(vt.ENTER_DISCONNECTED,(function(){e._clearHangupTimer();e._onCallStateChange(i.JG.DISCONNECTED);e._account.removeCallFromCallManager(e._callInfo.uuid);e._destroy()}));this._fsm.on(vt.LEAVE_CONNECTED,(function(){e._callSession.stopMediaStats();e._callSession.leaveConnected()}));this._fsm.on(vt.HANGUP_ACTION,(function(){e._onHangupAction()}));this._fsm.on(vt.CREATE_OUTGOING_CALL_SESSION,(function(){e._onCreateOutingCallSession()}));this._fsm.on(vt.FLIP_ACTION,(function(t){e._onFlipAction(t)}));this._fsm.on(vt.TRANSFER_TO_CONF_ACTION,(function(t){e._onTransferToConfAction(t)}));this._fsm.on(vt.BARGE_ACTION,(function(){e._onBargeAction()}));this._fsm.on(vt.WHISPER_ACTION,(function(){e._onWhisperAction()}));this._fsm.on(vt.TRANSFER_ACTION,(function(t){e._onTransferAction(t)}));this._fsm.on(vt.WARM_TRANSFER_ACTION,(function(t){e._onWarmTransferAction(t)}));this._fsm.on(vt.FORWARD_ACTION,(function(t){e._onForwardAction(t)}));this._fsm.on(vt.PARK_ACTION,(function(){e._onParkAction()}));this._fsm.on(vt.PARK_TO_LOCATION_ACTION,(function(t){e._callSession.parkToLocation(t)}));this._fsm.on(vt.START_RECORD_ACTION,(function(){e._onStartRecordAction()}));this._fsm.on(vt.STOP_RECORD_ACTION,(function(){e._onStopRecordAction()}));this._fsm.on(vt.MUTE_ACTION,(function(t){e._onMuteAction(t)}));this._fsm.on(vt.UNMUTE_ACTION,(function(t){e._onUnmuteAction(t)}));this._fsm.on(vt.DTMF_ACTION,(function(t){e._onDtmfAction(t)}));this._fsm.on(vt.START_REPLY_ACTION,(function(){e._onStartReplyAction()}));this._fsm.on(vt.REPLY_WITH_PATTERN_ACTION,(function(t,n,o){e._onReplyWithPatternAction(t,n,o)}));this._fsm.on(vt.REPLY_WITH_MESSAGE_ACTION,(function(t){e._onReplyWithMessageAction(t)}));this._fsm.on(vt.CALL_ACTION_FAILED,(function(t,n){if(n===void 0){n=i.QP.FSM_STATUS_INCORRECT}e._onCallActionFailed(t,n,"FSM state is "+e._fsm.state())}));this._fsm.on(vt.ANSWER_ACTION,(function(){e._onAnswerAction()}));this._fsm.on(vt.REJECT_ACTION,(function(){e._onRejectAction()}));this._fsm.on(vt.SEND_TO_VOICEMAIL_ACTION,(function(){e._onSendToVoicemailAction()}));this._fsm.on(vt.HOLD_ACTION,(function(){e._onHoldAction()}));this._fsm.on(vt.UNHOLD_ACTION,(function(){e._onUnholdAction()}));this._fsm.on(vt.HOLD_SUCCESS_ACTION,(function(){e._onCallActionSuccess(i.VB.HOLD)}));this._fsm.on(vt.HOLD_FAILED_ACTION,(function(){e._onCallActionFailed(i.VB.HOLD,i.QP.DEPENDENCY_ERROR,"Reinvite failed")}));this._fsm.on(vt.UNHOLD_SUCCESS_ACTION,(function(){e._onCallActionSuccess(i.VB.UNHOLD)}));this._fsm.on(vt.UNHOLD_FAILED_ACTION,(function(){e._onCallActionFailed(i.VB.UNHOLD,i.QP.DEPENDENCY_ERROR,"Reinvite failed")}));this._fsm.on(vt.RECOVER_CALL_ACTION,(function(){e._clearRetryRecoverCallTimer();e._callSession&&e._callSession.recoverCall()}))};RTCCall.prototype._destroy=function(){this._clearHangupTimer();this._clearRetryRecoverCallTimer();this._requestManager.cancelRequests();this._maybeNotifyNoAudioEvent();this._maybeNotifyMediaEvent();this._callSession.removeAllListeners();this._callSession.destroy();this._report.destroy();this._reportCallQuality();this._eventLogger.destroy();if(this._connectedTimestamp){Ce.instance().removeListener(""+_e.SESSION_STATUS_WITH_RECORDINGS+this._callInfo.partyId,this._partyStatusChanged)}};RTCCall.prototype._reportCallQuality=function(){return Dn(this,void 0,void 0,(function(){var e,t,n;return Pn(this,(function(o){switch(o.label){case 0:e=this._report.getCallReportInfo();t=e;return[4,this._getCallInfoReport()];case 1:t.callInfo=o.sent();e.transport=this._callSession.getMediaTransportInfo();e.mediaStats=this._callSession.getMediaStatsInfo();if(this._options.invalidEA){e.invalidEA=this._options.invalidEA}n=this._callTagCalculator.callDestroy(e);this._eventLogger.info({"Call Duration":n.callDuration,"Call Id":this._callInfo.callId,"Session Id":this._callInfo.sessionId,"To Number":this._callInfo.toNum,"From Number":this._callInfo.fromNum,"Auto Answered Call":this._callInfo.isAutoAnswered,"Queue Call":this._isQueueCall,"Anonymous Call":this.isAnonymous(),"Multi Party Conf":this._isMultiPartyConf,"Moved To Rcv":this._movedToRcv,"Enable Call Recovery":this._enableCallRecovery});return[2]}}))}))};RTCCall.prototype._getCallInfoReport=function(){var e;return Dn(this,void 0,void 0,(function(){var t,n,o,r,i,a,l;return Pn(this,(function(s){switch(s.label){case 0:t="";n="";s.label=1;case 1:s.trys.push([1,6,,7]);o=this._callInfo.fromName;if(o)return[3,3];return[4,(0,J.getCurrentAccount)().getUserInfo()];case 2:o=(e=s.sent())===null||e===void 0?void 0:e.name;s.label=3;case 3:t=o||"";r=this._callInfo.toName;if(r)return[3,5];return[4,this._delegate.getCalleeName()];case 4:r=s.sent();s.label=5;case 5:n=r;return[3,7];case 6:i=s.sent();S.info(this._logTag,"get name info failed: "+i.message);return[3,7];case 7:a="";l="";try{a=b64EncodeUnicode(t);l=b64EncodeUnicode(n)}catch(e){S.warn(this._logTag,"Call b64EncodeUnicode method failed: "+e.message)}if(a){a=""+a[a.length-1]+a.substring(1,a.length-1)+a[0]}if(l){l=""+l[l.length-1]+l.substring(1,l.length-1)+l[0]}return[2,{sessionId:this._callInfo.sessionId,fromName:a,toName:l,fromNumber:this._callInfo.fromNum,toNumber:this._callInfo.toNum,isQueueCall:this._isQueueCall,sessionDescriptionHandlerName:this.getVdiVendorName()?this.getVdiVendorName().toLowerCase():wn.DEFAULT,fromTag:this._callInfo.fromTag||"",toTag:this._callInfo.toTag||"",callId:this._callInfo.callId||""}]}}))}))};RTCCall.prototype._onMediaConnectionFailed=function(e){if(!this._enableCallRecovery){S.debug(this._logTag,"Call recovery is disabled. Ignore media connection failed signal");return}if(this._recoverStarted){S.debug(this._logTag,"Call recovery is started. Ignore media connection failed signal");return}if(e){S.debug(this._logTag,"Last media is valid when media is broken. Trigger call recovery with restarting Register");Q.instance().notifyMediaConnectionFailed()}else{S.debug(this._logTag,"Last media is invalid when media is broken. Trigger call recovery ONLY with ReInvite");this.recoverCall()}};RTCCall.prototype._maybeNotifyMediaEvent=function(){if(!this._connectedTimestamp){return}this._callTagCalculator.reportMediaErrorEvents(this._callSession.getMediaErrorEvents())};RTCCall.prototype._maybeNotifyNoAudioEvent=function(){if(!this._connectedTimestamp){return}var e=(Date.now()-this._connectedTimestamp.valueOf())/1e3;if(e<5){return}var t=this._callSession.hasSentPackages();var n=this._callSession.hasReceivedPackages();var o=isSafari()||this._callSession.hasLocalAudioLevel();var r=isSafari()||this._callSession.hasRemoteAudioLevel();this._callTagCalculator.markNoRtpOrNoAudio(t,n,o,r,this._callSession.getMediaTransportInfo());if(t&&n){this._notifyNoAudioStateEvent()}else if(t&&!n){this._notifyNoAudioDataEvent(e,i.aw.NO_RTP_INCOMING)}else if(!t&&n){this._notifyNoAudioDataEvent(e,i.aw.NO_RTP_OUTGOING)}else{this._notifyNoAudioDataEvent(e,i.aw.NO_RTP)}};RTCCall.prototype._notifyNoAudioStateEvent=function(){var e={event:{type:"success",details:{feature:"no_audio_data"}}};S.debug(this._logTag,"Notify no audio state event: "+JSON.stringify(e));this._account&&this._account.notifyNoAudioStateEvent(this._callInfo.uuid,e)};RTCCall.prototype._notifyNoAudioDataEvent=function(e,t){var n={event:{type:"no-rtp",details:{feature:"no_audio_data",data:{call_type:this._isIncomingCall?"Incoming":"Outgoing",user_agent:this._userAgent,session_time:e,type:t,call_info:{to_tag:this._callInfo.toTag?this._callInfo.toTag:"",to_number:this._callInfo.toNum,to_name:this._callInfo.toName,call_id:this._callInfo.callId?this._callInfo.callId:"",from_tag:this._callInfo.fromTag?this._callInfo.fromTag:"",from_number:this._callInfo.fromNum,from_name:this._callInfo.fromName}}}}};S.debug(this._logTag,"Notify no audio data event: "+JSON.stringify(n));this._account&&this._account.notifyNoAudioDataEvent(this._callInfo.uuid,n)};RTCCall.prototype._onCallActionSuccess=function(e,t){if(t===void 0){t={}}switch(e){case i.VB.START_RECORD:{this._recordState=i.M.RECORDING;this._hasStartRecordSucceed=true;break}case i.VB.STOP_RECORD:{this._recordState=i.M.IDLE;break}default:break}this._notifyCallActionSuccess(e,t)};RTCCall.prototype._notifyCallActionSuccess=function(e,t){var n;if(e===i.VB.MUTE){if(t.actionDirection===i.$X.LOCAL){n=i.VB.LOCAL_MUTE}else{n=i.VB.REMOTE_MUTE}}else{n=e}this._report.updateCallEvent(ot.CallActionSuccess,""+n);this._eventLogger.step(e,"succeed",ne.CALL_ACTION);if(this._delegate){this._delegate.onCallActionSuccess(e,t)}};RTCCall.prototype._onCallActionFailed=function(e,t,n){switch(e){case i.VB.START_RECORD:{this._recordState=i.M.IDLE;break}case i.VB.STOP_RECORD:{this._recordState=i.M.RECORDING;break}case i.VB.HOLD:{this._fsm.holdFailed();break}case i.VB.UNHOLD:{this._fsm.unholdFailed();break}default:break}this._notifyCallActionFailed(e,t,n)};RTCCall.prototype._notifyCallActionFailed=function(e,t,n){if(n===void 0){n=i.W6.UNKNOWN}this._report.updateCallEvent(ot.CallActionFailed,""+e);this._callTagCalculator.callActionFailed(e,t,n);S.warn(this._logTag,"Call action "+e+" Failed. Error code: "+t+", msg: "+n);this._eventLogger.step(e,"failed",ne.CALL_ACTION,ae.ERROR);if(this._delegate){this._delegate.onCallActionFailed(e,t)}};RTCCall.prototype._clearHangupTimer=function(){if(this._hangupInvalidCallTimer){clearTimeout(this._hangupInvalidCallTimer);this._hangupInvalidCallTimer=undefined}};RTCCall.prototype._setupRetryRecoverCallTimer=function(){var e=this;this._clearRetryRecoverCallTimer();S.debug(this._logTag,"Schedule retry recover call after "+wt+" sec");this._retryRecoverCallTimer=setTimeout((function(){S.debug(e._logTag,"Retry recover call");e.recoverCall()}),wt)};RTCCall.prototype._clearRetryRecoverCallTimer=function(){this._retryRecoverCallTimer&&clearTimeout(this._retryRecoverCallTimer);this._retryRecoverCallTimer=undefined};RTCCall.prototype._setSipInfoIntoCallInfo=function(){var e=this._callSession.getSession();if(!e||!e.dialog||!e.dialog.id){return}this._callInfo.callId=e.dialog.id.callId||"";this._callInfo.fromTag=e.dialog.id.remoteTag||"";this._callInfo.toTag=e.dialog.id.localTag||"";this._callInfo.callId&&this._callTagCalculator.setSipCallId(this._callInfo.callId);S.info(this._logTag,"set sip info callId="+this._callInfo.callId+"; fromTag="+this._callInfo.fromTag+"; toTag="+this._callInfo.toTag+"; to call info")};RTCCall.prototype._onSessionAccepted=function(){this._fsm.sessionAccepted()};RTCCall.prototype._onSessionConfirmed=function(){this._fsm.sessionConfirmed()};RTCCall.prototype._onSessionDisconnected=function(){this._fsm.sessionDisconnected()};RTCCall.prototype._onSessionError=function(){this._fsm.sessionError()};RTCCall.prototype._onSessionProgress=function(e){if(e.statusCode===183){S.info(this._logTag,"receive call "+e.statusCode+" status code");this._callTagCalculator.markCallEstablished();this._report.updateEstablishment(nt.RECEIVED_183_TIME);this._setSipInfoIntoCallInfo();this._clearHangupTimer()}};RTCCall.prototype._onSessionReinviteAccepted=function(e){if(!e||!e.sessionDescriptionHandler){return}if(Mn.SEND_ONLY===e.sessionDescriptionHandler.getDirection()){this._fsm.holdSuccess();return}if(this._recoverStarted){this._callTagCalculator.markCallRecoverReInviteSuccess();this._recoverStarted=false}this._fsm.unholdSuccess()};RTCCall.prototype._onSessionReinviteFailed=function(e){S.warn(this._logTag,"Reinvite failed. Terminate call");if(this._recoverStarted){this.hangup();return}if(e&&e.sessionDescriptionHandler&&Mn.SEND_ONLY===e.sessionDescriptionHandler.getDirection()){this._fsm.holdFailed();return}this._fsm.unholdFailed()};RTCCall.prototype._onAnswerAction=function(){var e;this._eventLogger.info({"Can Move To Rcv":(e=this._answerOptions)===null||e===void 0?void 0:e.canPromoteToVideo});this._report.updateEstablishment(nt.ANSWER_TIME);this._callSession.answer(this._answerOptions)};RTCCall.prototype._onRejectAction=function(){this._callSession.reject()};RTCCall.prototype._onSendToVoicemailAction=function(){this._callSession.sendToVoicemail()};RTCCall.prototype._onHoldAction=function(){this._clearRetryRecoverCallTimer();this._callSession.hold()};RTCCall.prototype._onUnholdAction=function(){this._clearRetryRecoverCallTimer();this._callSession.unhold()};RTCCall.prototype._onHangupAction=function(){this._clearRetryRecoverCallTimer();this._callSession.hangup()};RTCCall.prototype._onFlipAction=function(e){this._callSession.flip(e)};RTCCall.prototype._onTransferToConfAction=function(e){this._callSession.transferToConf(e)};RTCCall.prototype._onBargeAction=function(){this._callSession.barge()};RTCCall.prototype._onWhisperAction=function(){this._callSession.whisper()};RTCCall.prototype._onTransferAction=function(e){this._callSession.transfer(e)};RTCCall.prototype._onWarmTransferAction=function(e){this._callSession.warmTransfer(e)};RTCCall.prototype._onForwardAction=function(e){this._callSession.forward(e)};RTCCall.prototype._onParkAction=function(){this._callSession.park()};RTCCall.prototype._onStartRecordAction=function(){if(i.M.RECORDING===this._recordState){this._notifyCallActionSuccess(i.VB.START_RECORD,{})}else if(i.M.IDLE===this._recordState){this._recordState=i.M.START_RECORD_IN_PROGRESS;if(this._recordingId){this._setRecording(true)}else{this._callSession.startRecord()}}else{this._notifyCallActionFailed(i.VB.START_RECORD,i.QP.OTHER_ACTION_IN_PROGRESS)}};RTCCall.prototype._onStopRecordAction=function(){if(i.M.RECORDING===this._recordState){this._recordState=i.M.STOP_RECORD_IN_PROGRESS;if(this._recordingId){this._setRecording(false)}else{this._callSession.stopRecord()}}else if(i.M.IDLE===this._recordState){this._notifyCallActionSuccess(i.VB.STOP_RECORD,{})}else{this._notifyCallActionFailed(i.VB.STOP_RECORD,i.QP.OTHER_ACTION_IN_PROGRESS)}};RTCCall.prototype._setRecording=function(e){var t=this;var n=e?i.VB.START_RECORD:i.VB.STOP_RECORD;this._requestManager.setRecording(e,this._callInfo.sessionId,this._callInfo.partyId,this._recordingId).then((function(){S.info(t._logTag,"Set recording "+e+" succeed");t._onCallActionSuccess(n)})).catch((function(e){t._onCallActionFailed(n,e)}))};RTCCall.prototype._onMuteAction=function(e){this._callSession.mute(e)};RTCCall.prototype._onUnmuteAction=function(e){this._callSession.unmute(e)};RTCCall.prototype._onDtmfAction=function(e){this._callSession.dtmf(e)};RTCCall.prototype._onStartReplyAction=function(){this._callSession.startReply()};RTCCall.prototype._onReplyWithPatternAction=function(e,t,n){this._callSession.replyWithPattern(e,t,n)};RTCCall.prototype._onReplyWithMessageAction=function(e){this._callSession.replyWithMessage(e)};RTCCall.prototype._onCreateOutingCallSession=function(){this._report.updateEstablishment(nt.INVITE_SENT_TIME);var e=this._account.createOutgoingCallSession(this._callInfo.toNum,this._options);this.setCallSession(e);this._eventLogger.info({"Switch Over Call":this._options.replacesCallId,"Rcc Conf":!!this._options.accessCode,"Can Move to Rcv":this._options.canPromoteToVideo,"On Behalf Key":this._options.onBehalfKey,"Pick Up Call Id":this._options.pickUpCallId,"Rc Tap Conf":!!this._options.rcTapRcc})};RTCCall.prototype._onCallStateChange=function(e){if(this._callState===e){return}this._callState=e;if(this._delegate){this._delegate.onCallStateChange(e)}};RTCCall.prototype._parseRcApiIds=function(e){if(!e){return}var t=e[Ge.RC_API_IDS];if(!t){S.warn(this._logTag,"Sip headers have no "+Ge.RC_API_IDS);return}var n=t[0]["raw"].split(";").map((function(e){return e.split("=")}));this._callInfo.partyId=n[0][1];this._callInfo.sessionId=n[1][1];this._report.update(nt.SESSION_ID,this._callInfo.sessionId);S.info(this._logTag,"Got party id="+this._callInfo.partyId+" session id="+this._callInfo.sessionId);this._callTagCalculator.setPartyId(this._callInfo.partyId);this._callTagCalculator.setSessionId(this._callInfo.sessionId)};RTCCall.prototype._parseRcToPhn=function(e){try{var t=e[Ge.RC_P_RC][0].raw;var n=new DOMParser;var o=n.parseFromString(t,"text/xml").getElementsByTagName("Bdy");this._callInfo.toNum=o[0].getAttribute("ToPhn")||"";S.info(this._logTag,"Get to number "+this._callInfo.toNum)}catch(e){S.warn(this._logTag,"Can't parse to number from invite request due to "+e)}};RTCCall.prototype.updateProxyServer=function(e){this._callTagCalculator.updateProxyServer(e)};RTCCall.prototype._removeConferenceParty=function(e){return this._requestManager.removePartyMember(this._callInfo.sessionId,e)};RTCCall.prototype.removeConferenceParty=function(e){return Dn(this,void 0,Promise,(function(){var t,n,o,r;return Pn(this,(function(i){switch(i.label){case 0:if(!this._isMultiPartyConf){S.warn(this._logTag,"This call is not conference call, could not remove party");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}t=this._conferenceStatus.parties.findIndex((function(t){return t.sessionId===e}));if(t===-1){return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}n=this._conferenceStatus.parties[t].id;i.label=1;case 1:i.trys.push([1,3,,4]);return[4,this._removeConferenceParty(n)];case 2:o=i.sent();S.debug(this._logTag,"Remove party success: "+o);this._conferenceStatus.parties.splice(t,1);return[3,4];case 3:r=i.sent();S.warn(this._logTag,"Failed to Remove party into conference: "+r);return[2,Promise.reject(r)];case 4:return[2]}}))}))};RTCCall.prototype.updateConferencePartyList=function(e){if(!this._isMultiPartyConf){S.warn(this._logTag,"This call is not conference call, could not update the conference party list");return}this._updatePartiesList(e);return this._conferenceStatus.parties};RTCCall.prototype._updatePartiesList=function(e){var t=this;var n=[];e.forEach((function(e){S.info(t._logTag,"Update party info: "+JSON.stringify(e)+"}");var o=t._conferenceStatus.parties.find((function(t){return t.id===e.id}));if(o){Object.assign(o,e);S.info(t._logTag,"Party info updated: "+JSON.stringify(o));n.push(o)}else{S.warn(t._logTag,"Can not find party info")}}));this._conferenceStatus.parties=n};RTCCall.prototype.findConferenceParty=function(e){if(!this._isMultiPartyConf){S.warn(this._logTag,"This call is not conference call, could not find the conference party");return}return this._conferenceStatus.parties.find((function(t){return t.sessionId===e}))};RTCCall.prototype.getConferencePartyList=function(){return Dn(this,void 0,Promise,(function(){var e,t;return Pn(this,(function(n){switch(n.label){case 0:if(!this._isMultiPartyConf){S.warn(this._logTag,"This call is not conference call, could not get the conference party");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}n.label=1;case 1:n.trys.push([1,3,,4]);return[4,this._requestManager.getConferenceStatus(this._callInfo.sessionId)];case 2:e=n.sent();this._updatePartiesList(e.parties);S.info(this._logTag,"Succeed to get party conference status: "+JSON.stringify(this._conferenceStatus));return[2,this._conferenceStatus.parties];case 3:t=n.sent();S.warn(this._logTag,"Failed to get party conference status: "+t+", return local conference parties");return[2,Promise.reject(this._conferenceStatus.parties)];case 4:return[2]}}))}))};RTCCall.prototype.getVoiceQuality=function(){return this._callSession.getVoiceQuality()};RTCCall.prototype.promoteToVideo=function(e){return this._requestManager.promoteToVideo(this._callInfo.sessionId,e)};RTCCall.prototype.networkChange=function(e){this._eventLogger.step("network change",e,ne.NETWORK)};return RTCCall}();var kn=n(738954);var Un=n.n(kn);var Gn=undefined&&undefined.__assign||function(){Gn=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++){t=arguments[n];for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r))e[r]=t[r]}return e};return Gn.apply(this,arguments)};var Hn=undefined&&undefined.__awaiter||function(e,t,n,o){function adopt(e){return e instanceof n?e:new n((function(t){t(e)}))}return new(n||(n=Promise))((function(n,r){function fulfilled(e){try{step(o.next(e))}catch(e){r(e)}}function rejected(e){try{step(o["throw"](e))}catch(e){r(e)}}function step(e){e.done?n(e.value):adopt(e.value).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))};var Vn=undefined&&undefined.__generator||function(e,t){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},o,r,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(o)throw new TypeError("Generator is already executing.");while(n)try{if(o=1,r&&(i=a[0]&2?r["return"]:a[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;if(r=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;r=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e];r=0}finally{o=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var Bn="RTCAccount";var xn="Jupiter";var Wn=function(){function RTCAccount(e,t){var n=this;this._postponeRestartWebphone=false;this._postponeVDIReRegisterHandler=null;this._retryTimer=null;this._recoverDebounceTimer=null;this._registerForUnloadTimer=null;this._failedTimes=0;this._username="";this._server="";this._lastCallTime=-1;this._reportTime=-1;this._reportCount=0;this._callCountStats={outgoing:0,incoming:0,answered:0};this._isUaForbidden=false;this._turnServersChangedCallback=function(e){n._onTurnServersChanged(e)};this._state=i.Ty.IDLE;this._delegate=e;this._accReporter=new bt;this._regManager=new En(t,this._accReporter);this._userInfo=t;this._provManager=new Oe;this._callManager=new de;this._networkListener=function(e){n._onNetworkChange(e)};this._mediaListener=function(){n._onMediaFailed()};this._unloadListener=function(){n._handleBeforeUnload()};this._initListener();this._observeFeatureFlags()}RTCAccount.prototype.destroy=function(){Q.instance().removeListener(M.NETWORK_CHANGE,this._networkListener);Q.instance().removeListener(M.MEDIA_CONNECTION_FAILED,this._mediaListener);Q.instance().removeListener(M.WINDOW_BEFOREUNLOAD,this._unloadListener);this._unsubscribeFeatureFlags()};Object.defineProperty(RTCAccount.prototype,"_featureFlagModule",{get:function(){return(0,J.getModule)(X.FEATURE_FLAG_MODULE)},enumerable:true,configurable:true});RTCAccount.prototype._unsubscribeFeatureFlags=function(){var e;(e=this._featureFlagModule)===null||e===void 0?void 0:e.unsubscribe(X.G.D_USE_TURN_SERVER,this._turnServersChangedCallback)};RTCAccount.prototype._observeFeatureFlags=function(){var e;(e=this._featureFlagModule)===null||e===void 0?void 0:e.observeFeatureFlag(X.G.D_USE_TURN_SERVER,this._turnServersChangedCallback)};RTCAccount.prototype._checkTurnServersInfo=function(e){if(!e){return false}if(typeof e.enableTurnServers!=="boolean"){return false}if(typeof e.useRelayTransportPolicy!=="boolean"){return false}if(!(e.turnServers instanceof Array)){return false}var t=e.turnServers.find((function(e){if(typeof e.urls!=="string"){return true}return false}));return t?false:true};RTCAccount.prototype._onTurnServersChanged=function(e){if(!this._checkTurnServersInfo(e)){S.warn(Bn,"Receive a illegal turn servers info "+JSON.stringify(e));return}var t=this._regManager.getTurnServers();if(Un()(t,e)){S.info(Bn,"Turn servers info "+JSON.stringify(e)+" is same as local's");return}S.info(Bn,"Receive new turn servers info "+JSON.stringify(e));this._regManager.setTurnServers(e);if(this._callManager.callCount()===0){this._regManager.reRegister(true)}else{S.debug(Bn,"There're active calls. Postpone new turn servers reRegister");this._postponeRestartWebphone=true}};RTCAccount.prototype._handleBeforeUnload=function(){var e=this;if(!this._callManager.callCount()){this._regManager.unregisterWebphone();if(this._registerForUnloadTimer){clearTimeout(this._registerForUnloadTimer)}this._registerForUnloadTimer=setTimeout((function(){S.debug(Bn,"register timer for unregisterWebphone is reached, will do register");e._regManager.reRegister(true);e._registerForUnloadTimer=null}),g*1e3)}else{S.warn(Bn,"There are "+this._callManager.callCount()+" calls, not unregister webphone")}};RTCAccount.prototype.handleProvisioning=function(){this._provManager.acquireSipProv()};RTCAccount.prototype.clearLocalProvisioning=function(){this._provManager.clearProvInfo()};RTCAccount.prototype.handleVDIEvent=function(e,t){var n=this;S.debug(Bn,"handle VDI event, isConnected="+e);this._vdiOptions=t;var reRegisterHandler=function(t){var o;S.debug(Bn,"Do VDI re-register for "+t);(o=n._regManager)===null||o===void 0?void 0:o.vdiReRegister(e,t,n._modifyProvisioningOptions(T))};if(this._postponeVDIReRegisterHandler){this._postponeVDIReRegisterHandler=null;return}var o=this._callManager.getVdiVendorName();if(!e&&!!o){S.debug(Bn,"There are active VDI (vendor: "+o+") calls. Perform VDI re-register");this._callManager.endAllCalls();reRegisterHandler(o);return}if(this.callCount()){S.debug(Bn,"There are active calls. Postpone VDI re-register");this._postponeVDIReRegisterHandler=function(){reRegisterHandler(o)}}else{reRegisterHandler(o)}};RTCAccount.prototype.promoteDelegatedCallToConf=function(e,t,n,o){return Hn(this,void 0,Promise,(function(){var r;return Vn(this,(function(i){switch(i.label){case 0:if(!this._callManager.allowConference()){S.warn(Bn,"Failed to promote delegated call to conference. Max call count reached");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}return[4,this._movePartiesToConf(e)];case 1:i.sent();r=this.makeCall(t,n,o);if(!r){S.warn(Bn,"Failed to promote delegated call to conference. make call failed");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}return[2,r]}}))}))};RTCAccount.prototype._movePartiesToConf=function(e){return Hn(this,void 0,Promise,(function(){var t,n,o,r;return Vn(this,(function(i){switch(i.label){case 0:i.trys.push([0,2,,3]);return[4,H.getConfStatus(e.sessionId)];case 1:t=i.sent();n={};t.parties.forEach((function(t){var o;if(((o=t.status)===null||o===void 0?void 0:o.code)!=="Disconnected"){n[t.id]=e.conferencePinsCode}else{S.warn(Bn,"Filter out party "+t.id+" because this party status is disconnected")}}));o={rcc:{conferencePhoneNumber:e.conferencePhoneNumber,conferencePins:n}};return[2,H.movePartiesToConf(e.sessionId,o)];case 2:r=i.sent();S.warn(Bn,"Failed to move parties to rcc conference. Error: "+r);return[2,Promise.reject(r)];case 3:return[2]}}))}))};RTCAccount.prototype.makeConference=function(e,t){return Hn(this,void 0,Promise,(function(){var n,o,r,i;return Vn(this,(function(a){switch(a.label){case 0:if(!this._callManager.allowConference()){S.warn(Bn,"Failed to make conference. Max call count reached");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}a.label=1;case 1:a.trys.push([1,3,,4]);return[4,H.originateConference()];case 2:n=a.sent();if(!n||!n.session||!n.session.voiceCallToken||n.session.voiceCallToken.length===0){S.warn(Bn,"Failed to make conference. Create conference response invalid");return[2,Promise.reject(m.RESPONSE_STATUS_CODE.BAD_REQUEST)]}o=t?{canPromoteToVideo:t}:undefined;r=this._makeCall(String(n.session.voiceCallToken),e,n.session,o);if(!r){return[2,Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)]}return[2,r];case 3:i=a.sent();S.warn(Bn,"Failed to make conference. Error: "+i);return[2,Promise.reject(i)];case 4:return[2]}}))}))};RTCAccount.prototype.pickUpDelegatedCall=function(e){if(!this._callManager.allowCall()){S.warn(Bn,"Failed to pickup delegated Call. Max call count reached");return Promise.reject(m.RESPONSE_STATUS_CODE.LOCAL_ABORTED)}return H.pickUpDelegatedCall(e,this.getSipAuthorizationId())};RTCAccount.prototype.makeCall=function(e,t,n){S.ensureApiBeenCalledLog(Bn,"makeCall");if(!e||e.length===0){S.error(Bn,"Failed to make call. To number is empty");return null}var o=(n===null||n===void 0?void 0:n.extraCall)?this._callManager.allowConference():this._callManager.allowCall();if(!o){S.warn(Bn,"Failed to make call. Max call count reached, extraCall: "+(n===null||n===void 0?void 0:n.extraCall));return null}return this._makeCall(e,t,undefined,n)};RTCAccount.prototype.isReady=function(){return this._state===i.Ty.REGISTERED};RTCAccount.prototype.state=function(){return this._state};RTCAccount.prototype.callList=function(){return this._callManager.callList()};RTCAccount.prototype.callCount=function(){return this._callManager.callCount()};RTCAccount.prototype.getCallByUuid=function(e){return this._callManager.getCallByUuid(e)};RTCAccount.prototype.getRegistrationStatusCode=function(){return this._regManager.getRegistrationStatusCode()};RTCAccount.prototype.getRtcCallCountStats=function(){return this._callCountStats};RTCAccount.prototype.logout=function(){this._regManager.logout()};RTCAccount.prototype.createOutgoingCallSession=function(e,t){return this._regManager.createOutgoingCallSession(e,t)};RTCAccount.prototype.addAnsweredCall=function(){this._callCountStats.answered++};RTCAccount.prototype.removeCallFromCallManager=function(e){this._processAskForFeedback(e);this._callManager.removeCall(e);if(!this._callManager.callCount()){if(this._postponeProvisioning){S.debug(Bn,"There's no active call. Process postpone provisioning info");this._regManager.provisionReady(this._postponeProvisioning,this._modifyProvisioningOptions(T));this._updateUsernameAndServer(this._postponeProvisioning);this._postponeProvisioning=null}else if(this._postponeVDIReRegisterHandler){S.debug(Bn,"There's no active call. Process postpone VDI restart web phone handler");this._postponeVDIReRegisterHandler();this._postponeVDIReRegisterHandler=null;this._postponeRestartWebphone=false}else if(this._postponeRestartWebphone){S.debug(Bn,"There's no active call. Process postpone restart web phone");this._postponeRestartWebphone=false;this._regManager.reRegister(true)}}};RTCAccount.prototype._makeCall=function(e,t,n,o){if(this.state()===i.Ty.UNREGISTERED){S.warn(Bn,"Failed to make call. Account is in Unregistered state");return null}var r=o?o:{};this._regManager.makeCall(e,t,r);var a=new Fn(false,e,null,this,t,r,this._userInfo,n);this._callManager.addCall(a);this._callCountStats.outgoing++;if(this.isReady()){a.onAccountReady()}else{a.onAccountNotReady()}return a};RTCAccount.prototype.notifyNoAudioStateEvent=function(e,t){var n;(n=this._delegate)===null||n===void 0?void 0:n.onNoAudioStateEvent(e,t)};RTCAccount.prototype.notifyNoAudioDataEvent=function(e,t){var n;(n=this._delegate)===null||n===void 0?void 0:n.onNoAudioDataEvent(e,t)};RTCAccount.prototype._initListener=function(){var e=this;this._regManager.on(Ee.RECEIVE_INCOMING_INVITE,(function(t){e._onReceiveInvite(t)}));this._regManager.on(Ee.ACCOUNT_STATE_CHANGED,(function(t){e._onAccountStateChanged(t)}));this._regManager.on(Ee.LOGOUT_ACTION,(function(){e._onLogoutAction()}));this._regManager.on(Ee.REFRESH_PROV,(function(t){e._refreshProv(t)}));this._regManager.on(Ee.SWITCH_BACK_PROXY_ACTION,(function(){e._switchBackProxy()}));this._regManager.on(Ee.TRANSPORT_CONNECTED,(function(t){if(t!==e._server){e._server=t;e.callList().forEach((function(t){t.updateProxyServer(e._server)}))}}));this._regManager.on(Ee.VDI_RE_REGISTER,(function(t,n){var o;(o=e._delegate)===null||o===void 0?void 0:o.onVdiReRegister(t,n)}));this._provManager.on(Re.PROV_ARRIVE,(function(t,n){return Hn(e,void 0,void 0,(function(){var e;return Vn(this,(function(o){switch(o.label){case 0:return[4,(e=this._delegate)===null||e===void 0?void 0:e.onReceiveSipProv(t,n)];case 1:o.sent();return[2]}}))}))}));this._provManager.on(Re.NEW_PROV,(function(t){var n=t.info;var o;e._onNewProv(n);(o=e._delegate)===null||o===void 0?void 0:o.onReceiveNewProvFlags(n.sipFlags)}));this._provManager.on(Re.PROV_FAILED,(function(t,n){var o;(o=e._delegate)===null||o===void 0?void 0:o.onProvisioningFailed(t,n)}));Q.instance().on(M.NETWORK_CHANGE,this._networkListener);Q.instance().on(M.MEDIA_CONNECTION_FAILED,this._mediaListener);Q.instance().on(M.WINDOW_BEFOREUNLOAD,this._unloadListener)};RTCAccount.prototype._onAccountStateChanged=function(e){var t;if(this._state===e){return}this._state=e;if(this._state===i.Ty.REGISTERED){this._isUaForbidden=false;this._failedTimes=0;this._clearRecover();this._clearRegisterRetryTimer();this._callManager.notifyAccountReady();this._provManager.initRefreshState();Ce.instance().subscribe(r.RCSubscriptionKeys.TelephonySessionsWithRecordings)}else if(this._state===i.Ty.FAILED){if(this._regManager.getRegistrationStatusCode()!==ge.FORBIDDEN){this._isUaForbidden=false}else if(!this._isUaForbidden){S.warn(Bn,"Server return 403 Forbidden. Notify upper layer to show alert");this._isUaForbidden=true;(t=this._delegate)===null||t===void 0?void 0:t.onUserAgentForbidden()}this._scheduleRegisterRetryTimer()}else if(this._state===i.Ty.UNREGISTERED){Ce.instance().unsubscribe(r.RCSubscriptionKeys.TelephonySessionsWithRecordings)}window["sipState"]=e;if(this._delegate){this._delegate.onAccountStateChanged(e)}};RTCAccount.prototype._scheduleRegisterRetryTimer=function(){var e=this;var t=this._calculateNextRetryInterval();this._failedTimes++;S.debug(Bn,"Schedule retry registration in "+t+" seconds");if(this._retryTimer){clearTimeout(this._retryTimer)}this._retryTimer=setTimeout((function(){S.debug(Bn,"retry timer is reached and do reRegister");e._maybeRecover()}),t*1e3)};RTCAccount.prototype._clearRegisterRetryTimer=function(){S.debug(Bn,"Clear retry registration timer");if(this._retryTimer){clearTimeout(this._retryTimer)}this._retryTimer=null};RTCAccount.prototype._calculateNextRetryInterval=function(){var e=this._failedTimes;if(this.callCount()){e=this._failedTimes>3?this._failedTimes-3:0}var t=e<R.length?e:R.length-1;return randomBetween(R[t].min,R[t].max)};RTCAccount.prototype._scheduleRecover=function(){var e=this;this._clearRecover();this._recoverDebounceTimer=setTimeout((function(){e._maybeRecover()}),d)};RTCAccount.prototype._clearRecover=function(){this._recoverDebounceTimer&&clearTimeout(this._recoverDebounceTimer);this._recoverDebounceTimer=null};RTCAccount.prototype._maybeRecover=function(){this._clearRecover();this._clearRegisterRetryTimer();if(!Q.instance().isOnline()){S.debug(Bn,"Skip recover since network is offline");return}if(this.callCount()){S.debug(Bn,"There're active calls. Trigger Re-register");this._callManager.notifyRecoverStart();this._regManager.reRegister(false)}else{S.debug(Bn,"There's no active call. Trigger restart webphone");this._regManager.reRegister(true)}};RTCAccount.prototype._onLogoutAction=function(){this._callManager.endAllCalls();this.clearLocalProvisioning()};RTCAccount.prototype._onReceiveInvite=function(e){if(e===null){S.error(Bn,"Failed to receive incoming call. Session is null");return}if(!this._callManager.allowCall()){S.warn(Bn,"Failed to receive incoming call. Max call count is reached");return}var t=new Fn(true,"",e,this,null,undefined,this._userInfo);this._callManager.addCall(t);this._callCountStats.incoming++;this._delegate.onReceiveIncomingCall(t)};RTCAccount.prototype._onNewProv=function(e){if(!this._regManager){return}if(this._callManager.callCount()===0){S.debug(Bn,"There's no active call. Process new provisioning info");this._regManager.provisionReady(e,this._modifyProvisioningOptions(T));this._updateUsernameAndServer(e)}else{S.debug(Bn,"There're active calls. Postpone new provisioning info");this._postponeProvisioning=e}};RTCAccount.prototype._updateUsernameAndServer=function(e){if(e&&e.sipInfo[0]){this._username=e.sipInfo[0].username}};RTCAccount.prototype._onNetworkChange=function(e){if(w.ONLINE===e){S.debug(Bn,"network change to online");this._scheduleRecover()}this._callManager.callList().forEach((function(t){t.networkChange(e)}))};RTCAccount.prototype._onMediaFailed=function(){if(!Q.instance().isOnline()){S.debug(Bn,"media connection is failed when network is offline. Ignore it");return}S.debug(Bn,"media connection is failed. Try to recover");this._scheduleRecover()};RTCAccount.prototype.getSipProvFlags=function(){var e=this._provManager.getCurrentSipProvisionInfo();if(e){return e.sipFlags}return null};RTCAccount.prototype.getSipProv=function(){var e=this._provManager.getCurrentSipProvisionInfo();if(e){return e}return null};RTCAccount.prototype.getSipAuthorizationId=function(){var e;var t=this._provManager.getCurrentSipProvisionInfo();if(t&&t.sipInfo){return(e=t.sipInfo[0])===null||e===void 0?void 0:e.authorizationId}S.warn(Bn,"Cant find authorizationId due to sipProvisionInfo is "+t);return""};RTCAccount.prototype.getUsername=function(){return this._username};RTCAccount.prototype.getServer=function(){this._server=this._regManager.getServer();return this._server};RTCAccount.prototype.getAppName=function(){return xn};RTCAccount.prototype._refreshProv=function(e){this._provManager.refreshSipProv(e)};RTCAccount.prototype.refreshProv=function(){return Hn(this,void 0,void 0,(function(){var e;return Vn(this,(function(t){switch(t.label){case 0:t.trys.push([0,2,,3]);this._provManager.initRefreshState();return[4,this._provManager.refreshSipProv()];case 1:t.sent();return[3,3];case 2:e=t.sent();S.warn(Bn,"Failed to refresh sipProv");return[3,3];case 3:return[2]}}))}))};RTCAccount.prototype._switchBackProxy=function(){S.debug(Bn,"switch to back proxy and do restart webphone");if(this.callCount()){this._postponeRestartWebphone=true}else{this._regManager&&this._regManager.reRegister(true)}};RTCAccount.prototype._processAskForFeedback=function(e){var t=this._callManager.getCallByUuid(e);if(!t){return}if(this._callManager.callCount()>1){S.debug(Bn,"Call count > 1. Do not ask for feedback");return}!t.forbiddenQualityFeedback()&&this._mayAskForFeedback(t)};RTCAccount.prototype._mayAskForFeedback=function(e){var t=yn.instance().getCallQualityFeedbackParams();if(!t.enable){S.debug(Bn,"Call quality feedback disabled. Do not ask for feedback");return}if(this._lastCallTime<0||Date.now()-this._lastCallTime>=bn){this._lastCallTime=Date.now();if(!randomChance(t.chanceNoCall)){S.debug(Bn,"Chance no call miss, Do not ask for feedback");return}this._reportTime=Date.now();this._reportCount=1;S.debug(Bn,"Ask for call quality feedback first time in 24h");this._delegate&&this._delegate.onAskForCallQualityFeedback(e.getCallQualityFeedback())}else{this._lastCallTime=Date.now();if(!randomChance(t.chanceWithCall)){S.debug(Bn,"Chance with call miss, Do not ask for feedback");return}if(this._shouldAskFeedbackForHeavyCaller(t.decreaseRate)){S.debug(Bn,"Ask for call quality feedback");this._delegate&&this._delegate.onAskForCallQualityFeedback(e.getCallQualityFeedback())}}};RTCAccount.prototype._shouldAskFeedbackForHeavyCaller=function(e){var t=false;if(this._reportTime<0||Date.now()-this._reportTime>=bn){this._reportCount=0;t=true}if(!randomChance(1-this._reportCount*e)){S.debug(Bn,"Chance heavy caller miss, Do not ask for feedback");return false}if(t){this._reportTime=Date.now();this._reportCount=1}else{this._reportCount++}return true};RTCAccount.prototype._modifyProvisioningOptions=function(e){return this._vdiOptions?Gn(Gn({},e),this._vdiOptions):e};return RTCAccount}();var jn=function(){function RTCEngine(){this._audioDeviceManager=o.p.instance()}RTCEngine.getInstance=function(){if(!RTCEngine._instance){RTCEngine._instance=new RTCEngine}return RTCEngine._instance};RTCEngine.prototype.destroy=function(){yn.instance().destroy();RTCEngine._instance=null};RTCEngine.prototype.setUserInfo=function(e){if(e){this._userInfo=e}};RTCEngine.prototype.setCallRecoveryEnabled=function(e){yn.instance().setEnableCallRecovery(e)};RTCEngine.prototype.setCallQualityFeedbackParams=function(e){yn.instance().setCallQualityFeedbackParams(e)};RTCEngine.prototype.createAccount=function(e){return new Wn(e,this._userInfo)};RTCEngine.setLogger=function(e){S.setLogger(e)};RTCEngine.prototype.setNetworkDelegate=function(e){D.networkClient=e};RTCEngine.prototype.setTelephonyDaoDelegate=function(e){B.instance().setDaoDelegate(e)};RTCEngine.prototype.setVolume=function(e){q.instance().setVolume(e)};RTCEngine.prototype.getVolume=function(){return q.instance().getVolume()};RTCEngine.prototype.getAudioInputs=function(){return this._audioDeviceManager.getAudioInputs()};RTCEngine.prototype.getAudioOutputs=function(){return this._audioDeviceManager.getAudioOutputs()};RTCEngine.prototype.getCurrentAudioInput=function(){return this._audioDeviceManager.getCurrentAudioInput()};RTCEngine.prototype.setCurrentAudioInput=function(e){return this._audioDeviceManager.setAudioInputDevice(e)};RTCEngine.prototype.getCurrentAudioOutput=function(){return this._audioDeviceManager.getCurrentAudioOutput()};RTCEngine.prototype.setCurrentAudioOutput=function(e){return this._audioDeviceManager.setAudioOutputDevice(e)};RTCEngine.prototype.getDefaultDeviceId=function(e){return this._audioDeviceManager.getDefaultDeviceId(e)};return RTCEngine}();var Yn=n(344323);var qn=n(826585)},193415:()=>{},245697:()=>{}}]);