"use strict";var cancelOrderCtrl=["$scope","$rootScope","reasonData","$log","OSHPService",function($scope,$rootScope,reasonData,$log,OSHPService){$log.log("entering orderCancelCtrl");var current=$rootScope.current;if(current.appSource="Cancel Order Page Landing",current.OrderID||(current.OrderID=current.orderDetails.orders[0].orderNumber),current.zipcode||(current.zipcode=current.orderDetails.orders[0].ShippingZip),current.quantity=0,$rootScope.additionalCancelItems=[],void 0===current.orderDetails&&null==current.orderDetails)$scope.viewlandingPage();else{if(setTimeout(function(){$(".btn-quantity-toggle").each(function(){var check=$(this),currentVal=$(this).find("input[data-max-quantity]"),cancelOrderbtn=$("#cancelItem");$(this).find(".btn-prev").on("click",function(){"1"==currentVal.val()&&cancelOrderbtn.attr("disabled","disabled")}),$(this).find(".btn-next").on("click",function(){cancelOrderbtn.removeAttr("disabled")});var maxVal=currentVal.attr("data-max-quantity");currentVal.val()<="0"&&(currentVal.val("0"),currentVal.next().removeAttr("disabled aria-disabled").removeClass("disabled"),currentVal.prev().attr({disabled:"disabled","aria-disabled":"true"}).addClass("disabled")),currentVal.on("keyup",function(){if(currentVal.attr("value",$(currentVal).val()),currentVal.val()>=parseInt($("[data-max-quantity]").attr("data-max-quantity")))currentVal.val(maxVal),currentVal.prev().removeAttr("disabled aria-disabled").removeClass("disabled"),currentVal.next().attr({disabled:"disabled","aria-disabled":"true"}).addClass("disabled");else{if(!(currentVal.val()<="0"))return currentVal.next().removeAttr("disabled aria-disabled").removeClass("disabled"),currentVal.prev().removeAttr("disabled aria-disabled").removeClass("disabled"),!1;currentVal.val("0"),currentVal.next().removeAttr("disabled aria-disabled").removeClass("disabled"),currentVal.prev().attr({disabled:"disabled","aria-disabled":"true"}).addClass("disabled")}}),$(this).find(".btn-prev").on("click",function(){if("1"==currentVal.val()&&currentVal.prev().attr({disabled:"disabled","aria-disabled":"true"}).addClass("disabled"),"0"==currentVal.val())return!1;currentVal.val(parseInt(currentVal.val())-1),currentVal.attr("value",$(currentVal).val()),currentVal.next().removeAttr("disabled aria-disabled").removeClass("disabled")}),$(this).find(".btn-next").on("click",function(){if(currentVal.val()==parseInt($(check).find("[data-max-quantity]").attr("data-max-quantity"))-1&&currentVal.next().attr({disabled:"disabled","aria-disabled":"true"}).addClass("disabled"),currentVal.val()==parseInt($(check).find("[data-max-quantity]").attr("data-max-quantity")))return currentVal.next().attr({disabled:"disabled","aria-disabled":"true"}).addClass("disabled"),!1;currentVal.val(parseInt(currentVal.val())+1),currentVal.attr("value",$(currentVal).val()),currentVal.prev().removeAttr("disabled aria-disabled").removeClass("disabled")})}),$(".checkWrap").each(function(){function checkDisabledPrevBtn(){$(".checkWrap").find(".showQnty:visible .btn-prev[disabled]").length>0?cancelOrderbtn.attr("disabled","disabled"):cancelOrderbtn.removeAttr("disabled")}var checkWrap=$(this),cancelOrderbtn=$("#cancelItem");$(checkWrap).find("label.checkbox .quantity-list, label.checkbox i.skin").click(function(){$(this).parent().find(":checkbox").toggleClass("checkmeChecked"),$(this).parent().find(":checkbox").hasClass("checkmeChecked")||($(this).find("input[data-max-quantity]").val("0"),$(this).find("input[data-max-quantity]").trigger("input"),$(this).find(".btn-prev").attr("disabled","disabled"),$(this).find(".btn-next").removeAttr("disabled")),$(checkWrap).find(".showQnty:visible")&&$(checkWrap).find(".showQnty").length>0&&(cancelOrderbtn.attr("disabled","disabled"),$(checkWrap).find(".btn-prev").click(function(){$(this).hasClass("disabled")&&cancelOrderbtn.removeAttr("disabled")})),$(".checkWrap").find(".checkmeChecked").length<1&&cancelOrderbtn.removeAttr("disabled"),setTimeout(checkDisabledPrevBtn,100)}),$(checkWrap).find(".btn-next,.btn-prev").click(function(){setTimeout(checkDisabledPrevBtn,100)})})},500),angular.isUndefined(inqCustData)||(inqCustData.Liability=current.orderDetails.orderType),$scope.cancelOrder=null,$scope.cancelModal=null,$scope.donotCancelOrder=null,$rootScope.setPageContent(),$scope.orders=current.orderDetails.orders[0],$scope.orderDetails=current.orderDetails,$scope.itemCount=0,$scope.itemCount=$scope.orders.wirelessLines.length,1!==$scope.itemCount||Array.isArray($scope.orders.wirelessLines))$scope.itemDetails=$scope.orders.wirelessLines;else{var shipddet=[$scope.orders.wirelessLines];$scope.itemDetails=shipddet}var itemSelected=sessionStorage.getItem("itemSelected");$rootScope.cancelFlag=sessionStorage.getItem("cancelFlag"),$rootScope.itemSelected=itemSelected,$rootScope.qtyCtr=sessionStorage.getItem("qtyCtr"),$rootScope.qtyTobeCancelled=sessionStorage.getItem("qtyTobeCancelled");for(var tempItemsList=[],j=0,i=0;i<$scope.itemDetails.length;i++)$scope.itemDetails[i].uniqueId!=itemSelected&&"true"===$scope.itemDetails[i].cancellable&&(tempItemsList[j]=$scope.itemDetails[i],j++);$rootScope.tempItemDetails=tempItemsList,$scope.cancelOrderTracking=function(){if("Item"===sessionStorage.getItem("cancelFlag")){var itemsSelectedForCancellation=[],itemCanceledQty=0;if($scope.orders.wirelessLines.length>1){for(i=0;i<$scope.orders.wirelessLines.length;i++)if($scope.orders.wirelessLines[i].uniqueId==$rootScope.itemSelected){itemCanceledQty="1"==$scope.orders.wirelessLines[i].quantity?$scope.orders.wirelessLines[i].quantity:angular.element("#q"+$scope.orders.wirelessLines[i].uniqueId).val();var itemSelected={itemSku:$scope.orders.wirelessLines[i].itemSKU,itemName:$scope.orders.wirelessLines[i].productName,itemQty:itemCanceledQty};itemsSelectedForCancellation.push(itemSelected);break}for(var additionalCancelItem,i=0;i<$rootScope.additionalCancelItems.length;i++)itemCanceledQty="1"==$rootScope.additionalCancelItems[i].quantity?$rootScope.additionalCancelItems[i].quantity:angular.element("#q"+$rootScope.additionalCancelItems[i].uniqueId).val(),additionalCancelItem={itemSku:$rootScope.additionalCancelItems[i].itemSKU,itemName:$rootScope.additionalCancelItems[i].name,itemQty:itemCanceledQty},itemsSelectedForCancellation.push(additionalCancelItem)}else{itemCanceledQty="1"==$scope.orders.wirelessLines[0].quantity?$scope.orders.wirelessLines[0].quantity:angular.element("#q"+$scope.orders.wirelessLines[0].uniqueId).val();var itemsDetails={itemSku:$scope.orders.wirelessLines[0].itemSKU,itemName:$scope.orders.wirelessLines[0].productName,itemQty:itemCanceledQty};itemsSelectedForCancellation.push(itemsDetails)}current.itemsSelectedForCancellation=itemsSelectedForCancellation;var orderCancelFlag,dtmPN="",dtmURI="",orderNumber=current.orderDetails.OrderNumber,linkPosition="Body",linkName="Cancel Item(s)",linkDestinationUrl="/checkmyorder/virtual/cancelItem.html";orderCancelFlag=$scope.isItemLevelCancelEligibleCheck()?"N":"Y";fulldataList={orderId:orderNumber,items:itemsSelectedForCancellation,userResp:$rootScope.userResp,userRespTxt:$rootScope.comments,orderCancelFlag:orderCancelFlag,linkName:linkName,linkPosition:linkPosition,linkDestinationUrl:linkDestinationUrl};$scope.dtmCustomNotification("formSubmit","CMO_Cancel_Item_Submit","-2","-2",fulldataList,dtmPN,dtmURI),$scope.dtmCustomNotification("pageLoad","Page_Load","","","","CMO Order Mgmt Cancel Item Modal Pg","/checkmyorder/virtual/cancelItem.html")}else if("Order"===sessionStorage.getItem("cancelFlag")&&"COMS"===$scope.orders.orderSource){var item=null,items=[],dtmPN="",dtmURI="",orderNumber="";void 0!==$scope.orderDetails.orders[0].orderNumber&&null!=$scope.orderDetails.orders[0].orderNumber&&""!==$scope.orderDetails.orders[0].orderNumber&&(orderNumber=$scope.orderDetails.orders[0].orderNumber);var linkPosition="Body",linkName="Cancel Order",linkDestinationUrl="/checkmyorder/virtual/cancelOrder.html",fulldataList={orderId:orderNumber,userResp:$rootScope.userResp,userRespTxt:$rootScope.cmnt,linkName:linkName,linkPosition:linkPosition,linkDestinationUrl:linkDestinationUrl};if($scope.orders.wirelessLines.length>1)for(i=0;i<$scope.orders.wirelessLines.length;i++)"PREPARINGTOSHIP"!==$scope.orders.wirelessLines[i].statusKey&&"PENDINGPORTAPPROVAL"!==$scope.orders.wirelessLines[i].statusKey&&"CANCELED"!==$scope.orders.wirelessLines[i].statusKey&&(item={itemSku:$scope.orders.wirelessLines[i].itemSKU,itemName:$scope.orders.wirelessLines[i].productName,itemQty:$scope.orders.wirelessLines[i].quantity},items.push(item));else item={itemSku:$scope.orders.wirelessLines[0].itemSKU,itemName:$scope.orders.wirelessLines[0].productName,itemQty:$scope.orders.wirelessLines[0].quantity},items.push(item);fulldataList.items=items,$scope.dtmCustomNotification("formSubmit","CMO_Cancel_Order_Submit","-2","-2",fulldataList,dtmPN,dtmURI),$scope.dtmCustomNotification("pageLoad","Page_Load","","","","CMO Order Mgmt Cancel Order Modal Pg","/checkmyorder/virtual/cancelOrder.html")}setTimeout(function(){$("#wrapper").attr("aria-hidden","false"),$(".content-pane.content-tabs.innercontent-pane").attr("aria-hidden","true"),$("#cancelledOrder-modal").focus()},1e3)},$scope.viewOrderDetail=function(orders){$("#cancelledOrder-modal").modal("hide"),$scope.setView("orderDetails")},$scope.viewOrderDetailWithDTMCode=function(orders){current.appevent="CMO_Cancel_Item_Submit";var itemsSelectedForCancellation=[],itemCanceledQty=0;if(current.orderDetails.orders[0].wirelessLines.length>1){for(i=0;i<current.orderDetails.orders[0].wirelessLines.length;i++)if(current.orderDetails.orders[0].wirelessLines[i].uniqueId==$rootScope.itemSelected){itemCanceledQty="1"==current.orderDetails.orders[0].wirelessLines[i].quantity?current.orderDetails.orders[0].wirelessLines[i].quantity:angular.element("#q"+current.orderDetails.orders[0].wirelessLines[i].uniqueId).val();var itemSelected={itemSku:current.orderDetails.orders[0].wirelessLines[i].itemSKU,itemName:current.orderDetails.orders[0].wirelessLines[i].productName,itemQty:itemCanceledQty};itemsSelectedForCancellation.push(itemSelected);break}for(var additionalCancelItem,i=0;i<$rootScope.additionalCancelItems.length;i++)itemCanceledQty="1"==$rootScope.additionalCancelItems[i].quantity?$rootScope.additionalCancelItems[i].quantity:angular.element("#q"+$rootScope.additionalCancelItems[i].uniqueId).val(),additionalCancelItem={itemSku:$rootScope.additionalCancelItems[i].itemSKU,itemName:$rootScope.additionalCancelItems[i].productName,itemQty:itemCanceledQty},itemsSelectedForCancellation.push(additionalCancelItem)}else{itemCanceledQty="1"==current.orderDetails.orders[0].wirelessLines[0].quantity?current.orderDetails.orders[0].wirelessLines[0].quantity:angular.element("#q"+current.orderDetails.orders[0].wirelessLines[0].uniqueId).val();var itemsDetails={itemSku:current.orderDetails.orders[0].wirelessLines[0].itemSKU,itemName:current.orderDetails.orders[0].wirelessLines[0].productName,itemQty:itemCanceledQty};itemsSelectedForCancellation.push(itemsDetails)}var userResp="";0!=this.selItemReason&&(userResp=this.selItemReason+"  ");var cmnt="";void 0!==this.cancelItemComment&&""!==this.cancelItemComment&&(cmnt=this.cancelItemComment);var orderCancelFlag,fulldataList={orderId:orders,items:itemsSelectedForCancellation,userResp:userResp,userRespTxt:cmnt,orderCancelFlag:orderCancelFlag=$scope.isItemLevelCancelEligibleCheck()?"N":"Y",linkName:"Don't Cancel Items",linkPosition:"Body",linkDestinationUrl:"/checkmyorder/orderDetails.rt"};$scope.dtmCustomNotification("formResponse",current.appevent,"-1","-1",fulldataList,"",""),$scope.setView("orderDetails")},$rootScope.setcancelPgChatVariables(current.orderDetails.orders[0],current.orderDetails.orders[0].orderStatus,""),$rootScope.isItemLevelCancelEligibleCheck=function(){var isItemLevelCancelEligible=!1,totalQuantityEligibleForCancellation=0,quantitySelectedForCancellation=0,canceledQty=0;if(current.orderDetails.orders[0].wirelessLines.length>1){for(i=0;i<current.orderDetails.orders[0].wirelessLines.length;i++)if("PREPARINGTOSHIP"===current.orderDetails.orders[0].wirelessLines[i].statusKey||"PENDINGPORTAPPROVAL"===current.orderDetails.orders[0].wirelessLines[i].statusKey){isItemLevelCancelEligible=!0;break}if(!isItemLevelCancelEligible){for(i=0;i<current.orderDetails.orders[0].wirelessLines.length;i++)totalQuantityEligibleForCancellation+=parseInt(current.orderDetails.orders[0].wirelessLines[i].quantity),"CANCELED"===current.orderDetails.orders[0].wirelessLines[i].statusKey?quantitySelectedForCancellation+=parseInt(current.orderDetails.orders[0].wirelessLines[i].quantity):current.orderDetails.orders[0].wirelessLines[i].uniqueId==$rootScope.itemSelected&&(canceledQty="1"==current.orderDetails.orders[0].wirelessLines[i].quantity?current.orderDetails.orders[0].wirelessLines[i].quantity:angular.element("#q"+current.orderDetails.orders[0].wirelessLines[i].uniqueId).val(),quantitySelectedForCancellation+=parseInt(canceledQty));for(var i=0;i<$rootScope.additionalCancelItems.length;i++)canceledQty="1"==$rootScope.additionalCancelItems[i].quantity?$rootScope.additionalCancelItems[i].quantity:angular.element("#q"+$rootScope.additionalCancelItems[i].uniqueId).val(),quantitySelectedForCancellation+=parseInt(canceledQty);isItemLevelCancelEligible=totalQuantityEligibleForCancellation!==quantitySelectedForCancellation}}else"1"==current.orderDetails.orders[0].wirelessLines[0].quantity&&(canceledQty=current.orderDetails.orders[0].wirelessLines[0].quantity),isItemLevelCancelEligible=current.orderDetails.orders[0].wirelessLines[0].quantity!=canceledQty;return isItemLevelCancelEligible},$scope.filterCancelComment=function(cancelComment){angular.isDefined(this.cancelComment)?this.cancelComment=cancelComment.replace(/[^a-zA-Z0-9 ,.-]/gi,""):angular.isDefined(this.cancelItemComment)&&(this.cancelItemComment=cancelComment.replace(/[^a-zA-Z0-9 ,.-]/gi,""))},$scope.viewOrderCancelled=function(orders){$rootScope.avoidRefreshCancel="false",$("#cancelledOrder-modal").modal("hide");var cmnt="";0!=this.selReason&&(cmnt=this.selReason),void 0!==this.cancelComment&&""!==this.cancelComment&&(cmnt+=this.cancelComment),current.cmnt=cmnt,""===cmnt&&(cmnt=null);var optId="",emailMask="";if(void 0!==$scope.orderDetails.orders[0].slid&&null!=$scope.orderDetails.orders[0].slid&&""!==$scope.orderDetails.orders[0].slid?(optId=$scope.orderDetails.orders[0].slid,emailMask="false"):void 0!==$scope.orderDetails.orders[0].ctn&&null!=$scope.orderDetails.orders[0].ctn&&""!==$scope.orderDetails.orders[0].ctn?(optId=$scope.orderDetails.orders[0].ctn,emailMask="false"):void 0!==$scope.orderDetails.orders[0].email&&(optId=$scope.orderDetails.orders[0].orderNumber+$scope.orderDetails.orders[0].email,emailMask="true"),$scope.omniOrder=current.orderDetails.orders[0].orderSource,"COMS"!=$scope.omniOrder){var loc="",act="",ord="";void 0!==$scope.orderDetails.orders[0].updatePaymentONum&&(loc=$scope.orderDetails.orders[0].updatePaymentONum[0],act=$scope.orderDetails.orders[0].updatePaymentONum[1],ord=$scope.orderDetails.orders[0].updatePaymentONum[2]);var refOrdNumber={location:loc,activity:act,orderId:ord},refOrderNumber=[];refOrderNumber.push(refOrdNumber);var cancelDetails={CommonData:oshpData.defaults.CommonData,cancellationReason:oshpData.defReasonCode,comment:cmnt,externalOrderSource:oshpData.externalOrderSource,operatorId:optId,maskEmailKey:emailMask,ShippingZip:$scope.orderDetails.orders[0].ShippingZip,OrderStatus:$scope.orderDetails.orders[0].wirelessDetailsOrderStatus,cancelEncryptData:$scope.orderDetails.orders[0].refOrderNumData,refOrderNumber:refOrderNumber,OrderType:current.orderDetails.orders[0].orderType};current.cancelDetails=cancelDetails;var userComments=$rootScope.comments,fulldataList={userResp:$rootScope.userResp,userRespTxt:userComments,eosOrderDetails:"~"+current.orderDetails.orders[0].orderNumber+"~ ~"+current.oStatus+"~ ~ ~ ~ ~ ~ Wireless ~"+current.orderDetails.orders[0].orderDate,statusMessage:""};$scope.dtmCustomNotification("formSubmit","CMO_Cancel_Order_Submit","-2","-2",fulldataList,"","")}if(current.comsOn=$scope.omniOrder,"COMS"===$scope.omniOrder){var canceledDate="";canceledDate=new Date;var commonOrderId="";void 0!==$scope.orderDetails.orders[0].orderNumber&&null!=$scope.orderDetails.orders[0].orderNumber&&""!==$scope.orderDetails.orders[0].orderNumber&&(commonOrderId=$scope.orderDetails.orders[0].orderNumber);var yodaOrderId="";void 0!==$scope.orderDetails.orders[0].yodaOrderNumber&&null!=$scope.orderDetails.orders[0].yodaOrderNumber&&""!==$scope.orderDetails.orders[0].yodaOrderNumber&&(yodaOrderId=$scope.orderDetails.orders[0].yodaOrderNumber);var cancelDetailsOmni={CommonData:oshpData.defaults.CommonData,commonOrderId:commonOrderId,requestingSystemId:current.orderDetails.orders[0].originatingSystemId,comment:cmnt,cancelledDate:canceledDate,externalOrderSource:oshpData.externalOrderSource,operatorId:optId,cancellationReason:oshpData.defReasonCode,orderId:yodaOrderId,orderType:current.orderDetails.orders[0].orderType};current.cancelDetailsOmni=cancelDetailsOmni}$scope.setView("orderCancelled")},$scope.viewOrderItemsCancelled=function(orders){$rootScope.avoidRefreshCancel="false",$("#cancelledOrder-modal").modal("hide");var cmnt="";0!=this.selItemReason&&(cmnt=this.selItemReason+"  "),void 0!==this.cancelItemComment&&""!==this.cancelItemComment&&(cmnt+=this.cancelItemComment);var commonOrderId="";void 0!==$scope.orders.orderNumber&&null!=$scope.orders.orderNumber&&""!==$scope.orders.orderNumber&&(commonOrderId=$scope.orders.orderNumber);var yodaOrderId="";void 0!==$scope.orders.yodaOrderNumber&&null!=$scope.orders.yodaOrderNumber&&""!==$scope.orders.yodaOrderNumber&&(yodaOrderId=$scope.orders.yodaOrderNumber);var canceledDate="";canceledDate=new Date;var optId="";void 0!==$scope.orders.slid&&null!=$scope.orders.slid&&""!==$scope.orders.slid?optId=$scope.orders.slid:void 0!==$scope.orders.ctn&&null!=$scope.orders.ctn&&""!==$scope.orders.ctn?optId=$scope.orders.ctn:void 0!==$scope.orders.email&&(optId=$scope.orders.orderNumber+$scope.orders.email);var cancelItems=[],cancelOrderLineList=[],liabilityType=$scope.orders.account.accountType;null!=liabilityType&&"IRU"!==liabilityType&&"CRU"!==liabilityType&&(liabilityType=null);var cancelDetailsOmni={},isItemLevelCancelEligible=!1,totalQuantityEligibleForCancellation=0,quantitySelectedForCancellation=0,canceledQty=0;if($scope.orders.wirelessLines.length>1){for(i=0;i<$scope.orders.wirelessLines.length;i++)if("PREPARINGTOSHIP"===$scope.orders.wirelessLines[i].statusKey||"PENDINGPORTAPPROVAL"===$scope.orders.wirelessLines[i].statusKey){isItemLevelCancelEligible=!0;break}if(!isItemLevelCancelEligible){for(i=0;i<$scope.orders.wirelessLines.length;i++)totalQuantityEligibleForCancellation+=parseInt($scope.orders.wirelessLines[i].quantity),"CANCELED"===$scope.orders.wirelessLines[i].statusKey?quantitySelectedForCancellation+=parseInt($scope.orders.wirelessLines[i].quantity):$scope.orders.wirelessLines[i].uniqueId==$rootScope.itemSelected&&(canceledQty="1"==$scope.orders.wirelessLines[i].quantity?$scope.orders.wirelessLines[i].quantity:angular.element("#q"+$scope.orders.wirelessLines[i].uniqueId).val(),quantitySelectedForCancellation+=parseInt(canceledQty));for(i=0;i<$rootScope.additionalCancelItems.length;i++)canceledQty="1"==$rootScope.additionalCancelItems[i].quantity?$rootScope.additionalCancelItems[i].quantity:angular.element("#q"+$rootScope.additionalCancelItems[i].uniqueId).val(),quantitySelectedForCancellation+=parseInt(canceledQty);isItemLevelCancelEligible=totalQuantityEligibleForCancellation!==quantitySelectedForCancellation}}else canceledQty="1"==$scope.orders.wirelessLines[0].quantity?$scope.orders.wirelessLines[0].quantity:angular.element("#q"+$scope.orders.wirelessLines[0].uniqueId).val(),isItemLevelCancelEligible=$scope.orders.wirelessLines[0].quantity!==canceledQty;if($rootScope.isItemLevelCancelEligible=isItemLevelCancelEligible,isItemLevelCancelEligible){sessionStorage.setItem("cancelFlag","Item");var ItemDetailsArray=[];if($scope.orders.wirelessLines.length>1){for(var i=0;i<$scope.orders.wirelessLines.length;i++)if($scope.orders.wirelessLines[i].uniqueId==$rootScope.itemSelected){ItemDetailsArray.push($scope.orders.wirelessLines[i]);break}$scope.omniCancelRequest(ItemDetailsArray,liabilityType,cancelItems,cancelOrderLineList)}else{var ItemDetailsObj=$scope.orders.wirelessLines[0];ItemDetailsArray.push(ItemDetailsObj),$scope.omniCancelRequest(ItemDetailsArray,liabilityType,cancelItems,cancelOrderLineList)}$scope.omniCancelRequest($rootScope.additionalCancelItems,liabilityType,cancelItems,cancelOrderLineList),cancelDetailsOmni={CommonData:oshpData.defaults.CommonData,commonOrderId:commonOrderId,requestingSystemId:$scope.orders.OriginatingSystemId,cancelledDate:canceledDate,comment:cmnt,externalOrderSource:oshpData.externalOrderSource,operatorId:optId,cancellationReason:oshpData.defReasonCode,orderId:yodaOrderId,cancelItemList:cancelItems,orderType:$scope.orders.orderType,cancelOrderLineList:cancelOrderLineList}}else sessionStorage.setItem("cancelFlag","Order"),cancelDetailsOmni={CommonData:oshpData.defaults.CommonData,commonOrderId:commonOrderId,requestingSystemId:$scope.orders.originatingSystemId,cancelledDate:canceledDate,comment:cmnt,externalOrderSource:oshpData.externalOrderSource,operatorId:optId,cancellationReason:oshpData.defReasonCode,orderId:yodaOrderId,orderType:$scope.orders.orderType};current.comsOn=$scope.orders.orderSource,current.cancelDetailsOmni=cancelDetailsOmni,$scope.setView("orderCancelled")},$scope.omniCancelRequest=function(itemsForCancellation,liabilityType,cancelItems,cancelOrderLineList){for(var itemNumber,cancelledQuantity,newQuantity,lineNumber,lineType,subscriberNumber,i=0;i<itemsForCancellation.length;i++){itemNumber=itemsForCancellation[i].yodaLineId,cancelledQuantity="1"==itemsForCancellation[i].quantity?itemsForCancellation[i].quantity:angular.element("#q"+itemsForCancellation[i].uniqueId).val(),itemsForCancellation[i].canceledQuantity=cancelledQuantity;var cancelItem={itemNumber:itemNumber,cancelledQuantity:cancelledQuantity,newQuantity:newQuantity=itemsForCancellation[i].quantity-cancelledQuantity,lineNumber:lineNumber=itemsForCancellation[i].lineNumber},orderLine={lineNumber:lineNumber,lineType:lineType=itemsForCancellation[i].lineType,subscriberNumber:subscriberNumber=itemsForCancellation[i].subscriberNumber,liabilityType:liabilityType};if(cancelItems.push(cancelItem),null!=itemsForCancellation[i].associatedItems&&void 0!==itemsForCancellation[i].associatedItems)if(itemsForCancellation[i].associatedItems.length>1)for(var j=0;j<itemsForCancellation[i].associatedItems.length;j++)cancelItems.push(itemsForCancellation[i].associatedItems[j]);else cancelItems.push(itemsForCancellation[i].associatedItems[0]);null!=lineType&&void 0!==lineType&&cancelOrderLineList.push(orderLine)}},$scope.toggleSelection=function(checkFlag,uniqueId){for(var filteredItemDetails=$rootScope.tempItemDetails,idx=0,i=0;i<filteredItemDetails.length;i++)filteredItemDetails[i].uniqueId==uniqueId&&(idx=i);if(checkFlag)for(i=0;i<$rootScope.additionalCancelItems.length;i++)$rootScope.additionalCancelItems[i].uniqueId==uniqueId&&$rootScope.additionalCancelItems.splice(i,1);else $rootScope.additionalCancelItems.push(filteredItemDetails[idx])},$scope.selReason="0",$scope.selItemReason="0"}}];cancelOrderCtrl.resolve={reasonData:["$rootScope","SessionKeeper","$log","OSHPService",function($rootScope,SessionKeeper,$log,OSHPService){var current=$rootScope.current;return current||(current=$rootScope.current=SessionKeeper.read()),$log.log("entering orderCancel resolver"),$rootScope.showFooterDiv=!0,""}]};var orderCancelCtrl=["$scope","$rootScope","objectData","$log","OSHPService","$location","$window",function($scope,$rootScope,objectData,$log,OSHPService,$location,$window){$log.log("entering orderCancelCtrl");var current=$rootScope.current;if(current.appSource="Order Cancel Page Landing",void 0===current.orderDetails&&null==current.orderDetails)$scope.viewlandingPage();else{$scope.orders=current.orderDetails.orders[0],void 0!==sessionStorage.getItem("cancelFlag")&&null!=sessionStorage.getItem("cancelFlag")&&("Order"===sessionStorage.getItem("cancelFlag")?($scope.orders.isOrderCancel=!0,$scope.dtmCustomNotification("pageLoad","Page_Load","","","","CMO Order Management Cancel Order Pg",window.location.pathname)):"Item"===sessionStorage.getItem("cancelFlag")&&($scope.orders.isOrderCancel=!1,$scope.dtmCustomNotification("pageLoad","Page_Load","","","","CMO Order Management Cancel Item Pg",window.location.pathname))),$rootScope.setPageContent(),$scope.prepareCancelSuccessfailureList=function(orders,type){var orderNumObj;if(void 0===localStorage.getItem("successCnclOrderList")||null==localStorage.getItem("successCnclOrderList"))(orderNumObj=[]).push(orders.orderNumber+":"+type),localStorage.setItem("successCnclOrderList",orderNumObj);else{for(var newAddObj=!0,elgibleErrorList=[],orderListObj=(orderNumObj=localStorage.getItem("successCnclOrderList")).split(","),i=0;i<orderListObj.length;i++){var elgibleList=orderListObj[i].split(":");void 0!==elgibleList[0]&&(elgibleList[0]===orders.orderNumber?(newAddObj=!1,elgibleErrorList.push(orders.orderNumber+":"+type)):elgibleErrorList.push(elgibleList[0]+":"+elgibleList[1]))}newAddObj&&elgibleErrorList.push(orders.orderNumber+":"+type),localStorage.setItem("successCnclOrderList",elgibleErrorList)}};var itemSelected,eventAction,orderCancelFlag,userComments=$rootScope.comments,selReason=$rootScope.userResp,itemsSelectedForCancellation=[];if("Order"===sessionStorage.getItem("cancelFlag")){if(eventAction="CMO_Cancel_Order_Submit",current.orderDetails.orders[0].wirelessLines.length>1)for(i=0;i<current.orderDetails.orders[0].wirelessLines.length;i++)"PREPARINGTOSHIP"!==current.orderDetails.orders[0].wirelessLines[i].statusKey&&"PENDINGPORTAPPROVAL"!==current.orderDetails.orders[0].wirelessLines[i].statusKey&&"CANCELED"!==current.orderDetails.orders[0].wirelessLines[i].statusKey&&(itemSelected={itemSku:current.orderDetails.orders[0].wirelessLines[i].itemSKU,itemName:current.orderDetails.orders[0].wirelessLines[i].productName,itemQty:current.orderDetails.orders[0].wirelessLines[i].quantity},itemsSelectedForCancellation.push(itemSelected));else itemSelected={itemSku:current.orderDetails.orders[0].wirelessLines[0].itemSKU,itemName:current.orderDetails.orders[0].wirelessLines[0].productName,itemQty:current.orderDetails.orders[0].wirelessLines[0].quantity},itemsSelectedForCancellation.push(itemSelected);orderCancelFlag="Y"}else"Item"===sessionStorage.getItem("cancelFlag")&&(eventAction="CMO_Cancel_Item_Submit",orderCancelFlag=$rootScope.isItemLevelCancelEligible?"N":"Y",itemsSelectedForCancellation=current.itemsSelectedForCancellation);var fulldataList={userResp:selReason,userRespTxt:userComments,items:itemsSelectedForCancellation,orderId:current.orderDetails.orders[0].orderNumber,orderCancelFlag:orderCancelFlag};if(null!=objectData&&void 0!==objectData&&void 0!==objectData.Result&&void 0!==objectData.Result.Status&&"SUCCESS"===objectData.Result.Status)$scope.orderConfirm=!0,$scope.orderError=!1,$scope.prepareCancelSuccessfailureList($scope.orders,"CANCELSUCCESS"),$rootScope.setcancelPgChatVariables($scope.orders,current.orderDetails.orders[0].orderStatus,""),fulldataList.errorType="Success_Admit",$scope.dtmCustomNotification("formResponse",eventAction,"1","0",fulldataList,"","");else if(null!=objectData&&void 0!==objectData&&void 0!==objectData.Result&&void 0!==objectData.Result.Messages){$scope.orderConfirm=!1,$scope.orderError=!0;var msg="";if(void 0!==objectData.Result.Messages[0].DisplayCode&&(msg=objectData.Result.Messages[0].DisplayCode+" : "+$scope.getErrorMessage(objectData)),current.errmsg=msg,void 0!==objectData.Result.Messages[0].DisplayCode&&"OM112"===objectData.Result.Messages[0].DisplayCode||"OM128"==objectData.Result.Messages[0].DisplayCode||"OM228"==objectData.Result.Messages[0].DisplayCode?fulldataList.errorType="Planned_Downtime":void 0!==objectData.Result.Messages[0].DisplayCode&&"OM129"===objectData.Result.Messages[0].DisplayCode||"OM229"==objectData.Result.Messages[0].DisplayCode||"OM132"==objectData.Result.Messages[0].DisplayCode||"OM232"==objectData.Result.Messages[0].DisplayCode?fulldataList.errorType="Failure_BusinessRule":void 0!==objectData.Result.Messages[0].DisplayCode&&"OM130"===objectData.Result.Messages[0].DisplayCode||"OM230"==objectData.Result.Messages[0].DisplayCode?fulldataList.errorType="Failure_System":void 0!==objectData.Result.Messages[0].DisplayCode&&"OM131"===objectData.Result.Messages[0].DisplayCode||"OM132"==objectData.Result.Messages[0].DisplayCode?fulldataList.errorType="Failure_Data":fulldataList.statusMessage="We're sorry please try again at a later time.",$scope.dtmCustomNotification("formResponse",eventAction,"0",objectData.Result.Messages[0].DisplayCode,fulldataList,"",""),void 0!==objectData.Result&&void 0!==objectData.Result.Messages&&(void 0!==objectData.Result.Messages[0].DisplayCode&&"OM108"===objectData.Result.Messages[0].DisplayCode||"OM208"===objectData.Result.Messages[0].DisplayCode)){$scope.prepareCancelSuccessfailureList($scope.orders,"CANCELELGIBLE");statusError={code:objectData.Result.Messages[0].DisplayCode,type:"CNCLSLERROR",message:msg};$scope.setStatus(statusError)}if(void 0===objectData.Result||void 0===objectData.Result.Messages||null==objectData.Result.Messages[0].DisplayCode||"OM123"!==objectData.Result.Messages[0].DisplayCode&&"OM223"!==objectData.Result.Messages[0].DisplayCode){var statusError={code:objectData.Result.Messages[0].DisplayCode,type:"CNCLSLERROR",message:msg};$scope.setStatus(statusError)}else $scope.prepareCancelSuccessfailureList($scope.orders,"CANCELSUCCESS");$scope.setView("orderDetails")}if("COMS"==$scope.orders.orderSource&&void 0!==current.cancelDetailsOmni&&void 0!==current.cancelDetailsOmni.cancelItemList&&current.cancelDetailsOmni.cancelItemList.length>0){for(var temItemsToShow=[],totalCanceledQty=0,i=0;i<current.cancelDetailsOmni.cancelItemList.length;i++){var associatedItemFlag=!0,itemDetails=current.orderDetails.orders[0].wirelessLines;if(itemDetails.length>1){for(j=0;j<itemDetails.length;j++)if(current.cancelDetailsOmni.cancelItemList[i].itemNumber==current.orderDetails.orders[0].wirelessLines[j].yodaLineId&&"true"==current.orderDetails.orders[0].wirelessLines[j].cancellable){current.orderDetails.orders[0].wirelessLines[j].canceledQuantity=current.cancelDetailsOmni.cancelItemList[i].cancelledQuantity,totalCanceledQty+=parseInt(current.cancelDetailsOmni.cancelItemList[i].cancelledQuantity),temItemsToShow.push(current.orderDetails.orders[0].wirelessLines[j]),associatedItemFlag=!1;break}}else for(var itemDetailsObj=current.orderDetails.orders[0].wirelessLines,j=0;j<itemDetailsObj.length;j++)if(current.cancelDetailsOmni.cancelItemList[i].itemNumber===itemDetailsObj[j].yodaLineId&&"true"===itemDetailsObj[j].cancellable){itemDetailsObj[j].canceledQuantity=current.cancelDetailsOmni.cancelItemList[i].cancelledQuantity,totalCanceledQty+=parseInt(current.cancelDetailsOmni.cancelItemList[i].cancelledQuantity),temItemsToShow.push(itemDetailsObj[j]),associatedItemFlag=!1;break}associatedItemFlag&&0}$scope.itemDetails=temItemsToShow,$scope.itemCount=totalCanceledQty}else if($scope.itemCount=0,$scope.itemCount=current.orderDetails.orders[0].wirelessLines.length,1!==$scope.itemCount||Array.isArray(current.orderDetails.orders[0].wirelessLines))$scope.itemDetails=current.orderDetails.orders[0].wirelessLines;else{var shipddet=[current.orderDetails.orders[0].wirelessLines];$scope.itemDetails=shipddet}$scope.viewOrderDetail=function(orders){current.OrderDetails.ReturnURL&&void 0!==current.OrderDetails.ReturnURL?($rootScope.stop(),$window.location.href=current.OrderDetails.ReturnURL):($scope.setStatus({code:null,type:null,message:null}),$scope.setView("OrderDetails"))},$scope.cancelOrder=function(orders){$scope.setStatus({code:null,type:null,message:null}),$scope.setView("cancelOrder")},$scope.declineNCancel=function(){$scope.dtmCustomNotification("formResponse","CMO_Accept_Shipping_Date_Submit","-1","-1","","","")},$scope.viewHomePage=function(orders){$rootScope.stop(),void 0!==current.OrderDetails&&null!=current.OrderDetails&&(current.OrderDetails={}),$scope.setView("omhub")}}}];orderCancelCtrl.resolve={objectData:["$rootScope","SessionKeeper","$log","OSHPService",function($rootScope,SessionKeeper,$log,OSHPService){var current=$rootScope.current;return current||(current=$rootScope.current=SessionKeeper.read()),$log.log("entering orderCancel resolver"),"false"===$rootScope.avoidRefreshCancel?($rootScope.avoidRefreshCancel="true",OSHPService.oshpOrderCancelledAPIServices(current,oshpData.useStubs)):OSHPService.oshpOrderCancelledAPIServices(current,!0)}]};