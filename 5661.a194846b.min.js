(this["webpackChunkapplication"]=this["webpackChunkapplication"]||[]).push([[5661],{257519:(e,t,r)=>{"use strict";r.r(t);r.d(t,{SMSModule:()=>M});var n=r(667489);var o=r(587040);var gen=function(e,t,r){if(e===void 0){e="id"}if(t===void 0){t=[]}return{unique:e,indices:t,onUpgrade:r}};var i={name:"SMS",version:1,schema:{1:{sms:gen("id"),smsView:gen("id",["__timestamp","__groupId","__is_read"]),smsGroup:gen("id",["lastSMSTimestamp"]),userConfigs:gen("key")}}};var a=r(975027);var s=r(409787);var u=r(88195);var l=r(553362);var c=r(158820);var S=r(960172);var f=r(827027);var d=r(684997);var p=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var h=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var _=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var v=undefined&&undefined.__read||function(e,t){var r=typeof Symbol==="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,i=[],a;try{while((t===void 0||t-- >0)&&!(o=n.next()).done)i.push(o.value)}catch(e){a={error:e}}finally{try{if(o&&!o.done&&(r=n["return"]))r.call(n)}finally{if(a)throw a.error}}return i};var M=function(e){p(SMSModule,e);function SMSModule(t){var r=e.call(this,t)||this;r._getHealthyStatus=function(){return h(r,void 0,void 0,(function(){var e,t,r,n,o,i;return _(this,(function(a){switch(a.label){case 0:if(!this.isLoaded())return[3,3];return[4,Promise.all([this.smsService.userConfig.getLastSMSCallerId(),this.smsService.userConfig.getLastNotifiedSMSId(),this.smsService.getEntitySource().getTotalCount(),this.smsGroupService.getEntitySource().getTotalCount()])];case 1:e=v.apply(void 0,[a.sent(),4]),t=e[0],r=e[1],n=e[2],o=e[3];return[4,this.smsService.getEntitySource().getAll()];case 2:i=a.sent();return[2,{lastSMSCallerId:t,lastSMSNotifyId:r,allSMSCnt:n,allSMSGroupCnt:o,failedSMSData:c.RCItemUtils.collectFailedItemInfos(i),noContactSMS:i.filter((function(e){return!e.from||!e.to})),lastSyncTime:this.smsService.smsFetchController.getLastSyncTime(),UMI:this.smsService.smsBadgeController.getBadge()}];case 3:return[2,{}]}}))}))};r.hasUnSentFiles=function(){return r.smsService.smsDraftController.hasUnSentFiles()};r.hasSendingFiles=function(){return r.smsService.smsDraftController.hasSendingFiles()};return r}SMSModule.prototype.onLoad=function(){this._setupNetworkClient();this.smsGroupService.start();this.smsService.start();(0,n.getModule)(S.SEARCH_MODULE_NAME).registerSearchDataProvider(this.smsService.smsSearchController);this._initHealthyModule()};SMSModule.prototype.onUnload=function(){(0,n.getModule)(S.SEARCH_MODULE_NAME).unRegisterSearchDataProvider(this.smsService.smsSearchController);this._disposeHealthyModule();this.smsService.stop();this.smsGroupService.stop()};SMSModule.prototype._disposeHealthyModule=function(){this._healthModuleController&&this._healthModuleController.dispose()};SMSModule.prototype._initHealthyModule=function(){this._healthModuleController=new d.HealthModuleController(Symbol(a.ut),a.ut,{SMSDataInfo:this._getHealthyStatus});this._healthModuleController.init()};SMSModule.prototype.getSchema=function(){return i};SMSModule.prototype.getSMSGroupById=function(e){return this.smsGroupService.getById(e)};SMSModule.prototype.moduleName=function(){return a.ut};SMSModule.prototype.deleteConversations=function(e){return this.smsService.smsActionController.deleteConversations(e)};SMSModule.prototype.deleteSMSEntities=function(e){return this.smsService.smsActionController.deleteSMSEntities(e)};SMSModule.prototype.updateGroupReadStatus=function(e,t,r){return this.smsService.smsActionController.updateGroupReadStatus(e,t,r)};SMSModule.prototype.getIgnoreUMIGroupIds=function(){return this.smsService.smsBadgeController.getIgnoreGroups()};SMSModule.prototype.updateIgnoredStatus=function(e,t){return this.smsService.smsBadgeController.updateIgnoredStatus(e,t)};SMSModule.prototype.deleteAllSMS=function(){return this.smsService.smsFetchController.clearAll()};SMSModule.prototype.sendSMS=function(e){return this.smsService.smsActionController.sendSMS(e)};SMSModule.prototype.resendSMS=function(e,t){return this.smsService.smsActionController.resendSMS(e,t)};SMSModule.prototype.editFailedSMS=function(e,t){return this.smsService.smsActionController.editFailedSMS(e,t)};SMSModule.prototype.getSMSDraft=function(e){return this.smsService.smsDraftController.buildSMSDraft(e)};SMSModule.prototype.updateSMSDraft=function(e,t){return this.smsService.smsDraftController.updateSMSGroupDraft(e,t)};SMSModule.prototype.checkSMSAttachment=function(e,t){return this.smsService.smsActionController.checkSMSAttachment(e,t)};SMSModule.prototype.addFileAttachment=function(e,t){return this.smsService.smsDraftController.addFileAttachment(e,t)};SMSModule.prototype.removeDraftAttachment=function(e){return this.smsService.smsDraftController.removeFileAttachments(e)};SMSModule.prototype.getDraftAttachmentByIds=function(e){return this.smsService.smsDraftController.batchGet(e)};SMSModule.prototype.startPolling=function(){this.smsService.smsFetchController.startPolling()};SMSModule.prototype.stopPolling=function(){this.smsService.smsFetchController.stopPolling()};SMSModule.prototype.silentSyncNewerData=function(){return this.smsService.smsFetchController.doSilentSyncLatestData()};SMSModule.prototype.fetchEntities=function(e){return this.smsService.smsFetchController.fetchData(e)};SMSModule.prototype.buildFilterFunc=function(e){return this.smsService.smsFetchController.buildFilterFunc(e)};SMSModule.prototype.getById=function(e){return this.smsService.getById(e)};SMSModule.prototype.batchGetSMS=function(e){return this.smsService.batchGet(e)};SMSModule.prototype.addEntityNotificationObserver=function(e){this.smsService.addEntityNotificationObserver(e)};SMSModule.prototype.removeEntityNotificationObserver=function(e){this.smsService.removeEntityNotificationObserver(e)};SMSModule.prototype.updateSMSGroupPartially=function(e,t){return this.smsGroupService.smsGroupDataController.updateSMSGroup(e,t)};SMSModule.prototype.getOrCreateGroupByPhoneNumber=function(e,t){return this.smsGroupService.smsGroupDataController.getOrCreateGroupByPhoneNumber(e,t)};SMSModule.prototype.removeSendFailedSMSIds=function(e,t){return this.smsGroupService.smsGroupDataController.removeSendFailedSMSIds(e,t)};SMSModule.prototype.addSendFailedSMSIds=function(e,t){return this.smsGroupService.smsGroupDataController.addSendFailedSMSIds(e,t)};SMSModule.prototype.getSendFailedSMSIds=function(e){return this.smsGroupService.smsGroupDataController.getSendFailedSMSIds(e)};SMSModule.prototype.fetchSMSGroups=function(e){return this.smsService.fetchSMSGroups(e)};SMSModule.prototype.isValidSMSReceiverNumber=function(e){return c.RCItemUtils.isValidReceiverNumber(e,f.SPECIAL_NUMBER_USAGE_FEATURES.SMS)};SMSModule.prototype.searchSMS=function(e){return this.smsService.smsSearchController.searchSMS(e)};SMSModule.prototype.cleanSearchCache=function(){return this.smsService.smsSearchController.cleanSearchCache()};SMSModule.prototype.setCurrentSMSGroup=function(e){return this.smsService.smsPurgeController.setCurrentSMSConversation(e)};Object.defineProperty(SMSModule.prototype,"smsService",{get:function(){if(!this._smsService){this._smsService=new u.SMSService(this.daoManager,this.smsGroupService)}return this._smsService},enumerable:true,configurable:true});Object.defineProperty(SMSModule.prototype,"smsGroupService",{get:function(){if(!this._smsGroupService){this._smsGroupService=new l.SMSGroupService(this.daoManager)}return this._smsGroupService},enumerable:true,configurable:true});SMSModule.prototype._setupNetworkClient=function(){var e=(0,o.gT)();if(e){s.X.setNetworkClientProvider((function(){return e.buildNetworkClient()}))}};return SMSModule}(n.AbstractModule)},409787:(e,t,r)=>{"use strict";r.d(t,{X:()=>l});var n=r(862926);var o=r(667489);var i=r(158820);var a=r(827027);var s={CREATE_SMS:"/"+a.API_VERSION+"/account/~/extension/~/sms"};var u=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var l=function(e){u(SMSApi,e);function SMSApi(){return e!==null&&e.apply(this,arguments)||this}SMSApi.createSMS=function(e){var t={data:e,path:n.RequestPath.buildRequestPath(s.CREATE_SMS),method:n.NETWORK_METHOD.POST,via:n.NETWORK_VIA.HTTP,HAPriority:n.HA_PRIORITY.BASIC,retryCount:n.DEFAULT_RETRY_COUNT,ignoreNetwork:true,thresholdPriority:o.THRESHOLD_PRIORITY.HIGH};return this.networkClient.http(t)};SMSApi.createMMS=function(e,t,r,i){var a;var u=r?(a={},a[n.REQUEST_HEADER_KEYS.CONTENT_TYPE]=n.CONTENT_TYPES.MULTIPART+"; boundary="+r,a):undefined;var l={headers:u,path:n.RequestPath.buildRequestPath(s.CREATE_SMS),method:n.NETWORK_METHOD.POST,via:n.NETWORK_VIA.HTTP,HAPriority:n.HA_PRIORITY.BASIC,data:e,retryCount:n.DEFAULT_RETRY_COUNT,requestConfig:{onUploadProgress:function(e){t&&t(e)}},timeout:n.TEN_MINUTE_TIMEOUT,ignoreNetwork:true,thresholdPriority:o.THRESHOLD_PRIORITY.HIGH};return this.networkClient.http(l,i)};return SMSApi}(i.BaseRCItemApi)},975027:(e,t,r)=>{"use strict";r.d(t,{$q:()=>s,gC:()=>i,ut:()=>o,Lq:()=>u,no:()=>l,c9:()=>a});var n=r(295454);var o=n.Lb.SMS;var i=o+".SMS";var a="ENTITY.SMS";var s={ENTITY:{SMS:a+".*",SMS_GROUP:"ENTITY.SMSGROUP",SMS_DRAFT:"ENTITY.SMS_DRAFT"},SERVICE:{IGNORE_UMI_GROUPS:"SMS_SERVICE.IGNORE_UMI_GROUPS"}};var u={UNSPECIFIED_GROUP_ID:"UNSPECIFIED_GROUP_ID",SEARCH_DATA_PROVIDER_NAME:"SMS_SEARCH_DATA_PROVIDER"};var l={SMS:"sms"}},22146:(e,t,r)=>{"use strict";r.d(t,{k:()=>o});var n=r(158820);var o=n.logger.subModule("[SMS]")},912704:(e,t,r)=>{"use strict";r.d(t,{z:()=>u,A:()=>n.A});var n=r(396666);var o=r(158820);var i=r(960172);var a={ATTACHMENT_INFOS:"attachment_infos",LAST_SMS_CALLER_ID:"last_sms_caller_id",LAST_NOTIFIED_SMS_ID:"last_notified_sms_id",RECENT_SEARCH_RECORD:"recent_search_record",HAS_QUERY_ALL_SMS:"has_query_all_sms"};var s=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var u=function(e){s(SMSUserConfig,e);function SMSUserConfig(t,r){var n=e.call(this,t,r)||this;n._recentSearchUserConfig=new i.RecentSearchUserConfig(n);return n}SMSUserConfig.prototype.setLastSMSCallId=function(e){return this.put(a.LAST_SMS_CALLER_ID,e)};SMSUserConfig.prototype.getLastSMSCallerId=function(){return this.get(a.LAST_SMS_CALLER_ID)};SMSUserConfig.prototype.getLastNotifiedSMSId=function(){return this.get(a.LAST_NOTIFIED_SMS_ID)};SMSUserConfig.prototype.setLastNotifiedSMSId=function(e){return this.put(a.LAST_NOTIFIED_SMS_ID,e)};Object.defineProperty(SMSUserConfig.prototype,"recentSearchConfig",{get:function(){return this._recentSearchUserConfig},enumerable:true,configurable:true});SMSUserConfig.prototype.getHasQueryAll=function(){return this.get(a.HAS_QUERY_ALL_SMS)};SMSUserConfig.prototype.setHasQueryAll=function(e){return this.put(a.HAS_QUERY_ALL_SMS,e)};return SMSUserConfig}(o.RCItemUserConfig)},396666:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});var n;(function(e){e["CLEAR_ALL_SMS_IN_DB"]="clear_all_sms_in_db";e["FILTER_AND_SORT_SMS"]="filter_and_sort_sms";e["HANDLE_SMS_ENTITIES"]="handle_sms_entities";e["PARSE_SMS_ENTITIES"]="parse_sms_entities";e["SAVE_SMS_ENTITIES"]="save_sms_entities";e["INIT_SMS_VIEWS_CACHE"]="init_sms_views_cache";e["INIT_SMS_SEARCH_CACHE"]="init_sms_search_cache";e["SEARCH_SMS_TEXT"]="search_sms_text";e["SEARCH_SMS"]="search_sms";e["PURGE_OLD_SMS"]="purge_old_sms";e["INIT_SMS_BADGE"]="init_sms_badge"})(n||(n={}))},266816:(e,t,r)=>{"use strict";r.d(t,{nM:()=>n,zj:()=>o,A5:()=>a,KL:()=>s,v9:()=>i});var n="sms_group";var o={ATTACHMENT_COUNT_OVERSIZE:"ATTACHMENT_COUNT_OVERSIZE",ATTACHMENT_STORAGE_OVERSIZE:"ATTACHMENT_STORAGE_OVERSIZE",ATTACHMENT_TYPE_NOT_SUPPORT:"ATTACHMENT_TYPE_NOT_SUPPORT",SEND_SERVER_FAILED:"SEND_SERVER_FAILED",SMS_ATTACHMENT_NOT_EXISTED:"SMS_ATTACHMENT_NOT_EXISTED",SMS_PHONE_NUMBER_BLOCKED:"SMS_PHONE_NUMBER_BLOCKED",SMS_PHONE_NUMBER_NOT_FOUND:"SMS_PHONE_NUMBER_NOT_FOUND",SMS_EXT_NUMBER_INVALID:"SMS_EXT_NUMBER_INVALID",SMS_CAN_NOT_TO_SHORT_NUMBER:"SMS_CAN_NOT_TO_SHORT_NUMBER",SMS_EXCEED_MAX_RECIPIENT:"SMS_EXCEED_MAX_RECIPIENT",INTERNATIONAL_SMS_NOT_AVAILABLE:"INTERNATIONAL_SMS_NOT_AVAILABLE",INTERNATIONAL_MMS_NOT_AVAILABLE:"INTERNATIONAL_MMS_NOT_AVAILABLE",CAN_NOT_FROM_FAX_NUMBER:"CAN_NOT_FROM_FAX_NUMBER",FEATURE_NOT_AVAILABLE:"FEATURE_NOT_AVAILABLE",INAPPROPRIATE_EXT_TYPE:"INAPPROPRIATE_EXT_TYPE",FROM_NOT_SUPPORT_SMS:"FROM_NOT_SUPPORT_SMS",COUNTRY_ID_ISO_CODE_ERROR:"COUNTRY_ID_ISO_CODE_ERROR",ACCOUNT_LIMIT_EXCEEDED:"ACCOUNT_LIMIT_EXCEEDED",DESTINATION_IS_PROHIBITED:"DESTINATION_IS_PROHIBITED",UNSUPPORTED_ATTACHMENT_MEDIA_TYPE:"UNSUPPORTED_ATTACHMENT_MEDIA_TYPE",TEXT_TO_THE_SERVICE_NOT_AVAILABLE:"TEXT_TO_THE_SERVICE_NOT_AVAILABLE",INVALID_PARAMETER:"INVALID_PARAMETER"};var i={"MSG-243":o.SMS_PHONE_NUMBER_BLOCKED,"MSG-245":o.SMS_PHONE_NUMBER_NOT_FOUND,"MSG-246":o.SMS_EXT_NUMBER_INVALID,"MSG-247":o.SMS_CAN_NOT_TO_SHORT_NUMBER,"MSG-304":o.SMS_PHONE_NUMBER_NOT_FOUND,"MSG-365":o.COUNTRY_ID_ISO_CODE_ERROR,"MSG-376":o.ATTACHMENT_STORAGE_OVERSIZE,"MSG-379":o.ATTACHMENT_COUNT_OVERSIZE,"MSG-381":o.SMS_EXCEED_MAX_RECIPIENT,"MSG-240":o.INTERNATIONAL_SMS_NOT_AVAILABLE,"MSG-241":o.CAN_NOT_FROM_FAX_NUMBER,"MSG-242":o.FEATURE_NOT_AVAILABLE,"MSG-314":o.INAPPROPRIATE_EXT_TYPE,"MSG-367":o.FROM_NOT_SUPPORT_SMS,"MSG-380":o.FEATURE_NOT_AVAILABLE,"MSG-383":o.INTERNATIONAL_MMS_NOT_AVAILABLE,"MSG-384":o.ACCOUNT_LIMIT_EXCEEDED,"MSG-388":o.DESTINATION_IS_PROHIBITED,"MSG-348":o.UNSUPPORTED_ATTACHMENT_MEDIA_TYPE,"CMN-414":o.INVALID_PARAMETER};var a=["tiff","tif","gif","jpg","jpeg","bmp","png","svg","vcard","rtf","vcf","mpeg","mp3","mp4","zip"];var s=/^(130|388)3$/.test(r.j)?["image/tiff","image/gif","image/jpeg","image/bmp","image/png","image/svg+xml","text/vcard","application/rtf","video/mpeg","audio/mpeg","video/mp4","application/zip"]:null},543970:(e,t,r)=>{"use strict";r.d(t,{o:()=>nt});var n=r(667489);var o=r(316302);var i=r(587040);var a=r(158820);var s=r(228164);var u=r(95279);var l=r(298784);var c=r.n(l);var S=r(862926);var f=r(390582);var d=r(827027);var p=r(22146);var h=p.k.subModule("[SUB-SMS]");var _=r(912704);var v=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var M=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var y=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var m={GROUP_ID:"__groupId",IS_READ:"__is_read",TIMESTAMP:"__timestamp"};var g=function(e){v(SMSViewDao,e);function SMSViewDao(t){return e.call(this,SMSViewDao.COLLECTION_NAME,t,(function(e){return[e.__groupId]}))||this}SMSViewDao.prototype.getCollection=function(){return this.getDb().getCollection(SMSViewDao.COLLECTION_NAME)};SMSViewDao.prototype.toViewItem=function(e){return this.toPartialViewItem(e)};SMSViewDao.prototype._getCallersView=function(e){var t=e.direction?e.direction===d.CALL_DIRECTION.INBOUND?e.from&&[e.from]:e.to&&e.to.length&&e.to||[]:undefined;return t&&t.length&&t.map((function(e){return a.RCItemUtils.toCallerView(e)}))};SMSViewDao.prototype.toPartialViewItem=function(e){return c().pickBy({id:e.id,__groupId:e.__groupId,__timestamp:e.__timestamp,__is_read:e.readStatus===a.READ_STATUS.READ?1:0,subject:e.subject,callers:this._getCallersView(e)},(function(e){return e!==undefined&&e!==null}))};SMSViewDao.prototype.queryUnreadSMSIds=function(e){return M(this,void 0,void 0,(function(){var t,r,n;return y(this,(function(o){switch(o.label){case 0:if(!e)return[3,2];return[4,this.createQuery().equal(m.GROUP_ID,e).primaryKeys()];case 1:r=o.sent();return[3,3];case 2:r=undefined;o.label=3;case 3:t=r;return[4,this.createQuery().equal(m.IS_READ,0).primaryKeys()];case 4:n=o.sent();return[2,t?c().intersection(n,t):n]}}))}))};SMSViewDao.prototype.querySMSIdsOfGroups=function(e){var t=new Set(e);return this.createQuery().filter((function(e){return t.has(e.__groupId)})).primaryKeys()};SMSViewDao.prototype.queryOldestVisibleSMSId=function(e,t){return M(this,void 0,void 0,(function(){var r,n,o;return y(this,(function(i){switch(i.label){case 0:r=this.createQuery();if(!e)return[3,2];return[4,r.equal(m.GROUP_ID,e).orderBy(m.TIMESTAMP).primaryKeys()];case 1:n=i.sent();return[3,4];case 2:return[4,r.orderBy(m.TIMESTAMP).primaryKeys()];case 3:n=i.sent();i.label=4;case 4:o=t&&t.length?c().difference(n,t):n;return[2,o[0]]}}))}))};SMSViewDao.prototype.querySMS=function(e){return M(this,void 0,Promise,(function(){var t,r,n,o,i,s,u;var l=this;return y(this,(function(c){switch(c.label){case 0:t=e.anchorId,r=e.groupId;o=t;if(!o)return[3,2];return[4,this.get(t)];case 1:o=c.sent();c.label=2;case 2:n=o||undefined;i=h.performance();s=[];if(!(e.groupId&&!e.filterFunc))return[3,4];return[4,this.fetchItemsFromCache(e,e.groupId)];case 3:s=c.sent();return[3,6];case 4:return[4,f.KA.fetchItem({anchor:n,limit:e.limit,direction:e.direction,getEntitiesFunc:function(){return M(l,void 0,void 0,(function(){var e;return y(this,(function(t){switch(t.label){case 0:if(!r)return[3,2];return[4,this.createQuery().equal(m.GROUP_ID,r).toArray()];case 1:e=t.sent();return[3,4];case 2:return[4,this.getAll()];case 3:e=t.sent();t.label=4;case 4:return[2,e]}}))}))},sortFunc:a.RCItemUtils.sortRCItemsByTimestamp(),filterFunc:e.filterFunc?function(t){return e.filterFunc(l._translate2SMSForFilter(t))}:undefined})];case 5:u=c.sent();s=u.data.map((function(e){return e.id}));c.label=6;case 6:i.end({key:_.A.FILTER_AND_SORT_SMS,level:S.LOG_CONTROL_LEVEL.HIGH,count:s.length});return[2,s]}}))}))};SMSViewDao.prototype._translate2SMSForFilter=function(e){return{id:e.id,availability:a.MESSAGE_AVAILABILITY.ALIVE,direction:d.CALL_DIRECTION.OUTBOUND,to:e.callers,subject:e.subject}};SMSViewDao.prototype.queryAllUnreadSMSIds=function(){return this.createQuery().equal(m.IS_READ,0).primaryKeys()};SMSViewDao.prototype.queryNewestTimestamp=function(){return M(this,void 0,void 0,(function(){var e;return y(this,(function(t){switch(t.label){case 0:return[4,this.createQuery().orderBy(m.TIMESTAMP,true).first()];case 1:e=t.sent();return[2,e?e.__timestamp:undefined]}}))}))};SMSViewDao.COLLECTION_NAME="smsView";return SMSViewDao}(a.RCItemIdCacheDao);var C=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var E=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var b=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var I=function(e){C(SMSDao,e);function SMSDao(t,r){var n=e.call(this,SMSDao.COLLECTION_NAME,t)||this;n._smsView=r.getDao(g);n.addViewDaos([n._smsView]);return n}SMSDao.prototype.queryUnreadSMSIds=function(e){return this._smsView.queryUnreadSMSIds(e)};SMSDao.prototype.querySMSOfGroups=function(e){return E(this,void 0,void 0,(function(){var t;return b(this,(function(r){switch(r.label){case 0:return[4,this.querySMSIdsOfGroups(e)];case 1:t=r.sent();return[2,this.batchGet(t)]}}))}))};SMSDao.prototype.querySMSIdsOfGroups=function(e){return this._smsView.querySMSIdsOfGroups(e)};SMSDao.prototype.queryOldestVisibleSMS=function(e,t){return E(this,void 0,void 0,(function(){var r;return b(this,(function(n){switch(n.label){case 0:return[4,this._smsView.queryOldestVisibleSMSId(e,t)];case 1:r=n.sent();return[2,r!==undefined?this.get(r):null]}}))}))};SMSDao.prototype.queryItems=function(e){return E(this,void 0,Promise,(function(){var t,r;return b(this,(function(n){switch(n.label){case 0:return[4,this._smsView.querySMS(e)];case 1:t=n.sent();r=t.length;if(!r)return[3,3];return[4,this.batchGet(t,{order:true})];case 2:r=n.sent();n.label=3;case 3:return[2,r||[]]}}))}))};SMSDao.prototype.queryAllUnreadSMSIds=function(){return this._smsView.queryAllUnreadSMSIds()};SMSDao.prototype.queryNewestTimestamp=function(){return this._smsView.queryNewestTimestamp()};SMSDao.COLLECTION_NAME="sms";return SMSDao}(u.AbstractComposedDao);var T=r(975027);var A=r(886236);var O=r(642107);var N=r(17228);var D=r(74145);var R=r(266816);var w=undefined&&undefined.__assign||function(){w=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var o in t)if(Object.prototype.hasOwnProperty.call(t,o))e[o]=t[o]}return e};return w.apply(this,arguments)};var G=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var P=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var L=h.tags("SMSDraftController");var U;(function(e){e[e["INITIAL"]=0]="INITIAL";e[e["DRAFT"]=1]="DRAFT";e[e["SENT"]=2]="SENT"})(U||(U={}));var F=function(){function SMSDraftController(e){this._smsGroupService=e;this._attachmentCache=new Map;this._queue=new S.AsyncQueue}SMSDraftController.prototype.clearMemoryDraftByGroup=function(e){var t=[];this._attachmentCache.forEach((function(r){if(e.includes(r.groupId)){t.push(r.attachment.id)}}));this.removeFileAttachments(t);n.notificationCenter.emitEntityDelete(T.$q.ENTITY.SMS_DRAFT,e)};SMSDraftController.prototype.batchGet=function(e){var t=this;var r=[];e.forEach((function(e){if(t._attachmentCache.has(e)){r.push(t._attachmentCache.get(e).attachment)}}));return r};SMSDraftController.prototype.addFileAttachment=function(e,t){var r=D.F.buildAttachment([t])[0];this._attachmentCache.set(r.id,{file:t,attachment:r,groupId:e,status:U.INITIAL});return r};SMSDraftController.prototype.splitAndAssignDraftAttachment=function(e,t){var r=this;var n=new Map;t.forEach((function(t){var o=r._attachmentCache.get(t);if(o){e.forEach((function(e){var t=w(w({},o),{attachment:w(w({},o.attachment),{id:-(0,S.randomInt)()})});var i=t.attachment;r._attachmentCache.set(i.id,t);if(n.get(e)){n.get(e).push(i)}else{n.set(e,[i])}}))}}));this.removeFileAttachments(t);return n};SMSDraftController.prototype.removeFileAttachments=function(e){var t=this;e.forEach((function(e){t._attachmentCache.delete(e)}))};SMSDraftController.prototype.updateAttachmentStatus=function(e,t){var r=this;e.forEach((function(e){var n=r._attachmentCache.get(e);if(n){n.status=t}else{L.warn("updateAttachmentStatus failed, can not find attachment for id: ",e)}}))};SMSDraftController.prototype.getDraftAttachmentsByGroup=function(e){var t=[];this._attachmentCache.forEach((function(r){if(r.groupId===e&&r.status===U.DRAFT){t.push(r.attachment)}}));return t};SMSDraftController.prototype.getDraftFilesByGroup=function(e){var t=this.getDraftAttachmentsByGroup(e);return this.getFiles(t.map((function(e){return e.id})))};SMSDraftController.prototype.hasUnSentFiles=function(){return Array.from(this._attachmentCache.values()).some((function(e){return e.status!==U.INITIAL}))};SMSDraftController.prototype.hasSendingFiles=function(){return Array.from(this._attachmentCache.values()).some((function(e){return e.status===U.SENT}))};SMSDraftController.prototype.getFiles=function(e){var t=this;var r=[];e.forEach((function(e){var n=t._attachmentCache.get(e);if(n&&n.file){r.push(n.file)}else{L.error("!!! pay attention, can not find id for file which should not happen !!!",e)}}));return r};SMSDraftController.prototype.buildSMSDraft=function(e){return G(this,void 0,Promise,(function(){var t,r,n;return P(this,(function(o){switch(o.label){case 0:t={id:e};return[4,this._smsGroupService.getById(e)];case 1:r=o.sent();if(r){n=this.getDraftAttachmentsByGroup(e);t.attachmentIds=n.map((function(e){return e.id}));t.text=r.draft}return[2,t]}}))}))};SMSDraftController.prototype.updateSMSGroupDraft=function(e,t){var r=this;var o=w(w({},t),{id:e});L.log("updateSMSGroupDraft, new data is: ",o);return this._doInQueue((function(){return G(r,void 0,void 0,(function(){return P(this,(function(r){switch(r.label){case 0:if(!(t.text!==undefined))return[3,2];return[4,this._smsGroupService.smsGroupDataController.updateSMSGroup(e,{draft:t.text})];case 1:r.sent();r.label=2;case 2:if(t.attachmentIds){this.updateAttachmentStatus(t.attachmentIds,U.DRAFT)}n.notificationCenter.emitEntityUpdate(T.$q.ENTITY.SMS_DRAFT,[o]);return[2]}}))}))}))};SMSDraftController.prototype._doInQueue=function(e){var t=this;return this._queue.execute((function(){return G(t,void 0,void 0,(function(){return P(this,(function(t){switch(t.label){case 0:return[4,e()];case 1:t.sent();return[2]}}))}))}))};return SMSDraftController}();var H=r(409787);var B=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var k=undefined&&undefined.__assign||function(){k=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var o in t)if(Object.prototype.hasOwnProperty.call(t,o))e[o]=t[o]}return e};return k.apply(this,arguments)};var V=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var j=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var x=undefined&&undefined.__read||function(e,t){var r=typeof Symbol==="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,i=[],a;try{while((t===void 0||t-- >0)&&!(o=n.next()).done)i.push(o.value)}catch(e){a={error:e}}finally{try{if(o&&!o.done&&(r=n["return"]))r.call(n)}finally{if(a)throw a.error}}return i};var Y=undefined&&undefined.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(x(arguments[t]));return e};var q="SDK";var X=2*1e3;var K=30;var Q="SMSActionController";var z={FILE:"file",JSON_TYPE:"application/json",JSON_DATA:"jsonData"};var J={MAX_ATTACHMENT_COUNT:10,MAX_ATTACHMENT_STORAGE_SIZE:c().toInteger(15e8/1024)};var Z=function(e){B(SMSActionController,e);function SMSActionController(t,r,n,o,i,a,s){var u=e.call(this,Q,H.X.rcItemCommonApi,t,r)||this;u._smsDraftController=o;u._preInsertController=i;u._smsDao=a;u._smsGroupService=s;u._smsDataController=n;return u}SMSActionController.prototype.updateGroupReadStatus=function(e,t,r){return V(this,void 0,void 0,(function(){var n,o,i;return j(this,(function(s){switch(s.label){case 0:return[4,this._smsGroupService.getById(e)];case 1:n=s.sent();if(!n){return[2]}s.label=2;case 2:s.trys.push([2,4,,5]);o=t===a.READ_STATUS.READ?this._markGroupAsRead(n):this._markGroupAsUnread(n);return[4,o];case 3:s.sent();return[3,5];case 4:i=s.sent();if(!r){throw i}return[3,5];case 5:return[2]}}))}))};SMSActionController.prototype.deleteConversations=function(e){return V(this,void 0,void 0,(function(){var t,r,n,o,i;return j(this,(function(s){switch(s.label){case 0:return[4,this._smsGroupService.batchGetLocally(e,false)];case 1:t=s.sent();r=[];t.forEach((function(e){e&&e.conversationId&&r.push(e.conversationId)}));h.tags(Q).log("deleteConversations, to delete data",{localConversationIds:e,conversionIds:r});n=r.length;if(!n)return[3,3];return[4,H.X.deleteConversations(r)];case 2:n=s.sent();s.label=3;case 3:n;return[4,this._smsDao.querySMSIdsOfGroups(e)];case 4:o=s.sent();return[4,this.entitySourceController.getEntitiesLocally(o,false)];case 5:i=s.sent();return[4,this._smsDataController.saveInTransaction({deletedMessages:i,deletedSMSGroupIds:e})];case 6:s.sent();this._smsDataController.notifySMSUpdate(i.map((function(e){return k(k({},e),{availability:a.MESSAGE_AVAILABILITY.DELETED})})),true);this._smsDataController.notifySMSGroupUpdates([],t.map((function(e){return k(k({},e),{deactivated:true})})));return[2]}}))}))};SMSActionController.prototype.deleteSMSEntities=function(e){return V(this,void 0,void 0,(function(){var t;return j(this,(function(r){switch(r.label){case 0:return[4,this.deleteRcMessages(e,false)];case 1:t=r.sent();return[2,this._smsDataController.handleSMSEntities(t,N.k.SEND_RESPONSE)]}}))}))};SMSActionController.prototype.checkSMSAttachment=function(e,t){var r=this._smsDraftController.getDraftFilesByGroup(e)||[];var n=Y(t,r);if(n.length){if(this._isAttachmentOverLimit(n)){this._reportError(R.zj.ATTACHMENT_COUNT_OVERSIZE)}if((0,f.CH)(n,J.MAX_ATTACHMENT_STORAGE_SIZE)){this._reportError(R.zj.ATTACHMENT_STORAGE_OVERSIZE)}var o=this._filterUnSupportedMMSFiles(n);if(o.length){this._reportError(R.zj.ATTACHMENT_TYPE_NOT_SUPPORT,R.zj.ATTACHMENT_TYPE_NOT_SUPPORT,{unSupportedFiles:o})}}};SMSActionController.prototype._markGroupAsRead=function(e){if(this._getGroupUnreadCnt(e)===0){return}return this._updateSMSReadInternal(e.unreadSMSIds,a.READ_STATUS.READ)};SMSActionController.prototype._markGroupAsUnread=function(e){return V(this,void 0,void 0,(function(){var t;return j(this,(function(r){switch(r.label){case 0:if(this._getGroupUnreadCnt(e)>0){h.tags(Q).log("the sms group has unread already",(0,S.sensitive)(e,["myNumber","phoneNumber","extensionNumber","name"]));return[2]}return[4,this._smsDao.queryOldestVisibleSMS(e.id)];case 1:t=r.sent();if(t){return[2,this._updateSMSReadInternal([t.id],a.READ_STATUS.UNREAD)]}return[2]}}))}))};SMSActionController.prototype._updateSMSReadInternal=function(e,t){return V(this,void 0,void 0,(function(){var r;return j(this,(function(n){switch(n.label){case 0:return[4,this._updateReadStatusLocally(t,e)];case 1:n.sent();return[4,this.batchRequestUpdateReadStatus(e,t)];case 2:r=n.sent();if(!r.succeedRes.length)return[3,4];return[4,this._smsDataController.handleSMSEntities(r.succeedRes,N.k.SEND_RESPONSE)];case 3:n.sent();n.label=4;case 4:if(!r.error)return[3,6];return[4,this._updateReadStatusLocally(this._reverseReadStatus(t),r.failedIds)];case 5:n.sent();throw r.error;case 6:return[2]}}))}))};SMSActionController.prototype._reverseReadStatus=function(e){return e===a.READ_STATUS.READ?a.READ_STATUS.UNREAD:a.READ_STATUS.READ};SMSActionController.prototype._updateReadStatusLocally=function(e,t){return V(this,void 0,void 0,(function(){var r;return j(this,(function(n){switch(n.label){case 0:return[4,this.entitySourceController.batchGet(t)];case 1:r=n.sent();r.forEach((function(t){t.readStatus=e}));return[4,this._smsDataController.handleSMSEntities(r,N.k.LOCAL_MODIFICATION)];case 2:n.sent();this._smsDataController.notifySMSUpdate(r);return[2]}}))}))};SMSActionController.prototype.resendSMS=function(e,t){return V(this,void 0,void 0,(function(){var r,n;return j(this,(function(i){switch(i.label){case 0:return[4,this.entitySourceController.get(e)];case 1:r=i.sent();if(!r){h.warn("can not find the preinsert sms",e);return[2]}this._preInsertController.updateStatus(e,o.oi.INPROGRESS);return[4,this._smsGroupService.smsGroupDataController.removeSendFailedSMSIds(t,e)];case 2:i.sent();n={subject:r.subject,attachmentIds:r.attachments?r.attachments.map((function(e){return e.id})):[],fromNumber:r.from.phoneNumber,toNumbers:r.to.map((function(e){return e.phoneNumber})).filter((function(e){return e}))};return[4,this._innerSendSMS([r],n)];case 3:i.sent();return[2]}}))}))};SMSActionController.prototype.editFailedSMS=function(e,t){return V(this,void 0,void 0,(function(){return j(this,(function(r){switch(r.label){case 0:if(e>0){h.warn("can not edit success sms",e);return[2]}return[4,this.updateEntityPartially(e,{subject:t})];case 1:r.sent();return[2]}}))}))};SMSActionController.prototype.sendSMS=function(e){return V(this,void 0,void 0,(function(){var t;return j(this,(function(r){switch(r.label){case 0:return[4,this._buildPseudoSMS(e)];case 1:t=r.sent();return[4,this._preInsertController.bulkInsert(t)];case 2:r.sent();return[4,this._innerSendSMS(t,e)];case 3:r.sent();return[2]}}))}))};SMSActionController.prototype._innerSendSMS=function(e,t){return V(this,void 0,void 0,(function(){var r,n;var o=this;return j(this,(function(i){switch(i.label){case 0:h.tags(Q).log("_innerSendSMS",{preInsertSMSIdArr:e.map((function(e){return e.id})),options:this._sensitiveSendSMSOptions(t)});e.forEach((function(e){e.attachments&&o._smsDraftController.updateAttachmentStatus(e.attachments.map((function(e){return e.id})),U.SENT)}));return[4,this._smsDataController.handleSMSEntities(e,N.k.LOCAL_PREINSERT)];case 1:i.sent();if(t.preInsertReadyCallback){t.preInsertReadyCallback(e)}return[4,this._batchSendSMS(e,t)];case 2:r=i.sent();n=r.filter((function(e){return e&&Object.prototype.hasOwnProperty.call(e,"error")}));if(n.length){h.tags(Q).log("failed to send sms",{failedResults:n});throw this._reportError(R.zj.SEND_SERVER_FAILED,"",{failedResults:n})}return[2]}}))}))};SMSActionController.prototype._batchSendSMS=function(e,t){var r=this;return Promise.all(e.map((function(e){return r._sendSingleSMS(t,e)})))};SMSActionController.prototype._checkIsSMSReceiverValid=function(e){return V(this,void 0,void 0,(function(){var t,r;return j(this,(function(n){switch(n.label){case 0:return[4,Promise.all(e.map((function(e){return a.RCItemUtils.isValidReceiverNumber(e,d.SPECIAL_NUMBER_USAGE_FEATURES.SMS)})))];case 1:t=n.sent();r=t.some((function(e){return e===false}));if(r){this._reportError(R.zj.TEXT_TO_THE_SERVICE_NOT_AVAILABLE,R.zj.TEXT_TO_THE_SERVICE_NOT_AVAILABLE)}return[2]}}))}))};SMSActionController.prototype._sendSingleSMS=function(e,t){return V(this,void 0,void 0,(function(){var r,n,i,s,u,l;return j(this,(function(c){switch(c.label){case 0:r=t.to.map((function(e){return e.phoneNumber}));n=t.from.phoneNumber;c.label=1;case 1:c.trys.push([1,6,,9]);return[4,this._checkIsSMSReceiverValid(r)];case 2:c.sent();return[4,this._postSMSInQueue(k(k({},e),{toNumbers:r,fromNumber:n}),t)];case 3:i=c.sent();s=k(k({},i),{__preInsertId:t.id,__groupId:t.__groupId,__timestamp:Date.parse(i.creationTime)});return[4,this._preInsertController.delete(s)];case 4:c.sent();return[4,this._smsDataController.handleSMSEntities([k(k({},t),{availability:a.MESSAGE_AVAILABILITY.DELETED}),i],N.k.SEND_RESPONSE)];case 5:c.sent();e.attachmentIds&&this._smsDraftController.removeFileAttachments(e.attachmentIds);return[2,i];case 6:u=c.sent();h.tags(Q).log("_sendSingleSMS -> error",u);this._preInsertController.updateStatus(t.id,o.oi.FAIL);l=t.attachments&&t.attachments.map((function(e){return e.id}));l&&this._smsDraftController.updateAttachmentStatus(l,U.INITIAL);return[4,this._smsDataController.handleSMSEntities([k(k({},t),{__error:JSON.stringify({type:u.type||"",code:u.code||"",message:u.message||""})})],N.k.LOCAL_PREINSERT)];case 7:c.sent();return[4,this._smsGroupService.smsGroupDataController.addSendFailedSMSIds(t.__groupId,t.id)];case 8:c.sent();D.F.reportFailedSMSInfo(t,JSON.stringify(u));return[2,{error:u,data:{toNumbers:r,fromNumber:n}}];case 9:return[2]}}))}))};SMSActionController.prototype._getPendingTime=function(){if(this.sendSMSRequestQueue.getProcessors().length>K){return X}return undefined};SMSActionController.prototype._postSMSInQueue=function(e,t){var r=this;return new Promise((function(n,o){var sendFunc=function(){return V(r,void 0,void 0,(function(){var r,n,o;return j(this,(function(i){switch(i.label){case 0:i.trys.push([0,4,,8]);r=this._getPendingTime();n=r;if(!n)return[3,2];return[4,(0,S.sleep)(r)];case 1:n=i.sent();i.label=2;case 2:n;return[4,this._sendSMSToServer(e,t)];case 3:return[2,i.sent()];case 4:o=i.sent();if(!a.RCItemUtils.isOverAPILimitError(o))return[3,7];h.info("send sms over limit, sleep 1s and retry again",{id:t.id,subject:t.subject});return[4,(0,S.sleep)(X)];case 5:i.sent();return[4,this._sendSMSToServer(e,t)];case 6:return[2,i.sent()];case 7:throw o;case 8:return[2]}}))}))};var i=new(function(){function class_1(){}class_1.prototype.process=function(){return V(this,void 0,void 0,(function(){var e,t;return j(this,(function(r){switch(r.label){case 0:r.trys.push([0,2,,3]);return[4,sendFunc()];case 1:e=r.sent();n(e);return[2,true];case 2:t=r.sent();o(t);return[2,false];case 3:return[2]}}))}))};class_1.prototype.name=function(){return(0,f.Iy)()+"_"+Q+"_"+JSON.stringify(e)};return class_1}());r.sendSMSRequestQueue.addProcessor(i)}))};SMSActionController.prototype._sendSMSToServer=function(e,t){if(e.attachmentIds&&e.attachmentIds.length||e.toNumbers.length>1&&!e.sendSeparately){return this._requestSendMMS(e,t)}return this._requestSendSMS(e)};SMSActionController.prototype._requestSendMMS=function(e,t){return V(this,void 0,void 0,(function(){var r,n,o,i,s;var u=this;return j(this,(function(l){switch(l.label){case 0:h.tags(Q).log("_requestSendSMS with options: ",{id:t.id,options:this._sensitiveSendSMSOptions(e)});r=[];n=JSON.stringify(this._buildSMSRequestInfo(e));r.push({keyName:z.JSON_DATA,data:n,dataName:"",dataType:z.JSON_TYPE});if(t.attachments&&t.attachments.length){o=t.attachments.map((function(e){return e.id}));i=this._smsDraftController.getFiles(o);if(this._hasInvalidFile(i,o)){this._reportError(R.zj.SMS_ATTACHMENT_NOT_EXISTED);return[2]}i.forEach((function(e,t){var n=a.RCItemUtils.getRCMIMEByFileExtension((0,f.mD)(e.name))||e.type;r.push({keyName:z.FILE+"_"+t,data:e,dataName:e.name,dataType:n})}))}return[4,new a.RCMultiPartDataBuilder(r).buildMultiPartData()];case 1:s=l.sent();return[2,H.X.createMMS(s.data,(function(e){u._updateProgress(e,t.id)}),s.boundary)]}}))}))};SMSActionController.prototype._requestSendSMS=function(e){h.tags(Q).log("_requestSendSMS with options: ",this._sensitiveSendSMSOptions(e));return H.X.createSMS(this._buildSMSRequestInfo(e))};SMSActionController.prototype._buildSMSRequestInfo=function(e){return{from:{phoneNumber:e.fromNumber},to:e.toNumbers.map((function(e){return{phoneNumber:e}})),text:e.subject}};SMSActionController.prototype._getE164Numbers=function(e){return V(this,void 0,Promise,(function(){var t;var r=this;return j(this,(function(o){switch(o.label){case 0:return[4,Promise.all(e.map((function(e){return V(r,void 0,void 0,(function(){var t;return j(this,(function(r){switch(r.label){case 0:return[4,(0,n.getModule)(O.PHONE_PARSER_MODULE).getPhoneParser(e)];case 1:t=r.sent();return[2,t&&t.getE164()]}}))}))})))];case 1:t=o.sent();return[2,t.filter((function(e){return e}))]}}))}))};SMSActionController.prototype._buildPseudoSMS=function(e){return V(this,void 0,void 0,(function(){var t,r,n,o,i,a;var s=this;return j(this,(function(u){switch(u.label){case 0:return[4,this._getE164Numbers([e.fromNumber])];case 1:t=u.sent()[0];return[4,this._getE164Numbers(e.toNumbers)];case 2:r=u.sent();r=r.length===1||e.sendSeparately?r:r.filter((function(e){return e!==t}));o=e.attachmentIds?this._smsDraftController.batchGet(e.attachmentIds):[];if(e.sendSeparately){n=r.map((function(r){return s._infoToPseudoSMS(t,[r],o,e.subject)}));if(n.length&&e.attachmentIds){i=n.map((function(e){return e.__groupId}));a=this._smsDraftController.splitAndAssignDraftAttachment(i,e.attachmentIds);n.forEach((function(e){e.attachments=a.get(e.__groupId)}))}}else{n=[this._infoToPseudoSMS(t,r,o,e.subject)]}return[2,n]}}))}))};SMSActionController.prototype._infoToPseudoSMS=function(e,t,r,n){var o=D.F.buildSMSGroupId(t,e);var i=Date.now();var s=f.IM.nowInISO8601();var u=this._preInsertController.createPreInsertId((function(){return-(0,f.Iy)()}));return{id:u,uri:"",attachments:r,availability:a.MESSAGE_AVAILABILITY.ALIVE,direction:d.CALL_DIRECTION.OUTBOUND,readStatus:a.READ_STATUS.READ,type:d.RC_MESSAGE_TYPE.SMS,messageStatus:a.MESSAGE_STATUS.SENT,subject:n,from:{phoneNumber:e},to:t.map((function(e){return{phoneNumber:e}})),__timestamp:i,creationTime:s,lastModifiedTime:s,priority:a.MESSAGE_PRIORITY.NORMAL,conversation:{uri:"",id:o},__groupId:o}};SMSActionController.prototype._isAttachmentOverLimit=function(e){return e.length>J.MAX_ATTACHMENT_COUNT};SMSActionController.prototype._filterUnSupportedMMSFiles=function(e){var t=[];e.forEach((function(e){var r=(0,f.mD)(e.name);if(!r||!R.A5.includes(r.toLowerCase())){t.push(e)}}));return t};Object.defineProperty(SMSActionController.prototype,"progressService",{get:function(){return o.Nz.getInstance()},enumerable:true,configurable:true});SMSActionController.prototype._updateProgress=function(e,t){var r=e.loaded,n=e.total;if(r!==undefined&&n!==undefined){this.progressService.updateProgress(t,{id:t,rate:{loaded:r,total:n}})}};Object.defineProperty(SMSActionController.prototype,"sendSMSRequestQueue",{get:function(){if(!this._sendSMSQueueHandler){this._sendSMSQueueHandler=new A.vm({name:Q})}return this._sendSMSQueueHandler},enumerable:true,configurable:true});SMSActionController.prototype._reportError=function(e,t,r){throw new S.JError(q,e,t||e,r)};SMSActionController.prototype._getGroupUnreadCnt=function(e){return e.unreadSMSIds&&e.unreadSMSIds.length||0};SMSActionController.prototype._hasInvalidFile=function(e,t){return!!(!e.length||e.length!==t.length||e.some((function(e){return e.size<=0})))};SMSActionController.prototype._sensitiveSendSMSOptions=function(e){return(0,S.sensitive)(e,["fromNumber","toNumbers","subject"])};return SMSActionController}(a.RcMessageActionController);var $=r(814678);var W=r(396666);var ee=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var te=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var re=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var ne=h.tags("[SMSBadgeController]");var oe=function(e){ee(SMSBadgeController,e);function SMSBadgeController(t,r,n){var o=e.call(this,{badgeId:T.gC,badgeConfigName:T.$q.ENTITY.SMS,entityKey:T.$q.ENTITY.SMS,lazyInitialization:true,traceLoadPerformance:{key:W.A.INIT_SMS_BADGE,level:S.LOG_CONTROL_LEVEL.HIGH}})||this;o._smsDao=n;o._ignoreReadGroupIdSet=new Set;o._smsActionController=r;return o}SMSBadgeController.prototype.getIgnoreGroups=function(){return this._ignoreReadGroupIdSet};SMSBadgeController.prototype.updateIgnoredStatus=function(e,t){var r=this;if(t){e.forEach((function(e){if(!r._ignoreReadGroupIdSet.has(e)){r._ignoreReadGroupIdSet.add(e);r._smsActionController.updateGroupReadStatus(e,a.READ_STATUS.READ,true)}}))}else{e.forEach((function(e){return r._ignoreReadGroupIdSet.delete(e)}))}$.rF.emitKVChange(T.$q.SERVICE.IGNORE_UMI_GROUPS,this._ignoreReadGroupIdSet)};SMSBadgeController.prototype.getAllEntities=function(){return te(this,void 0,Promise,(function(){return re(this,(function(e){return[2,[]]}))}))};SMSBadgeController.prototype.calculateTotalUnreadMap=function(e){return te(this,void 0,void 0,(function(){var e,t;return re(this,(function(r){switch(r.label){case 0:return[4,this._smsDao.queryAllUnreadSMSIds()];case 1:e=r.sent();t=new Map;e.forEach((function(e){t.set(e,1)}));return[2,t]}}))}))};SMSBadgeController.prototype.getEntityBadge=function(e){var t=e;return t.availability===a.MESSAGE_AVAILABILITY.ALIVE&&t.readStatus===a.READ_STATUS.UNREAD&&!this._ignoreReadGroupIdSet.has(t.__groupId)?1:0};Object.defineProperty(SMSBadgeController.prototype,"logger",{get:function(){return ne},enumerable:true,configurable:true});return SMSBadgeController}(d.AbstractEntityBadgeController);var ie=r(379269);var ae=undefined&&undefined.__assign||function(){ae=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var o in t)if(Object.prototype.hasOwnProperty.call(t,o))e[o]=t[o]}return e};return ae.apply(this,arguments)};var se=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var ue=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var le=undefined&&undefined.__read||function(e,t){var r=typeof Symbol==="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,i=[],a;try{while((t===void 0||t-- >0)&&!(o=n.next()).done)i.push(o.value)}catch(e){a={error:e}}finally{try{if(o&&!o.done&&(r=n["return"]))r.call(n)}finally{if(a)throw a.error}}return i};var ce=undefined&&undefined.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(le(arguments[t]));return e};var Se="SMSDataController";var fe=function(){function SMSDataController(e,t,r,n,o,i){this._entitySourceController=e;this._userConfig=t;this._preInsertController=r;this._smsDraftController=n;this._smsDao=o;this._smsGroupService=i;this._dataChangeListeners=[]}SMSDataController.prototype.handleSMSEntities=function(e,t,r){if(r===void 0){r=false}return se(this,void 0,void 0,(function(){var n,o,i,s,u,l,c,f,d,p,v,M,y,m;var g=this;return ue(this,(function(C){switch(C.label){case 0:if(!(t===N.k.SYNC))return[3,2];return[4,this._preHandleIncomingSMS(e)];case 1:o=C.sent();return[3,3];case 2:o=e;C.label=3;case 3:n=o;if(!n.length){e.length&&h.tags(Se).log("handleSMSEntities, no valid sms",{incomingSMS:e.length});return[2]}i=h.performance();s=[];u=[];l=new Map;n.forEach((function(e){if(e){e.__timestamp=e.__timestamp||Date.parse(e.creationTime);if(a.RCItemUtils.isMessageAlive(e)){u.push(e)}else{s.push(e)}var t=g._getSMSGroupId(e);if(t){e.__groupId=t;if(!l.has(t)){l.set(t,[])}l.get(t).push(e)}}}));if(!l.size)return[3,5];return[4,this._handleSMSGroups(l)];case 4:M=C.sent();return[3,6];case 5:M={};C.label=6;case 6:c=M,f=c.toUpdatedGroups,d=f===void 0?[]:f,p=c.toDeleteGroups,v=p===void 0?[]:p;y=v.map((function(e){return e.id}));i.trace({key:_.A.PARSE_SMS_ENTITIES,level:S.LOG_CONTROL_LEVEL.HIGH});m={deletedMessages:s,updateSMSGroups:d,deletedSMSGroupIds:y,aliveMessage:u};return[4,this.saveInTransaction(m)];case 7:C.sent();i.trace({key:_.A.SAVE_SMS_ENTITIES,level:S.LOG_CONTROL_LEVEL.HIGH});i.end({key:_.A.HANDLE_SMS_ENTITIES,level:S.LOG_CONTROL_LEVEL.HIGH,count:n.length,infos:{source:t.toString()}});this.notifySMSGroupUpdates(d,v,r);this._notifyDataChangeListeners(m);h.tags(Se).log((0,S.sensitive)({toDeleteGroupIds:y,aliveSMSIds:u.map((function(e){return e.id})),deactivatedSMSIds:s,toUpdatedGroupsIds:d.map((function(e){return e.id}))},["phoneNumber"]));return[2,n]}}))}))};SMSDataController.prototype._notifyDataChangeListeners=function(e){this._dataChangeListeners.forEach((function(t){t(e)}))};SMSDataController.prototype.registerSMSDataChange=function(e){this._dataChangeListeners.push(e)};SMSDataController.prototype.unRegisterSMSDataChange=function(e){this._dataChangeListeners=this._dataChangeListeners.filter((function(t){return t!==e}))};SMSDataController.prototype.notifySMSUpdate=function(e,t){if(t===void 0){t=false}if(e.length){var r=this._entitySourceController.getEntityNotificationKeysByEntities(e);r.forEach((function(e,r){n.notificationCenter.emitEntityUpdate(r,e);t&&n.notificationCenter.emitEntityDelete(r,e.map((function(e){return e.id})))}))}};SMSDataController.prototype.batchUpdateGroupHasMore=function(e,t){return se(this,void 0,Promise,(function(){var r;return ue(this,(function(n){switch(n.label){case 0:return[4,this._getSMSGroupEntitySource().getEntitiesLocally(e,false)];case 1:r=n.sent();return[4,this._getSMSGroupEntitySource().bulkUpdate(r.map((function(e){return{id:e.id,hasMoreOlder:t}})))];case 2:n.sent();return[2]}}))}))};SMSDataController.prototype.notifySMSGroupUpdates=function(e,t,r){if(r===void 0){r=false}if(r){n.notificationCenter.emitEntityReload(this._getSMSGroupEntitySource().getEntityNotificationKey(),[],true)}else{var o=this._getSMSGroupEntitySource().getEntityNotificationKey();e.length&&n.notificationCenter.emitEntityUpdate(o,e);if(t.length){n.notificationCenter.emitEntityUpdate(o,t.map((function(e){return ae(ae({},e),{deactivated:true})})),t.map((function(e){return{id:e.id,deactivated:true}})));n.notificationCenter.emitEntityDelete(o,t.map((function(e){return e.id})))}}};SMSDataController.prototype._handleIncomingGroupSMS=function(e,t,r){var n=c().cloneDeep(e);r.alive.length&&this._handleAliveSMSOfGroup(n,r.alive);r.deleted.length&&this._handleDeletedSMSOfGroup(n,r.deleted,r.alive,t);return n};SMSDataController.prototype._uniqueConcatSMSEntities=function(e,t){var r=new Map;e.forEach((function(e){r.set(e.id,e)}));t.forEach((function(e){r.set(e.id,e)}));return Array.from(r.values())};SMSDataController.prototype._handleDeletedSMSOfGroup=function(e,t,r,n){var o=t.map((function(e){return e.id}));var i=this._uniqueConcatSMSEntities(n.get(e.id)||[],r);var a=i.map((function(e){return e.id}));var s=!!c().difference(a,o).length;var u=c().isEmpty(e.draft);if(e.failedSMSIds&&e.failedSMSIds.length){e.failedSMSIds=e.failedSMSIds.filter((function(e){return!o.includes(e)}))}if(s){var l=!!t.find((function(t){return t.id===e.lastSMSId}));if(l){var S=this._getLastVisibleSMS(i,o);this._updateLastSMSInGroup(e,S,true)}if(t.length){var f=c().difference(e.unreadSMSIds,t.map((function(e){return e.id})));e.unreadSMSIds=f}}else if(!u){this._updateLastSMSInGroup(e,undefined,true);e.unreadSMSIds=[]}e.deactivated=u&&!s};SMSDataController.prototype._getLastVisibleSMS=function(e,t){return c().last(e.filter((function(e){return!t.includes(e.id)})).sort(a.RCItemUtils.getSortRCItemByTimeFn(false)))};SMSDataController.prototype._handleAliveSMSOfGroup=function(e,t){if(t.length){var r=t[0];var n=this._getSMSIdsDivideByReadStatus(t);e.unreadSMSIds=c().union(e.unreadSMSIds||[],n.unReadIds);e.unreadSMSIds=e.unreadSMSIds.filter((function(e){return!n.readIds.includes(e)}));this._updateLastSMSInGroup(e,r)}};SMSDataController.prototype._handleSMSGroups=function(e){return se(this,void 0,void 0,(function(){var t,r,n,o,i,a,s,u;return ue(this,(function(l){switch(l.label){case 0:t=Array.from(e.keys());return[4,this._smsGroupService.batchGetLocally(t,false)];case 1:r=l.sent()||[];n=r.filter((function(e){return e.conversationId===undefined})).map((function(e){return e.id}));o=ce(c().difference(t,r.map((function(e){return e.id}))),n);return[4,this._handleExistedGroups(r,e)];case 2:i=l.sent();return[4,this._handleNewGroups(o,e)];case 3:a=l.sent();s=ce(i.toUpdatedGroups,a);u=i.toDeleteGroups;return[2,{toUpdatedGroups:s,toDeleteGroups:u}]}}))}))};SMSDataController.prototype._handleExistedGroups=function(e,t){return se(this,void 0,void 0,(function(){var r,n,o,i,a,s;var u=this;return ue(this,(function(l){switch(l.label){case 0:r=[];n=[];o=[];i=new Map;e.forEach((function(e){var r=u._groupSMSByAliveStatus(t.get(e.id));if(r.deleted.length){o.push(e.id)}i.set(e.id,r)}));a=new Map;if(!o.length)return[3,2];return[4,this._smsDao.querySMSOfGroups(o)];case 1:s=l.sent();s.forEach((function(e){var t=e.__groupId;if(!a.has(t)){a.set(t,[])}a.get(t).push(e)}));l.label=2;case 2:e.forEach((function(e){var t=u._handleIncomingGroupSMS(e,a,i.get(e.id));if(t.deactivated){n.push(t)}else{r.push(t)}}));return[2,{toUpdatedGroups:r,toDeleteGroups:n}]}}))}))};SMSDataController.prototype.getReplyNumbers=function(e,t){var r=e.find((function(e){return e.direction===d.CALL_DIRECTION.OUTBOUND}))||c().last(e);if(!r){return{myNumber:"",otherCallers:[]}}return D.F.extractCallersFromSMS(r,t)};SMSDataController.prototype._getOrderedMySMSNumbers=function(){return se(this,void 0,void 0,(function(){var e,t,r,o,i,a;return ue(this,(function(s){switch(s.label){case 0:e=(0,n.getModule)(ie.oF);return[4,e.getSMSCallerIds()];case 1:t=s.sent();r=t.map((function(e){return e.phoneNumber}));o=r;return[4,this._userConfig.getLastSMSCallerId()];case 2:i=s.sent();a=t.find((function(e){return e.id===i}));if(a){o=ce([a.phoneNumber],t.filter((function(e){return e.id===i})).map((function(e){return e.phoneNumber})))}return[2,o]}}))}))};SMSDataController.prototype._handleNewGroups=function(e,t){return se(this,void 0,void 0,(function(){var r,n;var o=this;return ue(this,(function(i){switch(i.label){case 0:return[4,this._getOrderedMySMSNumbers()];case 1:r=i.sent();n=[];e.forEach((function(e){var i=t.get(e);var a=o._groupSMSByAliveStatus(i);var s=a.alive;if(s.length){var u=c().first(s);var l=c().first(s.filter((function(e){return e.id>0})));var S=o.getReplyNumbers(i,r);var f={id:e,conversationId:l&&l.conversation&&l.conversation.id,hasMoreOlder:true,lastSMSTimestamp:u.__timestamp,lastSMSId:u.id,unreadSMSIds:o._getSMSIdsDivideByReadStatus(s).unReadIds,myNumber:S.myNumber,otherCallers:S.otherCallers,deactivated:false};n.push(f)}}));return[2,n]}}))}))};SMSDataController.prototype._updateLastSMSInGroup=function(e,t,r){if(r===void 0){r=false}var n=t&&t.id;var o=t&&t.__timestamp||e.lastSMSTimestamp||0;var i=e.lastSMSTimestamp||0;if(r){e.lastSMSId=n;e.lastSMSTimestamp=Math.max(o,i)}else if(i<o){e.lastSMSId=n;e.lastSMSTimestamp=o}};SMSDataController.prototype._groupSMSByAliveStatus=function(e){var t=this._sortSMSByTimeDesc(e);var r=[];var n=[];t.forEach((function(e){if(a.RCItemUtils.isMessageAlive(e)){r.push(e)}else{n.push(e)}}));return{alive:r,deleted:n}};SMSDataController.prototype._getSMSIdsDivideByReadStatus=function(e){var t={readIds:[],unReadIds:[]};e.forEach((function(e){e.readStatus===a.READ_STATUS.UNREAD?t.unReadIds.push(e.id):t.readIds.push(e.id)}));return t};SMSDataController.prototype._sortSMSByTimeDesc=function(e){return e.length&&e.sort((function(e,t){return n.SortUtils.sortModelByKey(e,t,[{key:"__timestamp"},{key:"lastModifiedTime"}],true)}))||[]};SMSDataController.prototype.saveInTransaction=function(e){return se(this,void 0,void 0,(function(){var t,r,n,o,i,a,s,u,l,c,S,f,d,p;var _=this;return ue(this,(function(v){switch(v.label){case 0:t=e.aliveMessage,r=t===void 0?[]:t,n=e.deletedMessages,o=n===void 0?[]:n,i=e.updateSMSGroups,a=i===void 0?[]:i,s=e.deletedSMSGroupIds,u=s===void 0?[]:s;l=o.map((function(e){return e.id}));h.tags(Se).log("_saveInTransaction",{deletedMessages:l,normalMessages:r.map((function(e){return e.id})),updateSMSGroups:a.map((function(e){return e.id})),deletedSMSGroups:u});c=o.length;if(!c)return[3,2];return[4,this._deleteSMSLocalData(o)];case 1:c=v.sent();v.label=2;case 2:c;S=u.length;if(!S)return[3,4];return[4,this.deleteSMSGroupLocalData(u)];case 3:S=v.sent();v.label=4;case 4:S;f=this._smsDao.getAllCollection();d=this._smsGroupService.getDao().getCollection();p=this._getSMSGroupEntitySource();return[2,this._smsDao.executeInTransaction((function(){var e=[];r.length&&e.push(_._entitySourceController.bulkPut(r));l.length&&e.push(_._entitySourceController.bulkDelete(l));a.length&&e.push(p.bulkUpdate(a));u.length&&e.push(p.bulkDelete(u));return Promise.all(e)}),ce(f,[d]))]}}))}))};SMSDataController.prototype._getSMSGroupEntitySource=function(){return this._smsGroupService.getEntitySource()};SMSDataController.prototype._getSMSGroupId=function(e){var t=a.RCItemUtils.getFromNumber(e);var r=a.RCItemUtils.getToNumbers(e);return t&&r.length?D.F.buildSMSGroupId(r,t):undefined};SMSDataController.prototype._preHandleIncomingSMS=function(e){return se(this,void 0,void 0,(function(){var t,r,n,o,i;return ue(this,(function(s){switch(s.label){case 0:t=[];r=new Map;n=[];e.forEach((function(e){if(e.availability!==a.MESSAGE_AVAILABILITY.ALIVE){r.set(e.id,e);n.push(e.id)}else{t.push(e)}}));if(!r.size)return[3,2];return[4,this._entitySourceController.getEntitiesLocally(n,false)];case 1:o=s.sent().filter((function(e){return!!e}));i=o.map((function(e){return ae(ae({},e),r.get(e.id)||{})}));t.push.apply(t,ce(i));s.label=2;case 2:return[2,t]}}))}))};SMSDataController.prototype.deleteSMSGroupLocalData=function(e){this._smsDraftController.clearMemoryDraftByGroup(e)};SMSDataController.prototype._deleteSMSLocalData=function(e){return se(this,void 0,void 0,(function(){var t,r;return ue(this,(function(n){switch(n.label){case 0:t=e.filter((function(e){return e.id<0}));if(!t.length){return[2]}r=[];t.forEach((function(e){var t=e.attachments&&e.attachments.map((function(e){return e.id}));t&&r.push.apply(r,ce(t))}));r.length&&this._smsDraftController.removeFileAttachments(r);return[4,this._preInsertController.bulkDelete(t.map((function(e){return ae(ae({},e),{__preInsertId:e.id})})))];case 1:n.sent();return[2]}}))}))};return SMSDataController}();var de=r(684997);var pe=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var he=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var _e=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var ve="SMSEntitiesNotificationController";var Me=function(e){pe(SMSEntitiesNotificationController,e);function SMSEntitiesNotificationController(t){var r=e.call(this)||this;r._smsUserConfig=t;r._notifyQueue=new A.vm({name:ve});r._filterIncomingAndNotifySMS=function(e){return he(r,void 0,void 0,(function(){var t,r,n;return _e(this,(function(o){switch(o.label){case 0:return[4,this._smsUserConfig.getLastNotifiedSMSId()];case 1:t=o.sent()||0;r=e.filter((function(e){return e.direction===d.CALL_DIRECTION.INBOUND&&e.readStatus===a.READ_STATUS.UNREAD&&e.id>t}));if(!r.length)return[3,4];h.tags(ve).log("notify sms notification",r.map((function(e){return e.id})));n=c().first(e.sort((function(e,t){return t.id-e.id})));if(!n)return[3,3];return[4,this._smsUserConfig.setLastNotifiedSMSId(n.id)];case 2:o.sent();o.label=3;case 3:this.notifyObservers(r);o.label=4;case 4:return[2]}}))}))};return r}SMSEntitiesNotificationController.prototype.onReceivedNotification=function(e){var t=this;var processFn=function(){return he(t,void 0,void 0,(function(){return _e(this,(function(t){switch(t.label){case 0:return[4,this._filterIncomingAndNotifySMS(e)];case 1:t.sent();return[2]}}))}))};var r=new(function(){function class_1(){}class_1.prototype.process=function(){return he(this,void 0,void 0,(function(){return _e(this,(function(e){switch(e.label){case 0:return[4,processFn()];case 1:e.sent();return[2,true]}}))}))};class_1.prototype.name=function(){return ve+"_"+Date.now()+"_"+(0,S.randomInt)()};return class_1}());this._notifyQueue.addProcessor(r)};return SMSEntitiesNotificationController}(de.EntityNotificationController);var ye=r(461197);var me=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var ge=undefined&&undefined.__assign||function(){ge=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var o in t)if(Object.prototype.hasOwnProperty.call(t,o))e[o]=t[o]}return e};return ge.apply(this,arguments)};var Ce=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var Ee=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var be=5e3;var Ie=100;var Te="SMSFetchController";var Ae=h.tags(Te);var Oe=function(e){me(SMSFetchController,e);function SMSFetchController(t,r,n,o,i,s,u){var l=e.call(this,{api:H.X.rcItemCommonApi,userConfig:t,entitySourceController:r,badgeController:n,messageType:d.RC_MESSAGE_TYPE.SMS,moduleName:Te,rcItemDao:s,entityKey:T.$q.ENTITY.SMS})||this;l._smsDataController=o;l._smsNotificationController=i;l._smsDao=s;l._smsGroupService=u;l.handleRCInstantMessageEvent=function(e){return Ce(l,void 0,void 0,(function(){var t;return Ee(this,(function(r){switch(r.label){case 0:if(!((t=e.conversation)===null||t===void 0?void 0:t.id)){Ae.tags(this.syncName).info("message body not conversation id exists, messageId:"+e.id);return[2]}return[4,this.hasPermission()];case 1:if(!r.sent()||this._isInClear()){Ae.tags(this.syncName).info("can not do sync now");return[2]}return[4,this.getSyncToken()];case 2:if(!r.sent())return[2];return[4,this._handleInstantSyncPayload(e)];case 3:r.sent();return[2]}}))}))};l._handleExtPhoneNumberChanged=function(){return Ce(l,void 0,void 0,(function(){var e;return Ee(this,(function(t){switch(t.label){case 0:return[4,this.syncConfig.getSyncToken()];case 1:e=!!t.sent();if(!!e)return[3,3];Ae.log("phone number updated, sync sms log");return[4,this.doSync({isSilent:true,direction:a.SYNC_DIRECTION.NEWER,fireImmediately:true})];case 2:t.sent();t.label=3;case 3:return[2]}}))}))};l._querySMSMessagesFromServer=function(e){return H.X.queryRCMessages(ge(ge({},e),{availability:a.MESSAGE_AVAILABILITY.ALIVE,messageType:d.RC_MESSAGE_TYPE.SMS}))};return l}SMSFetchController.prototype.init=function(){e.prototype.init.call(this);this._listenPhoneNumberUpdate()};SMSFetchController.prototype.dispose=function(){this._rcInfoModule.DBConfig.off(ie.Uz.EXTENSION_PHONE_NUMBER_LIST,this._handleExtPhoneNumberChanged);e.prototype.dispose.call(this)};SMSFetchController.prototype._handleInstantSyncPayload=function(e){var t;return Ce(this,void 0,void 0,(function(){var r,n;return Ee(this,(function(o){switch(o.label){case 0:r=c().assign({},e,{id:Number(e.id),uri:"",conversationId:Number((t=e.conversation)===null||t===void 0?void 0:t.id)});n=[r];if(!(n&&n.length))return[3,2];return[4,this._smsDataController.handleSMSEntities(n,N.k.SYNC,false)];case 1:n=o.sent();o.label=2;case 2:if(e.messageStatus===a.MESSAGE_STATUS.DELIVERY_FAILED||e.messageStatus===a.MESSAGE_STATUS.SENDING_FAILED){D.F.reportFailedSMSInfo(r,e.__error)}this.notifyEntityUpdate(n);this._smsNotificationController.onReceivedNotification(n);return[2]}}))}))};SMSFetchController.prototype._listenPhoneNumberUpdate=function(){this._rcInfoModule.DBConfig.on(ie.Uz.EXTENSION_PHONE_NUMBER_LIST,this._handleExtPhoneNumberChanged)};SMSFetchController.prototype.sendSyncRequest=function(e,t,r){return Ce(this,void 0,Promise,(function(){var n,o,i,s;return Ee(this,(function(u){switch(u.label){case 0:o=e===a.SYNC_TYPE.FSYNC?a.MAX_RECORD_COUNT:r;return[4,H.X.syncMessage({syncType:e,syncToken:t,recordCount:o,messageType:e===a.SYNC_TYPE.FSYNC?this._messageType:undefined})];case 1:i=u.sent();return[4,this._smsUserConfig.getHasQueryAll()];case 2:s=u.sent();if(!(e===a.SYNC_TYPE.FSYNC||!s))return[3,4];return[4,this._requestAllSMS()];case 3:n=u.sent()||[];Ae.log("allSMS len",n.length);u.label=4;case 4:Ae.log("syncResult",{"syncResult.records.length":i.records.length,"allSMSFromServer.length":n&&n.length||0});i.records=n||i.records;if(!!s)return[3,6];return[4,this._smsUserConfig.setHasQueryAll(true)];case 5:u.sent();u.label=6;case 6:return[2,i]}}))}))};SMSFetchController.prototype._requestAllSMS=function(){var e={dateFrom:n.TimeUtils.firstDayInISO8601(),dateTo:n.TimeUtils.nowInISO8601(),page:d.FIRST_PAGE_INDEX,perPage:d.MAX_PER_PAGE};var t=new d.RCPaginationController({fetchHandler:this._querySMSMessagesFromServer});return t.getAllPage(e,be/d.MAX_PER_PAGE)};SMSFetchController.prototype.hasPermission=function(){return Ce(this,void 0,Promise,(function(){var e;return Ee(this,(function(t){switch(t.label){case 0:return[4,this.hasReadMessagePermission()];case 1:if(!t.sent()){return[2,false]}return[4,this._rcInfoModule.DBConfig.getExtensionPhoneNumberList()];case 2:e=t.sent();if(!e){Ae.log("return because no extension caller id");return[2,false]}return[2,this._rcInfoModule.isRCFeaturePermissionEnabled(ie.D9.SMS_RECEIVE)]}}))}))};SMSFetchController.prototype.handleDataAndSave=function(e){return Ce(this,void 0,Promise,(function(){var t,r;return Ee(this,(function(n){switch(n.label){case 0:r=!!(e.syncInfo&&e.syncInfo.syncType===a.SYNC_TYPE.FSYNC);if(!(e&&e.records&&e.records.length))return[3,2];return[4,this._smsDataController.handleSMSEntities(e.records,N.k.SYNC,r)];case 1:t=n.sent();n.label=2;case 2:e.records.forEach((function(e){if(e.messageStatus===a.MESSAGE_STATUS.DELIVERY_FAILED||e.messageStatus===a.MESSAGE_STATUS.SENDING_FAILED){D.F.reportFailedSMSInfo(e,e.__error)}}));return[2,t||[]]}}))}))};SMSFetchController.prototype.handleSuccessResponse=function(t,r,n,o){return Ce(this,void 0,void 0,(function(){var i,s;return Ee(this,(function(u){switch(u.label){case 0:return[4,e.prototype.handleSuccessResponse.call(this,t,r,n,o)];case 1:i=u.sent();if(i.length){s=t.syncInfo&&t.syncInfo.syncType===a.SYNC_TYPE.ISYNC&&!n;if(s){this._smsNotificationController.onReceivedNotification(i)}}return[2,i]}}))}))};SMSFetchController.prototype.notifyEntityUpdate=function(e){return this._smsDataController.notifySMSUpdate(e)};SMSFetchController.prototype._getQueryRange=function(e){var t=n.TimeUtils.firstDayInISO8601();var r=e&&e.creationTime;var o=r||n.TimeUtils.nowInISO8601();return{dateTo:o,dateFrom:t}};SMSFetchController.prototype.hasMoreOlderDataInRemote=function(e){return Ce(this,void 0,void 0,(function(){var t,r;return Ee(this,(function(n){switch(n.label){case 0:t=e.groupId;if(!t)return[3,2];return[4,this._smsGroupService.getById(t)];case 1:r=n.sent();return[2,!!(r&&r.conversationId&&r.hasMoreOlder)];case 2:return[2,false]}}))}))};SMSFetchController.prototype.fetchData=function(t){return Ce(this,void 0,void 0,(function(){var r;return Ee(this,(function(o){switch(o.label){case 0:r=t.direction===n.QUERY_DIRECTION.OLDER;if(!r)return[3,2];return[4,this.syncConfig.getHasMore()];case 1:r=o.sent();o.label=2;case 2:if(r){this.doSync({isSilent:false,direction:a.SYNC_DIRECTION.OLDER,needNotification:false,recordCount:a.MAX_RECORD_COUNT}).catch((function(e){Ae.log("refresh sms syncToken failed.",e)}))}return[2,e.prototype.fetchData.call(this,t)]}}))}))};SMSFetchController.prototype.fetchDataFromServer=function(t,r){return Ce(this,void 0,void 0,(function(){var o,i,s,u,l,S,f,d,p,h,_,v;return Ee(this,(function(M){switch(M.label){case 0:o=t.groupId,i=t.limit,s=t.direction,u=s===void 0?n.QUERY_DIRECTION.OLDER:s;if(!o){Ae.log("fetch sms data from server use common way",t);return[2,e.prototype.fetchDataFromServer.call(this,t,r)]}if(u===n.QUERY_DIRECTION.NEWER){return[2,Promise.resolve({hasMore:false,serverEntities:[]})]}return[4,this._smsGroupService.getById(o)];case 1:l=M.sent();if(!l||!l.hasMoreOlder||!l.conversationId){return[2,{hasMore:false,serverEntities:[]}]}S=c().first(r);if(!!S)return[3,3];return[4,this._smsDao.queryOldestVisibleSMS(o)];case 2:S=M.sent()||undefined;M.label=3;case 3:return[4,this._fetchAndHandleSMSFromServer(l,S,i)];case 4:f=M.sent();if(!(S&&f.records.length))return[3,6];d=c().last(f.records.slice().sort(a.RCItemUtils.getSortRCItemByTimeFn(true)));if(!(d.creationTime===S.creationTime))return[3,6];Ae.log("get same range data from server, expand page size",d,S);return[4,this._fetchAndHandleSMSFromServer(l,d,Ie)];case 5:p=M.sent();f.records=f.records.concat(p.records);f.records=c().unionBy(f.records,"id");M.label=6;case 6:h=f.records.length>=(t.limit||Ie)||(f.paging&&f.paging.totalElements||0)>f.records.length;_=l.hasMoreOlder!==h;v=_;if(!v)return[3,8];return[4,this._smsDataController.batchUpdateGroupHasMore([o],h)];case 7:v=M.sent();M.label=8;case 8:v;Ae.log("fetch sms from server results end",{options:t,hasMore:h,serverEntitiesLen:f.records.length});return[2,{hasMore:h,serverEntities:f.records}]}}))}))};SMSFetchController.prototype._fetchAndHandleSMSFromServer=function(e,t,r){return Ce(this,void 0,void 0,(function(){var n,o,i,a;return Ee(this,(function(s){switch(s.label){case 0:n=this._getQueryRange(t);o=r||Ie;return[4,this._querySMSMessagesFromServer(ge(ge({},n),{conversationId:e.conversationId,page:1,perPage:o}))];case 1:i=s.sent();a=i.records.length;if(!a)return[3,3];return[4,this._smsDataController.handleSMSEntities(i.records,N.k.USER_FETCH)];case 2:a=s.sent();s.label=3;case 3:a;Ae.log("fetch sms from server results",{limit:r,timeRange:n,serverEntitiesLen:i.records.length});return[2,i]}}))}))};SMSFetchController.prototype.removeLocalData=function(){return Ce(this,void 0,Promise,(function(){var t,r;return Ee(this,(function(n){switch(n.label){case 0:Ae.log("clear all local sms data");t=this._smsGroupService.clear();r=e.prototype.removeLocalData.call(this);return[4,Promise.all([t,r])];case 1:n.sent();return[2]}}))}))};Object.defineProperty(SMSFetchController.prototype,"_rcInfoModule",{get:function(){return(0,ye.getModule)(ie.oF)},enumerable:true,configurable:true});Object.defineProperty(SMSFetchController.prototype,"_smsUserConfig",{get:function(){return this.syncConfig},enumerable:true,configurable:true});return SMSFetchController}(a.RCMessageFetchController);var Ne=r(960172);var De=undefined&&undefined.__read||function(e,t){var r=typeof Symbol==="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,i=[],a;try{while((t===void 0||t-- >0)&&!(o=n.next()).done)i.push(o.value)}catch(e){a={error:e}}finally{try{if(o&&!o.done&&(r=n["return"]))r.call(n)}finally{if(a)throw a.error}}return i};var Re=undefined&&undefined.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(De(arguments[t]));return e};var we=function(){function SMSSearchHandler(e,t){this._searchOptions=e;this._sortedSource=t;this._matchedData=new Set}SMSSearchHandler.prototype.search=function(){var e=this._searchText();var t=[];if(!this.searchTextOnly){t=this._searchContacts(e.notMatchedGroups).matchResults}var sortFn=function(e,t){return t.sortValue-e.sortValue};var r;var o=Re(e.matchResults,t);if(this._searchOptions.resultLimit){var i=n.SortUtils.heapSort(o,sortFn,this._searchOptions.resultLimit);var a=new Set(i.map((function(e){return e.id})));r=i.concat(o.filter((function(e){return!a.has(e.id)})))}else{r=o.sort(sortFn)}this._cache={sortableModels:r,terms:this.terms};return this._cache};Object.defineProperty(SMSSearchHandler.prototype,"searchCache",{get:function(){return this._cache},enumerable:true,configurable:true});Object.defineProperty(SMSSearchHandler.prototype,"terms",{get:function(){return n.SearchUtils.getTermsFromText(this._searchOptions.searchKey.toLowerCase())},enumerable:true,configurable:true});Object.defineProperty(SMSSearchHandler.prototype,"searchOptions",{get:function(){return this._searchOptions},enumerable:true,configurable:true});SMSSearchHandler.prototype._searchContacts=function(e){var t=this;var r=[];var n=new Map;e.forEach((function(e){e.otherCallers&&n.set(e.id,e.otherCallers)}));var o=a.RCItemUtils.filterMatchedContactNumbersCallers(this._searchOptions.searchKey,n);o.forEach((function(e){var n=t._sortedSource.get(e);if(n){var o=n.smsEntities[0];o&&r.push(t._buildSMSSortableModel(!o.subject?o:D.F.buildTempSMSForSearch(n.smsGroup),n.smsGroup,n.sortValue,N.M.CONTACT))}}));return{matchResults:r}};SMSSearchHandler.prototype._buildSMSSortableModel=function(e,t,r,n){return{sms:e,smsGroup:t,matchType:n,id:e.id,sortValue:this.searchTextOnly?e.__timestamp:r}};SMSSearchHandler.prototype._searchText=function(){var e=this;var t=h.performance();t.start();var r=this.sortedTerms;var o=new Set;var i=[];this._sortedSource.forEach((function(t){var a=false;t.smsEntities[e.searchTextOnly?"forEach":"some"]((function(o){var s=o.subject&&n.SearchUtils.isFuzzyMatched(o.subject.toLowerCase(),r);if(s){i.push(e._buildSMSSortableModel(o,t.smsGroup,t.sortValue,N.M.TEXT));e._matchedData.add(o.id);a=true}return s}));if(!a){o.add(t.smsGroup)}}));t.end({key:_.A.SEARCH_SMS_TEXT,level:S.LOG_CONTROL_LEVEL.HIGH});return{matchResults:i,notMatchedGroups:o}};Object.defineProperty(SMSSearchHandler.prototype,"sortedTerms",{get:function(){return this.terms.sort((function(e,t){return t.length-e.length}))},enumerable:true,configurable:true});Object.defineProperty(SMSSearchHandler.prototype,"searchTextOnly",{get:function(){return!!this._searchOptions.groupId},enumerable:true,configurable:true});return SMSSearchHandler}();var Ge=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var Pe=undefined&&undefined.__assign||function(){Pe=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var o in t)if(Object.prototype.hasOwnProperty.call(t,o))e[o]=t[o]}return e};return Pe.apply(this,arguments)};var Le=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var Ue=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var Fe=undefined&&undefined.__read||function(e,t){var r=typeof Symbol==="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,i=[],a;try{while((t===void 0||t-- >0)&&!(o=n.next()).done)i.push(o.value)}catch(e){a={error:e}}finally{try{if(o&&!o.done&&(r=n["return"]))r.call(n)}finally{if(a)throw a.error}}return i};var He=undefined&&undefined.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(Fe(arguments[t]));return e};var Be=h.tags("[SMSSearchController]");var ke=function(e){Ge(SMSSearchController,e);function SMSSearchController(t,r,o){var i=e.call(this,o.recentSearchConfig)||this;i._smsSource=t;i._smsGroupSource=r;i._searchHandlers=new n.ObjectHashTable;i.handleSMSDataUpdate=function(e){return Le(i,void 0,void 0,(function(){var t,r;return Ue(this,(function(n){switch(n.label){case 0:if(!this._entityCache)return[3,5];e.deletedSMSGroupIds&&this._handleDeletedSMSGroups(e.deletedSMSGroupIds);t=e.updateSMSGroups;if(!t)return[3,2];return[4,this._handleUpdatedSMSGroups(e.updateSMSGroups)];case 1:t=n.sent();n.label=2;case 2:t;r=e.aliveMessage||e.deletedMessages;if(!r)return[3,4];return[4,this._handleUpdatedSMSEntities(e.deletedMessages,e.aliveMessage)];case 3:r=n.sent();n.label=4;case 4:r;this._searchHandlers.clear();n.label=5;case 5:return[2]}}))}))};i._sortSMSDesc=a.RCItemUtils.getSortRCItemByTimeFn(true);return i}SMSSearchController.prototype.providerName=function(){return T.Lq.SEARCH_DATA_PROVIDER_NAME};SMSSearchController.prototype.shouldSaveRecord=function(t){return e.prototype.shouldSaveRecord.call(this,t)||Object.values(T.no).includes(t.type)};SMSSearchController.prototype.searchSMS=function(e){return Le(this,void 0,Promise,(function(){var t,r,n,o,i;return Ue(this,(function(a){switch(a.label){case 0:Be.log("start searchSMS",e);t=Pe(Pe({},e),{searchKey:e.searchKey.toLowerCase()});r=h.performance();r.start();n=!this._entityCache;if(!n)return[3,2];return[4,this._prepareEntityCache()];case 1:n=a.sent();a.label=2;case 2:n;o=this._getOrCreateSearchHandler(t);i=o.search();r.end({key:_.A.SEARCH_SMS,level:S.LOG_CONTROL_LEVEL.HIGH,infos:{options:t,resultsLen:i.sortableModels.length}});Be.log("end searchSMS",{resultsLen:i.sortableModels.length});return[2,i]}}))}))};SMSSearchController.prototype._defaultSearchSource=function(e){return e?new Map([[e,this._entityCache.get(e)]]):this._entityCache};SMSSearchController.prototype._getOrCreateSearchHandler=function(e){var t=this._defaultSearchSource(e.groupId);var r=this._searchHandlers.get(e);if(this._searchHandlers.size&&!r&&e.groupId){var n;this._searchHandlers.forEach((function(t){var r=t.searchOptions.searchKey;if(t.searchOptions.groupId===e.groupId&&e.searchKey.startsWith(r)){(!n||r.length>n.searchOptions.searchKey.length)&&(n=t)}}));if(n&&n.searchCache){t=this._convertSearchResToSearchSource(n.searchCache)}}if(!r){r=new we(e,t);this._searchHandlers.set(e,r)}return r};SMSSearchController.prototype.cleanSearchCache=function(){this._searchHandlers.clear();delete this._entityCache};SMSSearchController.prototype._prepareEntityCache=function(){return Le(this,void 0,void 0,(function(){var e,t,r,n,o,i,a,s,u,l,c,l,c,f,d;var p=this;return Ue(this,(function(v){switch(v.label){case 0:e=h.performance();e.start();i=(o=Promise).all;return[4,this._smsSource.getAll()];case 1:a=[v.sent().sort(this._sortSMSDesc)];return[4,this._smsGroupSource.getAll()];case 2:return[4,i.apply(o,[a.concat([v.sent()])])];case 3:t=Fe.apply(void 0,[v.sent(),2]),r=t[0],n=t[1];e.trace({key:"get_data_from_DB",level:S.LOG_CONTROL_LEVEL.NORMAL});s=new Map;u=new Map;for(l=0;l<n.length;l++){c=n[l];s.set(c.id,c)}for(l=0;l<r.length;l++){c=r[l];f=c.__groupId;if(u.has(f)){u.get(f).smsEntities.push(c)}else{d=s.get(f);u.set(f,{smsGroup:d,smsEntities:[c],sortValue:D.F.getSMSSearchSortTimestamp(d)});s.delete(f)}}s.forEach((function(e){u.set(e.id,p._buildEmptyGroupCache(e))}));e.end({key:_.A.INIT_SMS_SEARCH_CACHE,level:S.LOG_CONTROL_LEVEL.NORMAL,infos:{allSMSEntitiesLen:r.length,allGroupsLen:n.length}});this._entityCache=u;return[2]}}))}))};SMSSearchController.prototype._buildEmptyGroupCache=function(e){return{smsEntities:[D.F.buildTempSMSForSearch(e)],smsGroup:e,sortValue:D.F.getSMSSearchSortTimestamp(e)}};SMSSearchController.prototype._handleDeletedSMSGroups=function(e){var t=this;e.length&&e.forEach((function(e){t._entityCache.delete(e)}))};SMSSearchController.prototype._handleUpdatedSMSGroups=function(e){return Le(this,void 0,void 0,(function(){var t,r,n;var o=this;return Ue(this,(function(i){switch(i.label){case 0:t=e.map((function(e){return e.id})).filter((function(e){return e!==undefined}));if(!t.length)return[3,2];return[4,this._smsGroupSource.batchGet(t)];case 1:n=i.sent();return[3,3];case 2:n=[];i.label=3;case 3:r=n;if(t.length){r.forEach((function(e){var t=o._entityCache.get(e.id);if(t){var r=D.F.getSMSSearchSortTimestamp(e);t.sortValue=r}else{o._entityCache.set(e.id,o._buildEmptyGroupCache(e))}}))}return[2]}}))}))};SMSSearchController.prototype._handleUpdatedSMSEntities=function(e,t){var r=this;var n=e||[];var o=new Set(n.map((function(e){return e.id})));var i=He(e||[],t||[]);var a=c().groupBy(i,(function(e){return e.__groupId}));var s=Object.keys(a).map((function(e){return Le(r,void 0,void 0,(function(){var t;return Ue(this,(function(r){switch(r.label){case 0:t=a[e];return[4,this._updatedSMSEntitiesCache(e,t,o)];case 1:r.sent();return[2]}}))}))}));return Promise.all(s)};SMSSearchController.prototype._updatedSMSEntitiesCache=function(e,t,r){return Le(this,void 0,void 0,(function(){var n,o,i,a;return Ue(this,(function(s){switch(s.label){case 0:n=this._entityCache.get(e);o=c().uniqBy(He(n&&n.smsEntities||[],t),"id").filter((function(e){return!r.has(e.id)})).sort(this._sortSMSDesc);if(!n)return[3,1];if(o.length){n.smsEntities=o;i=c().first(o);if(n.sortValue<i.__timestamp){n.sortValue=i.__timestamp}}else{this._entityCache.delete(e)}return[3,3];case 1:return[4,this._smsGroupSource.get(e)];case 2:a=s.sent();a&&this._entityCache.set(e,{smsEntities:o,smsGroup:a,sortValue:D.F.getSMSSearchSortTimestamp(a)});s.label=3;case 3:return[2]}}))}))};SMSSearchController.prototype._convertSearchResToSearchSource=function(e){var t=this;var r=new Map;if(e.sortableModels.length){var n=c().groupBy(e.sortableModels.map((function(e){return e.sms})),(function(e){return e.__groupId}));Object.keys(n).forEach((function(e){var o=n[e];var i=t._entityCache.get(e);i&&r.set(e,{smsEntities:o.sort(t._sortSMSDesc),smsGroup:i.smsGroup,sortValue:D.F.getSMSSearchSortTimestamp(i.smsGroup)})}))}return r};return SMSSearchController}(Ne.a);var Ve=undefined&&undefined.__assign||function(){Ve=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var o in t)if(Object.prototype.hasOwnProperty.call(t,o))e[o]=t[o]}return e};return Ve.apply(this,arguments)};var je=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var xe=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var Ye=h.tags("[PurgeSMSController]");var qe=20;var Xe=5e3;var Ke="PURGE_SMS";var Qe="PURGE_SMS_TASK";var ze=function(){function SMSPurgeController(e,t){var r=this;this._smsSource=e;this._smsDataController=t;this._dailyPurgeJob=function(e){try{Ye.info("add purge to idle task");n.IdleTaskController.instance().registerTask({taskFn:function(){return r._purgeOldSMS()},name:Qe,priority:n.IDLE_TASK_PRIORITY.LOW});e(true)}catch(t){Ye.info("failed to add idle task");e(false)}}}SMSPurgeController.prototype.setCurrentSMSConversation=function(e){this._currentGroupId=e};SMSPurgeController.prototype.schedulePurgeSMSJob=function(){n.jobScheduler.scheduleDailyPeriodicJob(Ke,this._dailyPurgeJob,true,n.INITIAL_OPTION.IGNORE_FIRST_TIME)};SMSPurgeController.prototype._purgeOldSMS=function(){return je(this,void 0,void 0,(function(){var e,t,r,o,i,s,u,l,f,d,p,v,M;return xe(this,(function(y){switch(y.label){case 0:return[4,this._smsSource.getTotalCount()];case 1:e=y.sent();if(e<Xe){Ye.log("return => less than max local sms count");return[2]}Ye.log("start purgeOldSMS");t=h.performance();return[4,this._smsSource.getAll()];case 2:r=y.sent();o=r.sort(a.RCItemUtils.getSortRCItemByTimeFn(true));i=new Set(this._currentGroupId?[this._currentGroupId]:[]);s=new Map;u=new Map;l=o[Xe-1];for(f=0;f<o.length;f++){d=o[f];p=d.__groupId;n.ArrayUtils.appendToArrayMap(u,{key:d.__groupId,value:d.id});if(d.__timestamp<l.__timestamp){if(d.readStatus===a.READ_STATUS.UNREAD){i.add(p);s.delete(p)}if(!i.has(p)&&u.get(p).length>qe){n.ArrayUtils.appendToArrayMap(s,{key:p,value:d})}}}v=c().flatten(Array.from(s.values()));M=Array.from(s.keys());return[4,this._smsDataController.batchUpdateGroupHasMore(M,true)];case 3:y.sent();return[4,this._smsDataController.handleSMSEntities(v.map((function(e){return Ve(Ve({},e),{availability:a.MESSAGE_AVAILABILITY.DELETED})})),N.k.LOCAL_MODIFICATION)];case 4:y.sent();n.notificationCenter.emitEntityDelete(T.$q.ENTITY.SMS,v.map((function(e){return e.id})));t.end({key:_.A.PURGE_OLD_SMS,level:S.LOG_CONTROL_LEVEL.HIGH,count:v.length,infos:{groupIdsLen:M.length}});Ye.log("end purgeOldSMS",{smsIds:v.map((function(e){return e.id})),groupIds:M});return[2]}}))}))};return SMSPurgeController}();var Je=r(553362);var Ze=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var $e=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var We=undefined&&undefined.__read||function(e,t){var r=typeof Symbol==="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,i=[],a;try{while((t===void 0||t-- >0)&&!(o=n.next()).done)i.push(o.value)}catch(e){a={error:e}}finally{try{if(o&&!o.done&&(r=n["return"]))r.call(n)}finally{if(a)throw a.error}}return i};var getSMSDBHistory=function(e){return{version:1,moduleName:T.ut,changes:{1:function(){return Ze(void 0,void 0,void 0,(function(){var t,r,o,i,a,s,u,l,c,S;return $e(this,(function(f){switch(f.label){case 0:t=(0,n.getModule)(ie.oF);return[4,t.getSMSCallerIds()];case 1:r=f.sent().map((function(e){return e.phoneNumber}));p.k.tags("DBChangeHistory").log("start update sms group data");o=e.getDao(I,e);i=e.getDao(Je.SMSGroupDao,e);return[4,Promise.all([o.getAll(),i.getAll()])];case 2:a=We.apply(void 0,[f.sent(),2]),s=a[0],u=a[1];l=[];if(u.length){u.forEach((function(e){var t=e&&!e.lastSMSId&&Array.isArray(e["otherNumbers"])?e["otherNumbers"]:[];if(t.length){l.push({id:e.id,otherCallers:t.map((function(e){return{phoneNumber:e}}))})}}))}if(s.length){c=s.sort((function(e){return e.direction===d.CALL_DIRECTION.OUTBOUND?1:0}));S=new Map;c.forEach((function(e){if(e.__groupId&&e.id>0&&!S.has(e.__groupId)){S.set(e.__groupId,e)}}));c.forEach((function(e){var t=D.F.extractCallersFromSMS(e,r).otherCallers;l.push({id:e.__groupId,otherCallers:t})}))}if(!l.length)return[3,4];return[4,i.bulkUpdate(l)];case 3:f.sent();n.notificationCenter.emitEntityUpdate(T.$q.ENTITY.SMS_GROUP,[],l);f.label=4;case 4:p.k.tags("DBChangeHistory").log("end update sms group data");return[2]}}))}))}}}};var et=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var tt=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var rt=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var nt=function(e){et(SMSService,e);function SMSService(t,r){var n=e.call(this,{isSupportedCache:false,entityNotificationKeyBuilder:D.F.getSMSNotificationKey},{dao:t.getDao(I,t)})||this;n._daoManager=t;n._smsGroupService=r;n._onRCLogin=function(e){if(e.success){n.smsFetchController.init();n.smsBadgeController.start();n.smsFetchController.doSilentSyncLatestData();n.smsBadgeController.initializeBadge()}};n._onRCLogout=function(){return tt(n,void 0,Promise,(function(){return rt(this,(function(e){switch(e.label){case 0:return[4,caches.delete("sms-image-cache")];case 1:e.sent();return[2]}}))}))};return n}SMSService.prototype.onAppRestored=function(){var t;e.prototype.onAppRestored.call(this);(0,i.gT)().onLoginResult(this._onRCLogin);this.addSubscriptionController(n.SubscribeController.buildSubscriptionController(n.notificationCenter,(t={},t[i.FY.LOGOUT]=this._onRCLogout,t)))};SMSService.prototype.onStarted=function(){var t=this;e.prototype.onStarted.call(this);this._listenInstantMessage(true);this.smsPurgeController.schedulePurgeSMSJob();n.dbMigrator.addHistory({getDBHistoryDetail:function(){return getSMSDBHistory(t._daoManager)}})};SMSService.prototype.onStopped=function(){this._listenInstantMessage(false);this.smsFetchController.dispose();this.smsBadgeController.stop();e.prototype.onStopped.call(this)};Object.defineProperty(SMSService.prototype,"userConfig",{get:function(){if(!this._smsUserConfig){this._smsUserConfig=new _.z(T.ut,this._daoManager.getDBConfigService())}return this._smsUserConfig},enumerable:true,configurable:true});SMSService.prototype.fetchSMSGroups=function(e){return tt(this,void 0,Promise,(function(){return rt(this,(function(t){switch(t.label){case 0:return[4,this.userConfig.getSyncToken()];case 1:if(!!t.sent())return[3,3];return[4,this.smsFetchController.doSync({isSilent:false,fireImmediately:true,direction:a.SYNC_DIRECTION.NEWER})];case 2:t.sent();t.label=3;case 3:return[2,this._smsGroupService.smsGroupFetchController.fetchEntities(e)]}}))}))};SMSService.prototype.getRCItemFetchController=function(){return this.smsFetchController};SMSService.prototype.buildNotificationController=function(){return new Me(this.userConfig)};Object.defineProperty(SMSService.prototype,"smsFetchController",{get:function(){if(!this._smsFetchController){this._smsFetchController=new Oe(this.userConfig,this.getEntitySource(),this.smsBadgeController,this.smsDataController,this.getEntityNotificationController(),this.smsDao,this._smsGroupService)}return this._smsFetchController},enumerable:true,configurable:true});Object.defineProperty(SMSService.prototype,"smsPurgeController",{get:function(){if(!this._smsPurgeController){this._smsPurgeController=new ze(this.getEntitySource(),this.smsDataController)}return this._smsPurgeController},enumerable:true,configurable:true});Object.defineProperty(SMSService.prototype,"smsBadgeController",{get:function(){if(!this._smsBadgeController){this._smsBadgeController=new oe(this.getEntitySource(),this.smsActionController,this.smsDao)}return this._smsBadgeController},enumerable:true,configurable:true});Object.defineProperty(SMSService.prototype,"smsDataController",{get:function(){if(!this._smsDataController){this._smsDataController=new fe(this.getEntitySource(),this.userConfig,this.preInsertController,this.smsDraftController,this.smsDao,this._smsGroupService)}return this._smsDataController},enumerable:true,configurable:true});Object.defineProperty(SMSService.prototype,"preInsertController",{get:function(){var e=this;if(!this._smsPreInsertController){var t=o.Nz.getInstance();this._smsPreInsertController=new n.PreInsertController({progressService:t,entitySourceController:this.getEntitySource(),preInsertKeyGetter:function(e){return e.__preInsertId||e.id},notificationKeyGetter:function(t){return e.getEntitySource().getEntityNotificationKeyByEntity(t)},moduleName:T.ut})}return this._smsPreInsertController},enumerable:true,configurable:true});Object.defineProperty(SMSService.prototype,"smsActionController",{get:function(){if(!this._smsActionController){this._smsActionController=new Z(this.getEntitySource(),this._buildPartialModifyController(),this.smsDataController,this.smsDraftController,this.preInsertController,this.smsDao,this._smsGroupService)}return this._smsActionController},enumerable:true,configurable:true});Object.defineProperty(SMSService.prototype,"smsDao",{get:function(){return this.dao},enumerable:true,configurable:true});Object.defineProperty(SMSService.prototype,"smsDraftController",{get:function(){if(!this._smsDraftController){this._smsDraftController=new F(this._smsGroupService)}return this._smsDraftController},enumerable:true,configurable:true});Object.defineProperty(SMSService.prototype,"smsSearchController",{get:function(){if(!this._smsSearchController){this._smsSearchController=new ke(this.getEntitySource(),this._smsGroupService.getEntitySource(),this.userConfig);this.smsDataController.registerSMSDataChange(this._smsSearchController.handleSMSDataUpdate)}return this._smsSearchController},enumerable:true,configurable:true});SMSService.prototype._buildPartialModifyController=function(){return new n.PartialModifyController(this.getEntitySource())};SMSService.prototype._listenInstantMessage=function(e){var t=this.getRCItemFetchController().handleRCInstantMessageEvent;if(!t)return;this.subscribeRCMessageEvent(e,s.RCSubscriptionKeys.InstantMessageStore,t)};return SMSService}(a.AbstractRCItemService)},17228:(e,t,r)=>{"use strict";r.d(t,{k:()=>n,M:()=>o});var n;(function(e){e[e["SYNC"]=0]="SYNC";e[e["USER_FETCH"]=1]="USER_FETCH";e[e["LOCAL_PREINSERT"]=2]="LOCAL_PREINSERT";e[e["SEND_RESPONSE"]=3]="SEND_RESPONSE";e[e["LOCAL_MODIFICATION"]=4]="LOCAL_MODIFICATION"})(n||(n={}));var o;(function(e){e[e["TEXT"]=0]="TEXT";e[e["CONTACT"]=1]="CONTACT"})(o||(o={}))},74145:(e,t,r)=>{"use strict";r.d(t,{F:()=>M});var n=r(298784);var o=r.n(n);var i=r(667489);var a=r.n(i);var s=r(862926);var u=r.n(s);var l=r(158820);var c=r(587040);var S=r(827027);var f=r(266816);var d=r(975027);var p=undefined&&undefined.__read||function(e,t){var r=typeof Symbol==="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,i=[],a;try{while((t===void 0||t-- >0)&&!(o=n.next()).done)i.push(o.value)}catch(e){a={error:e}}finally{try{if(o&&!o.done&&(r=n["return"]))r.call(n)}finally{if(a)throw a.error}}return i};var h=undefined&&undefined.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e};var _=r(661586);var v=1;var M=function(){function SMSUtils(){}SMSUtils.buildSMSGroupId=function(e,t){var r=h(o().unionBy(e),[t]).filter((function(e){return e}));var n=r.sort();var i=f.nM+"_"+n.join("_");return _(i)};SMSUtils.buildAttachment=function(e){return e?e.map((function(e){return{id:-(0,i.randomInt)(),type:l.ATTACHMENT_TYPE.MMS_ATTACHMENT,size:e.size,contentType:e.type,fileName:e.name,uri:""}})):[]};SMSUtils.getSMSSearchSortTimestamp=function(e){return e.lastSMSTimestamp||e.lastAccessAt||0};SMSUtils.extractCallersFromSMS=function(e,t){if(e.to.length===v||e.direction===S.CALL_DIRECTION.OUTBOUND){return{myNumber:l.RCItemUtils.getNumbersBySide(e,true)[0],otherCallers:l.RCItemUtils.getCallerBySide(e,false)}}var r=l.RCItemUtils.getToNumbers(e);var n=l.RCItemUtils.getFromNumber(e);var i=e.to.slice();var a=e.from;var s=r.find((function(e){return t.includes(e)}));if(!s&&t.includes(n)){s=n}var u=h(i.filter((function(e){return l.RCItemUtils.getNumberFromCaller(e)!==s})),[a]);return{myNumber:s||"",otherCallers:o().unionBy(u,(function(e){return e.phoneNumber}))}};SMSUtils.buildTempSMSForSearch=function(e){return{id:-(0,i.randomInt)(),subject:"",__timestamp:SMSUtils.getSMSSearchSortTimestamp(e),__groupId:e.id}};SMSUtils.getSMSNotificationKey=function(e){return SMSUtils.assembleSMSNotificationKey(e.__groupId)};SMSUtils.assembleSMSNotificationKey=function(e){return d.c9+"."+(e||"*")};SMSUtils.reportFailedSMSInfo=function(e,t){var r,n;var o={sentTime:e.__timestamp,userId:((n=(r=(0,c.gT)())===null||r===void 0?void 0:r.userConfig)===null||n===void 0?void 0:n.getExtensionId())||0,to:e.to,from:e.from,messageStatus:e.messageStatus||l.MESSAGE_STATUS.SENDING_FAILED,type:S.RC_MESSAGE_TYPE.SMS,messageId:e.id,error:t,level:s.LOG_CONTROL_LEVEL.HIGH};l.RCItemUtils.reportFailedRCItem(o)};return SMSUtils}()},818017:()=>{},553362:(e,t,r)=>{"use strict";r.d(t,{SMSGroupDao:()=>S,SMSGroupService:()=>L});var n=r(818017);var o=r(667489);var i=r(95279);var a=r(158820);var s=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var u=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var l=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var c={lastSMSTimestamp:"lastSMSTimestamp"};var S=function(e){s(SMSGroupDao,e);function SMSGroupDao(t){return e.call(this,SMSGroupDao.COLLECTION_NAME,t)||this}SMSGroupDao.prototype.getCollection=function(){return this.getDb().getCollection(SMSGroupDao.COLLECTION_NAME)};SMSGroupDao.prototype.queryGroups=function(e){return u(this,void 0,Promise,(function(){var t,r,n,o,s,u,S,f,d,p;return l(this,(function(l){switch(l.label){case 0:t=e.limit,r=t===void 0?a.DEFAULT_FETCH_SIZE:t,n=e.direction,o=n===void 0?i.QUERY_DIRECTION.OLDER:n,s=e.anchorId;S=s;if(!S)return[3,2];return[4,this.get(s)];case 1:S=l.sent();l.label=2;case 2:u=S||undefined;f=this.createQuery();d=u&&u.lastSMSTimestamp;if(o===i.QUERY_DIRECTION.OLDER){d=d||Number.MAX_VALUE;f=f.lessThan(c.lastSMSTimestamp,d).orderBy(c.lastSMSTimestamp,true).limit(r)}else{d=d||-1;f=f.greaterThan(c.lastSMSTimestamp,d).orderBy(c.lastSMSTimestamp,false).limit(r)}return[4,f.toArray()];case 3:p=l.sent();return[2,{hasMore:e.limit===p.length,data:p}]}}))}))};SMSGroupDao.COLLECTION_NAME="smsGroup";return SMSGroupDao}(i.BaseDao);var f=r(642107);var d=r(862926);var p=r(74145);var h=r(975027);var _=r(22146);var v=_.k.subModule("[SMS_GROUP]");var M={INVALID_PARAMETERS:"INVALID_SMS_GROUP_PARAMETERS"};var y="SMS_GROUP_ERROR";var m=undefined&&undefined.__assign||function(){m=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var o in t)if(Object.prototype.hasOwnProperty.call(t,o))e[o]=t[o]}return e};return m.apply(this,arguments)};var g=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var C=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var E=undefined&&undefined.__read||function(e,t){var r=typeof Symbol==="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),o,i=[],a;try{while((t===void 0||t-- >0)&&!(o=n.next()).done)i.push(o.value)}catch(e){a={error:e}}finally{try{if(o&&!o.done&&(r=n["return"]))r.call(n)}finally{if(a)throw a.error}}return i};var b=undefined&&undefined.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(E(arguments[t]));return e};var I="SMSGroupDataController";var T=v.tags(I);var A=function(){function SMSGroupDataController(e){this._entitySourceController=e}Object.defineProperty(SMSGroupDataController.prototype,"partialModifyController",{get:function(){if(!this._partialModifyController){this._partialModifyController=(0,o.buildPartialModifyController)(this._entitySourceController)}return this._partialModifyController},enumerable:true,configurable:true});SMSGroupDataController.prototype.addSendFailedSMSIds=function(e,t){return g(this,void 0,void 0,(function(){var r,n;return C(this,(function(o){switch(o.label){case 0:return[4,this.getSendFailedSMSIds(e)];case 1:r=o.sent();n=b(new Set(b(r,[t])));return[2,this.updateSMSGroup(e,{id:e,failedSMSIds:n})]}}))}))};SMSGroupDataController.prototype.removeSendFailedSMSIds=function(e,t){return g(this,void 0,void 0,(function(){var r,n;return C(this,(function(o){switch(o.label){case 0:return[4,this.getSendFailedSMSIds(e)];case 1:r=o.sent();n=r.filter((function(e){return e!==t}));return[2,this.updateSMSGroup(e,{id:e,failedSMSIds:n})]}}))}))};SMSGroupDataController.prototype.getSendFailedSMSIds=function(e){return g(this,void 0,void 0,(function(){var t;return C(this,(function(r){switch(r.label){case 0:return[4,this._entitySourceController.get(e)];case 1:t=r.sent();return[2,t&&t.failedSMSIds||[]]}}))}))};SMSGroupDataController.prototype.updateSMSGroup=function(e,t){return g(this,void 0,void 0,(function(){var r;return C(this,(function(n){switch(n.label){case 0:T.log("_updateSMSGroup with data",t);n.label=1;case 1:n.trys.push([1,3,,4]);return[4,this.partialModifyController.updatePartially({entityId:e,preHandlePartialEntity:function(e){return m(m({},e),t)},doUpdateEntity:function(e){return Promise.resolve(e)}})];case 2:n.sent();return[3,4];case 3:r=n.sent();T.warn("_updateSMSGroup with error",r);return[3,4];case 4:return[2]}}))}))};SMSGroupDataController.prototype.getOrCreateGroupByPhoneNumber=function(e,t){return g(this,void 0,void 0,(function(){var r,n,i,a,s,u;var l=this;return C(this,(function(c){switch(c.label){case 0:T.log("createGroupByPhoneNumber, raw parameters",(0,d.sensitive)({otherNumbers:e,myNumber:t},["otherNumbers","myNumber"]));r=(0,o.getModule)(f.PHONE_PARSER_MODULE);return[4,Promise.all(b(e,[t]).map((function(e){return g(l,void 0,void 0,(function(){var t;return C(this,(function(n){switch(n.label){case 0:return[4,r.getPhoneParser(e)];case 1:t=n.sent();return[2,t&&t.getE164()]}}))}))})))];case 1:n=c.sent().filter((function(e){return e}));i=n.pop();a=n;if(!i||!a.length||a.length!==e.length){throw new d.JError(y,M.INVALID_PARAMETERS,M.INVALID_PARAMETERS,{otherNumbers:e,myNumber:t})}s=p.F.buildSMSGroupId(a,i);return[4,this._entitySourceController.get(s)];case 2:u=c.sent();if(!!u)return[3,4];u=this._buildEmptySMSGroup(a,i);return[4,this._entitySourceController.put(u)];case 3:c.sent();o.notificationCenter.emitEntityUpdate(h.$q.ENTITY.SMS_GROUP,[u]);T.log("createGroupByPhoneNumber",u.id);c.label=4;case 4:return[2,u]}}))}))};SMSGroupDataController.prototype._buildEmptySMSGroup=function(e,t){var r=p.F.buildSMSGroupId(e,t);return{otherCallers:e.map((function(e){return{phoneNumber:e}})),myNumber:t,id:r,hasMoreOlder:true,lastAccessAt:Date.now(),deactivated:false}};return SMSGroupDataController}();var O=r(390582);var N;(function(e){e["FETCH_SMS_GROUP_FROM_DB"]="fetch_sms_group_from_db"})(N||(N={}));var D=undefined&&undefined.__awaiter||function(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Promise))((function(r,o){function fulfilled(e){try{step(n.next(e))}catch(e){o(e)}}function rejected(e){try{step(n["throw"](e))}catch(e){o(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))};var R=undefined&&undefined.__generator||function(e,t){var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},n,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(e){return function(t){return step([e,t])}}function step(a){if(n)throw new TypeError("Generator is already executing.");while(r)try{if(n=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:r.label++;return{value:a[1],done:false};case 5:r.label++;o=a[1];a=[0];continue;case 7:a=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){r=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(a[0]===6&&r.label<i[1]){r.label=i[1];i=a;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(a);break}if(i[2])r.ops.pop();r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e];o=0}finally{n=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var w=a.logger.tags("SMSGroupFetchController");var G=function(){function SMSGroupFetchController(e){this._entitySourceController=e}SMSGroupFetchController.prototype.fetchEntities=function(e){return D(this,void 0,Promise,(function(){var t,r;return R(this,(function(n){switch(n.label){case 0:w.log("do fetchEntities",e);t=a.logger.performance();return[4,this._querySMSGroupFromAll(e)];case 1:r=n.sent();t.end({key:N.FETCH_SMS_GROUP_FROM_DB,level:d.LOG_CONTROL_LEVEL.HIGH,count:r.data.length,infos:{options:e}});return[2,r]}}))}))};SMSGroupFetchController.prototype._querySMSGroupFromAll=function(e){return D(this,void 0,Promise,(function(){var t,r;var n=this;return R(this,(function(o){switch(o.label){case 0:r=e.anchorId;if(!r)return[3,2];return[4,this._entitySourceController.get(e.anchorId)];case 1:r=o.sent();o.label=2;case 2:t=r||undefined;return[2,O.KA.fetchItem({anchor:t,direction:e.direction,limit:e.limit,sortFunc:function(e,t){var r=Math.max(e.lastSMSTimestamp||0,e.lastAccessAt||0);var n=Math.max(t.lastSMSTimestamp||0,t.lastAccessAt||0);return r-n},filterFunc:function(t){return!!(t.otherCallers&&(!e.filterFunc||e.filterFunc(t)))},getEntitiesFunc:function(){return n._entitySourceController.getAll()}})]}}))}))};return SMSGroupFetchController}();var P=undefined&&undefined.__extends||function(){var extendStatics=function(e,t){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r]};return extendStatics(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=t===null?Object.create(t):(__.prototype=t.prototype,new __)}}();var L=function(e){P(SMSGroupService,e);function SMSGroupService(t){return e.call(this,{isSupportedCache:false},{dao:t.getDao(S)})||this}Object.defineProperty(SMSGroupService.prototype,"smsGroupDataController",{get:function(){if(!this._smsGroupDataController){this._smsGroupDataController=new A(this.getEntitySource())}return this._smsGroupDataController},enumerable:true,configurable:true});Object.defineProperty(SMSGroupService.prototype,"smsGroupFetchController",{get:function(){if(!this._smsGroupFetchController){this._smsGroupFetchController=new G(this.getEntitySource())}return this._smsGroupFetchController},enumerable:true,configurable:true});SMSGroupService.prototype.getDao=function(){return this.dao};return SMSGroupService}(o.EntityBaseService)}}]);