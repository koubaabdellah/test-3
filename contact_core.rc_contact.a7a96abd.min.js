"use strict";(this["webpackChunkapplication"]=this["webpackChunkapplication"]||[]).push([[9281],{905339:(t,e,n)=>{n.r(e);n.d(e,{RCContactModule:()=>S});var r=n(461197);var o=n(831270);var i=n(960782);var a=n(587040);var c=n(470033);var u=n(960172);var l=n(822896);var s=n(665939);var C=n(934316);var gen=function(t,e,n){if(t===void 0){t="id"}if(e===void 0){e=[]}return{unique:t,indices:e,onUpgrade:n}};var f={name:"RCContact",version:1,schema:{1:{rcContact:gen(),userConfigs:gen("key")},2:{userConfigs:gen("key")}}};const p=f;var h=n(713757);var d=n(667489);var _=undefined&&undefined.__extends||function(){var extendStatics=function(t,e){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return extendStatics(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=e===null?Object.create(e):(__.prototype=e.prototype,new __)}}();var y=function(t){_(GetRCContactTypeKeyAction,t);function GetRCContactTypeKeyAction(e){if(e===void 0){e=d.ActionWeight.NORMAL}return t.call(this,e)||this}Object.defineProperty(GetRCContactTypeKeyAction.prototype,"rcContactModule",{get:function(){if(!this._rcContactModule){this._rcContactModule=(0,d.getModule)(C.oF)}return this._rcContactModule},enumerable:true,configurable:true});GetRCContactTypeKeyAction.prototype.getAction=function(){return Promise.resolve(this.rcContactModule.getRCContactType())};return GetRCContactTypeKeyAction}(d.AbstractKeyAction);var v=undefined&&undefined.__extends||function(){var extendStatics=function(t,e){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return extendStatics(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=e===null?Object.create(e):(__.prototype=e.prototype,new __)}}();var R=undefined&&undefined.__awaiter||function(t,e,n,r){function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}return new(n||(n=Promise))((function(n,o){function fulfilled(t){try{step(r.next(t))}catch(t){o(t)}}function rejected(t){try{step(r["throw"](t))}catch(t){o(t)}}function step(t){t.done?n(t.value):adopt(t.value).then(fulfilled,rejected)}step((r=r.apply(t,e||[])).next())}))};var g=undefined&&undefined.__generator||function(t,e){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(t){return function(e){return step([t,e])}}function step(a){if(r)throw new TypeError("Generator is already executing.");while(n)try{if(r=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;o=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=e.call(t,n)}catch(t){a=[6,t];o=0}finally{r=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var b=h.k.tags("[RCContactModule]");var S=function(t){v(RCContactModule,t);function RCContactModule(e){var n=t.call(this,e)||this;n._getModuleInfo=function(){return R(n,void 0,void 0,(function(){var t,e;return g(this,(function(n){switch(n.label){case 0:if(!this.isLoaded())return[3,2];t=this.contactService.rcContactFetchController;return[4,this.contactService.getEntitySource().getTotalCount()];case 1:e=n.sent();return[2,{lastSyncTime:t.getLastSyncTime(),totalCount:e}];case 2:return[2,{}]}}))}))};return n}RCContactModule.prototype.onLoad=function(){this._setupNetworkClient();this.startService();this._onMessagePermissionChange();this.getHealthController().registerItemMap({RCContactModuleInfo:this._getModuleInfo});this._initCommonKeyAction()};RCContactModule.prototype.onUnload=function(){this.contactService.stop();this._unregisterContactSource()};RCContactModule.prototype.getSchema=function(){return p};RCContactModule.prototype.moduleName=function(){return C.oF};RCContactModule.prototype.startService=function(){!this.contactService.isStarted()&&this.contactService.start()};RCContactModule.prototype.getService=function(){return this.contactService};RCContactModule.prototype.getAllPhoneNumbers=function(t,e){return this.contactService.getAllPhoneNumbers(t,e)};RCContactModule.prototype.getContactEmailByExtensionId=function(t){return this.contactService.getContactEmailByExtensionId(t)};RCContactModule.prototype.getContactGroupIdByExtensionId=function(t){return this.contactService.getContactGroupIdByExtensionId(t)};Object.defineProperty(RCContactModule.prototype,"contactService",{get:function(){if(!this._rcContactService){this._rcContactService=new l.S(this.daoManager)}return this._rcContactService},enumerable:true,configurable:true});RCContactModule.prototype._setupNetworkClient=function(){var t=(0,a.gT)();if(t){s.RCContactApi.networkClient=t.buildNetworkClient()}};RCContactModule.prototype._onMessagePermissionChange=function(){var t=c.H3.RCExtensionFeaturesId.Glip;var e=this._context.entitlement.get(t);if(e===undefined){this._context.entitlement.onChange(t,this._unregisterContactSource.bind(this),this._registerContactSource.bind(this))}else if(e===false){this._registerContactSource()}};RCContactModule.prototype._registerContactSource=function(){(0,r.getModule)(o.MODULE_NAME).subscribeContactSource(this.contactService);(0,r.getModule)(u.SEARCH_MODULE_NAME).registerSearchDataProvider(this.contactService.rcContactSearchDataProviderController)};RCContactModule.prototype._unregisterContactSource=function(){(0,r.getModule)(o.MODULE_NAME).unsubscribeContactSource(this.contactService.getType());(0,r.getModule)(u.SEARCH_MODULE_NAME).unRegisterSearchDataProvider(this.contactService.rcContactSearchDataProviderController)};RCContactModule.prototype.onDBRecoverRequire=function(){b.log("RCContact DB is recovering now");if(!s.RCContactApi.networkClient){this._setupNetworkClient()}this.contactService.recoverRCContactList()};RCContactModule.prototype.getRCContactType=function(){return this.contactService.getType()};RCContactModule.prototype.getCurrentContactGroupId=function(){return this.contactService.getCurrentContactGroupId()};RCContactModule.prototype._initCommonKeyAction=function(){var t=(0,r.getModule)(i.COMMON_KEY_ACTION_MODULE).getKeyActionService();t.register(i.ACTION_KEY.GET_RC_CONTACT_TYPE,new y)};return RCContactModule}(r.AbstractModule)},665939:(t,e,n)=>{n.d(e,{RCContactApi:()=>c});var r=n(862926);var o=n(667489);var i="/v1.0";var a={DIRECTORY_CONTACTS:i+"/account/~/directory/contacts"};var c=function(){function RCContactApi(){}RCContactApi.fetchRCContactList=function(t,e){var n;var i=(n={},n[r.REQUEST_HEADER_KEYS.IF_NONE_MATCH]=e,n);var c={method:r.NETWORK_METHOD.GET,path:r.RequestPath.buildRequestPath(a.DIRECTORY_CONTACTS+"?type="+r.FORMAT_MARK+"&excludeFederatedContacts="+r.FORMAT_MARK,"User",""+false),via:r.NETWORK_VIA.HTTP,params:t,headers:i,retryCount:r.DEFAULT_RETRY_COUNT,thresholdPriority:o.THRESHOLD_PRIORITY.SPECIAL};return RCContactApi.networkClient.rawRequest(c)};return RCContactApi}()},934316:(t,e,n)=>{n.d(e,{m:()=>i,oF:()=>o,LZ:()=>u,yK:()=>s,FY:()=>l,wH:()=>C,Vo:()=>f,wY:()=>c,rn:()=>p});var r=n(295454);var o=r.Lb.RC_CONTACT;var i={FETCH_RC_CONTACT_LIST:"FETCH_RC_CONTACT_LIST"};var a=1e3;var c="rc_contact_list";var u={MATCH_RC_CONTACT_BY_PHONE_NUMBER:"match_rc_contact_by_phone_number",SEARCH_PERSON_BY_RC:"search_person_by_rc",SEARCH_PHONE_NUMBER_BY_RC:"search_phone_number_by_rc",SEARCH_EMAIL_BY_RC:"search_email_by_rc"};var l={ENTITY:{RC_CONTACT:"ENTITY.RC_CONTACT"}};var s=2;var C="RC_CONTACT_DATA_PROVIDER";var f={RC_CONTACT:"people"};var p={E_TAG:"e_tag"}},9461:(t,e,n)=>{n.d(e,{Z:()=>r,E:()=>o});var r={UPDATE:"Update",CREATE:"Create",DELETE:"Delete"};var o={DISABLED:"Disabled",ENABLED:"Enabled"}},713757:(t,e,n)=>{n.d(e,{k:()=>c});var r=n(862926);var o=n.n(r);var i=n(827027);var a="[RC_CONTACT][CORE]";var c=r.ModuleLogger.getLogger(a,(function(){var t=[];for(var e=0;e<arguments.length;e++){t[e]=arguments[e]}return t}),i.PHONE_EVENT_DATA_FEATURE_KEY)},822896:(t,e,n)=>{n.d(e,{S:()=>tt});var r=n(298784);var o=n.n(r);var i=n(667489);var a=n(862926);var c=n(960782);var u=n(831270);var l=n(228164);var s=n(295454);var C=n(470033);var f=n(587040);var p=n(749514);var h=n(487151);var d=n(17297);var _=n(665939);var y=n(934316);var v=n(9461);var R=n(713757);var g=undefined&&undefined.__extends||function(){var extendStatics=function(t,e){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return extendStatics(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=e===null?Object.create(e):(__.prototype=e.prototype,new __)}}();var b=function(t){g(RCContactDao,t);function RCContactDao(e){return t.call(this,RCContactDao.COLLECTION_NAME,e)||this}RCContactDao.COLLECTION_NAME="rcContact";return RCContactDao}(i.BaseDao);var S=undefined&&undefined.__extends||function(){var extendStatics=function(t,e){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return extendStatics(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=e===null?Object.create(e):(__.prototype=e.prototype,new __)}}();var E=undefined&&undefined.__awaiter||function(t,e,n,r){function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}return new(n||(n=Promise))((function(n,o){function fulfilled(t){try{step(r.next(t))}catch(t){o(t)}}function rejected(t){try{step(r["throw"](t))}catch(t){o(t)}}function step(t){t.done?n(t.value):adopt(t.value).then(fulfilled,rejected)}step((r=r.apply(t,e||[])).next())}))};var T=undefined&&undefined.__generator||function(t,e){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(t){return function(e){return step([t,e])}}function step(a){if(r)throw new TypeError("Generator is already executing.");while(n)try{if(r=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;o=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=e.call(t,n)}catch(t){a=[6,t];o=0}finally{r=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var O=R.k.tags("RCContactFetchController");var I=2e3;var m=function(t){S(RCContactFetchController,t);function RCContactFetchController(e,n,r,o){var i=t.call(this,{entityEventKey:y.FY.ENTITY.RC_CONTACT,jobKey:y.m.FETCH_RC_CONTACT_LIST,perfTag:y.wY,pageSize:I},r.get(b))||this;i._sourceController=e;i._cacheController=n;i._userConfig=o;return i}RCContactFetchController.prototype.handleRCContactEvent=function(t){return E(this,void 0,void 0,(function(){var e,n;return T(this,(function(r){switch(r.label){case 0:e=[];n=[];t.contacts.forEach((function(t){if(t.type===d.Pd.USER){switch(t.eventType){case v.Z.CREATE:e.push(t);break;case v.Z.UPDATE:n.push(t);break;default:break}}}));return[4,this.handleCreateContacts(e)];case 1:r.sent();return[4,this.handleUpdateContacts(n)];case 2:r.sent();return[2]}}))}))};RCContactFetchController.prototype.handleRCContactExtensionProfileEvent=function(t){return E(this,void 0,void 0,(function(){var e;return T(this,(function(n){switch(n.label){case 0:return[4,this.entitySourceController.getEntityLocally(t.id.toString())];case 1:e=n.sent();if(!e)return[3,3];h.tR.forEach((function(n){if(!t.contact[n]){e[n]=undefined}else{e[n]=t.contact[n]}}));return[4,this.entitySourceController.put(e)];case 2:n.sent();i.notificationCenter.emitEntityUpdate(y.FY.ENTITY.RC_CONTACT,[e]);n.label=3;case 3:return[2]}}))}))};RCContactFetchController.prototype.logError=function(){var t=[];for(var e=0;e<arguments.length;e++){t[e]=arguments[e]}O.log(t);u.ContactUtils.doErrorTrackingInCommon("RC_CONTACT_SYNC_FAIL",t)};RCContactFetchController.prototype.recoverRCContactList=function(){i.jobScheduler.cancelJob(y.m.FETCH_RC_CONTACT_LIST,true)};Object.defineProperty(RCContactFetchController.prototype,"logger",{get:function(){return O},enumerable:true,configurable:true});Object.defineProperty(RCContactFetchController.prototype,"userConfig",{get:function(){return this._userConfig},enumerable:true,configurable:true});Object.defineProperty(RCContactFetchController.prototype,"entitySourceController",{get:function(){return this._sourceController},enumerable:true,configurable:true});Object.defineProperty(RCContactFetchController.prototype,"entityCacheController",{get:function(){return this._cacheController},enumerable:true,configurable:true});RCContactFetchController.prototype.fetchContactApi=function(t,e){return _.RCContactApi.fetchRCContactList(t,e)};return RCContactFetchController}(u.AbstractContactFetchController);var A=n(274251);var w=undefined&&undefined.__extends||function(){var extendStatics=function(t,e){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return extendStatics(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=e===null?Object.create(e):(__.prototype=e.prototype,new __)}}();var N=function(t){w(RCContactInfoReader,t);function RCContactInfoReader(){return t!==null&&t.apply(this,arguments)||this}RCContactInfoReader.getInstance=function(){if(!this._instance){RCContactInfoReader._instance=new RCContactInfoReader}return RCContactInfoReader._instance};RCContactInfoReader.prototype.getRawName=function(t){return t.firstName&&t.lastName?t.firstName+"."+t.lastName:t.firstName||t.lastName||t.name||""};RCContactInfoReader.prototype.getOrgId=function(t){return o().toInteger(t.account.id)};RCContactInfoReader.prototype.getContactGroupId=function(t){return t.account.id};RCContactInfoReader.prototype.iteratorContactNumbers=function(t,e){if(t.extensionNumber){e({phoneNumber:t.extensionNumber,usageType:A.vX.Extension,type:A.fk.ExtType})}t.phoneNumbers&&t.phoneNumbers.forEach((function(t){e(t)}))};RCContactInfoReader.prototype.getEmails=function(t){return[{label:"",address:t.email||""}]};RCContactInfoReader.prototype.isContactHidden=function(t){return!!t.hidden};RCContactInfoReader.prototype.isMatchableContact=function(t){return(t===null||t===void 0?void 0:t.status)===v.E.ENABLED};RCContactInfoReader.prototype.getExtensionId=function(t){return t.id.toString()};return RCContactInfoReader}(u.AbstractContactInfoReader);var P=undefined&&undefined.__extends||function(){var extendStatics=function(t,e){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return extendStatics(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=e===null?Object.create(e):(__.prototype=e.prototype,new __)}}();var M=function(t){P(RCContactCacheController,t);function RCContactCacheController(e){return t.call(this,N.getInstance(),e)||this}RCContactCacheController.prototype.getMyId=function(){return(0,f.gT)().userConfig.getExtensionId().toString()};RCContactCacheController.prototype.getSearchableNumber=function(t){return this.parser.getSearchablePhoneNumbers(t,this.getMyId)};RCContactCacheController.prototype.getMyOrgId=function(){var t;if(!this._userAccountId){this._userAccountId=(t=(0,f.gT)().userConfig.getAccountId())===null||t===void 0?void 0:t.toString()}return this._userAccountId};RCContactCacheController.prototype.getContactGroupIdByExtensionId=function(t){var e;return(e=this.getSynchronously(t))===null||e===void 0?void 0:e.account.id};return RCContactCacheController}(u.ContactCacheController);var D=undefined&&undefined.__extends||function(){var extendStatics=function(t,e){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return extendStatics(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=e===null?Object.create(e):(__.prototype=e.prototype,new __)}}();var x=function(t){D(RCContactSearchController,t);function RCContactSearchController(e){return t.call(this,N.getInstance(),e)||this}RCContactSearchController.prototype.getMyOrgId=function(){return(0,f.gT)().userConfig.getAccountId()};RCContactSearchController.prototype.getMyId=function(){return this.contactCacheController.getMyId()};RCContactSearchController.prototype.isValidContactForSearch=function(t){return!!t&&t.status!==v.E.DISABLED&&(!this.contactCacheController.parser.isContactHidden(t)||t.id===this.getMyId())};RCContactSearchController.prototype.filterContacts=function(t,e){var n,r;if(!t){return false}if((n=e.filterOption)===null||n===void 0?void 0:n.excludeCompany){return false}var o=(r=e.filterOption)===null||r===void 0?void 0:r.contactGroupIds;if(o&&!o.has(t.account.id)){return false}return this.filter({contact:t,searchTerms:e.searchTerms,checkNameOnly:e.checkNameOnly,skipValidate:e.skipValidate})};return RCContactSearchController}(u.AbstractContactSearchController);var F=n(960172);var L=undefined&&undefined.__extends||function(){var extendStatics=function(t,e){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return extendStatics(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=e===null?Object.create(e):(__.prototype=e.prototype,new __)}}();var k=function(t){L(RCContactSearchDataProviderController,t);function RCContactSearchDataProviderController(e){return t.call(this,e.recentSearchConfig)||this}RCContactSearchDataProviderController.prototype.providerName=function(){return y.wH};RCContactSearchDataProviderController.prototype.shouldSaveRecord=function(e){return t.prototype.shouldSaveRecord.call(this,e)||Object.values(y.Vo).includes(e.type)};return RCContactSearchDataProviderController}(F.a);var U=undefined&&undefined.__awaiter||function(t,e,n,r){function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}return new(n||(n=Promise))((function(n,o){function fulfilled(t){try{step(r.next(t))}catch(t){o(t)}}function rejected(t){try{step(r["throw"](t))}catch(t){o(t)}}function step(t){t.done?n(t.value):adopt(t.value).then(fulfilled,rejected)}step((r=r.apply(t,e||[])).next())}))};var G=undefined&&undefined.__generator||function(t,e){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(t){return function(e){return step([t,e])}}function step(a){if(r)throw new TypeError("Generator is already executing.");while(n)try{if(r=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;o=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=e.call(t,n)}catch(t){a=[6,t];o=0}finally{r=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var j=undefined&&undefined.__read||function(t,e){var n=typeof Symbol==="function"&&t[Symbol.iterator];if(!n)return t;var r=n.call(t),o,i=[],a;try{while((e===void 0||e-- >0)&&!(o=r.next()).done)i.push(o.value)}catch(t){a={error:t}}finally{try{if(o&&!o.done&&(n=r["return"]))n.call(r)}finally{if(a)throw a.error}}return i};var z=undefined&&undefined.__spread||function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(j(arguments[e]));return t};var Y=R.k.tags("[RCContactSanitizeDataCacheController]");var B=function(){function RCContactSanitizeDataCacheController(t){var e=this;this._entitySourceController=t;this._sanitizeCache=new Map;this._contactServerDataWaiter=new a.Barrier;this._contactCacheDataWaiter=new a.Barrier;this._isWaitingContactReady=false;this._handleRCContactChange=function(t){return U(e,void 0,void 0,(function(){var e;var n=this;return G(this,(function(r){switch(r.label){case 0:e=this._getEntityInfoFromPayload(t);if(!e.isReload)return[3,2];return[4,this.initCacheData()];case 1:r.sent();return[3,3];case 2:e.updateAddEntities.forEach((function(t){return n._updateCacheInfo(t)}));e.deletedIds.forEach((function(t){return n._sanitizeCache.delete(t)}));r.label=3;case 3:return[2]}}))}))}}RCContactSanitizeDataCacheController.prototype.init=function(){Y.log("init controller");i.notificationCenter.on(y.FY.ENTITY.RC_CONTACT,this._handleRCContactChange)};RCContactSanitizeDataCacheController.prototype.dispose=function(){Y.log("dispose controller");this._sanitizeCache.clear();i.notificationCenter.off(y.FY.ENTITY.RC_CONTACT,this._handleRCContactChange)};RCContactSanitizeDataCacheController.prototype.initCacheData=function(){return U(this,void 0,void 0,(function(){var t;var e=this;return G(this,(function(n){switch(n.label){case 0:Y.log("init controller cache");this._sanitizeCache.clear();return[4,this._entitySourceController.getAll()];case 1:t=n.sent();t.forEach((function(t){return e._updateCacheInfo(t)}));this._contactCacheDataWaiter.open();return[2]}}))}))};RCContactSanitizeDataCacheController.prototype.getEmailByExtensionId=function(t){var e;return U(this,void 0,void 0,(function(){return G(this,(function(n){switch(n.label){case 0:return[4,this._waitRCContactReady()];case 1:n.sent();return[2,(e=this._sanitizeCache.get(t))===null||e===void 0?void 0:e.email]}}))}))};RCContactSanitizeDataCacheController.prototype.getContactGroupIdByExtensionId=function(t){var e;return(e=this._sanitizeCache.get(t))===null||e===void 0?void 0:e.accountId};RCContactSanitizeDataCacheController.prototype.getContactGroupIdMap=function(){return U(this,void 0,Promise,(function(){var t;return G(this,(function(e){switch(e.label){case 0:t=new Map;return[4,this._waitRCContactReady()];case 1:e.sent();this._sanitizeCache.forEach((function(e,n){(e===null||e===void 0?void 0:e.accountId)&&t.set(n,e.accountId)}));return[2,t]}}))}))};RCContactSanitizeDataCacheController.prototype._waitRCContactReady=function(){return U(this,void 0,void 0,(function(){var t,e;var n=this;return G(this,(function(r){switch(r.label){case 0:if(!!this._contactCacheDataWaiter.isOpen())return[3,2];Y.log("should wait until sanitize contact cache ready");return[4,this._contactCacheDataWaiter.wait()];case 1:r.sent();r.label=2;case 2:if(!!this._contactServerDataWaiter.isOpen())return[3,4];Y.log("should wait until contact synced");if(this._hasSyncedAlready()){this._contactServerDataWaiter.open()}else if(!this._isWaitingContactReady){this._isWaitingContactReady=true;t=i.jobScheduler.userConfig;e=function(){Y.log("rc contact synced",n._hasSyncedAlready());n._contactServerDataWaiter.open();t.off(y.m.FETCH_RC_CONTACT_LIST,e)};t.on(y.m.FETCH_RC_CONTACT_LIST,e)}return[4,this._contactServerDataWaiter.wait()];case 3:r.sent();r.label=4;case 4:return[2]}}))}))};RCContactSanitizeDataCacheController.prototype._hasSyncedAlready=function(){return i.jobScheduler.getLastSuccessTime(y.m.FETCH_RC_CONTACT_LIST)>0};RCContactSanitizeDataCacheController.prototype._updateCacheInfo=function(t){this._sanitizeCache.set(t.id,{email:t.email,accountId:t.account.id})};RCContactSanitizeDataCacheController.prototype._getEntityInfoFromPayload=function(t){var e,n;var r={updateAddEntities:[],deletedIds:[],isReload:false};switch(t.type){case i.EVENT_TYPES.UPDATE:(e=r.updateAddEntities).push.apply(e,z(Array.from(t.body.entities.values())));break;case i.EVENT_TYPES.DELETE:(n=r.deletedIds).push.apply(n,z(t.body.ids));break;case i.EVENT_TYPES.RELOAD:r.isReload=true;break;default:break}return r};return RCContactSanitizeDataCacheController}();var H=undefined&&undefined.__extends||function(){var extendStatics=function(t,e){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return extendStatics(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=e===null?Object.create(e):(__.prototype=e.prototype,new __)}}();var K=undefined&&undefined.__awaiter||function(t,e,n,r){function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}return new(n||(n=Promise))((function(n,o){function fulfilled(t){try{step(r.next(t))}catch(t){o(t)}}function rejected(t){try{step(r["throw"](t))}catch(t){o(t)}}function step(t){t.done?n(t.value):adopt(t.value).then(fulfilled,rejected)}step((r=r.apply(t,e||[])).next())}))};var V=undefined&&undefined.__generator||function(t,e){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(t){return function(e){return step([t,e])}}function step(a){if(r)throw new TypeError("Generator is already executing.");while(n)try{if(r=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;o=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=e.call(t,n)}catch(t){a=[6,t];o=0}finally{r=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var W=function(t){H(RCContactUserConfig,t);function RCContactUserConfig(e,n){var r=t.call(this,e,n)||this;r._recentSearchUserConfig=new F.RecentSearchUserConfig(r);return r}RCContactUserConfig.prototype.get=function(t,e){if(e===void 0){e=false}var n;return K(this,void 0,void 0,(function(){var r;return V(this,(function(o){switch(o.label){case 0:return[4,this._configService.get(y.oF,t,e)];case 1:if(!((n=o.sent())!==null&&n!==void 0))return[3,2];r=n;return[3,4];case 2:return[4,this._configService.get("rc_contact",t,e)];case 3:r=o.sent();o.label=4;case 4:return[2,r]}}))}))};Object.defineProperty(RCContactUserConfig.prototype,"recentSearchConfig",{get:function(){return this._recentSearchUserConfig},enumerable:true,configurable:true});RCContactUserConfig.prototype.setETag=function(t){return this.put(y.rn.E_TAG,t)};RCContactUserConfig.prototype.getETag=function(){return this.get(y.rn.E_TAG)};RCContactUserConfig.prototype.removeETag=function(){return this.remove(y.rn.E_TAG)};return RCContactUserConfig}(i.DBConfig);var Z=undefined&&undefined.__extends||function(){var extendStatics=function(t,e){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(e.hasOwnProperty(n))t[n]=e[n]};return extendStatics(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=e===null?Object.create(e):(__.prototype=e.prototype,new __)}}();var q=undefined&&undefined.__awaiter||function(t,e,n,r){function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}return new(n||(n=Promise))((function(n,o){function fulfilled(t){try{step(r.next(t))}catch(t){o(t)}}function rejected(t){try{step(r["throw"](t))}catch(t){o(t)}}function step(t){t.done?n(t.value):adopt(t.value).then(fulfilled,rejected)}step((r=r.apply(t,e||[])).next())}))};var J=undefined&&undefined.__generator||function(t,e){var n={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},r,o,i,a;return a={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(a[Symbol.iterator]=function(){return this}),a;function verb(t){return function(e){return step([t,e])}}function step(a){if(r)throw new TypeError("Generator is already executing.");while(n)try{if(r=1,o&&(i=a[0]&2?o["return"]:a[0]?o["throw"]||((i=o["return"])&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;if(o=0,i)a=[a[0]&2,i.value];switch(a[0]){case 0:case 1:i=a;break;case 4:n.label++;return{value:a[1],done:false};case 5:n.label++;o=a[1];a=[0];continue;case 7:a=n.ops.pop();n.trys.pop();continue;default:if(!(i=n.trys,i=i.length>0&&i[i.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!i||a[1]>i[0]&&a[1]<i[3])){n.label=a[1];break}if(a[0]===6&&n.label<i[1]){n.label=i[1];i=a;break}if(i&&n.label<i[2]){n.label=i[2];n.ops.push(a);break}if(i[2])n.ops.pop();n.trys.pop();continue}a=e.call(t,n)}catch(t){a=[6,t];o=0}finally{r=i=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:true}}};var Q=undefined&&undefined.__read||function(t,e){var n=typeof Symbol==="function"&&t[Symbol.iterator];if(!n)return t;var r=n.call(t),o,i=[],a;try{while((e===void 0||e-- >0)&&!(o=r.next()).done)i.push(o.value)}catch(t){a={error:t}}finally{try{if(o&&!o.done&&(n=r["return"]))n.call(r)}finally{if(a)throw a.error}}return i};var X=undefined&&undefined.__spread||function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(Q(arguments[e]));return t};var $=undefined&&undefined.__values||function(t){var e=typeof Symbol==="function"&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&typeof t.length==="number")return{next:function(){if(t&&r>=t.length)t=void 0;return{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};var tt=function(t){Z(RCContactService,t);function RCContactService(e){var n=t.call(this,{isSupportedCache:true,entityName:b.COLLECTION_NAME,lazyLoad:true},{dao:e.getDao(b)})||this;n._handleRCContactEvent=function(t){n.rcContactFetchController.handleRCContactEvent(t)};n._handleRCContactExtensionProfileEvent=function(t){n.rcContactFetchController.handleRCContactExtensionProfileEvent(t)};n._debounceUpdateContactGroupInfo=o().debounce((function(){return q(n,void 0,void 0,(function(){return J(this,(function(t){switch(t.label){case 0:return[4,this._setContactGroupIdMap()];case 1:return[2,t.sent()]}}))}))}),s.lo.THREE_SECOND);n._updateContactGroupInfo=function(){return q(n,void 0,void 0,(function(){return J(this,(function(t){switch(t.label){case 0:return[4,this._setContactGroupIdMap()];case 1:t.sent();return[2]}}))}))};n.getCurrentContactGroupId=function(){return(0,f.gT)().userConfig.getAccountId().toString()};n._daoManager=e;return n}RCContactService.prototype.getContactInfoReader=function(){return N.getInstance()};RCContactService.prototype.getContactCacheController=function(){return this.getEntityCacheController()};RCContactService.prototype.getContactSearchController=function(){if(!this._rcContactSearchController){this._rcContactSearchController=new x(this.getContactCacheController())}return this._rcContactSearchController};RCContactService.prototype.getContactSourceInfo=function(){return{moduleName:y.oF,eventKey:y.FY.ENTITY.RC_CONTACT,priority:y.yK}};RCContactService.prototype.hasConflictPhoneNumberWithOthers=function(t){return this.getContactCacheController().hasConflictPhoneNumberWithOthers(t)};RCContactService.prototype.filter=function(t){return this.getContactSearchController().filterContacts(this.getSynchronously(t.id),t)};Object.defineProperty(RCContactService.prototype,"rcContactFetchController",{get:function(){if(!this._rcContactFetchController){this._rcContactFetchController=new m(this.getEntitySource(),this.getContactCacheController(),this._daoManager,this.userConfig)}return this._rcContactFetchController},enumerable:true,configurable:true});Object.defineProperty(RCContactService.prototype,"userConfig",{get:function(){if(!this._rcContactUserConfig){this._rcContactUserConfig=new W(y.oF,this._daoManager.getDBConfigService())}return this._rcContactUserConfig},enumerable:true,configurable:true});Object.defineProperty(RCContactService.prototype,"rcContactSearchDataProviderController",{get:function(){if(!this._rcContactSearchDataProviderController){this._rcContactSearchDataProviderController=new k(this.userConfig)}return this._rcContactSearchDataProviderController},enumerable:true,configurable:true});RCContactService.prototype.buildEntityCacheController=function(){return new M(this.entityOptions.entityName)};RCContactService.prototype.doFuzzySearchPhoneContacts=function(e,n){return q(this,void 0,Promise,(function(){var r,o;return J(this,(function(i){switch(i.label){case 0:r=R.k.performance();return[4,t.prototype.doFuzzySearchPhoneContacts.call(this,e,n)];case 1:o=i.sent();r.end({key:y.LZ.SEARCH_PHONE_NUMBER_BY_RC,level:a.LOG_CONTROL_LEVEL.HIGH});return[2,o]}}))}))};RCContactService.prototype.doFuzzySearchContacts=function(e,n){return q(this,void 0,Promise,(function(){var r,o;return J(this,(function(i){switch(i.label){case 0:r=R.k.performance();return[4,t.prototype.doFuzzySearchContacts.call(this,e,n)];case 1:o=i.sent();r.end({key:y.LZ.SEARCH_PERSON_BY_RC,level:a.LOG_CONTROL_LEVEL.HIGH});return[2,o]}}))}))};RCContactService.prototype.getUserContactId=function(){var t=(0,f.gT)().userConfig.getExtensionId();return t?u.ContactUtils.getUniqueId(y.oF,t):undefined};RCContactService.prototype.getPhoneNumbers=function(e){return t.prototype.getAllPhoneNumbers.call(this,e.phoneNumbers||[],e.extensionNumber)};RCContactService.prototype.getContactsByEmails=function(t){var e=new Map(t.map((function(t){return[t,undefined]})));this.getContactCacheController().getEntitiesSync((function(t){var n=t.email&&e.has(t.email);n&&e.set(t.email,t.id);return false}));return Promise.resolve(X(e.values()))};RCContactService.prototype.getSourceScope=function(){return"account"};RCContactService.prototype.doFuzzySearchEmailContacts=function(e,n){return q(this,void 0,Promise,(function(){var r,o;return J(this,(function(i){switch(i.label){case 0:r=R.k.performance();return[4,t.prototype.doFuzzySearchEmailContacts.call(this,e,n)];case 1:o=i.sent();r.end({key:y.LZ.SEARCH_EMAIL_BY_RC,level:a.LOG_CONTROL_LEVEL.HIGH});return[2,o]}}))}))};RCContactService.prototype.onStarted=function(){t.prototype.onStarted.call(this);this._rcNotificationModule.subscribe(l.RCSubscriptionKeys.RCContact,this._handleRCContactEvent);i.notificationCenter.on(p.FY.RC_INFO_SERVICE.USER_PROFILE_UPDATED,this._handleRCContactExtensionProfileEvent);this._commonKeyActionModule.on(c.ACTION_KEY.SET_CONTACT_GROUP_ID_MAP,this._updateContactGroupInfo);i.notificationCenter.on(y.FY.ENTITY.RC_CONTACT,this._debounceUpdateContactGroupInfo);this.rcContactFetchController.schedulePeriodicSync();this._setContactGroupIdMap()};RCContactService.prototype.onStopped=function(){t.prototype.onStopped.call(this);this._rcNotificationModule.unsubscribe(l.RCSubscriptionKeys.RCContact,this._handleRCContactEvent);i.notificationCenter.off(p.FY.RC_INFO_SERVICE.USER_PROFILE_UPDATED,this._handleRCContactExtensionProfileEvent);i.notificationCenter.off(y.FY.ENTITY.RC_CONTACT,this._debounceUpdateContactGroupInfo);this._commonKeyActionModule.off(c.ACTION_KEY.SET_CONTACT_GROUP_ID_MAP,this._updateContactGroupInfo);this.rcContactSanitizeCacheController.dispose()};RCContactService.prototype.onAppRestored=function(){t.prototype.onAppRestored.call(this);this._initEntityCache()};RCContactService.prototype._initEntityCache=function(){if(this._isRCOnlyMode){this.initialEntitiesCache()}else{this.rcContactSanitizeCacheController.init();this.rcContactSanitizeCacheController.initCacheData()}};Object.defineProperty(RCContactService.prototype,"_isRCOnlyMode",{get:function(){var t=C.H3.RCExtensionFeaturesId.Glip;return!(0,i.getCurrentAccount)().context.entitlement.get(t)},enumerable:true,configurable:true});Object.defineProperty(RCContactService.prototype,"_rcNotificationModule",{get:function(){return(0,i.getModule)(l.MODULE_NAME)},enumerable:true,configurable:true});Object.defineProperty(RCContactService.prototype,"rcContactSanitizeCacheController",{get:function(){if(!this._rcContactSanitizeCacheController){this._rcContactSanitizeCacheController=new B(this.getEntitySource())}return this._rcContactSanitizeCacheController},enumerable:true,configurable:true});RCContactService.prototype.getContactEmailByExtensionId=function(t){return q(this,void 0,void 0,(function(){var e;return J(this,(function(n){switch(n.label){case 0:if(!this._isRCOnlyMode)return[3,2];return[4,this.getById(t)];case 1:e=n.sent();return[2,e===null||e===void 0?void 0:e.email];case 2:return[2,this.rcContactSanitizeCacheController.getEmailByExtensionId(t)]}}))}))};RCContactService.prototype.getContactGroupIdByExtensionId=function(t){return this.rcContactSanitizeCacheController.getContactGroupIdByExtensionId(t)||this.getContactCacheController().getContactGroupIdByExtensionId(t)};RCContactService.prototype._setContactGroupIdMap=function(){var t;return q(this,void 0,void 0,(function(){var e,n,r,o;return J(this,(function(i){switch(i.label){case 0:e=this._commonKeyActionModule.get(c.ACTION_KEY.SET_CONTACT_GROUP_ID_MAP);if(!e)return[3,5];return[4,(t=e.getAction)===null||t===void 0?void 0:t.call(e)];case 1:n=i.sent();return[4,this.rcContactSanitizeCacheController.getContactGroupIdMap()];case 2:r=i.sent();o=n;if(!o)return[3,4];return[4,n(r)];case 3:o=i.sent();i.label=4;case 4:o;i.label=5;case 5:return[2]}}))}))};Object.defineProperty(RCContactService.prototype,"_commonKeyActionModule",{get:function(){return(0,i.getModule)(c.COMMON_KEY_ACTION_MODULE).getKeyActionService()},enumerable:true,configurable:true});RCContactService.prototype.matchByExtensionId=function(t){return q(this,void 0,void 0,(function(){return J(this,(function(e){switch(e.label){case 0:return[4,this.getById(t)];case 1:return[2,e.sent()?t:undefined]}}))}))};RCContactService.prototype.matchByExtensionIdSynchronously=function(t){return this.getDataByIdSynchronously(t)?t:undefined};RCContactService.prototype.recoverRCContactList=function(){this.rcContactFetchController.recoverRCContactList()};RCContactService.prototype.isDeduplicateProvider=function(){return true};RCContactService.prototype.getDeduplicateInfo=function(){return q(this,void 0,Promise,(function(){var t,e,n,r,o,i;var a,c;return J(this,(function(u){switch(u.label){case 0:t=new Map;return[4,this.getData()];case 1:e=u.sent();try{for(n=$(e),r=n.next();!r.done;r=n.next()){o=r.value;if(this.getContactSearchController().isValidContactForSearch(o)){i=N.getInstance().getLowercaseEmails(o);if((i===null||i===void 0?void 0:i.length)>0){t.set(i[0],[o.id])}}}}catch(t){a={error:t}}finally{try{if(r&&!r.done&&(c=n.return))c.call(n)}finally{if(a)throw a.error}}return[2,t]}}))}))};RCContactService.prototype.getDeduplicateCount=function(){return this.getEntityCacheController().getTotalCount()};RCContactService.prototype.isProviderAvailable=function(){return Promise.resolve(true)};RCContactService.prototype.canBeDeduplicate=function(t){return q(this,void 0,Promise,(function(){var e;return J(this,(function(n){switch(n.label){case 0:return[4,this.getById(t)];case 1:e=n.sent();return[2,!!e&&this.getContactSearchController().isValidContactForSearch(e)]}}))}))};return RCContactService}(u.BaseContactService)}}]);